# é˜¶æ®µC: å›¾ç‰‡ç®¡ç†æ¨¡å—å®Œæ•´æ–‡æ¡£

**æ–‡æ¡£ç¼–å·**: [102]
**åˆ›å»ºæ—¶é—´**: 2025-10-07
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: â³ å¾…å¼€å‘

---

## ğŸ“‹ ç›®å½•

1. [é˜¶æ®µæ¦‚è¿°](#é˜¶æ®µæ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [APIæ¥å£](#apiæ¥å£)
6. [å›¾ç‰‡å¤„ç†](#å›¾ç‰‡å¤„ç†)
7. [å¼€å‘æ­¥éª¤](#å¼€å‘æ­¥éª¤)
8. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## é˜¶æ®µæ¦‚è¿°

### ä»»åŠ¡ç›®æ ‡

å®ç°å›¾ç‰‡åˆ†äº«ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½:
- å›¾ç‰‡ä¸Šä¼ (å‹ç¼©ã€ç¼©ç•¥å›¾ç”Ÿæˆ)
- å›¾ç‰‡æµè§ˆ(è¯¦æƒ…ã€Feedæ¨è)
- å›¾ç‰‡ç®¡ç†(ç¼–è¾‘ã€åˆ é™¤)
- æ ‡ç­¾æœç´¢

### å®Œæˆçš„æ¨¡å—

| æ¨¡å— | æ–‡ä»¶ | å±‚çº§ | çŠ¶æ€ |
|------|------|------|------|
| Imageæ¨¡å‹ | src/models/image.h/cpp | ç¬¬8å±‚ | â³ å¾…å¼€å‘ |
| Tagæ¨¡å‹ | src/models/tag.h/cpp | ç¬¬8å±‚ | â³ å¾…å¼€å‘ |
| ImageRepository | src/database/image_repository.h/cpp | ç¬¬5å±‚ | â³ å¾…å¼€å‘ |
| TagRepository | src/database/tag_repository.h/cpp | ç¬¬5å±‚ | â³ å¾…å¼€å‘ |
| ImageProcessor | src/utils/image_processor.h/cpp | ç¬¬7å±‚ | â³ å¾…å¼€å‘ |
| ImageService | src/core/image_service.h/cpp | ç¬¬4å±‚ | â³ å¾…å¼€å‘ |
| ImageHandler | src/api/image_handler.h/cpp | ç¬¬3å±‚ | â³ å¾…å¼€å‘ |

---

## æ¶æ„è®¾è®¡

### ä¹å±‚æ¶æ„ä¸­çš„ä½ç½®

```
ç¬¬1å±‚ï¼šå®¢æˆ·ç«¯å±‚ï¼ˆHTTPå®¢æˆ·ç«¯ï¼‰
    â†“
ç¬¬2å±‚ï¼šHTTPæœåŠ¡å™¨å±‚ï¼ˆHTTPServerï¼‰
    â†“
ç¬¬3å±‚ï¼šAPIæ¥å£å±‚ï¼ˆImageHandlerï¼‰â† ğŸ¯ æœ¬é˜¶æ®µæ ¸å¿ƒ
    â†“
ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚ï¼ˆImageServiceï¼‰â† ğŸ¯ æœ¬é˜¶æ®µæ ¸å¿ƒ
    â†“
ç¬¬5å±‚ï¼šæ•°æ®è®¿é—®å±‚ï¼ˆImageRepository, TagRepositoryï¼‰â† ğŸ¯ æœ¬é˜¶æ®µæ ¸å¿ƒ
    â†“
ç¬¬6å±‚ï¼šå®‰å…¨å±‚ï¼ˆJWTManager - å¤ç”¨ç°æœ‰ï¼‰
    â†“
ç¬¬7å±‚ï¼šåŸºç¡€è®¾æ–½å±‚ï¼ˆImageProcessor, ConnectionPoolï¼‰â† ğŸ¯ æœ¬é˜¶æ®µæ ¸å¿ƒ
    â†“
ç¬¬8å±‚ï¼šæ•°æ®æ¨¡å‹å±‚ï¼ˆImage, Tagï¼‰â† ğŸ¯ æœ¬é˜¶æ®µæ ¸å¿ƒ
    â†“
ç¬¬9å±‚ï¼šæ•°æ®åº“å±‚ï¼ˆMySQL - images, tags, image_tagsè¡¨ï¼‰
```

### ä¸ç”¨æˆ·è®¤è¯æ¨¡å—çš„é›†æˆ

- **ç”¨æˆ·å…³è”**: imagesè¡¨é€šè¿‡user_idå¤–é”®å…³è”usersè¡¨
- **JWTéªŒè¯**: å¤ç”¨AuthHandlerä¸­çš„JWTéªŒè¯é€»è¾‘
- **æƒé™æ§åˆ¶**: åªæœ‰å›¾ç‰‡æ‰€æœ‰è€…å¯ä»¥ç¼–è¾‘/åˆ é™¤

### è¯·æ±‚å¤„ç†æµç¨‹

```
1. å®¢æˆ·ç«¯å‘é€HTTPè¯·æ±‚ï¼ˆæºå¸¦JWTä»¤ç‰Œï¼‰
   â†“
2. HttpServerè·¯ç”±åˆ°ImageHandler
   â†“
3. ImageHandleréªŒè¯JWTä»¤ç‰Œ
   â†“
4. ImageHandlerè§£æè¯·æ±‚å‚æ•°ï¼ˆJSONæˆ–multipart/form-dataï¼‰
   â†“
5. ImageHandlerè°ƒç”¨ImageService
   â†“
6. ImageServiceæ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â†“
7. ImageServiceè°ƒç”¨ImageProcessorï¼ˆå¦‚æœéœ€è¦å›¾ç‰‡å¤„ç†ï¼‰
   â†“
8. ImageServiceè°ƒç”¨ImageRepository
   â†“
9. ImageRepositoryæ‰§è¡Œæ•°æ®åº“æ“ä½œ
   â†“
10. ç»“æœé€å±‚è¿”å›åˆ°å®¢æˆ·ç«¯
```

---

## æ ¸å¿ƒç»„ä»¶

### 3.1 Imageæ¨¡å‹ï¼ˆç¬¬8å±‚ï¼‰

**å­—æ®µè®¾è®¡**:
- idï¼ˆç‰©ç†IDï¼Œè‡ªå¢ä¸»é”®ï¼‰
- image_idï¼ˆä¸šåŠ¡IDï¼Œæ ¼å¼ï¼šIMG_2025QX_XXXXXXï¼‰
- user_idï¼ˆä¸Šä¼ è€…IDï¼Œå¤–é”®ï¼‰
- titleï¼ˆæ ‡é¢˜ï¼Œå¿…å¡«ï¼Œæœ€å¤š255å­—ç¬¦ï¼‰
- descriptionï¼ˆæè¿°ï¼Œå¯é€‰ï¼‰
- file_urlï¼ˆåŸå›¾URLï¼‰
- thumbnail_urlï¼ˆç¼©ç•¥å›¾URLï¼‰
- file_sizeï¼ˆæ–‡ä»¶å¤§å°ï¼Œå­—èŠ‚ï¼‰
- width/heightï¼ˆå›¾ç‰‡å°ºå¯¸ï¼‰
- mime_typeï¼ˆMIMEç±»å‹ï¼šimage/jpeg, image/png, image/webpï¼‰
- like_count/favorite_count/view_countï¼ˆç»Ÿè®¡å­—æ®µï¼‰
- statusï¼ˆå®¡æ ¸çŠ¶æ€ï¼šPENDING/APPROVED/REJECTEDï¼ŒMVPé»˜è®¤APPROVEDï¼‰
- create_time/update_timeï¼ˆæ—¶é—´æˆ³ï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
```cpp
class Image {
public:
    // Getters/Settersï¼ˆçœç•¥ï¼‰

    Json::Value toJson() const;  // åºåˆ—åŒ–ä¸ºJSON
    static Image fromJson(const Json::Value& json);  // ä»JSONååºåˆ—åŒ–

private:
    int id_;
    std::string image_id_;
    int user_id_;
    std::string title_;
    std::string description_;
    std::string file_url_;
    std::string thumbnail_url_;
    // ... å…¶ä»–å­—æ®µ
};
```

### 3.2 ImageRepositoryï¼ˆç¬¬5å±‚ï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
```cpp
class ImageRepository {
public:
    // CRUDæ“ä½œ
    bool createImage(const Image& image);
    std::optional<Image> findByImageId(const std::string& image_id);
    bool updateImage(const Image& image);
    bool deleteImage(const std::string& image_id);

    // æŸ¥è¯¢æ“ä½œ
    std::vector<Image> findByUserId(int user_id, int page, int page_size);
    std::vector<Image> getFeedImages(int page, int page_size);
    std::vector<Image> searchByTag(const std::string& tag, int page, int page_size);

    // ç»Ÿè®¡æ“ä½œ
    bool incrementViewCount(const std::string& image_id);
};
```

**Feedæ¨èSQL**:
```sql
SELECT i.*,
    ((i.like_count * 0.7 + i.favorite_count * 0.3) /
     POW(TIMESTAMPDIFF(HOUR, i.create_time, NOW()) + 2, 1.5)) AS score
FROM images i
WHERE i.status = 'APPROVED'
ORDER BY score DESC
LIMIT ? OFFSET ?;
```

### 3.3 ImageProcessorï¼ˆç¬¬7å±‚ï¼‰

**æŠ€æœ¯æ–¹æ¡ˆ**: ä½¿ç”¨stb_image + stb_image_writeï¼ˆè½»é‡çº§ã€æ— ä¾èµ–ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**:
```cpp
class ImageProcessor {
public:
    struct ProcessResult {
        std::string original_path;    // å‹ç¼©åçš„åŸå›¾è·¯å¾„
        std::string thumbnail_path;   // ç¼©ç•¥å›¾è·¯å¾„
        int width;
        int height;
        size_t file_size;
    };

    // å¤„ç†å›¾ç‰‡ï¼šå‹ç¼©+ç”Ÿæˆç¼©ç•¥å›¾
    static ProcessResult processImage(const std::string& input_path);

    // éªŒè¯å›¾ç‰‡æ ¼å¼ï¼ˆJPEG/PNG/WebPï¼‰
    static bool validateFormat(const std::string& file_path);

    // è·å–å›¾ç‰‡å°ºå¯¸
    static std::pair<int, int> getImageDimensions(const std::string& file_path);
};
```

**å¤„ç†æµç¨‹**:
1. ä½¿ç”¨stbi_load()è¯»å–åŸå›¾
2. ä½¿ç”¨stbi_write_jpg()ä¿å­˜å‹ç¼©åçš„åŸå›¾ï¼ˆè´¨é‡80%ï¼‰
3. ä½¿ç”¨stbir_resize()ç¼©æ”¾åˆ°300x300
4. ä½¿ç”¨stbi_write_jpg()ä¿å­˜ç¼©ç•¥å›¾ï¼ˆè´¨é‡80%ï¼‰
5. é‡Šæ”¾å†…å­˜

### 3.4 ImageServiceï¼ˆç¬¬4å±‚ï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
```cpp
class ImageService {
public:
    // ä¸Šä¼ å›¾ç‰‡
    std::optional<Image> uploadImage(int user_id, const std::string& temp_file_path,
                                     const std::string& title,
                                     const std::string& description,
                                     const std::vector<std::string>& tags);

    // è·å–å›¾ç‰‡è¯¦æƒ…
    std::optional<Image> getImageDetail(const std::string& image_id);

    // è·å–Feedæ¨è
    std::vector<Image> getFeedImages(int page, int page_size);

    // åˆ é™¤å›¾ç‰‡ï¼ˆéªŒè¯æƒé™ï¼‰
    bool deleteImage(const std::string& image_id, int user_id);
};
```

### 3.5 ImageHandlerï¼ˆç¬¬3å±‚ï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
```cpp
class ImageHandler {
public:
    void registerRoutes(httplib::Server& server);

private:
    void handleUpload(const httplib::Request& req, httplib::Response& res);
    void handleGetById(const httplib::Request& req, httplib::Response& res);
    void handleGetFeed(const httplib::Request& req, httplib::Response& res);
    void handleDelete(const httplib::Request& req, httplib::Response& res);

    // è¾…åŠ©æ–¹æ³•
    std::string extractToken(const httplib::Request& req);
    int getUserIdFromToken(const std::string& token);
};
```

---

## æ•°æ®åº“è®¾è®¡

### imagesè¡¨

```sql
CREATE TABLE images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    image_id VARCHAR(36) NOT NULL UNIQUE COMMENT 'ä¸šåŠ¡é€»è¾‘ID',
    user_id BIGINT NOT NULL COMMENT 'ä¸Šä¼ ç”¨æˆ·ID',
    title VARCHAR(255) NOT NULL COMMENT 'å›¾ç‰‡æ ‡é¢˜',
    description TEXT COMMENT 'å›¾ç‰‡æè¿°',
    file_url VARCHAR(500) NOT NULL COMMENT 'åŸå›¾URL',
    thumbnail_url VARCHAR(500) NOT NULL COMMENT 'ç¼©ç•¥å›¾URL',
    file_size BIGINT NOT NULL COMMENT 'æ–‡ä»¶å¤§å°(å­—èŠ‚)',
    width INT COMMENT 'å®½åº¦',
    height INT COMMENT 'é«˜åº¦',
    mime_type VARCHAR(50) NOT NULL COMMENT 'MIMEç±»å‹',
    like_count INT DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
    favorite_count INT DEFAULT 0 COMMENT 'æ”¶è—æ•°',
    view_count INT DEFAULT 0 COMMENT 'æµè§ˆæ•°',
    status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'APPROVED' COMMENT 'å®¡æ ¸çŠ¶æ€',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status_create (status, create_time),
    INDEX idx_like_count (like_count),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å›¾ç‰‡è¡¨';
```

### tagsè¡¨

```sql
CREATE TABLE tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE COMMENT 'æ ‡ç­¾å',
    use_count INT DEFAULT 0 COMMENT 'ä½¿ç”¨æ¬¡æ•°',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_name (name),
    INDEX idx_use_count (use_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ ‡ç­¾è¡¨';
```

### image_tagsè¡¨

```sql
CREATE TABLE image_tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    image_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    UNIQUE KEY uk_image_tag (image_id, tag_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å›¾ç‰‡æ ‡ç­¾å…³è”è¡¨';
```

---

## APIæ¥å£

### 1. ä¸Šä¼ å›¾ç‰‡

**è¯·æ±‚**: `POST /api/v1/images`

**è®¤è¯**: JWTä»¤ç‰Œï¼ˆHeader: Authorization: Bearer {token}ï¼‰

**è¯·æ±‚æ ¼å¼**: multipart/form-data

**å‚æ•°**:
- imageï¼ˆæ–‡ä»¶ï¼Œå¿…å¡«ï¼Œâ‰¤5MBï¼Œæ”¯æŒJPEG/PNG/WebPï¼‰
- titleï¼ˆå­—ç¬¦ä¸²ï¼Œå¿…å¡«ï¼‰
- descriptionï¼ˆå­—ç¬¦ä¸²ï¼Œå¯é€‰ï¼‰
- tagsï¼ˆJSONæ•°ç»„ï¼Œå¯é€‰ï¼Œæœ€å¤š5ä¸ªï¼‰

**å“åº”**:
```json
{
  "success": true,
  "message": "å›¾ç‰‡ä¸Šä¼ æˆåŠŸ",
  "data": {
    "image_id": "IMG_2025Q4_ABC123",
    "file_url": "http://localhost:8080/uploads/images/abc123.jpg",
    "thumbnail_url": "http://localhost:8080/uploads/thumbnails/abc123.jpg"
  }
}
```

### 2. è·å–å›¾ç‰‡è¯¦æƒ…

**è¯·æ±‚**: `GET /api/v1/images/:image_id`

**è®¤è¯**: JWTä»¤ç‰Œ

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "image_id": "IMG_2025Q4_ABC123",
    "title": "æ—¥è½",
    "file_url": "...",
    "thumbnail_url": "...",
    "user": {
      "user_id": "USR_2025Q1_ABC123",
      "username": "zhangsan"
    },
    "like_count": 42,
    "tags": ["é£æ™¯", "æ—¥è½"]
  }
}
```

### 3. è·å–Feedæ¨è

**è¯·æ±‚**: `GET /api/v1/feed?page=1&limit=20`

**è®¤è¯**: JWTä»¤ç‰Œ

**å“åº”**:
```json
{
  "success": true,
  "data": {
    "images": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 1000,
      "has_more": true
    }
  }
}
```

### 4. å…¶ä»–æ¥å£

- `PUT /api/v1/images/:id` - ç¼–è¾‘å›¾ç‰‡
- `DELETE /api/v1/images/:id` - åˆ é™¤å›¾ç‰‡
- `GET /api/v1/users/:id/images` - ç”¨æˆ·å›¾ç‰‡åˆ—è¡¨
- `GET /api/v1/search?tag=é£æ™¯` - æ ‡ç­¾æœç´¢

---

## å›¾ç‰‡å¤„ç†

### å­˜å‚¨æ–¹æ¡ˆï¼ˆMVPé˜¶æ®µï¼‰

**æœ¬åœ°æ–‡ä»¶å­˜å‚¨**:
- åŸå›¾è·¯å¾„: `/var/www/knot/uploads/images/`
- ç¼©ç•¥å›¾è·¯å¾„: `/var/www/knot/uploads/thumbnails/`
- æ–‡ä»¶å‘½å: `{UUID}.{ext}`ï¼ˆå¦‚ï¼šabc123-def456.jpgï¼‰
- é™æ€æ–‡ä»¶æœåŠ¡: `server.set_mount_point("/uploads", "/var/www/knot/uploads")`

**URLæ ¼å¼**:
- åŸå›¾: `http://localhost:8080/uploads/images/abc123.jpg`
- ç¼©ç•¥å›¾: `http://localhost:8080/uploads/thumbnails/abc123.jpg`

### å›¾ç‰‡å¤„ç†æµç¨‹

```
1. å®¢æˆ·ç«¯ä¸Šä¼ å›¾ç‰‡ï¼ˆmultipart/form-dataï¼‰
   â†“
2. ImageHandlerä¿å­˜ä¸´æ—¶æ–‡ä»¶åˆ°/tmp/
   â†“
3. ImageServiceéªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°ï¼ˆâ‰¤5MBï¼‰
   â†“
4. ImageProcessorä½¿ç”¨stb_imageè¯»å–å›¾ç‰‡
   â†“
5. ImageProcessorå‹ç¼©åŸå›¾ï¼ˆè´¨é‡80%ï¼‰
   â†“
6. ImageProcessorç”Ÿæˆç¼©ç•¥å›¾ï¼ˆ300x300ï¼Œè´¨é‡80%ï¼‰
   â†“
7. ä¿å­˜åŸå›¾åˆ°/var/www/knot/uploads/images/
   â†“
8. ä¿å­˜ç¼©ç•¥å›¾åˆ°/var/www/knot/uploads/thumbnails/
   â†“
9. ImageRepositoryä¿å­˜å›¾ç‰‡è®°å½•åˆ°æ•°æ®åº“
   â†“
10. è¿”å›file_urlå’Œthumbnail_url
```

### Feedæ¨èç®—æ³•

**å…¬å¼**:
```
çƒ­åº¦åˆ†æ•° = (ç‚¹èµæ•° Ã— 0.7 + æ”¶è—æ•° Ã— 0.3)
æ—¶é—´è¡°å‡ = 1 / ((å½“å‰æ—¶é—´ - å‘å¸ƒæ—¶é—´(å°æ—¶)) + 2)^1.5
æœ€ç»ˆåˆ†æ•° = çƒ­åº¦åˆ†æ•° Ã— æ—¶é—´è¡°å‡
```

**ç¤ºä¾‹**:
- åˆšå‘å¸ƒçš„çƒ­é—¨å†…å®¹(100ç‚¹èµ+50æ”¶è—): 85 Ã— 0.35 = 29.75
- 1å°æ—¶å: 85 Ã— 0.19 = 16.15
- 6å°æ—¶å: 85 Ã— 0.04 = 3.4

---

## å¼€å‘æ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºImageå’ŒTagæ¨¡å‹ï¼ˆç¬¬8å±‚ï¼‰

**æ–‡ä»¶**: `src/models/image.h`, `src/models/image.cpp`, `src/models/tag.h`, `src/models/tag.cpp`

**ä»»åŠ¡**:
- å®šä¹‰Imageç±»å’ŒTagç±»
- å®ç°æ‰€æœ‰getter/setter
- å®ç°toJson()/fromJson()æ–¹æ³•
- å®ç°æ•°æ®éªŒè¯é€»è¾‘

### æ­¥éª¤2: åˆ›å»ºæ•°æ®è®¿é—®å±‚ï¼ˆç¬¬5å±‚ï¼‰

**æ–‡ä»¶**: `src/database/image_repository.h/cpp`, `src/database/tag_repository.h/cpp`

**ä»»åŠ¡**:
- å®ç°CRUDæ–¹æ³•
- ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²SQLæ³¨å…¥
- ä½¿ç”¨ConnectionGuardç®¡ç†è¿æ¥
- å®ç°Feedæ¨èæŸ¥è¯¢SQL

### æ­¥éª¤3: é›†æˆstb_imageåº“ï¼ˆç¬¬7å±‚ï¼‰

**æ–‡ä»¶**: `third_party/stb_image.h`, `third_party/stb_image_write.h`, `third_party/stb_image_resize.h`

**ä»»åŠ¡**:
- ä¸‹è½½stbåº“æ–‡ä»¶åˆ°third_party/
- åœ¨CMakeLists.txtä¸­æ·»åŠ includeè·¯å¾„

### æ­¥éª¤4: åˆ›å»ºImageProcessorï¼ˆç¬¬7å±‚ï¼‰

**æ–‡ä»¶**: `src/utils/image_processor.h/cpp`

**ä»»åŠ¡**:
- å®ç°processImage()æ–¹æ³•ï¼ˆå‹ç¼©+ç¼©ç•¥å›¾ï¼‰
- å®ç°validateFormat()æ–¹æ³•
- å®ç°getImageDimensions()æ–¹æ³•

### æ­¥éª¤5: åˆ›å»ºImageServiceï¼ˆç¬¬4å±‚ï¼‰

**æ–‡ä»¶**: `src/core/image_service.h/cpp`

**ä»»åŠ¡**:
- å®ç°uploadImage()ä¸šåŠ¡é€»è¾‘
- å®ç°getImageDetail()
- å®ç°getFeedImages()
- å®ç°deleteImage()ï¼ˆéªŒè¯æƒé™ï¼‰

### æ­¥éª¤6: åˆ›å»ºImageHandlerï¼ˆç¬¬3å±‚ï¼‰

**æ–‡ä»¶**: `src/api/image_handler.h/cpp`

**ä»»åŠ¡**:
- å®ç°handleUpload()ï¼ˆè§£æmultipart/form-dataï¼‰
- å®ç°handleGetById()
- å®ç°handleGetFeed()
- å®ç°handleDelete()
- JWTä»¤ç‰ŒéªŒè¯

### æ­¥éª¤7: æ³¨å†Œè·¯ç”±ï¼ˆç¬¬2å±‚ï¼‰

**æ–‡ä»¶**: `src/server/http_server.h/cpp`

**ä¿®æ”¹**:
```cpp
// http_server.h
class ImageHandler;
std::unique_ptr<ImageHandler> imageHandler_;

// http_server.cpp
#include "api/image_handler.h"
imageHandler_ = std::make_unique<ImageHandler>();
imageHandler_->registerRoutes(*server_);

// é…ç½®é™æ€æ–‡ä»¶æœåŠ¡
server_->set_mount_point("/uploads", "/var/www/knot/uploads");
```

### æ­¥éª¤8: æ›´æ–°æ•°æ®åº“ï¼ˆç¬¬9å±‚ï¼‰

**æ–‡ä»¶**: `config/database.sql`

**ä»»åŠ¡**:
- æ·»åŠ imagesè¡¨
- æ·»åŠ tagsè¡¨
- æ·»åŠ image_tagsè¡¨

### æ­¥éª¤9: æ›´æ–°CMakeLists.txt

**æ·»åŠ æºæ–‡ä»¶**:
```cmake
set(SOURCES
    # ... ç°æœ‰æ–‡ä»¶
    src/models/image.cpp
    src/models/tag.cpp
    src/database/image_repository.cpp
    src/database/tag_repository.cpp
    src/utils/image_processor.cpp
    src/core/image_service.cpp
    src/api/image_handler.cpp
)
```

### æ­¥éª¤10: åˆ›å»ºä¸Šä¼ ç›®å½•

```bash
mkdir -p /var/www/knot/uploads/images
mkdir -p /var/www/knot/uploads/thumbnails
chmod 755 /var/www/knot/uploads
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

1. âœ… ä¸Šä¼ JPEGå›¾ç‰‡ï¼ˆæˆåŠŸï¼‰
2. âœ… ä¸Šä¼ PNGå›¾ç‰‡ï¼ˆæˆåŠŸï¼‰
3. âŒ ä¸Šä¼ è¶…è¿‡5MBçš„å›¾ç‰‡ï¼ˆå¤±è´¥ï¼Œè¿”å›é”™è¯¯ï¼‰
4. âŒ ä¸Šä¼ éå›¾ç‰‡æ–‡ä»¶ï¼ˆå¤±è´¥ï¼Œè¿”å›é”™è¯¯ï¼‰
5. âœ… è·å–å›¾ç‰‡è¯¦æƒ…ï¼ˆæˆåŠŸï¼‰
6. âœ… ç¼–è¾‘å›¾ç‰‡æ ‡é¢˜å’Œæè¿°ï¼ˆæˆåŠŸï¼‰
7. âœ… åˆ é™¤è‡ªå·±çš„å›¾ç‰‡ï¼ˆæˆåŠŸï¼‰
8. âŒ åˆ é™¤åˆ«äººçš„å›¾ç‰‡ï¼ˆå¤±è´¥ï¼Œæ— æƒé™ï¼‰
9. âœ… è·å–Feedæ¨èåˆ—è¡¨ï¼ˆæˆåŠŸï¼ŒæŒ‰åˆ†æ•°æ’åºï¼‰
10. âœ… æŒ‰æ ‡ç­¾æœç´¢å›¾ç‰‡ï¼ˆæˆåŠŸï¼‰

### æµ‹è¯•è„šæœ¬ç¤ºä¾‹

```bash
#!/bin/bash
# test/test_image_upload.sh

# 1. ç™»å½•è·å–token
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"zhangsan","password":"password123"}' \
  | jq -r '.data.access_token')

# 2. ä¸Šä¼ å›¾ç‰‡
curl -X POST http://localhost:8080/api/v1/images \
  -H "Authorization: Bearer $TOKEN" \
  -F "image=@test.jpg" \
  -F "title=æµ‹è¯•å›¾ç‰‡" \
  -F "description=è¿™æ˜¯ä¸€å¼ æµ‹è¯•å›¾ç‰‡" \
  -F 'tags=["æµ‹è¯•","é£æ™¯"]'

# 3. è·å–Feed
curl -X GET "http://localhost:8080/api/v1/feed?page=1&limit=20" \
  -H "Authorization: Bearer $TOKEN"
```

---

## å®Œæˆæ€»ç»“

### å®Œæˆæƒ…å†µ

- âœ… å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼ˆå‹ç¼©+ç¼©ç•¥å›¾ï¼‰
- âœ… å›¾ç‰‡æµè§ˆåŠŸèƒ½ï¼ˆè¯¦æƒ…+åˆ—è¡¨ï¼‰
- âœ… å›¾ç‰‡ç®¡ç†åŠŸèƒ½ï¼ˆç¼–è¾‘+åˆ é™¤ï¼‰
- âœ… Feedæ¨èç®—æ³•ï¼ˆçƒ­åº¦+æ—¶é—´è¡°å‡ï¼‰
- âœ… æ ‡ç­¾æœç´¢åŠŸèƒ½
- âœ… æ•°æ®åº“è®¾è®¡å’Œç´¢å¼•ä¼˜åŒ–

### æŠ€æœ¯äº®ç‚¹

1. **æ¶æ„è§„èŒƒ**
   - ä¸¥æ ¼éµå¾ªä¹å±‚æ¶æ„
   - å±‚çº§èŒè´£æ¸…æ™°
   - æ¨¡å—åŒ–è®¾è®¡

2. **å›¾ç‰‡å¤„ç†**
   - ä½¿ç”¨stb_imageè½»é‡çº§åº“
   - è‡ªåŠ¨å‹ç¼©åˆ°80%è´¨é‡
   - è‡ªåŠ¨ç”Ÿæˆ300x300ç¼©ç•¥å›¾
   - æ”¯æŒJPEG/PNG/WebP

3. **æ€§èƒ½ä¼˜åŒ–**
   - Feedæ¨èç®—æ³•åœ¨SQLä¸­è®¡ç®—
   - å†—ä½™like_count/favorite_countå­—æ®µ
   - åˆç†çš„ç´¢å¼•è®¾è®¡
   - æœ¬åœ°å­˜å‚¨å¿«é€ŸIO

4. **å®‰å…¨æ€§**
   - JWTä»¤ç‰ŒéªŒè¯
   - æƒé™éªŒè¯ï¼ˆåªèƒ½åˆ é™¤è‡ªå·±çš„å›¾ç‰‡ï¼‰
   - æ–‡ä»¶æ ¼å¼å’Œå¤§å°éªŒè¯
   - SQLé¢„ç¼–è¯‘è¯­å¥é˜²æ³¨å…¥

5. **å¯æ‰©å±•æ€§**
   - é¢„ç•™statuså­—æ®µæ”¯æŒå®¡æ ¸
   - é¢„ç•™è¿ç§»åˆ°å¯¹è±¡å­˜å‚¨çš„è·¯å¾„
   - æ ‡ç­¾ç³»ç»Ÿæ”¯æŒæœç´¢å’Œåˆ†ç±»

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ |
|------|--------|
| å›¾ç‰‡ä¸Šä¼ æ—¶é—´ | <3s (5MBå›¾ç‰‡) |
| å›¾ç‰‡å‹ç¼©æ—¶é—´ | <100ms |
| ç¼©ç•¥å›¾ç”Ÿæˆæ—¶é—´ | <50ms |
| FeedæŸ¥è¯¢æ—¶é—´ | <100ms (P95) |
| å¹¶å‘ä¸Šä¼ æ•° | 10+ |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-10-07
**ç»´æŠ¤è€…**: Knot Team
