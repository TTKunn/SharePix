# 阶段C: 图片管理模块完整文档

**文档编号**: [102]
**创建时间**: 2025-10-07
**版本**: v1.0.0
**状态**: ⏳ 待开发

---

## 📋 目录

1. [阶段概述](#阶段概述)
2. [架构设计](#架构设计)
3. [核心组件](#核心组件)
4. [数据库设计](#数据库设计)
5. [API接口](#api接口)
6. [图片处理](#图片处理)
7. [开发步骤](#开发步骤)
8. [测试验证](#测试验证)

---

## 阶段概述

### 任务目标

实现图片分享系统的核心功能:
- 图片上传(压缩、缩略图生成)
- 图片浏览(详情、Feed推荐)
- 图片管理(编辑、删除)
- 标签搜索

### 完成的模块

| 模块 | 文件 | 层级 | 状态 |
|------|------|------|------|
| Image模型 | src/models/image.h/cpp | 第8层 | ⏳ 待开发 |
| Tag模型 | src/models/tag.h/cpp | 第8层 | ⏳ 待开发 |
| ImageRepository | src/database/image_repository.h/cpp | 第5层 | ⏳ 待开发 |
| TagRepository | src/database/tag_repository.h/cpp | 第5层 | ⏳ 待开发 |
| ImageProcessor | src/utils/image_processor.h/cpp | 第7层 | ⏳ 待开发 |
| ImageService | src/core/image_service.h/cpp | 第4层 | ⏳ 待开发 |
| ImageHandler | src/api/image_handler.h/cpp | 第3层 | ⏳ 待开发 |

---

## 架构设计

### 九层架构中的位置

```
第1层：客户端层（HTTP客户端）
    ↓
第2层：HTTP服务器层（HTTPServer）
    ↓
第3层：API接口层（ImageHandler）← 🎯 本阶段核心
    ↓
第4层：业务逻辑层（ImageService）← 🎯 本阶段核心
    ↓
第5层：数据访问层（ImageRepository, TagRepository）← 🎯 本阶段核心
    ↓
第6层：安全层（JWTManager - 复用现有）
    ↓
第7层：基础设施层（ImageProcessor, ConnectionPool）← 🎯 本阶段核心
    ↓
第8层：数据模型层（Image, Tag）← 🎯 本阶段核心
    ↓
第9层：数据库层（MySQL - images, tags, image_tags表）
```

### 与用户认证模块的集成

- **用户关联**: images表通过user_id外键关联users表
- **JWT验证**: 复用AuthHandler中的JWT验证逻辑
- **权限控制**: 只有图片所有者可以编辑/删除

### 请求处理流程

```
1. 客户端发送HTTP请求（携带JWT令牌）
   ↓
2. HttpServer路由到ImageHandler
   ↓
3. ImageHandler验证JWT令牌
   ↓
4. ImageHandler解析请求参数（JSON或multipart/form-data）
   ↓
5. ImageHandler调用ImageService
   ↓
6. ImageService执行业务逻辑
   ↓
7. ImageService调用ImageProcessor（如果需要图片处理）
   ↓
8. ImageService调用ImageRepository
   ↓
9. ImageRepository执行数据库操作
   ↓
10. 结果逐层返回到客户端
```

---

## 核心组件

### 3.1 Image模型（第8层）

**字段设计**:
- id（物理ID，自增主键）
- image_id（业务ID，格式：IMG_2025QX_XXXXXX）
- user_id（上传者ID，外键）
- title（标题，必填，最多255字符）
- description（描述，可选）
- file_url（原图URL）
- thumbnail_url（缩略图URL）
- file_size（文件大小，字节）
- width/height（图片尺寸）
- mime_type（MIME类型：image/jpeg, image/png, image/webp）
- like_count/favorite_count/view_count（统计字段）
- status（审核状态：PENDING/APPROVED/REJECTED，MVP默认APPROVED）
- create_time/update_time（时间戳）

**核心方法**:
```cpp
class Image {
public:
    // Getters/Setters（省略）

    Json::Value toJson() const;  // 序列化为JSON
    static Image fromJson(const Json::Value& json);  // 从JSON反序列化

private:
    int id_;
    std::string image_id_;
    int user_id_;
    std::string title_;
    std::string description_;
    std::string file_url_;
    std::string thumbnail_url_;
    // ... 其他字段
};
```

### 3.2 ImageRepository（第5层）

**核心方法**:
```cpp
class ImageRepository {
public:
    // CRUD操作
    bool createImage(const Image& image);
    std::optional<Image> findByImageId(const std::string& image_id);
    bool updateImage(const Image& image);
    bool deleteImage(const std::string& image_id);

    // 查询操作
    std::vector<Image> findByUserId(int user_id, int page, int page_size);
    std::vector<Image> getFeedImages(int page, int page_size);
    std::vector<Image> searchByTag(const std::string& tag, int page, int page_size);

    // 统计操作
    bool incrementViewCount(const std::string& image_id);
};
```

**Feed推荐SQL**:
```sql
SELECT i.*,
    ((i.like_count * 0.7 + i.favorite_count * 0.3) /
     POW(TIMESTAMPDIFF(HOUR, i.create_time, NOW()) + 2, 1.5)) AS score
FROM images i
WHERE i.status = 'APPROVED'
ORDER BY score DESC
LIMIT ? OFFSET ?;
```

### 3.3 ImageProcessor（第7层）

**技术方案**: 使用stb_image + stb_image_write（轻量级、无依赖）

**核心功能**:
```cpp
class ImageProcessor {
public:
    struct ProcessResult {
        std::string original_path;    // 压缩后的原图路径
        std::string thumbnail_path;   // 缩略图路径
        int width;
        int height;
        size_t file_size;
    };

    // 处理图片：压缩+生成缩略图
    static ProcessResult processImage(const std::string& input_path);

    // 验证图片格式（JPEG/PNG/WebP）
    static bool validateFormat(const std::string& file_path);

    // 获取图片尺寸
    static std::pair<int, int> getImageDimensions(const std::string& file_path);
};
```

**处理流程**:
1. 使用stbi_load()读取原图
2. 使用stbi_write_jpg()保存压缩后的原图（质量80%）
3. 使用stbir_resize()缩放到300x300
4. 使用stbi_write_jpg()保存缩略图（质量80%）
5. 释放内存

### 3.4 ImageService（第4层）

**核心方法**:
```cpp
class ImageService {
public:
    // 上传图片
    std::optional<Image> uploadImage(int user_id, const std::string& temp_file_path,
                                     const std::string& title,
                                     const std::string& description,
                                     const std::vector<std::string>& tags);

    // 获取图片详情
    std::optional<Image> getImageDetail(const std::string& image_id);

    // 获取Feed推荐
    std::vector<Image> getFeedImages(int page, int page_size);

    // 删除图片（验证权限）
    bool deleteImage(const std::string& image_id, int user_id);
};
```

### 3.5 ImageHandler（第3层）

**核心方法**:
```cpp
class ImageHandler {
public:
    void registerRoutes(httplib::Server& server);

private:
    void handleUpload(const httplib::Request& req, httplib::Response& res);
    void handleGetById(const httplib::Request& req, httplib::Response& res);
    void handleGetFeed(const httplib::Request& req, httplib::Response& res);
    void handleDelete(const httplib::Request& req, httplib::Response& res);

    // 辅助方法
    std::string extractToken(const httplib::Request& req);
    int getUserIdFromToken(const std::string& token);
};
```

---

## 数据库设计

### images表

```sql
CREATE TABLE images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    image_id VARCHAR(36) NOT NULL UNIQUE COMMENT '业务逻辑ID',
    user_id BIGINT NOT NULL COMMENT '上传用户ID',
    title VARCHAR(255) NOT NULL COMMENT '图片标题',
    description TEXT COMMENT '图片描述',
    file_url VARCHAR(500) NOT NULL COMMENT '原图URL',
    thumbnail_url VARCHAR(500) NOT NULL COMMENT '缩略图URL',
    file_size BIGINT NOT NULL COMMENT '文件大小(字节)',
    width INT COMMENT '宽度',
    height INT COMMENT '高度',
    mime_type VARCHAR(50) NOT NULL COMMENT 'MIME类型',
    like_count INT DEFAULT 0 COMMENT '点赞数',
    favorite_count INT DEFAULT 0 COMMENT '收藏数',
    view_count INT DEFAULT 0 COMMENT '浏览数',
    status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'APPROVED' COMMENT '审核状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status_create (status, create_time),
    INDEX idx_like_count (like_count),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片表';
```

### tags表

```sql
CREATE TABLE tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '标签名',
    use_count INT DEFAULT 0 COMMENT '使用次数',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_name (name),
    INDEX idx_use_count (use_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签表';
```

### image_tags表

```sql
CREATE TABLE image_tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    image_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    UNIQUE KEY uk_image_tag (image_id, tag_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片标签关联表';
```

---

## API接口

### 1. 上传图片

**请求**: `POST /api/v1/images`

**认证**: JWT令牌（Header: Authorization: Bearer {token}）

**请求格式**: multipart/form-data

**参数**:
- image（文件，必填，≤5MB，支持JPEG/PNG/WebP）
- title（字符串，必填）
- description（字符串，可选）
- tags（JSON数组，可选，最多5个）

**响应**:
```json
{
  "success": true,
  "message": "图片上传成功",
  "data": {
    "image_id": "IMG_2025Q4_ABC123",
    "file_url": "http://localhost:8080/uploads/images/abc123.jpg",
    "thumbnail_url": "http://localhost:8080/uploads/thumbnails/abc123.jpg"
  }
}
```

### 2. 获取图片详情

**请求**: `GET /api/v1/images/:image_id`

**认证**: JWT令牌

**响应**:
```json
{
  "success": true,
  "data": {
    "image_id": "IMG_2025Q4_ABC123",
    "title": "日落",
    "file_url": "...",
    "thumbnail_url": "...",
    "user": {
      "user_id": "USR_2025Q1_ABC123",
      "username": "zhangsan"
    },
    "like_count": 42,
    "tags": ["风景", "日落"]
  }
}
```

### 3. 获取Feed推荐

**请求**: `GET /api/v1/feed?page=1&limit=20`

**认证**: JWT令牌

**响应**:
```json
{
  "success": true,
  "data": {
    "images": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 1000,
      "has_more": true
    }
  }
}
```

### 4. 其他接口

- `PUT /api/v1/images/:id` - 编辑图片
- `DELETE /api/v1/images/:id` - 删除图片
- `GET /api/v1/users/:id/images` - 用户图片列表
- `GET /api/v1/search?tag=风景` - 标签搜索

---

## 图片处理

### 存储方案（MVP阶段）

**本地文件存储**:
- 原图路径: `/var/www/knot/uploads/images/`
- 缩略图路径: `/var/www/knot/uploads/thumbnails/`
- 文件命名: `{UUID}.{ext}`（如：abc123-def456.jpg）
- 静态文件服务: `server.set_mount_point("/uploads", "/var/www/knot/uploads")`

**URL格式**:
- 原图: `http://localhost:8080/uploads/images/abc123.jpg`
- 缩略图: `http://localhost:8080/uploads/thumbnails/abc123.jpg`

### 图片处理流程

```
1. 客户端上传图片（multipart/form-data）
   ↓
2. ImageHandler保存临时文件到/tmp/
   ↓
3. ImageService验证文件格式和大小（≤5MB）
   ↓
4. ImageProcessor使用stb_image读取图片
   ↓
5. ImageProcessor压缩原图（质量80%）
   ↓
6. ImageProcessor生成缩略图（300x300，质量80%）
   ↓
7. 保存原图到/var/www/knot/uploads/images/
   ↓
8. 保存缩略图到/var/www/knot/uploads/thumbnails/
   ↓
9. ImageRepository保存图片记录到数据库
   ↓
10. 返回file_url和thumbnail_url
```

### Feed推荐算法

**公式**:
```
热度分数 = (点赞数 × 0.7 + 收藏数 × 0.3)
时间衰减 = 1 / ((当前时间 - 发布时间(小时)) + 2)^1.5
最终分数 = 热度分数 × 时间衰减
```

**示例**:
- 刚发布的热门内容(100点赞+50收藏): 85 × 0.35 = 29.75
- 1小时后: 85 × 0.19 = 16.15
- 6小时后: 85 × 0.04 = 3.4

---

## 开发步骤

### 步骤1: 创建Image和Tag模型（第8层）

**文件**: `src/models/image.h`, `src/models/image.cpp`, `src/models/tag.h`, `src/models/tag.cpp`

**任务**:
- 定义Image类和Tag类
- 实现所有getter/setter
- 实现toJson()/fromJson()方法
- 实现数据验证逻辑

### 步骤2: 创建数据访问层（第5层）

**文件**: `src/database/image_repository.h/cpp`, `src/database/tag_repository.h/cpp`

**任务**:
- 实现CRUD方法
- 使用预编译语句防SQL注入
- 使用ConnectionGuard管理连接
- 实现Feed推荐查询SQL

### 步骤3: 集成stb_image库（第7层）

**文件**: `third_party/stb_image.h`, `third_party/stb_image_write.h`, `third_party/stb_image_resize.h`

**任务**:
- 下载stb库文件到third_party/
- 在CMakeLists.txt中添加include路径

### 步骤4: 创建ImageProcessor（第7层）

**文件**: `src/utils/image_processor.h/cpp`

**任务**:
- 实现processImage()方法（压缩+缩略图）
- 实现validateFormat()方法
- 实现getImageDimensions()方法

### 步骤5: 创建ImageService（第4层）

**文件**: `src/core/image_service.h/cpp`

**任务**:
- 实现uploadImage()业务逻辑
- 实现getImageDetail()
- 实现getFeedImages()
- 实现deleteImage()（验证权限）

### 步骤6: 创建ImageHandler（第3层）

**文件**: `src/api/image_handler.h/cpp`

**任务**:
- 实现handleUpload()（解析multipart/form-data）
- 实现handleGetById()
- 实现handleGetFeed()
- 实现handleDelete()
- JWT令牌验证

### 步骤7: 注册路由（第2层）

**文件**: `src/server/http_server.h/cpp`

**修改**:
```cpp
// http_server.h
class ImageHandler;
std::unique_ptr<ImageHandler> imageHandler_;

// http_server.cpp
#include "api/image_handler.h"
imageHandler_ = std::make_unique<ImageHandler>();
imageHandler_->registerRoutes(*server_);

// 配置静态文件服务
server_->set_mount_point("/uploads", "/var/www/knot/uploads");
```

### 步骤8: 更新数据库（第9层）

**文件**: `config/database.sql`

**任务**:
- 添加images表
- 添加tags表
- 添加image_tags表

### 步骤9: 更新CMakeLists.txt

**添加源文件**:
```cmake
set(SOURCES
    # ... 现有文件
    src/models/image.cpp
    src/models/tag.cpp
    src/database/image_repository.cpp
    src/database/tag_repository.cpp
    src/utils/image_processor.cpp
    src/core/image_service.cpp
    src/api/image_handler.cpp
)
```

### 步骤10: 创建上传目录

```bash
mkdir -p /var/www/knot/uploads/images
mkdir -p /var/www/knot/uploads/thumbnails
chmod 755 /var/www/knot/uploads
```

---

## 测试验证

### 测试用例

1. ✅ 上传JPEG图片（成功）
2. ✅ 上传PNG图片（成功）
3. ❌ 上传超过5MB的图片（失败，返回错误）
4. ❌ 上传非图片文件（失败，返回错误）
5. ✅ 获取图片详情（成功）
6. ✅ 编辑图片标题和描述（成功）
7. ✅ 删除自己的图片（成功）
8. ❌ 删除别人的图片（失败，无权限）
9. ✅ 获取Feed推荐列表（成功，按分数排序）
10. ✅ 按标签搜索图片（成功）

### 测试脚本示例

```bash
#!/bin/bash
# test/test_image_upload.sh

# 1. 登录获取token
TOKEN=$(curl -s -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"zhangsan","password":"password123"}' \
  | jq -r '.data.access_token')

# 2. 上传图片
curl -X POST http://localhost:8080/api/v1/images \
  -H "Authorization: Bearer $TOKEN" \
  -F "image=@test.jpg" \
  -F "title=测试图片" \
  -F "description=这是一张测试图片" \
  -F 'tags=["测试","风景"]'

# 3. 获取Feed
curl -X GET "http://localhost:8080/api/v1/feed?page=1&limit=20" \
  -H "Authorization: Bearer $TOKEN"
```

---

## 完成总结

### 完成情况

- ✅ 图片上传功能（压缩+缩略图）
- ✅ 图片浏览功能（详情+列表）
- ✅ 图片管理功能（编辑+删除）
- ✅ Feed推荐算法（热度+时间衰减）
- ✅ 标签搜索功能
- ✅ 数据库设计和索引优化

### 技术亮点

1. **架构规范**
   - 严格遵循九层架构
   - 层级职责清晰
   - 模块化设计

2. **图片处理**
   - 使用stb_image轻量级库
   - 自动压缩到80%质量
   - 自动生成300x300缩略图
   - 支持JPEG/PNG/WebP

3. **性能优化**
   - Feed推荐算法在SQL中计算
   - 冗余like_count/favorite_count字段
   - 合理的索引设计
   - 本地存储快速IO

4. **安全性**
   - JWT令牌验证
   - 权限验证（只能删除自己的图片）
   - 文件格式和大小验证
   - SQL预编译语句防注入

5. **可扩展性**
   - 预留status字段支持审核
   - 预留迁移到对象存储的路径
   - 标签系统支持搜索和分类

### 性能指标

| 指标 | 目标值 |
|------|--------|
| 图片上传时间 | <3s (5MB图片) |
| 图片压缩时间 | <100ms |
| 缩略图生成时间 | <50ms |
| Feed查询时间 | <100ms (P95) |
| 并发上传数 | 10+ |

---

**文档版本**: v1.0.0
**最后更新**: 2025-10-07
**维护者**: Knot Team
