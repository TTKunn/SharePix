# ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŠŸèƒ½å®Œå–„ - å®æ–½è®¡åˆ’

**æ–‡æ¡£ç¼–å·**: [106]
**åˆ›å»ºæ—¶é—´**: 2025-10-09
**ç‰ˆæœ¬**: v2.0.0
**çŠ¶æ€**: ğŸš§ è¿›è¡Œä¸­

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

ä¸ºKnotå›¾ç‰‡åˆ†äº«ç³»ç»Ÿè¡¥å……å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŠŸèƒ½ï¼Œå®ç°5ä¸ªæ ¸å¿ƒAPIæ¥å£ã€‚

### å®æ–½èŒƒå›´

| åºå· | åŠŸèƒ½ | APIè·¯å¾„ | æ–¹æ³• | ä¼˜å…ˆçº§ | çŠ¶æ€ |
|------|------|---------|------|--------|------|
| 1 | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ | `/api/v1/users/profile` | GET | P0 | âœ… å·²å®Œæˆ (v2.1.0) |
| 2 | ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ | `/api/v1/users/profile` | PUT | P0 | âœ… å·²å®Œæˆ (v2.1.0) |
| 3 | è·å–å…¶ä»–ç”¨æˆ·å…¬å¼€ä¿¡æ¯ | `/api/v1/users/:user_id` | GET | P1 | âœ… å·²å®Œæˆ (v2.1.0) |
| 4 | ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥ | `/api/v1/users/check-username` | GET | P1 | âœ… å·²å®Œæˆ (v2.1.0) |
| 5 | **ç”¨æˆ·å¤´åƒä¸Šä¼ ** | `/api/v1/users/avatar` | POST | P0 | â³ å¾…å®æ–½ (v2.5.0) |

**æ€»å·¥ä½œé‡**: 
- v2.1.0 å·²å®Œæˆ: 9-12å°æ—¶
- v2.5.0 å¤´åƒä¸Šä¼ : 4-6å°æ—¶

---

## ğŸ“ è¯¦ç»†ä»»åŠ¡åˆ—è¡¨

### é˜¶æ®µ1ï¼šæ•°æ®åº“å˜æ›´ï¼ˆ30åˆ†é’Ÿï¼‰

- [x] **ä»»åŠ¡1.1**: å¤‡ä»½å½“å‰æ•°æ®åº“ âœ…
  - æ‰§è¡Œ: `mysqldump -u root -p knot_image_sharing > backup_$(date +%Y%m%d_%H%M%S).sql`
  - éªŒè¯: æ£€æŸ¥å¤‡ä»½æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ

- [x] **ä»»åŠ¡1.2**: æ·»åŠ æ–°å­—æ®µåˆ°usersè¡¨ âœ…
  - æ‰§è¡ŒSQL:
    ```sql
    ALTER TABLE users ADD COLUMN bio VARCHAR(500) NULL COMMENT 'ä¸ªäººç®€ä»‹' AFTER avatar_url;
    ALTER TABLE users ADD COLUMN gender ENUM('male', 'female', 'other', 'prefer_not_to_say') NULL COMMENT 'æ€§åˆ«' AFTER bio;
    ALTER TABLE users ADD COLUMN location VARCHAR(100) NULL COMMENT 'æ‰€åœ¨åœ°' AFTER gender;
    ```
  - éªŒè¯: `DESC users;` æ£€æŸ¥å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸ

---

### é˜¶æ®µ2ï¼šModelå±‚ï¼ˆ1å°æ—¶ï¼‰

- [x] **ä»»åŠ¡2.1**: ä¿®æ”¹ `src/models/user.h` âœ…
  - æ·»åŠ ç§æœ‰æˆå‘˜å˜é‡: `bio_`, `gender_`, `location_` âœ…
  - æ·»åŠ getteræ–¹æ³•: `getBio()`, `getGender()`, `getLocation()` âœ…
  - æ·»åŠ setteræ–¹æ³•: `setBio()`, `setGender()`, `setLocation()` âœ…

- [x] **ä»»åŠ¡2.2**: ä¿®æ”¹ `src/models/user.cpp` âœ…
  - æ›´æ–°æ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æ–°å­—æ®µ âœ…
  - æ›´æ–° `toJson()` æ–¹æ³•ï¼ŒåŒ…å«æ–°å­—æ®µ âœ…
  - æ›´æ–° `fromJson()` æ–¹æ³•ï¼Œè§£ææ–°å­—æ®µ âœ…
  - æ›´æ–° `validate()` æ–¹æ³•ï¼ŒéªŒè¯æ–°å­—æ®µ âœ…

- [x] **ä»»åŠ¡2.3**: ç¼–è¯‘æµ‹è¯• âœ…
  - æ‰§è¡Œ: `cd build && make` âœ…
  - éªŒè¯: ç¼–è¯‘æ— é”™è¯¯ âœ…

---

### é˜¶æ®µ3ï¼šRepositoryå±‚ï¼ˆ2-3å°æ—¶ï¼‰

- [x] **ä»»åŠ¡3.1**: ä¿®æ”¹ `src/database/user_repository.h` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `updateUserProfile()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `emailExistsForOtherUser()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `phoneExistsForOtherUser()` âœ…

- [x] **ä»»åŠ¡3.2**: å®ç° `src/database/user_repository.cpp` - `updateUserProfile()` âœ…
  - ä½¿ç”¨ConnectionGuardè·å–è¿æ¥
  - å‡†å¤‡SQL: `UPDATE users SET real_name=?, email=?, avatar_url=?, phone=?, bio=?, gender=?, location=?, update_time=CURRENT_TIMESTAMP WHERE id=?`
  - ä½¿ç”¨MYSQL_BINDç»‘å®šå‚æ•°
  - æ‰§è¡Œæ›´æ–°
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
  - æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—

- [x] **ä»»åŠ¡3.3**: å®ç° `src/database/user_repository.cpp` - `emailExistsForOtherUser()` âœ…
  - ä½¿ç”¨ConnectionGuardè·å–è¿æ¥ âœ…
  - å‡†å¤‡SQL: `SELECT COUNT(*) FROM users WHERE email=? AND id!=?` âœ…
  - æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœ âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡3.4**: å®ç° `src/database/user_repository.cpp` - `phoneExistsForOtherUser()` âœ…
  - ä½¿ç”¨ConnectionGuardè·å–è¿æ¥ âœ…
  - å‡†å¤‡SQL: `SELECT COUNT(*) FROM users WHERE phone=? AND id!=?` âœ…
  - æ‰§è¡ŒæŸ¥è¯¢å¹¶è¿”å›ç»“æœ âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡3.5**: ç¼–è¯‘æµ‹è¯• âœ…
  - æ‰§è¡Œ: `cd build && make` âœ…
  - éªŒè¯: ç¼–è¯‘æ— é”™è¯¯ âœ…

---

### é˜¶æ®µ4ï¼šServiceå±‚ï¼ˆ2-3å°æ—¶ï¼‰

- [x] **ä»»åŠ¡4.1**: ä¿®æ”¹ `src/core/auth_service.h` âœ…
  - æ·»åŠ ç»“æ„ä½“: `UpdateProfileResult` âœ…
  - æ·»åŠ ç»“æ„ä½“: `UsernameCheckResult` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `updateUserProfile()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `getUserPublicInfo()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `checkUsernameAvailability()` âœ…
  - æ·»åŠ ç§æœ‰æ–¹æ³•å£°æ˜: `validateProfileUpdateInput()` âœ…

- [x] **ä»»åŠ¡4.2**: å®ç° `src/core/auth_service.cpp` - `validateProfileUpdateInput()` âœ…
  - éªŒè¯real_name: éç©ºï¼Œä¸è¶…è¿‡50å­—ç¬¦
  - éªŒè¯email: å¦‚æœæä¾›ï¼ŒéªŒè¯é‚®ç®±æ ¼å¼
  - éªŒè¯phone: 11ä½ä¸­å›½æ‰‹æœºå·
  - éªŒè¯bio: ä¸è¶…è¿‡500å­—ç¬¦
  - éªŒè¯gender: male/female/other/prefer_not_to_say
  - éªŒè¯location: ä¸è¶…è¿‡100å­—ç¬¦
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š

- [x] **ä»»åŠ¡4.3**: å®ç° `src/core/auth_service.cpp` - `updateUserProfile()` âœ…
  - è°ƒç”¨ `validateProfileUpdateInput()` éªŒè¯è¾“å…¥ âœ…
  - è°ƒç”¨ `userRepository_->findById()` æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ âœ…
  - å¦‚æœä¿®æ”¹äº†emailï¼Œè°ƒç”¨ `emailExistsForOtherUser()` æ£€æŸ¥å”¯ä¸€æ€§ âœ…
  - å¦‚æœä¿®æ”¹äº†phoneï¼Œè°ƒç”¨ `phoneExistsForOtherUser()` æ£€æŸ¥å”¯ä¸€æ€§ âœ…
  - è°ƒç”¨ `userRepository_->updateUserProfile()` æ›´æ–° âœ…
  - æŸ¥è¯¢å¹¶è¿”å›æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯ âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Šå’Œæ—¥å¿— âœ…

- [x] **ä»»åŠ¡4.4**: å®ç° `src/core/auth_service.cpp` - `getUserPublicInfo()` âœ…
  - è°ƒç”¨ `userRepository_->findByUserId()` æŸ¥è¯¢ç”¨æˆ· âœ…
  - è¿”å›ç”¨æˆ·å¯¹è±¡ï¼ˆåªåŒ…å«å…¬å¼€ä¿¡æ¯ï¼‰ âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡4.5**: å®ç° `src/core/auth_service.cpp` - `checkUsernameAvailability()` âœ…
  - éªŒè¯ç”¨æˆ·åæ ¼å¼ âœ…
  - è°ƒç”¨ `userRepository_->usernameExists()` æ£€æŸ¥æ˜¯å¦å­˜åœ¨ âœ…
  - è¿”å›å¯ç”¨æ€§ç»“æœ âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡4.6**: ç¼–è¯‘æµ‹è¯• âœ…
  - æ‰§è¡Œ: `cd build && make` âœ…
  - éªŒè¯: ç¼–è¯‘æ— é”™è¯¯ âœ…

---

### é˜¶æ®µ5ï¼šHandlerå±‚ï¼ˆ2å°æ—¶ï¼‰

- [x] **ä»»åŠ¡5.1**: ä¿®æ”¹ `src/api/auth_handler.h` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `handleGetProfile()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `handleUpdateProfile()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `handleGetUserPublicInfo()` âœ…
  - æ·»åŠ æ–¹æ³•å£°æ˜: `handleCheckUsername()` âœ…

- [x] **ä»»åŠ¡5.2**: å®ç° `src/api/auth_handler.cpp` - `handleGetProfile()` âœ…
  - æå–JWT token
  - éªŒè¯tokenå¹¶è·å–userId
  - è°ƒç”¨ `userRepository_->findById(userId)`
  - æ„é€ JSONå“åº”
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š

- [x] **ä»»åŠ¡5.3**: å®ç° `src/api/auth_handler.cpp` - `handleUpdateProfile()` âœ…
  - æå–JWT token âœ…
  - éªŒè¯tokenå¹¶è·å–userId âœ…
  - è§£æJSONè¯·æ±‚ä½“ âœ…
  - æå–å­—æ®µ: real_name, email, avatar_url, phone, bio, gender, location âœ…
  - è°ƒç”¨ `authService_->updateUserProfile()` âœ…
  - æ„é€ JSONå“åº” âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡5.4**: å®ç° `src/api/auth_handler.cpp` - `handleGetUserPublicInfo()` âœ…
  - ä»è·¯å¾„å‚æ•°æå–user_id âœ…
  - è°ƒç”¨ `authService_->getUserPublicInfo()` âœ…
  - æ„é€ JSONå“åº”ï¼ˆåªåŒ…å«å…¬å¼€å­—æ®µï¼‰ âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡5.5**: å®ç° `src/api/auth_handler.cpp` - `handleCheckUsername()` âœ…
  - ä»æŸ¥è¯¢å‚æ•°æå–username âœ…
  - è°ƒç”¨ `authService_->checkUsernameAvailability()` âœ…
  - æ„é€ JSONå“åº” âœ…
  - æ·»åŠ è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…

- [x] **ä»»åŠ¡5.6**: ä¿®æ”¹ `src/api/auth_handler.cpp` - `registerRoutes()` âœ…
  - æ³¨å†Œè·¯ç”±: `GET /api/v1/users/profile` âœ…
  - æ³¨å†Œè·¯ç”±: `PUT /api/v1/users/profile` âœ…
  - æ³¨å†Œè·¯ç”±: `GET /api/v1/users/:user_id` âœ…
  - æ³¨å†Œè·¯ç”±: `GET /api/v1/users/check-username` âœ…
  - ä¿®å¤è·¯ç”±é¡ºåºå†²çªé—®é¢˜ âœ…

- [x] **ä»»åŠ¡5.7**: ç¼–è¯‘æµ‹è¯• âœ…
  - æ‰§è¡Œ: `cd build && make` âœ…
  - éªŒè¯: ç¼–è¯‘æ— é”™è¯¯ âœ…

---

### é˜¶æ®µ6ï¼šé›†æˆæµ‹è¯•ï¼ˆ1-2å°æ—¶ï¼‰

- [x] **ä»»åŠ¡6.1**: å¯åŠ¨æœåŠ¡å™¨ âœ…
  - æ‰§è¡Œ: `cd backend-service && ./build/knot_image_sharing` âœ…
  - éªŒè¯: æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨ï¼Œç›‘å¬8080ç«¯å£ âœ…

- [x] **ä»»åŠ¡6.2**: æµ‹è¯•ç”¨æˆ·æ³¨å†Œå’Œç™»å½• âœ…
  - æ³¨å†Œæµ‹è¯•ç”¨æˆ· âœ…
  - ç™»å½•è·å–access_token âœ…
  - ä¿å­˜tokenç”¨äºåç»­æµ‹è¯• âœ…

- [x] **ä»»åŠ¡6.3**: æµ‹è¯•è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ âœ…
  - æ‰§è¡Œ: `curl -X GET http://localhost:8080/api/v1/users/profile -H "Authorization: Bearer {token}"` âœ…
  - éªŒè¯: è¿”å›200ï¼ŒåŒ…å«ç”¨æˆ·ä¿¡æ¯ âœ…

- [x] **ä»»åŠ¡6.4**: æµ‹è¯•ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ âœ…
  - æ‰§è¡Œ: `curl -X PUT http://localhost:8080/api/v1/users/profile -H "Authorization: Bearer {token}" -H "Content-Type: application/json" -d '{...}'` âœ…
  - éªŒè¯: è¿”å›200ï¼Œä¿¡æ¯æ›´æ–°æˆåŠŸï¼Œæ–°å­—æ®µ(bioã€genderã€location)æ­£ç¡®ä¿å­˜ âœ…

- [x] **ä»»åŠ¡6.5**: æµ‹è¯•è·å–å…¶ä»–ç”¨æˆ·å…¬å¼€ä¿¡æ¯ âœ…
  - æ‰§è¡Œ: `curl -X GET http://localhost:8080/api/v1/users/{user_id}` âœ…
  - éªŒè¯: è¿”å›200ï¼ŒåªåŒ…å«å…¬å¼€ä¿¡æ¯ âœ…

- [x] **ä»»åŠ¡6.6**: æµ‹è¯•ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥ âœ…
  - æ‰§è¡Œ: `curl -X GET "http://localhost:8080/api/v1/users/check-username?username=test"` âœ…
  - éªŒè¯: è¿”å›200ï¼Œæ­£ç¡®æ˜¾ç¤ºå¯ç”¨æ€§(å·²å­˜åœ¨/å¯ç”¨/æ— æ•ˆæ ¼å¼) âœ…

- [x] **ä»»åŠ¡6.7**: å¼‚å¸¸æµç¨‹æµ‹è¯• âœ…
  - æµ‹è¯•æ— æ•ˆtoken âœ…
  - æµ‹è¯•æ ¼å¼é”™è¯¯çš„è¾“å…¥ âœ…
  - æµ‹è¯•å”¯ä¸€æ€§çº¦æŸå†²çª âœ…
  - éªŒè¯: è¿”å›æ­£ç¡®çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯ âœ…

---

### é˜¶æ®µ7ï¼šæ–‡æ¡£æ›´æ–°ï¼ˆ30åˆ†é’Ÿï¼‰

- [x] **ä»»åŠ¡7.1**: æ›´æ–° `[000]APIæ–‡æ¡£.md` âœ…
  - åœ¨"è®¤è¯ç›¸å…³API"ç« èŠ‚æ·»åŠ 4ä¸ªæ–°æ¥å£ âœ…
  - æ›´æ–°ç‰ˆæœ¬å·ä¸º v2.1.0 âœ…
  - æ›´æ–°ç›®å½• âœ…

- [x] **ä»»åŠ¡7.2**: æ›´æ–° `[101]é˜¶æ®µB-ç”¨æˆ·è®¤è¯æ¨¡å—.md` âœ…
  - æ›´æ–°"å®Œæˆçš„æ¨¡å—"åˆ—è¡¨
  - æ·»åŠ æ–°åŠŸèƒ½è¯´æ˜

- [x] **ä»»åŠ¡7.3**: æ›´æ–° `README.md` âœ…
  - æ›´æ–°åŠŸèƒ½åˆ—è¡¨

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] æ‰€æœ‰4ä¸ªAPIæ¥å£æ­£å¸¸å·¥ä½œ âœ…
- [x] JWTè®¤è¯æ­£ç¡®å®æ–½ âœ…
- [x] è¾“å…¥éªŒè¯æ­£ç¡®æ‰§è¡Œ âœ…
- [x] å”¯ä¸€æ€§çº¦æŸæ­£ç¡®æ£€æŸ¥ âœ…
- [x] é”™è¯¯å¤„ç†å®Œå–„ âœ…
- [x] å“åº”æ ¼å¼ç»Ÿä¸€ âœ…

### ä»£ç è´¨é‡éªŒæ”¶
- [x] ç¬¦åˆä¹å±‚æ¶æ„è§„èŒƒ âœ…
- [x] è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š âœ…
- [x] ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥ âœ…
- [x] ä½¿ç”¨ConnectionGuard âœ…
- [x] ç»Ÿä¸€çš„é”™è¯¯å¤„ç† âœ…
- [x] æ— å†…å­˜æ³„æ¼ âœ…

### æµ‹è¯•éªŒæ”¶
- [x] æ‰€æœ‰é›†æˆæµ‹è¯•é€šè¿‡ âœ…
- [x] å¼‚å¸¸æµç¨‹æµ‹è¯•é€šè¿‡ âœ…

### æ–‡æ¡£éªŒæ”¶
- [x] APIæ–‡æ¡£æ›´æ–°å®Œæ•´ âœ…
- [ ] æ¶æ„æ–‡æ¡£æ›´æ–° â³
- [ ] READMEæ›´æ–° â³

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

| é˜¶æ®µ | ä»»åŠ¡æ•° | å·²å®Œæˆ | è¿›åº¦ |
|------|--------|--------|------|
| é˜¶æ®µ1ï¼šæ•°æ®åº“å˜æ›´ | 2 | 2 | 100% âœ… |
| é˜¶æ®µ2ï¼šModelå±‚ | 3 | 3 | 100% âœ… |
| é˜¶æ®µ3ï¼šRepositoryå±‚ | 5 | 5 | 100% âœ… |
| é˜¶æ®µ4ï¼šServiceå±‚ | 6 | 6 | 100% âœ… |
| é˜¶æ®µ5ï¼šHandlerå±‚ | 7 | 7 | 100% âœ… |
| é˜¶æ®µ6ï¼šé›†æˆæµ‹è¯• | 7 | 7 | 100% âœ… |
| é˜¶æ®µ7ï¼šæ–‡æ¡£æ›´æ–° | 3 | 3 | 100% âœ… |
| **æ€»è®¡** | **33** | **33** | **100%** |

---

## ğŸ› å½“å‰é—®é¢˜è®°å½•

### é—®é¢˜1ï¼šæœåŠ¡å™¨APIè¯·æ±‚æ— å“åº”

**å‘ç°æ—¶é—´**: 2025-10-09 21:34

**é—®é¢˜æè¿°**:
æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å¯åŠ¨å¹¶ç›‘å¬8080ç«¯å£ï¼Œä½†æ‰€æœ‰APIè¯·æ±‚ï¼ˆåŒ…æ‹¬åŸæœ‰çš„æ³¨å†Œã€ç™»å½•æ¥å£ï¼‰éƒ½è¿”å›"Empty reply from server"é”™è¯¯ï¼ŒæœåŠ¡å™¨è¿›ç¨‹éšåå´©æºƒã€‚

**å¤ç°æ­¥éª¤**:
1. ç¼–è¯‘é¡¹ç›®ï¼š`cd build && make -j4`ï¼ˆç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯ï¼‰
2. å¯åŠ¨æœåŠ¡å™¨ï¼š`LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH ./knot_image_sharing ../config/config.json`
3. æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—æ­£å¸¸ï¼Œæ˜¾ç¤ºï¼š
   ```
   [2025-10-09 21:34:06.883] [info] [thread 42444] Auth routes registered
   [2025-10-09 21:34:06.883] [info] [thread 42444] Starting HTTP server...
   ```
4. å‘é€æµ‹è¯•è¯·æ±‚ï¼š
   ```bash
   curl -X POST http://localhost:8080/api/v1/auth/register \
     -H "Content-Type: application/json" \
     -d '{"username":"test123","password":"Test123456","real_name":"æµ‹è¯•","phone":"13800138002","email":"test@test.com"}'
   ```
5. ç»“æœï¼š`curl: (52) Empty reply from server`
6. æœåŠ¡å™¨è¿›ç¨‹å´©æºƒï¼ˆreturn code: -1ï¼‰

**é¢„æœŸç»“æœ**:
åº”è¯¥è¿”å›JSONå“åº”ï¼Œä¾‹å¦‚ï¼š
```json
{
  "success": true,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "user_id": "USR_2025Q1_XXX",
    "username": "test123",
    ...
  }
}
```

**å¯èƒ½åŸå› åˆ†æ**:

1. **æ•°æ®åº“æŸ¥è¯¢é—®é¢˜**ï¼š
   - æ–°æ·»åŠ çš„å­—æ®µï¼ˆbio, gender, locationï¼‰åœ¨æŸ¥è¯¢æ—¶å¯èƒ½å¯¼è‡´NULLå€¼å¤„ç†é”™è¯¯
   - Repositoryå±‚çš„`findById`æˆ–`findByUserId`æ–¹æ³•å¯èƒ½éœ€è¦æ›´æ–°ä»¥å¤„ç†æ–°å­—æ®µ
   - å»ºè®®æ£€æŸ¥ï¼š`src/database/user_repository.cpp`ä¸­çš„æŸ¥è¯¢ç»“æœç»‘å®šéƒ¨åˆ†

2. **JSONåºåˆ—åŒ–é—®é¢˜**ï¼š
   - Useræ¨¡å‹çš„`toJson()`æ–¹æ³•å·²æ›´æ–°åŒ…å«æ–°å­—æ®µ
   - ä½†å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ï¼ˆå¦‚å­—æ®µä¸ºç©ºï¼‰å¯¼è‡´åºåˆ—åŒ–å¤±è´¥
   - å»ºè®®æ£€æŸ¥ï¼š`src/models/user.cpp`çš„`toJson()`æ–¹æ³•

3. **å†…å­˜è®¿é—®é—®é¢˜**ï¼š
   - å¯èƒ½å­˜åœ¨æœªåˆå§‹åŒ–çš„æŒ‡é’ˆæˆ–è¶Šç•Œè®¿é—®
   - å»ºè®®ä½¿ç”¨gdbè°ƒè¯•ï¼š`gdb ./knot_image_sharing`

4. **è·¯ç”±å†²çª**ï¼š
   - æ–°æ·»åŠ çš„è·¯ç”±å¯èƒ½ä¸ç°æœ‰è·¯ç”±å†²çª
   - ç‰¹åˆ«æ˜¯`GET /api/v1/users/:user_id`ä½¿ç”¨äº†æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
   - å»ºè®®æ£€æŸ¥ï¼š`src/api/auth_handler.cpp`çš„`registerRoutes()`æ–¹æ³•

**è°ƒè¯•å»ºè®®**:

1. **æ·»åŠ æ›´å¤šæ—¥å¿—**ï¼š
   ```cpp
   // åœ¨Handleræ–¹æ³•å¼€å§‹å¤„æ·»åŠ 
   Logger::info("è¿›å…¥handleRegisteræ–¹æ³•");
   Logger::info("è¯·æ±‚ä½“: " + req.body);
   ```

2. **ä½¿ç”¨gdbè°ƒè¯•**ï¼š
   ```bash
   gdb ./knot_image_sharing
   (gdb) run ../config/config.json
   # åœ¨å¦ä¸€ä¸ªç»ˆç«¯å‘é€è¯·æ±‚
   # æŸ¥çœ‹å´©æºƒä½ç½®
   (gdb) bt
   ```

3. **æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢**ï¼š
   - åœ¨`user_repository.cpp`çš„æŸ¥è¯¢æ–¹æ³•ä¸­æ·»åŠ æ—¥å¿—
   - éªŒè¯æ–°å­—æ®µçš„NULLå€¼å¤„ç†æ˜¯å¦æ­£ç¡®

4. **ç®€åŒ–æµ‹è¯•**ï¼š
   - å…ˆæµ‹è¯•ä¸æ¶‰åŠæ–°å­—æ®µçš„APIï¼ˆå¦‚ç™»å½•ï¼‰
   - å¦‚æœç™»å½•ä¹Ÿå¤±è´¥ï¼Œè¯´æ˜é—®é¢˜ä¸åœ¨æ–°å­—æ®µ
   - å¦‚æœç™»å½•æˆåŠŸï¼Œé€æ­¥æµ‹è¯•æ–°API

**ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**:
å¦‚æœé—®é¢˜éš¾ä»¥å®šä½ï¼Œå¯ä»¥è€ƒè™‘ï¼š
1. å›æ»šåˆ°æ·»åŠ æ–°å­—æ®µä¹‹å‰çš„ç‰ˆæœ¬
2. é€æ­¥æ·»åŠ åŠŸèƒ½ï¼Œæ¯æ¬¡æ·»åŠ åæµ‹è¯•
3. ä½¿ç”¨git bisectå®šä½å¼•å…¥é—®é¢˜çš„æäº¤

**çŠ¶æ€**: âœ… å·²è§£å†³

**è§£å†³æ—¶é—´**: 2025-10-09 22:10

**è§£å†³æ–¹æ³•**:
ä¿®å¤äº†`src/database/user_repository.cpp`ä¸­`buildUserFromStatement`æ–¹æ³•çš„å­—æ®µç»‘å®šé—®é¢˜ã€‚

**å…·ä½“ä¿®æ”¹**:
1. å°†`MYSQL_BIND result[14]`æ‰©å±•ä¸º`MYSQL_BIND result[17]`
2. æ·»åŠ bioã€genderã€locationä¸‰ä¸ªå­—æ®µçš„å˜é‡å£°æ˜:
   ```cpp
   char bio[501] = {0};
   char gender[25] = {0};
   char location[101] = {0};
   ```
3. æ·»åŠ å¯¹åº”çš„é•¿åº¦å˜é‡å’ŒNULLæ ‡å¿—å˜é‡:
   ```cpp
   unsigned long bio_length, gender_length, location_length;
   bool bio_is_null, gender_is_null, location_is_null;
   ```
4. åœ¨resultæ•°ç»„ä¸­æ·»åŠ bio(result[11])ã€gender(result[12])ã€location(result[13])çš„ç»‘å®š
5. å°†device_countã€create_timeã€update_timeçš„ç´¢å¼•ä»[11][12][13]è°ƒæ•´ä¸º[14][15][16]
6. åœ¨fetchåæ·»åŠ bioã€genderã€locationå­—æ®µçš„å€¼è®¾ç½®:
   ```cpp
   if (!bio_is_null) {
       user.setBio(std::string(bio, bio_length));
   }
   if (!gender_is_null) {
       user.setGender(std::string(gender, gender_length));
   }
   if (!location_is_null) {
       user.setLocation(std::string(location, location_length));
   }
   ```

**ä¿®æ”¹æ–‡ä»¶**: `backend-service/src/database/user_repository.cpp` (ç¬¬157-327è¡Œ)

**éªŒè¯ç»“æœ**:
- âœ… ç¼–è¯‘æˆåŠŸæ— é”™è¯¯
- âœ… æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨
- âœ… ç”¨æˆ·æ³¨å†Œæ¥å£æ­£å¸¸å·¥ä½œ
- âœ… ç”¨æˆ·ç™»å½•æ¥å£æ­£å¸¸å·¥ä½œ
- âœ… è·å–ç”¨æˆ·ä¿¡æ¯æ¥å£æ­£å¸¸å·¥ä½œ
- âœ… æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ¥å£æ­£å¸¸å·¥ä½œï¼Œæ–°å­—æ®µ(bioã€genderã€location)æ­£ç¡®è¯»å†™

**æµ‹è¯•ç”¨ä¾‹**:
```bash
# æ³¨å†Œç”¨æˆ·
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser001","password":"Test123456","real_name":"æµ‹è¯•ç”¨æˆ·001","phone":"13900000099","email":"test001@example.com"}'

# ç™»å½•
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser001","password":"Test123456"}'

# æ›´æ–°ç”¨æˆ·ä¿¡æ¯(åŒ…å«æ–°å­—æ®µ)
curl -X PUT http://localhost:8080/api/v1/users/profile \
  -H "Authorization: Bearer {TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"real_name":"æµ‹è¯•ç”¨æˆ·001æ›´æ–°","email":"test001@example.com","phone":"13900000099","bio":"è¿™æ˜¯æˆ‘çš„ä¸ªäººç®€ä»‹","gender":"male","location":"åŒ—äº¬"}'
```

**æ ¹æœ¬åŸå› åˆ†æ**:
æ•°æ®åº“è¡¨userså¢åŠ äº†3ä¸ªæ–°å­—æ®µ(bioã€genderã€location),ä½†`buildUserFromStatement`æ–¹æ³•çš„MYSQL_BINDæ•°ç»„å¤§å°æœªåŒæ­¥æ›´æ–°,å¯¼è‡´`SELECT * FROM users`æŸ¥è¯¢è¿”å›17ä¸ªå­—æ®µæ—¶,åªç»‘å®šäº†14ä¸ªæ§½ä½,é€ æˆå†…å­˜è®¿é—®è¶Šç•Œ,æœåŠ¡å™¨å´©æºƒã€‚

---

## ğŸ“ å˜æ›´æ—¥å¿—

### 2025-10-09 22:15 - Bugä¿®å¤ä¸æµ‹è¯•å®Œæˆ

**ä¿®å¤å†…å®¹**:
- ä¿®å¤äº†`buildUserFromStatement`æ–¹æ³•çš„å­—æ®µç»‘å®šbug (user_repository.cpp:157-327)
- è§£å†³äº†æœåŠ¡å™¨APIè¯·æ±‚å¯¼è‡´å´©æºƒçš„é—®é¢˜

**æµ‹è¯•å®Œæˆ**:
- âœ… ä»»åŠ¡6.1: æœåŠ¡å™¨å¯åŠ¨æµ‹è¯•é€šè¿‡
- âœ… ä»»åŠ¡6.2: ç”¨æˆ·æ³¨å†Œå’Œç™»å½•æµ‹è¯•é€šè¿‡
- âœ… ä»»åŠ¡6.3: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æµ‹è¯•é€šè¿‡
- âœ… ä»»åŠ¡6.4: ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯æµ‹è¯•é€šè¿‡(åŒ…æ‹¬æ–°å­—æ®µ)

**å¾…å®Œæˆ**:
- â³ ä»»åŠ¡6.5: è·å–å…¶ä»–ç”¨æˆ·å…¬å¼€ä¿¡æ¯
- â³ ä»»åŠ¡6.6: ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥
- â³ ä»»åŠ¡6.7: å¼‚å¸¸æµç¨‹æµ‹è¯•
- â³ é˜¶æ®µ7: æ–‡æ¡£æ›´æ–°(3ä¸ªä»»åŠ¡)

**å½“å‰è¿›åº¦**: 82% (27/33ä»»åŠ¡å®Œæˆ)

---

### 2025-10-09 22:35 - è·¯ç”±ä¿®å¤ä¸å…¨éƒ¨æµ‹è¯•å®Œæˆ

**ä¿®å¤å†…å®¹**:
- ä¿®å¤è·¯ç”±å†²çªé—®é¢˜:è°ƒæ•´è·¯ç”±æ³¨å†Œé¡ºåº,å°†`check-username`æ”¾åœ¨æ­£åˆ™åŒ¹é…è·¯ç”±`/users/([^/]+)`ä¹‹å‰
- ä¿®æ”¹æ–‡ä»¶: `src/api/auth_handler.cpp` (ç¬¬68-76è¡Œ)
- åŸå› : æ­£åˆ™è¡¨è¾¾å¼è·¯ç”±ä¼šåŒ¹é…æ‰€æœ‰`/users/xxx`æ ¼å¼çš„URL,å¯¼è‡´`check-username`è¢«è¯¯åŒ¹é…

**æµ‹è¯•å®Œæˆ**:
- âœ… ä»»åŠ¡6.5: è·å–å…¶ä»–ç”¨æˆ·å…¬å¼€ä¿¡æ¯æµ‹è¯•é€šè¿‡
- âœ… ä»»åŠ¡6.6: ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥æµ‹è¯•é€šè¿‡
  - æµ‹è¯•ç”¨æˆ·åå·²å­˜åœ¨: è¿”å›available=false âœ…
  - æµ‹è¯•ç”¨æˆ·åå¯ç”¨: è¿”å›available=true âœ…
  - æµ‹è¯•æ— æ•ˆæ ¼å¼: è¿”å›valid=false âœ…
- âœ… ä»»åŠ¡6.7: å¼‚å¸¸æµç¨‹æµ‹è¯•é€šè¿‡
  - æ— æ•ˆtokenæµ‹è¯• âœ…
  - æ ¼å¼é”™è¯¯è¾“å…¥æµ‹è¯• âœ…
  - å”¯ä¸€æ€§çº¦æŸå†²çªæµ‹è¯• âœ…

**æ–‡æ¡£æ›´æ–°å®Œæˆ**:
- âœ… ä»»åŠ¡7.1: [000]APIæ–‡æ¡£æ›´æ–°å®Œæˆ
  - ç‰ˆæœ¬å·æ›´æ–°ä¸º v2.1.0
  - ç›®å½•æ·»åŠ 4ä¸ªæ–°æ¥å£é“¾æ¥
  - æ·»åŠ 4ä¸ªæ–°æ¥å£å®Œæ•´æ–‡æ¡£(è¯·æ±‚/å“åº”/é”™è¯¯ç è¯´æ˜)

**å½“å‰è¿›åº¦**: 94% (31/33ä»»åŠ¡å®Œæˆ)

**å¾…å®Œæˆä»»åŠ¡**:
- â³ ä»»åŠ¡7.2: æ›´æ–°[101]é˜¶æ®µB-ç”¨æˆ·è®¤è¯æ¨¡å—.md
- â³ ä»»åŠ¡7.3: æ›´æ–°README.md

---

### 2025-10-09 22:40 - æ‰€æœ‰æ–‡æ¡£æ›´æ–°å®Œæˆ ğŸ‰

**æ–‡æ¡£æ›´æ–°å®Œæˆ**:
- âœ… ä»»åŠ¡7.2: æ›´æ–°[101]é˜¶æ®µB-ç”¨æˆ·è®¤è¯æ¨¡å—.mdå®Œæˆ
  - ç‰ˆæœ¬å·æ›´æ–°ä¸º v2.1.0
  - åœ¨"å®Œæˆçš„æ¨¡å—"è¡¨æ ¼ä¸­æ·»åŠ ç”¨æˆ·ä¿¡æ¯ç®¡ç†æ¨¡å—
  - åœ¨"APIæ¥å£"ç« èŠ‚æ·»åŠ 4ä¸ªæ–°æ¥å£æ–‡æ¡£
  - åœ¨"å®Œæˆæ€»ç»“"ä¸­æ·»åŠ v2.1.0æ–°å¢åŠŸèƒ½è¯´æ˜
  - æ›´æ–°æ–‡æ¡£ç»´æŠ¤è€…ä¸ºKnot Development Team

- âœ… ä»»åŠ¡7.3: æ›´æ–°README.mdå®Œæˆ
  - ç‰ˆæœ¬å·æ›´æ–°ä¸º v2.1.0
  - åœ¨"æ ¸å¿ƒåŠŸèƒ½"ä¸­æ·»åŠ ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŠŸèƒ½è¯´æ˜
  - åœ¨"APIæ–‡æ¡£"ä¸­æ·»åŠ ç”¨æˆ·ä¿¡æ¯ç®¡ç†æ¥å£è¡¨æ ¼
  - åœ¨"é¡¹ç›®è¿›åº¦-é˜¶æ®µB"ä¸­æ·»åŠ v2.1.0æ–°å¢åŠŸèƒ½æ¸…å•

**ğŸ‰ é¡¹ç›®å®Œæˆ**: 100% (33/33ä»»åŠ¡å…¨éƒ¨å®Œæˆ)

**åŠŸèƒ½å®ç°æƒ…å†µ**:
- âœ… è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ (GET /api/v1/users/profile)
- âœ… ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ (PUT /api/v1/users/profile)
- âœ… è·å–å…¶ä»–ç”¨æˆ·å…¬å¼€ä¿¡æ¯ (GET /api/v1/users/:user_id)
- âœ… ç”¨æˆ·åå¯ç”¨æ€§æ£€æŸ¥ (GET /api/v1/users/check-username)

**æ•°æ®åº“å˜æ›´**:
- âœ… bioå­—æ®µ (ä¸ªäººç®€ä»‹)
- âœ… genderå­—æ®µ (æ€§åˆ«)
- âœ… locationå­—æ®µ (æ‰€åœ¨åœ°)

**Bugä¿®å¤**:
- âœ… MYSQL_BINDæ•°ç»„å¤§å°ä¸åŒ¹é…é—®é¢˜
- âœ… è·¯ç”±å†²çªé—®é¢˜

---

## ğŸ¯ é˜¶æ®µ8ï¼šç”¨æˆ·å¤´åƒä¸Šä¼ åŠŸèƒ½ï¼ˆv2.5.0ï¼‰

### åŠŸèƒ½éœ€æ±‚åˆ†æ

#### ä¸šåŠ¡éœ€æ±‚
- ç”¨æˆ·å¯ä»¥ä¸Šä¼ è‡ªå®šä¹‰å¤´åƒå›¾ç‰‡
- ç³»ç»Ÿè‡ªåŠ¨å‹ç¼©å’Œè£å‰ªä¸ºæ ‡å‡†å°ºå¯¸ï¼ˆ200x200ï¼‰
- è‡ªåŠ¨åˆ é™¤æ—§å¤´åƒæ–‡ä»¶ï¼ˆèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
- è¿”å›å¸¦æœåŠ¡å™¨URLå‰ç¼€çš„å®Œæ•´å¤´åƒè·¯å¾„
- æ”¯æŒå¸¸è§å›¾ç‰‡æ ¼å¼ï¼ˆJPEGã€PNGã€GIFã€WebPï¼‰

#### æŠ€æœ¯éœ€æ±‚
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼šæœ€å¤§5MB
- å›¾ç‰‡å°ºå¯¸ï¼šè‡ªåŠ¨è£å‰ªä¸º200x200æ­£æ–¹å½¢
- å­˜å‚¨è·¯å¾„ï¼š`/uploads/avatars/USER_ID_timestamp.jpg`
- å‹ç¼©è´¨é‡ï¼šJPEG 80%
- æ”¯æŒæ ¼å¼ï¼šimage/jpeg, image/png, image/gif, image/webp

#### APIè®¾è®¡

**æ¥å£**: `POST /api/v1/users/avatar`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| avatar | File | æ˜¯ | å¤´åƒå›¾ç‰‡æ–‡ä»¶ |

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1728912345.jpg",
    "file_size": 45678,
    "width": 200,
    "height": 200
  },
  "timestamp": 1728912345
}
```

**é”™è¯¯å“åº”**:
- 400: æœªæä¾›æ–‡ä»¶ã€æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€æ–‡ä»¶è¿‡å¤§
- 401: æœªæˆæƒï¼ˆtokenæ— æ•ˆæˆ–è¿‡æœŸï¼‰
- 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯

---

### é˜¶æ®µ8.1ï¼šå·¥å…·å±‚å¢å¼ºï¼ˆ1å°æ—¶ï¼‰

#### ä»»åŠ¡8.1.1: åˆ›å»º `src/utils/avatar_processor.h`

**åŠŸèƒ½**: ä¸“é—¨å¤„ç†å¤´åƒçš„å·¥å…·ç±»ï¼ˆåŸºäºImageProcessorï¼‰

**ç±»å®šä¹‰**:
```cpp
/**
 * @brief å¤´åƒå¤„ç†ç»“æœç»“æ„ä½“
 */
struct AvatarProcessResult {
    bool success;              // å¤„ç†æ˜¯å¦æˆåŠŸ
    std::string message;       // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
    std::string avatarPath;    // å¤´åƒè·¯å¾„
    int width;                 // å›¾ç‰‡å®½åº¦ï¼ˆå›ºå®š200ï¼‰
    int height;                // å›¾ç‰‡é«˜åº¦ï¼ˆå›ºå®š200ï¼‰
    long long fileSize;        // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    
    AvatarProcessResult() : success(false), width(0), height(0), fileSize(0) {}
};

/**
 * @brief å¤´åƒå¤„ç†å·¥å…·ç±»
 * 
 * ä¸“é—¨ç”¨äºå¤„ç†ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼ŒåŒ…æ‹¬è£å‰ªã€å‹ç¼©ã€ä¿å­˜
 */
class AvatarProcessor {
public:
    /**
     * @brief å¤„ç†å¤´åƒå›¾ç‰‡ï¼ˆè£å‰ªä¸ºæ­£æ–¹å½¢ + å‹ç¼©ï¼‰
     * 
     * @param inputPath è¾“å…¥å›¾ç‰‡è·¯å¾„ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰
     * @param userId ç”¨æˆ·IDï¼ˆç”¨äºç”Ÿæˆæ–‡ä»¶åï¼‰
     * @param outputDir è¾“å‡ºç›®å½•ï¼ˆä¾‹ï¼šuploads/avatars/ï¼‰
     * @return AvatarProcessResult å¤„ç†ç»“æœ
     */
    static AvatarProcessResult processAvatar(
        const std::string& inputPath,
        const std::string& userId,
        const std::string& outputDir
    );
    
    /**
     * @brief åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
     * 
     * @param avatarUrl æ—§å¤´åƒURLï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
     * @return bool æˆåŠŸè¿”å›true
     */
    static bool deleteOldAvatar(const std::string& avatarUrl);
    
    /**
     * @brief éªŒè¯å¤´åƒæ–‡ä»¶æ ¼å¼å’Œå¤§å°
     * 
     * @param filePath æ–‡ä»¶è·¯å¾„
     * @param maxSize æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
     * @return std::pair<bool, std::string> {æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯ä¿¡æ¯}
     */
    static std::pair<bool, std::string> validateAvatarFile(
        const std::string& filePath,
        long long maxSize = 5 * 1024 * 1024
    );

private:
    static constexpr int AVATAR_SIZE = 200;        // å¤´åƒå°ºå¯¸ï¼ˆ200x200ï¼‰
    static constexpr int JPEG_QUALITY = 80;        // JPEGå‹ç¼©è´¨é‡
    static constexpr long long MAX_FILE_SIZE = 5 * 1024 * 1024;  // 5MB
    
    /**
     * @brief è£å‰ªå›¾ç‰‡ä¸ºæ­£æ–¹å½¢ï¼ˆå±…ä¸­è£å‰ªï¼‰
     * 
     * @param inputData è¾“å…¥å›¾ç‰‡æ•°æ®
     * @param width åŸå›¾å®½åº¦
     * @param height åŸå›¾é«˜åº¦
     * @param channels é€šé“æ•°
     * @return unsigned char* è£å‰ªåçš„å›¾ç‰‡æ•°æ®ï¼ˆéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼‰
     */
    static unsigned char* cropToSquare(
        unsigned char* inputData,
        int width,
        int height,
        int channels,
        int& outSize
    );
};
```

**å®ç°è¦ç‚¹**:
1. ä½¿ç”¨stb_imageåŠ è½½å›¾ç‰‡
2. å¦‚æœä¸æ˜¯æ­£æ–¹å½¢ï¼Œå±…ä¸­è£å‰ªä¸ºæ­£æ–¹å½¢
3. ä½¿ç”¨stb_image_resizeç¼©æ”¾åˆ°200x200
4. ä½¿ç”¨stb_image_writeä¿å­˜ä¸ºJPEGï¼ˆ80%è´¨é‡ï¼‰
5. æ–‡ä»¶å‘½åæ ¼å¼ï¼š`USER_ID_timestamp.jpg`

---

#### ä»»åŠ¡8.1.2: å®ç° `src/utils/avatar_processor.cpp`

**æ ¸å¿ƒé€»è¾‘**:

```cpp
AvatarProcessResult AvatarProcessor::processAvatar(
    const std::string& inputPath,
    const std::string& userId,
    const std::string& outputDir
) {
    AvatarProcessResult result;
    
    try {
        // 1. éªŒè¯æ–‡ä»¶
        auto [valid, errorMsg] = validateAvatarFile(inputPath);
        if (!valid) {
            result.message = errorMsg;
            return result;
        }
        
        // 2. åŠ è½½å›¾ç‰‡
        int width, height, channels;
        unsigned char* data = stbi_load(inputPath.c_str(), &width, &height, &channels, 0);
        if (!data) {
            result.message = "æ— æ³•åŠ è½½å›¾ç‰‡";
            return result;
        }
        
        // 3. è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
        int squareSize = std::min(width, height);
        unsigned char* squareData = cropToSquare(data, width, height, channels, squareSize);
        stbi_image_free(data);
        
        // 4. ç¼©æ”¾åˆ°200x200
        unsigned char* resizedData = (unsigned char*)malloc(AVATAR_SIZE * AVATAR_SIZE * channels);
        stbir_resize_uint8_linear(
            squareData, squareSize, squareSize, 0,
            resizedData, AVATAR_SIZE, AVATAR_SIZE, 0,
            (stbir_pixel_layout)channels
        );
        free(squareData);
        
        // 5. ç”Ÿæˆæ–‡ä»¶åï¼šUSER_ID_timestamp.jpg
        std::string timestamp = std::to_string(std::time(nullptr));
        std::string filename = userId + "_" + timestamp + ".jpg";
        std::string outputPath = outputDir + filename;
        
        // 6. ä¿å­˜ä¸ºJPEG
        int saveResult = stbi_write_jpg(
            outputPath.c_str(),
            AVATAR_SIZE,
            AVATAR_SIZE,
            channels,
            resizedData,
            JPEG_QUALITY
        );
        free(resizedData);
        
        if (!saveResult) {
            result.message = "æ— æ³•ä¿å­˜å¤´åƒ";
            return result;
        }
        
        // 7. æ„å»ºç»“æœ
        result.success = true;
        result.avatarPath = "/uploads/avatars/" + filename;
        result.width = AVATAR_SIZE;
        result.height = AVATAR_SIZE;
        result.fileSize = ImageProcessor::getFileSize(outputPath);
        
        Logger::info("Avatar processed successfully for user: " + userId);
        return result;
        
    } catch (const std::exception& e) {
        result.message = "å¤„ç†å¤´åƒæ—¶å‘ç”Ÿå¼‚å¸¸: " + std::string(e.what());
        Logger::error(result.message);
        return result;
    }
}

bool AvatarProcessor::deleteOldAvatar(const std::string& avatarUrl) {
    if (avatarUrl.empty() || avatarUrl.find("/uploads/avatars/") == std::string::npos) {
        return false;  // ä¸æ˜¯æœ‰æ•ˆçš„å¤´åƒè·¯å¾„
    }
    
    // æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„
    std::string filePath = "." + avatarUrl;  // ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•
    
    // åˆ é™¤æ–‡ä»¶
    if (std::remove(filePath.c_str()) == 0) {
        Logger::info("Old avatar deleted: " + avatarUrl);
        return true;
    } else {
        Logger::warning("Failed to delete old avatar: " + avatarUrl);
        return false;
    }
}

std::pair<bool, std::string> AvatarProcessor::validateAvatarFile(
    const std::string& filePath,
    long long maxSize
) {
    // 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    struct stat st;
    if (stat(filePath.c_str(), &st) != 0) {
        return {false, "æ–‡ä»¶ä¸å­˜åœ¨"};
    }
    
    // 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
    if (st.st_size > maxSize) {
        return {false, "æ–‡ä»¶å¤§å°è¶…è¿‡5MBé™åˆ¶"};
    }
    
    // 3. æ£€æŸ¥æ–‡ä»¶æ ¼å¼
    if (!ImageProcessor::validateFormat(filePath)) {
        return {false, "ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼"};
    }
    
    return {true, ""};
}

unsigned char* AvatarProcessor::cropToSquare(
    unsigned char* inputData,
    int width,
    int height,
    int channels,
    int& outSize
) {
    int squareSize = std::min(width, height);
    outSize = squareSize;
    
    // è®¡ç®—è£å‰ªèµ·å§‹ä½ç½®ï¼ˆå±…ä¸­ï¼‰
    int startX = (width - squareSize) / 2;
    int startY = (height - squareSize) / 2;
    
    // åˆ†é…è¾“å‡ºç¼“å†²åŒº
    unsigned char* output = (unsigned char*)malloc(squareSize * squareSize * channels);
    
    // å¤åˆ¶åƒç´ æ•°æ®
    for (int y = 0; y < squareSize; y++) {
        for (int x = 0; x < squareSize; x++) {
            int srcIdx = ((startY + y) * width + (startX + x)) * channels;
            int dstIdx = (y * squareSize + x) * channels;
            for (int c = 0; c < channels; c++) {
                output[dstIdx + c] = inputData[srcIdx + c];
            }
        }
    }
    
    return output;
}
```

---

### é˜¶æ®µ8.2ï¼šServiceå±‚ï¼ˆ1.5å°æ—¶ï¼‰

#### ä»»åŠ¡8.2.1: ä¿®æ”¹ `src/core/auth_service.h`

**æ·»åŠ ç»“æ„ä½“**:
```cpp
/**
 * @brief å¤´åƒä¸Šä¼ ç»“æœ
 */
struct UploadAvatarResult {
    bool success = false;
    std::string message;
    std::string avatarUrl;      // å¤´åƒURLï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
    long long fileSize = 0;
    int width = 0;
    int height = 0;
};
```

**æ·»åŠ æ–¹æ³•å£°æ˜**:
```cpp
/**
 * @brief ä¸Šä¼ ç”¨æˆ·å¤´åƒ
 * 
 * @param userId ç”¨æˆ·ID
 * @param tempFilePath ä¸´æ—¶æ–‡ä»¶è·¯å¾„
 * @return UploadAvatarResult ä¸Šä¼ ç»“æœ
 */
UploadAvatarResult uploadAvatar(int userId, const std::string& tempFilePath);
```

---

#### ä»»åŠ¡8.2.2: å®ç° `src/core/auth_service.cpp` - `uploadAvatar()`

```cpp
UploadAvatarResult AuthService::uploadAvatar(int userId, const std::string& tempFilePath) {
    UploadAvatarResult result;
    
    try {
        Logger::info("Uploading avatar for user ID: " + std::to_string(userId));
        
        // 1. éªŒè¯ç”¨æˆ·å­˜åœ¨
        auto existingUser = userRepo_->findById(userId);
        if (!existingUser.has_value()) {
            result.message = "ç”¨æˆ·ä¸å­˜åœ¨";
            Logger::warning(result.message);
            return result;
        }
        
        // 2. è·å–ç”¨æˆ·çš„user_idï¼ˆç”¨äºæ–‡ä»¶å‘½åï¼‰
        std::string userIdStr = existingUser->getUserId();
        
        // 3. å¤„ç†å¤´åƒå›¾ç‰‡
        std::string avatarDir = "uploads/avatars/";
        auto processResult = AvatarProcessor::processAvatar(tempFilePath, userIdStr, avatarDir);
        
        if (!processResult.success) {
            result.message = processResult.message;
            Logger::error("Failed to process avatar: " + result.message);
            return result;
        }
        
        // 4. åˆ é™¤æ—§å¤´åƒï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        std::string oldAvatarUrl = existingUser->getAvatarUrl();
        if (!oldAvatarUrl.empty()) {
            AvatarProcessor::deleteOldAvatar(oldAvatarUrl);
        }
        
        // 5. æ›´æ–°æ•°æ®åº“ä¸­çš„avatar_url
        bool updateSuccess = userRepo_->updateAvatarUrl(userId, processResult.avatarPath);
        if (!updateSuccess) {
            result.message = "æ›´æ–°æ•°æ®åº“å¤±è´¥";
            Logger::error(result.message);
            // åˆ é™¤åˆšä¸Šä¼ çš„å¤´åƒæ–‡ä»¶
            AvatarProcessor::deleteOldAvatar(processResult.avatarPath);
            return result;
        }
        
        // 6. åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        std::remove(tempFilePath.c_str());
        
        // 7. æ„å»ºæˆåŠŸç»“æœ
        result.success = true;
        result.message = "å¤´åƒä¸Šä¼ æˆåŠŸ";
        result.avatarUrl = processResult.avatarPath;
        result.fileSize = processResult.fileSize;
        result.width = processResult.width;
        result.height = processResult.height;
        
        Logger::info("Avatar uploaded successfully for user: " + userIdStr);
        return result;
        
    } catch (const std::exception& e) {
        result.message = "ä¸Šä¼ å¤´åƒæ—¶å‘ç”Ÿå¼‚å¸¸: " + std::string(e.what());
        Logger::error(result.message);
        return result;
    }
}
```

---

### é˜¶æ®µ8.3ï¼šRepositoryå±‚ï¼ˆ30åˆ†é’Ÿï¼‰

#### ä»»åŠ¡8.3.1: ä¿®æ”¹ `src/database/user_repository.h`

**æ·»åŠ æ–¹æ³•å£°æ˜**:
```cpp
/**
 * @brief æ›´æ–°ç”¨æˆ·å¤´åƒURL
 * 
 * @param userId ç”¨æˆ·æ•°æ®åº“ID
 * @param avatarUrl æ–°çš„å¤´åƒURL
 * @return bool æˆåŠŸè¿”å›true
 */
bool updateAvatarUrl(int userId, const std::string& avatarUrl);
```

---

#### ä»»åŠ¡8.3.2: å®ç° `src/database/user_repository.cpp` - `updateAvatarUrl()`

```cpp
bool UserRepository::updateAvatarUrl(int userId, const std::string& avatarUrl) {
    // ä½¿ç”¨ConnectionGuardè·å–æ•°æ®åº“è¿æ¥
    ConnectionGuard connGuard(pool_);
    if (!connGuard.isValid()) {
        Logger::error("Failed to get database connection");
        return false;
    }
    
    MYSQL* conn = connGuard.get();
    
    // å‡†å¤‡SQLè¯­å¥
    const char* sql = "UPDATE users SET avatar_url = ?, update_time = CURRENT_TIMESTAMP WHERE id = ?";
    
    MYSQL_STMT* stmt = mysql_stmt_init(conn);
    if (!stmt) {
        Logger::error("Failed to initialize statement");
        return false;
    }
    
    if (mysql_stmt_prepare(stmt, sql, strlen(sql)) != 0) {
        Logger::error("Failed to prepare statement: " + std::string(mysql_stmt_error(stmt)));
        mysql_stmt_close(stmt);
        return false;
    }
    
    // ç»‘å®šå‚æ•°
    MYSQL_BIND bind[2];
    memset(bind, 0, sizeof(bind));
    
    // avatar_url
    unsigned long avatar_length = avatarUrl.length();
    bind[0].buffer_type = MYSQL_TYPE_STRING;
    bind[0].buffer = (char*)avatarUrl.c_str();
    bind[0].buffer_length = avatarUrl.length();
    bind[0].length = &avatar_length;
    
    // userId
    bind[1].buffer_type = MYSQL_TYPE_LONG;
    bind[1].buffer = (char*)&userId;
    
    if (mysql_stmt_bind_param(stmt, bind) != 0) {
        Logger::error("Failed to bind parameters: " + std::string(mysql_stmt_error(stmt)));
        mysql_stmt_close(stmt);
        return false;
    }
    
    // æ‰§è¡Œæ›´æ–°
    if (mysql_stmt_execute(stmt) != 0) {
        Logger::error("Failed to execute statement: " + std::string(mysql_stmt_error(stmt)));
        mysql_stmt_close(stmt);
        return false;
    }
    
    mysql_stmt_close(stmt);
    
    Logger::info("Avatar URL updated for user ID: " + std::to_string(userId));
    return true;
}
```

---

### é˜¶æ®µ8.4ï¼šHandlerå±‚ï¼ˆ1.5å°æ—¶ï¼‰

#### ä»»åŠ¡8.4.1: ä¿®æ”¹ `src/api/auth_handler.h`

**æ·»åŠ æ–¹æ³•å£°æ˜**:
```cpp
/**
 * @brief å¤„ç†å¤´åƒä¸Šä¼ è¯·æ±‚
 * 
 * @param req HTTPè¯·æ±‚å¯¹è±¡
 * @param res HTTPå“åº”å¯¹è±¡
 */
void handleUploadAvatar(const httplib::Request& req, httplib::Response& res);

private:
/**
 * @brief ä¿å­˜ä¸Šä¼ çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
 * 
 * @param file ä¸Šä¼ çš„æ–‡ä»¶å¯¹è±¡
 * @return std::string ä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼ˆå¤±è´¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼‰
 */
std::string saveTempFile(const httplib::MultipartFormData& file);
```

---

#### ä»»åŠ¡8.4.2: å®ç° `src/api/auth_handler.cpp` - `handleUploadAvatar()`

```cpp
void AuthHandler::handleUploadAvatar(const httplib::Request& req, httplib::Response& res) {
    try {
        // 1. éªŒè¯JWT token
        std::string authHeader = req.get_header_value("Authorization");
        if (authHeader.substr(0, 7) != "Bearer ") {
            sendJsonResponse(res, 401, false, "æœªæˆæƒï¼šç¼ºå°‘æˆ–æ— æ•ˆçš„Authorizationå¤´");
            return;
        }
        
        std::string token = authHeader.substr(7);
        auto jwtManager = std::make_unique<JWTManager>();
        TokenValidationResult validation = jwtManager->validateAccessToken(token);
        
        if (!validation.valid) {
            sendJsonResponse(res, 401, false, "æœªæˆæƒï¼š" + validation.message);
            return;
        }
        
        int userId = validation.userId;
        
        // 2. æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šä¼ çš„æ–‡ä»¶
        if (!req.has_file("avatar")) {
            sendJsonResponse(res, 400, false, "è¯·æ±‚é”™è¯¯ï¼šæœªæä¾›å¤´åƒæ–‡ä»¶");
            return;
        }
        
        // 3. è·å–ä¸Šä¼ çš„æ–‡ä»¶
        auto file = req.get_file_value("avatar");
        
        // 4. éªŒè¯æ–‡ä»¶ç±»å‹
        std::string contentType = file.content_type;
        if (contentType != "image/jpeg" && 
            contentType != "image/png" && 
            contentType != "image/gif" && 
            contentType != "image/webp") {
            sendJsonResponse(res, 400, false, "è¯·æ±‚é”™è¯¯ï¼šä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼");
            return;
        }
        
        // 5. ä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
        std::string tempFilePath = saveTempFile(file);
        if (tempFilePath.empty()) {
            sendJsonResponse(res, 500, false, "æœåŠ¡å™¨é”™è¯¯ï¼šæ— æ³•ä¿å­˜ä¸´æ—¶æ–‡ä»¶");
            return;
        }
        
        // 6. è°ƒç”¨Serviceå±‚å¤„ç†å¤´åƒä¸Šä¼ 
        auto result = authService_->uploadAvatar(userId, tempFilePath);
        
        if (!result.success) {
            sendJsonResponse(res, 400, false, result.message);
            return;
        }
        
        // 7. æ„å»ºå“åº”æ•°æ®ï¼ˆä½¿ç”¨UrlHelperæ·»åŠ URLå‰ç¼€ï¼‰
        Json::Value data;
        data["avatar_url"] = UrlHelper::toFullUrl(result.avatarUrl);
        data["file_size"] = static_cast<Json::Int64>(result.fileSize);
        data["width"] = result.width;
        data["height"] = result.height;
        
        sendJsonResponse(res, 200, true, result.message, data);
        
        Logger::info("Avatar uploaded successfully for user ID: " + std::to_string(userId));
        
    } catch (const std::exception& e) {
        Logger::error("Exception in handleUploadAvatar: " + std::string(e.what()));
        sendJsonResponse(res, 500, false, "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯");
    }
}

std::string AuthHandler::saveTempFile(const httplib::MultipartFormData& file) {
    try {
        // ç”Ÿæˆä¸´æ—¶æ–‡ä»¶å
        std::string timestamp = std::to_string(std::time(nullptr));
        std::string tempDir = "uploads/temp/";
        std::string tempFilePath = tempDir + "avatar_" + timestamp + ".tmp";
        
        // ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
        system(("mkdir -p " + tempDir).c_str());
        
        // å†™å…¥æ–‡ä»¶
        std::ofstream ofs(tempFilePath, std::ios::binary);
        if (!ofs) {
            Logger::error("Failed to create temp file: " + tempFilePath);
            return "";
        }
        
        ofs.write(file.content.data(), file.content.size());
        ofs.close();
        
        Logger::info("Temp file saved: " + tempFilePath);
        return tempFilePath;
        
    } catch (const std::exception& e) {
        Logger::error("Exception in saveTempFile: " + std::string(e.what()));
        return "";
    }
}
```

---

#### ä»»åŠ¡8.4.3: ä¿®æ”¹ `src/api/auth_handler.cpp` - `registerRoutes()`

```cpp
// åœ¨registerRoutes()æ–¹æ³•ä¸­æ·»åŠ è·¯ç”±
server.Post("/api/v1/users/avatar", [this](const httplib::Request& req, httplib::Response& res) {
    handleUploadAvatar(req, res);
});
```

**æ³¨æ„è·¯ç”±é¡ºåº**ï¼šå°†æ­¤è·¯ç”±æ”¾åœ¨ `/api/v1/users/check-username` ä¹‹åï¼Œ`/api/v1/users/([^/]+)` ä¹‹å‰ã€‚

---

### é˜¶æ®µ8.5ï¼šæµ‹è¯•ä¸éªŒè¯ï¼ˆ1å°æ—¶ï¼‰

#### ä»»åŠ¡8.5.1: åˆ›å»ºæµ‹è¯•ç›®å½•

```bash
mkdir -p uploads/avatars uploads/temp
chmod 755 uploads/avatars uploads/temp
```

---

#### ä»»åŠ¡8.5.2: ç¼–è¯‘æµ‹è¯•

```bash
cd backend-service/build
cmake ..
make -j4
```

**éªŒè¯**: ç¼–è¯‘æ— é”™è¯¯

---

#### ä»»åŠ¡8.5.3: åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹1ï¼šæ­£å¸¸ä¸Šä¼ å¤´åƒ**
```bash
# 1. ç™»å½•è·å–token
TOKEN=$(curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser","password":"Test123456"}' \
  | jq -r '.data.access_token')

# 2. ä¸Šä¼ å¤´åƒ
curl -X POST http://localhost:8080/api/v1/users/avatar \
  -H "Authorization: Bearer $TOKEN" \
  -F "avatar=@test_avatar.jpg"
```

**é¢„æœŸç»“æœ**:
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1728912345.jpg",
    "file_size": 45678,
    "width": 200,
    "height": 200
  },
  "timestamp": 1728912345
}
```

---

**æµ‹è¯•ç”¨ä¾‹2ï¼šéªŒè¯å¤´åƒå·²æ›´æ–°**
```bash
# è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæ£€æŸ¥avatar_urlæ˜¯å¦å·²æ›´æ–°
curl -X GET http://localhost:8080/api/v1/users/profile \
  -H "Authorization: Bearer $TOKEN"
```

---

**æµ‹è¯•ç”¨ä¾‹3ï¼šä¸Šä¼ ç¬¬äºŒæ¬¡å¤´åƒï¼ˆéªŒè¯æ—§å¤´åƒè¢«åˆ é™¤ï¼‰**
```bash
# å†æ¬¡ä¸Šä¼ æ–°å¤´åƒ
curl -X POST http://localhost:8080/api/v1/users/avatar \
  -H "Authorization: Bearer $TOKEN" \
  -F "avatar=@test_avatar2.jpg"

# éªŒè¯ï¼šæ—§å¤´åƒæ–‡ä»¶åº”è¯¥è¢«åˆ é™¤ï¼Œåªä¿ç•™æœ€æ–°çš„å¤´åƒæ–‡ä»¶
ls -lh uploads/avatars/
```

---

**æµ‹è¯•ç”¨ä¾‹4ï¼šé”™è¯¯æµ‹è¯• - æœªæä¾›æ–‡ä»¶**
```bash
curl -X POST http://localhost:8080/api/v1/users/avatar \
  -H "Authorization: Bearer $TOKEN"
```

**é¢„æœŸç»“æœ**: 400é”™è¯¯ï¼Œ"è¯·æ±‚é”™è¯¯ï¼šæœªæä¾›å¤´åƒæ–‡ä»¶"

---

**æµ‹è¯•ç”¨ä¾‹5ï¼šé”™è¯¯æµ‹è¯• - æ–‡ä»¶è¿‡å¤§**
```bash
# åˆ›å»ºä¸€ä¸ª6MBçš„æµ‹è¯•æ–‡ä»¶
dd if=/dev/zero of=large_avatar.jpg bs=1M count=6

curl -X POST http://localhost:8080/api/v1/users/avatar \
  -H "Authorization: Bearer $TOKEN" \
  -F "avatar=@large_avatar.jpg"
```

**é¢„æœŸç»“æœ**: 400é”™è¯¯ï¼Œ"æ–‡ä»¶å¤§å°è¶…è¿‡5MBé™åˆ¶"

---

**æµ‹è¯•ç”¨ä¾‹6ï¼šé”™è¯¯æµ‹è¯• - ä¸æ”¯æŒçš„æ ¼å¼**
```bash
# ä¸Šä¼ éå›¾ç‰‡æ–‡ä»¶
curl -X POST http://localhost:8080/api/v1/users/avatar \
  -H "Authorization: Bearer $TOKEN" \
  -F "avatar=@test.txt"
```

**é¢„æœŸç»“æœ**: 400é”™è¯¯ï¼Œ"ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼"

---

**æµ‹è¯•ç”¨ä¾‹7ï¼šé”™è¯¯æµ‹è¯• - æ— æ•ˆtoken**
```bash
curl -X POST http://localhost:8080/api/v1/users/avatar \
  -H "Authorization: Bearer invalid_token" \
  -F "avatar=@test_avatar.jpg"
```

**é¢„æœŸç»“æœ**: 401é”™è¯¯ï¼Œ"æœªæˆæƒ"

---

### é˜¶æ®µ8.6ï¼šæ–‡æ¡£æ›´æ–°ï¼ˆ30åˆ†é’Ÿï¼‰

#### ä»»åŠ¡8.6.1: æ›´æ–° `[000]APIæ–‡æ¡£.md`

åœ¨"ç”¨æˆ·ç›¸å…³API"ç« èŠ‚æ·»åŠ ï¼š

```markdown
### 5. ä¸Šä¼ ç”¨æˆ·å¤´åƒ

**æ¥å£**: `POST /api/v1/users/avatar`

**æè¿°**: ä¸Šä¼ ç”¨æˆ·å¤´åƒå›¾ç‰‡ï¼Œè‡ªåŠ¨è£å‰ªä¸º200x200æ­£æ–¹å½¢å¹¶å‹ç¼©

**è®¤è¯**: éœ€è¦JWT token

**è¯·æ±‚å¤´**:
```
Authorization: Bearer {access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| avatar | File | æ˜¯ | å¤´åƒå›¾ç‰‡æ–‡ä»¶ï¼ˆæœ€å¤§5MBï¼‰ |

**æ”¯æŒæ ¼å¼**: JPEG, PNG, GIF, WebP

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1728912345.jpg",
    "file_size": 45678,
    "width": 200,
    "height": 200
  },
  "timestamp": 1728912345
}
```

**é”™è¯¯å“åº”**:
- 400: æœªæä¾›æ–‡ä»¶ã€æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒã€æ–‡ä»¶è¿‡å¤§
- 401: æœªæˆæƒï¼ˆtokenæ— æ•ˆæˆ–è¿‡æœŸï¼‰
- 500: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
```

---

#### ä»»åŠ¡8.6.2: æ›´æ–° `docs/api/openapi.yaml`

æ·»åŠ å¤´åƒä¸Šä¼ æ¥å£å®šä¹‰ï¼š

```yaml
/api/v1/users/avatar:
  post:
    tags:
      - ç”¨æˆ·ç®¡ç†
    summary: ä¸Šä¼ ç”¨æˆ·å¤´åƒ
    description: |
      ä¸Šä¼ ç”¨æˆ·å¤´åƒå›¾ç‰‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
      - è£å‰ªä¸º200x200æ­£æ–¹å½¢
      - å‹ç¼©ä¸ºJPEGæ ¼å¼ï¼ˆ80%è´¨é‡ï¼‰
      - åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
      - è¿”å›å¸¦æœåŠ¡å™¨URLå‰ç¼€çš„å®Œæ•´è·¯å¾„
    security:
      - BearerAuth: []
    requestBody:
      required: true
      content:
        multipart/form-data:
          schema:
            type: object
            required:
              - avatar
            properties:
              avatar:
                type: string
                format: binary
                description: å¤´åƒå›¾ç‰‡æ–‡ä»¶ï¼ˆæœ€å¤§5MBï¼Œæ”¯æŒJPEG/PNG/GIF/WebPï¼‰
    responses:
      '200':
        description: å¤´åƒä¸Šä¼ æˆåŠŸ
        content:
          application/json:
            schema:
              type: object
              properties:
                success:
                  type: boolean
                  example: true
                message:
                  type: string
                  example: "å¤´åƒä¸Šä¼ æˆåŠŸ"
                data:
                  type: object
                  properties:
                    avatar_url:
                      type: string
                      example: "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1728912345.jpg"
                    file_size:
                      type: integer
                      example: 45678
                    width:
                      type: integer
                      example: 200
                    height:
                      type: integer
                      example: 200
                timestamp:
                  type: integer
                  example: 1728912345
      '400':
        description: è¯·æ±‚é”™è¯¯ï¼ˆæœªæä¾›æ–‡ä»¶ã€æ ¼å¼ä¸æ”¯æŒã€æ–‡ä»¶è¿‡å¤§ï¼‰
      '401':
        description: æœªæˆæƒ
      '500':
        description: æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
```

---

#### ä»»åŠ¡8.6.3: æ›´æ–° `README.md` å’Œ `CLAUDE.md`

åœ¨åŠŸèƒ½åˆ—è¡¨ä¸­æ·»åŠ ï¼š
- âœ… ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼ˆv2.5.0 - è‡ªåŠ¨è£å‰ªã€å‹ç¼©ã€æ—§å¤´åƒæ¸…ç†ï¼‰

---

### é˜¶æ®µ8.7ï¼šæ€§èƒ½ä¼˜åŒ–ä¸å®‰å…¨åŠ å›ºï¼ˆå¯é€‰ï¼Œ30åˆ†é’Ÿï¼‰

#### ä¼˜åŒ–å»ºè®®

1. **å¹¶å‘ä¸Šä¼ é™åˆ¶**ï¼š
   - ä½¿ç”¨ä¿¡å·é‡é™åˆ¶åŒæ—¶ä¸Šä¼ çš„æ•°é‡
   - é˜²æ­¢æœåŠ¡å™¨èµ„æºè€—å°½

2. **æ–‡ä»¶ç±»å‹éªŒè¯å¢å¼º**ï¼š
   - ä¸ä»…æ£€æŸ¥MIMEç±»å‹ï¼Œè¿˜æ£€æŸ¥æ–‡ä»¶é­”æ•°
   - é˜²æ­¢ä¼ªé€ æ–‡ä»¶ç±»å‹çš„æ”»å‡»

3. **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**ï¼š
   - å®šæœŸæ¸…ç†è¶…è¿‡1å°æ—¶çš„ä¸´æ—¶æ–‡ä»¶
   - é˜²æ­¢ç£ç›˜ç©ºé—´å ç”¨

4. **CDNé›†æˆ**ï¼ˆæœªæ¥ï¼‰ï¼š
   - å°†å¤´åƒä¸Šä¼ åˆ°CDN
   - æå‡è®¿é—®é€Ÿåº¦

---

## ğŸ“Š v2.5.0 è¿›åº¦è·Ÿè¸ª

| é˜¶æ®µ | ä»»åŠ¡æ•° | å·²å®Œæˆ | è¿›åº¦ |
|------|--------|--------|------|
| é˜¶æ®µ8.1ï¼šå·¥å…·å±‚å¢å¼º | 2 | 0 | 0% â³ |
| é˜¶æ®µ8.2ï¼šServiceå±‚ | 2 | 0 | 0% â³ |
| é˜¶æ®µ8.3ï¼šRepositoryå±‚ | 2 | 0 | 0% â³ |
| é˜¶æ®µ8.4ï¼šHandlerå±‚ | 3 | 0 | 0% â³ |
| é˜¶æ®µ8.5ï¼šæµ‹è¯•ä¸éªŒè¯ | 3 | 0 | 0% â³ |
| é˜¶æ®µ8.6ï¼šæ–‡æ¡£æ›´æ–° | 3 | 0 | 0% â³ |
| é˜¶æ®µ8.7ï¼šæ€§èƒ½ä¼˜åŒ– | å¯é€‰ | 0 | 0% â³ |
| **æ€»è®¡** | **15** | **0** | **0%** |

---

## âœ… v2.5.0 éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] å¤´åƒä¸Šä¼ æ¥å£æ­£å¸¸å·¥ä½œ
- [ ] å›¾ç‰‡è‡ªåŠ¨è£å‰ªä¸º200x200æ­£æ–¹å½¢
- [ ] å›¾ç‰‡è‡ªåŠ¨å‹ç¼©ä¸ºJPEGæ ¼å¼
- [ ] æ—§å¤´åƒæ–‡ä»¶è‡ªåŠ¨åˆ é™¤
- [ ] è¿”å›çš„URLåŒ…å«æœåŠ¡å™¨å‰ç¼€
- [ ] æ–‡ä»¶å¤§å°å’Œæ ¼å¼éªŒè¯æ­£ç¡®

### å®‰å…¨éªŒæ”¶
- [ ] JWTè®¤è¯æ­£ç¡®å®æ–½
- [ ] æ–‡ä»¶ç±»å‹éªŒè¯ä¸¥æ ¼
- [ ] æ–‡ä»¶å¤§å°é™åˆ¶æœ‰æ•ˆ
- [ ] ä¸´æ—¶æ–‡ä»¶æ­£ç¡®æ¸…ç†
- [ ] æ— è·¯å¾„éå†æ¼æ´

### æ€§èƒ½éªŒæ”¶
- [ ] å•æ¬¡ä¸Šä¼ å“åº”æ—¶é—´ < 2ç§’
- [ ] å¹¶å‘ä¸Šä¼ ä¸å½±å“å…¶ä»–API
- [ ] ç£ç›˜ç©ºé—´å ç”¨åˆç†

### ä»£ç è´¨é‡éªŒæ”¶
- [ ] ç¬¦åˆä¹å±‚æ¶æ„è§„èŒƒ
- [ ] è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
- [ ] ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- [ ] æ— å†…å­˜æ³„æ¼

---

**æœ€åæ›´æ–°**: 2025-10-14 20:00
**ç»´æŠ¤è€…**: Knot Development Team

