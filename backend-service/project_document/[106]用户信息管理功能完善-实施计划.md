# 用户信息管理功能完善 - 实施计划

**文档编号**: [106]
**创建时间**: 2025-10-09
**版本**: v1.0.0
**状态**: 🚧 进行中

---

## 📋 任务概述

为Knot图片分享系统补充完整的用户信息管理功能，实现4个核心API接口。

### 实施范围

| 序号 | 功能 | API路径 | 方法 | 优先级 | 状态 |
|------|------|---------|------|--------|------|
| 1 | 获取当前用户信息 | `/api/v1/users/profile` | GET | P0 | ✅ 已完成 |
| 2 | 修改用户信息 | `/api/v1/users/profile` | PUT | P0 | ✅ 已完成 |
| 3 | 获取其他用户公开信息 | `/api/v1/users/:user_id` | GET | P1 | ✅ 已完成 |
| 4 | 用户名可用性检查 | `/api/v1/users/check-username` | GET | P1 | ✅ 已完成 |

**总工作量**: 9-12小时

---

## 📝 详细任务列表

### 阶段1：数据库变更（30分钟）

- [x] **任务1.1**: 备份当前数据库 ✅
  - 执行: `mysqldump -u root -p knot_image_sharing > backup_$(date +%Y%m%d_%H%M%S).sql`
  - 验证: 检查备份文件是否生成

- [x] **任务1.2**: 添加新字段到users表 ✅
  - 执行SQL:
    ```sql
    ALTER TABLE users ADD COLUMN bio VARCHAR(500) NULL COMMENT '个人简介' AFTER avatar_url;
    ALTER TABLE users ADD COLUMN gender ENUM('male', 'female', 'other', 'prefer_not_to_say') NULL COMMENT '性别' AFTER bio;
    ALTER TABLE users ADD COLUMN location VARCHAR(100) NULL COMMENT '所在地' AFTER gender;
    ```
  - 验证: `DESC users;` 检查字段是否添加成功

---

### 阶段2：Model层（1小时）

- [x] **任务2.1**: 修改 `src/models/user.h` ✅
  - 添加私有成员变量: `bio_`, `gender_`, `location_` ✅
  - 添加getter方法: `getBio()`, `getGender()`, `getLocation()` ✅
  - 添加setter方法: `setBio()`, `setGender()`, `setLocation()` ✅

- [x] **任务2.2**: 修改 `src/models/user.cpp` ✅
  - 更新构造函数，初始化新字段 ✅
  - 更新 `toJson()` 方法，包含新字段 ✅
  - 更新 `fromJson()` 方法，解析新字段 ✅
  - 更新 `validate()` 方法，验证新字段 ✅

- [x] **任务2.3**: 编译测试 ✅
  - 执行: `cd build && make` ✅
  - 验证: 编译无错误 ✅

---

### 阶段3：Repository层（2-3小时）

- [x] **任务3.1**: 修改 `src/database/user_repository.h` ✅
  - 添加方法声明: `updateUserProfile()` ✅
  - 添加方法声明: `emailExistsForOtherUser()` ✅
  - 添加方法声明: `phoneExistsForOtherUser()` ✅

- [x] **任务3.2**: 实现 `src/database/user_repository.cpp` - `updateUserProfile()` ✅
  - 使用ConnectionGuard获取连接
  - 准备SQL: `UPDATE users SET real_name=?, email=?, avatar_url=?, phone=?, bio=?, gender=?, location=?, update_time=CURRENT_TIMESTAMP WHERE id=?`
  - 使用MYSQL_BIND绑定参数
  - 执行更新
  - 添加详细的中文注释
  - 添加错误处理和日志

- [x] **任务3.3**: 实现 `src/database/user_repository.cpp` - `emailExistsForOtherUser()` ✅
  - 使用ConnectionGuard获取连接 ✅
  - 准备SQL: `SELECT COUNT(*) FROM users WHERE email=? AND id!=?` ✅
  - 执行查询并返回结果 ✅
  - 添加详细的中文注释 ✅

- [x] **任务3.4**: 实现 `src/database/user_repository.cpp` - `phoneExistsForOtherUser()` ✅
  - 使用ConnectionGuard获取连接 ✅
  - 准备SQL: `SELECT COUNT(*) FROM users WHERE phone=? AND id!=?` ✅
  - 执行查询并返回结果 ✅
  - 添加详细的中文注释 ✅

- [x] **任务3.5**: 编译测试 ✅
  - 执行: `cd build && make` ✅
  - 验证: 编译无错误 ✅

---

### 阶段4：Service层（2-3小时）

- [x] **任务4.1**: 修改 `src/core/auth_service.h` ✅
  - 添加结构体: `UpdateProfileResult` ✅
  - 添加结构体: `UsernameCheckResult` ✅
  - 添加方法声明: `updateUserProfile()` ✅
  - 添加方法声明: `getUserPublicInfo()` ✅
  - 添加方法声明: `checkUsernameAvailability()` ✅
  - 添加私有方法声明: `validateProfileUpdateInput()` ✅

- [x] **任务4.2**: 实现 `src/core/auth_service.cpp` - `validateProfileUpdateInput()` ✅
  - 验证real_name: 非空，不超过50字符
  - 验证email: 如果提供，验证邮箱格式
  - 验证phone: 11位中国手机号
  - 验证bio: 不超过500字符
  - 验证gender: male/female/other/prefer_not_to_say
  - 验证location: 不超过100字符
  - 添加详细的中文注释

- [x] **任务4.3**: 实现 `src/core/auth_service.cpp` - `updateUserProfile()` ✅
  - 调用 `validateProfileUpdateInput()` 验证输入 ✅
  - 调用 `userRepository_->findById()` 检查用户是否存在 ✅
  - 如果修改了email，调用 `emailExistsForOtherUser()` 检查唯一性 ✅
  - 如果修改了phone，调用 `phoneExistsForOtherUser()` 检查唯一性 ✅
  - 调用 `userRepository_->updateUserProfile()` 更新 ✅
  - 查询并返回更新后的用户信息 ✅
  - 添加详细的中文注释和日志 ✅

- [x] **任务4.4**: 实现 `src/core/auth_service.cpp` - `getUserPublicInfo()` ✅
  - 调用 `userRepository_->findByUserId()` 查询用户 ✅
  - 返回用户对象（只包含公开信息） ✅
  - 添加详细的中文注释 ✅

- [x] **任务4.5**: 实现 `src/core/auth_service.cpp` - `checkUsernameAvailability()` ✅
  - 验证用户名格式 ✅
  - 调用 `userRepository_->usernameExists()` 检查是否存在 ✅
  - 返回可用性结果 ✅
  - 添加详细的中文注释 ✅

- [x] **任务4.6**: 编译测试 ✅
  - 执行: `cd build && make` ✅
  - 验证: 编译无错误 ✅

---

### 阶段5：Handler层（2小时）

- [x] **任务5.1**: 修改 `src/api/auth_handler.h` ✅
  - 添加方法声明: `handleGetProfile()` ✅
  - 添加方法声明: `handleUpdateProfile()` ✅
  - 添加方法声明: `handleGetUserPublicInfo()` ✅
  - 添加方法声明: `handleCheckUsername()` ✅

- [x] **任务5.2**: 实现 `src/api/auth_handler.cpp` - `handleGetProfile()` ✅
  - 提取JWT token
  - 验证token并获取userId
  - 调用 `userRepository_->findById(userId)`
  - 构造JSON响应
  - 添加详细的中文注释

- [x] **任务5.3**: 实现 `src/api/auth_handler.cpp` - `handleUpdateProfile()` ✅
  - 提取JWT token ✅
  - 验证token并获取userId ✅
  - 解析JSON请求体 ✅
  - 提取字段: real_name, email, avatar_url, phone, bio, gender, location ✅
  - 调用 `authService_->updateUserProfile()` ✅
  - 构造JSON响应 ✅
  - 添加详细的中文注释 ✅

- [x] **任务5.4**: 实现 `src/api/auth_handler.cpp` - `handleGetUserPublicInfo()` ✅
  - 从路径参数提取user_id ✅
  - 调用 `authService_->getUserPublicInfo()` ✅
  - 构造JSON响应（只包含公开字段） ✅
  - 添加详细的中文注释 ✅

- [x] **任务5.5**: 实现 `src/api/auth_handler.cpp` - `handleCheckUsername()` ✅
  - 从查询参数提取username ✅
  - 调用 `authService_->checkUsernameAvailability()` ✅
  - 构造JSON响应 ✅
  - 添加详细的中文注释 ✅

- [x] **任务5.6**: 修改 `src/api/auth_handler.cpp` - `registerRoutes()` ✅
  - 注册路由: `GET /api/v1/users/profile` ✅
  - 注册路由: `PUT /api/v1/users/profile` ✅
  - 注册路由: `GET /api/v1/users/:user_id` ✅
  - 注册路由: `GET /api/v1/users/check-username` ✅
  - 修复路由顺序冲突问题 ✅

- [x] **任务5.7**: 编译测试 ✅
  - 执行: `cd build && make` ✅
  - 验证: 编译无错误 ✅

---

### 阶段6：集成测试（1-2小时）

- [x] **任务6.1**: 启动服务器 ✅
  - 执行: `cd backend-service && ./build/knot_image_sharing` ✅
  - 验证: 服务器正常启动，监听8080端口 ✅

- [x] **任务6.2**: 测试用户注册和登录 ✅
  - 注册测试用户 ✅
  - 登录获取access_token ✅
  - 保存token用于后续测试 ✅

- [x] **任务6.3**: 测试获取当前用户信息 ✅
  - 执行: `curl -X GET http://localhost:8080/api/v1/users/profile -H "Authorization: Bearer {token}"` ✅
  - 验证: 返回200，包含用户信息 ✅

- [x] **任务6.4**: 测试修改用户信息 ✅
  - 执行: `curl -X PUT http://localhost:8080/api/v1/users/profile -H "Authorization: Bearer {token}" -H "Content-Type: application/json" -d '{...}'` ✅
  - 验证: 返回200，信息更新成功，新字段(bio、gender、location)正确保存 ✅

- [x] **任务6.5**: 测试获取其他用户公开信息 ✅
  - 执行: `curl -X GET http://localhost:8080/api/v1/users/{user_id}` ✅
  - 验证: 返回200，只包含公开信息 ✅

- [x] **任务6.6**: 测试用户名可用性检查 ✅
  - 执行: `curl -X GET "http://localhost:8080/api/v1/users/check-username?username=test"` ✅
  - 验证: 返回200，正确显示可用性(已存在/可用/无效格式) ✅

- [x] **任务6.7**: 异常流程测试 ✅
  - 测试无效token ✅
  - 测试格式错误的输入 ✅
  - 测试唯一性约束冲突 ✅
  - 验证: 返回正确的错误码和错误信息 ✅

---

### 阶段7：文档更新（30分钟）

- [x] **任务7.1**: 更新 `[000]API文档.md` ✅
  - 在"认证相关API"章节添加4个新接口 ✅
  - 更新版本号为 v2.1.0 ✅
  - 更新目录 ✅

- [x] **任务7.2**: 更新 `[101]阶段B-用户认证模块.md` ✅
  - 更新"完成的模块"列表
  - 添加新功能说明

- [x] **任务7.3**: 更新 `README.md` ✅
  - 更新功能列表

---

## ✅ 验收标准

### 功能验收
- [x] 所有4个API接口正常工作 ✅
- [x] JWT认证正确实施 ✅
- [x] 输入验证正确执行 ✅
- [x] 唯一性约束正确检查 ✅
- [x] 错误处理完善 ✅
- [x] 响应格式统一 ✅

### 代码质量验收
- [x] 符合九层架构规范 ✅
- [x] 详细的中文注释 ✅
- [x] 使用预编译语句 ✅
- [x] 使用ConnectionGuard ✅
- [x] 统一的错误处理 ✅
- [x] 无内存泄漏 ✅

### 测试验收
- [x] 所有集成测试通过 ✅
- [x] 异常流程测试通过 ✅

### 文档验收
- [x] API文档更新完整 ✅
- [ ] 架构文档更新 ⏳
- [ ] README更新 ⏳

---

## 📊 进度跟踪

| 阶段 | 任务数 | 已完成 | 进度 |
|------|--------|--------|------|
| 阶段1：数据库变更 | 2 | 2 | 100% ✅ |
| 阶段2：Model层 | 3 | 3 | 100% ✅ |
| 阶段3：Repository层 | 5 | 5 | 100% ✅ |
| 阶段4：Service层 | 6 | 6 | 100% ✅ |
| 阶段5：Handler层 | 7 | 7 | 100% ✅ |
| 阶段6：集成测试 | 7 | 7 | 100% ✅ |
| 阶段7：文档更新 | 3 | 3 | 100% ✅ |
| **总计** | **33** | **33** | **100%** |

---

## 🐛 当前问题记录

### 问题1：服务器API请求无响应

**发现时间**: 2025-10-09 21:34

**问题描述**:
服务器可以正常启动并监听8080端口，但所有API请求（包括原有的注册、登录接口）都返回"Empty reply from server"错误，服务器进程随后崩溃。

**复现步骤**:
1. 编译项目：`cd build && make -j4`（编译成功，无错误）
2. 启动服务器：`LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH ./knot_image_sharing ../config/config.json`
3. 服务器启动日志正常，显示：
   ```
   [2025-10-09 21:34:06.883] [info] [thread 42444] Auth routes registered
   [2025-10-09 21:34:06.883] [info] [thread 42444] Starting HTTP server...
   ```
4. 发送测试请求：
   ```bash
   curl -X POST http://localhost:8080/api/v1/auth/register \
     -H "Content-Type: application/json" \
     -d '{"username":"test123","password":"Test123456","real_name":"测试","phone":"13800138002","email":"test@test.com"}'
   ```
5. 结果：`curl: (52) Empty reply from server`
6. 服务器进程崩溃（return code: -1）

**预期结果**:
应该返回JSON响应，例如：
```json
{
  "success": true,
  "message": "注册成功",
  "data": {
    "user_id": "USR_2025Q1_XXX",
    "username": "test123",
    ...
  }
}
```

**可能原因分析**:

1. **数据库查询问题**：
   - 新添加的字段（bio, gender, location）在查询时可能导致NULL值处理错误
   - Repository层的`findById`或`findByUserId`方法可能需要更新以处理新字段
   - 建议检查：`src/database/user_repository.cpp`中的查询结果绑定部分

2. **JSON序列化问题**：
   - User模型的`toJson()`方法已更新包含新字段
   - 但可能在某些情况下（如字段为空）导致序列化失败
   - 建议检查：`src/models/user.cpp`的`toJson()`方法

3. **内存访问问题**：
   - 可能存在未初始化的指针或越界访问
   - 建议使用gdb调试：`gdb ./knot_image_sharing`

4. **路由冲突**：
   - 新添加的路由可能与现有路由冲突
   - 特别是`GET /api/v1/users/:user_id`使用了正则表达式匹配
   - 建议检查：`src/api/auth_handler.cpp`的`registerRoutes()`方法

**调试建议**:

1. **添加更多日志**：
   ```cpp
   // 在Handler方法开始处添加
   Logger::info("进入handleRegister方法");
   Logger::info("请求体: " + req.body);
   ```

2. **使用gdb调试**：
   ```bash
   gdb ./knot_image_sharing
   (gdb) run ../config/config.json
   # 在另一个终端发送请求
   # 查看崩溃位置
   (gdb) bt
   ```

3. **检查数据库查询**：
   - 在`user_repository.cpp`的查询方法中添加日志
   - 验证新字段的NULL值处理是否正确

4. **简化测试**：
   - 先测试不涉及新字段的API（如登录）
   - 如果登录也失败，说明问题不在新字段
   - 如果登录成功，逐步测试新API

**临时解决方案**:
如果问题难以定位，可以考虑：
1. 回滚到添加新字段之前的版本
2. 逐步添加功能，每次添加后测试
3. 使用git bisect定位引入问题的提交

**状态**: ✅ 已解决

**解决时间**: 2025-10-09 22:10

**解决方法**:
修复了`src/database/user_repository.cpp`中`buildUserFromStatement`方法的字段绑定问题。

**具体修改**:
1. 将`MYSQL_BIND result[14]`扩展为`MYSQL_BIND result[17]`
2. 添加bio、gender、location三个字段的变量声明:
   ```cpp
   char bio[501] = {0};
   char gender[25] = {0};
   char location[101] = {0};
   ```
3. 添加对应的长度变量和NULL标志变量:
   ```cpp
   unsigned long bio_length, gender_length, location_length;
   bool bio_is_null, gender_is_null, location_is_null;
   ```
4. 在result数组中添加bio(result[11])、gender(result[12])、location(result[13])的绑定
5. 将device_count、create_time、update_time的索引从[11][12][13]调整为[14][15][16]
6. 在fetch后添加bio、gender、location字段的值设置:
   ```cpp
   if (!bio_is_null) {
       user.setBio(std::string(bio, bio_length));
   }
   if (!gender_is_null) {
       user.setGender(std::string(gender, gender_length));
   }
   if (!location_is_null) {
       user.setLocation(std::string(location, location_length));
   }
   ```

**修改文件**: `backend-service/src/database/user_repository.cpp` (第157-327行)

**验证结果**:
- ✅ 编译成功无错误
- ✅ 服务器正常启动
- ✅ 用户注册接口正常工作
- ✅ 用户登录接口正常工作
- ✅ 获取用户信息接口正常工作
- ✅ 更新用户信息接口正常工作，新字段(bio、gender、location)正确读写

**测试用例**:
```bash
# 注册用户
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser001","password":"Test123456","real_name":"测试用户001","phone":"13900000099","email":"test001@example.com"}'

# 登录
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"testuser001","password":"Test123456"}'

# 更新用户信息(包含新字段)
curl -X PUT http://localhost:8080/api/v1/users/profile \
  -H "Authorization: Bearer {TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{"real_name":"测试用户001更新","email":"test001@example.com","phone":"13900000099","bio":"这是我的个人简介","gender":"male","location":"北京"}'
```

**根本原因分析**:
数据库表users增加了3个新字段(bio、gender、location),但`buildUserFromStatement`方法的MYSQL_BIND数组大小未同步更新,导致`SELECT * FROM users`查询返回17个字段时,只绑定了14个槽位,造成内存访问越界,服务器崩溃。

---

## 📝 变更日志

### 2025-10-09 22:15 - Bug修复与测试完成

**修复内容**:
- 修复了`buildUserFromStatement`方法的字段绑定bug (user_repository.cpp:157-327)
- 解决了服务器API请求导致崩溃的问题

**测试完成**:
- ✅ 任务6.1: 服务器启动测试通过
- ✅ 任务6.2: 用户注册和登录测试通过
- ✅ 任务6.3: 获取当前用户信息测试通过
- ✅ 任务6.4: 修改用户信息测试通过(包括新字段)

**待完成**:
- ⏳ 任务6.5: 获取其他用户公开信息
- ⏳ 任务6.6: 用户名可用性检查
- ⏳ 任务6.7: 异常流程测试
- ⏳ 阶段7: 文档更新(3个任务)

**当前进度**: 82% (27/33任务完成)

---

### 2025-10-09 22:35 - 路由修复与全部测试完成

**修复内容**:
- 修复路由冲突问题:调整路由注册顺序,将`check-username`放在正则匹配路由`/users/([^/]+)`之前
- 修改文件: `src/api/auth_handler.cpp` (第68-76行)
- 原因: 正则表达式路由会匹配所有`/users/xxx`格式的URL,导致`check-username`被误匹配

**测试完成**:
- ✅ 任务6.5: 获取其他用户公开信息测试通过
- ✅ 任务6.6: 用户名可用性检查测试通过
  - 测试用户名已存在: 返回available=false ✅
  - 测试用户名可用: 返回available=true ✅
  - 测试无效格式: 返回valid=false ✅
- ✅ 任务6.7: 异常流程测试通过
  - 无效token测试 ✅
  - 格式错误输入测试 ✅
  - 唯一性约束冲突测试 ✅

**文档更新完成**:
- ✅ 任务7.1: [000]API文档更新完成
  - 版本号更新为 v2.1.0
  - 目录添加4个新接口链接
  - 添加4个新接口完整文档(请求/响应/错误码说明)

**当前进度**: 94% (31/33任务完成)

**待完成任务**:
- ⏳ 任务7.2: 更新[101]阶段B-用户认证模块.md
- ⏳ 任务7.3: 更新README.md

---

### 2025-10-09 22:40 - 所有文档更新完成 🎉

**文档更新完成**:
- ✅ 任务7.2: 更新[101]阶段B-用户认证模块.md完成
  - 版本号更新为 v2.1.0
  - 在"完成的模块"表格中添加用户信息管理模块
  - 在"API接口"章节添加4个新接口文档
  - 在"完成总结"中添加v2.1.0新增功能说明
  - 更新文档维护者为Knot Development Team

- ✅ 任务7.3: 更新README.md完成
  - 版本号更新为 v2.1.0
  - 在"核心功能"中添加用户信息管理功能说明
  - 在"API文档"中添加用户信息管理接口表格
  - 在"项目进度-阶段B"中添加v2.1.0新增功能清单

**🎉 项目完成**: 100% (33/33任务全部完成)

**功能实现情况**:
- ✅ 获取当前用户信息 (GET /api/v1/users/profile)
- ✅ 修改用户信息 (PUT /api/v1/users/profile)
- ✅ 获取其他用户公开信息 (GET /api/v1/users/:user_id)
- ✅ 用户名可用性检查 (GET /api/v1/users/check-username)

**数据库变更**:
- ✅ bio字段 (个人简介)
- ✅ gender字段 (性别)
- ✅ location字段 (所在地)

**Bug修复**:
- ✅ MYSQL_BIND数组大小不匹配问题
- ✅ 路由冲突问题

---

**最后更新**: 2025-10-09 22:40
**维护者**: Knot Development Team

