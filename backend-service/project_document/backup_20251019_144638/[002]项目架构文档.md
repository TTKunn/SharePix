# Knot图片分享系统项目架构文档

**文档编号**: [002]
**创建时间**: 2025-10-02
**最后更新**: 2025-10-10
**项目**: Knot - 图片分享社交平台后端服务
**版本**: v2.0.0
**状态**: 正式版

---

## 📋 目录

1. [项目概述](#项目概述)
2. [技术栈](#技术栈)
3. [九层架构](#九层架构)
4. [系统架构图](#系统架构图)
5. [目录结构](#目录结构)
6. [设计模式](#设计模式)
7. [核心组件](#核心组件)
8. [性能优化](#性能优化)

---

## 项目概述

### 项目简介

Knot是一个基于C++17开发的高性能图片分享社交平台后端服务。系统采用九层架构设计，支持多图片帖子发布、Feed推荐、社交互动等功能，确保代码的可维护性、可扩展性和高性能。

### 核心功能模块

1. **用户管理系统** ✅ 已完成
   - 用户注册/登录/认证
   - JWT令牌管理（访问令牌 + 刷新令牌）
   - 用户信息管理
   - 用户角色管理（普通用户、管理员）

2. **帖子管理模块** ✅ 已完成
   - 多图片帖子发布（1-9张图片）
   - 帖子编辑/删除
   - 图片顺序管理
   - 帖子审核状态管理

3. **图片处理模块** ✅ 已完成
   - 图片压缩（质量85%）
   - 缩略图生成（300x300）
   - 支持JPEG/PNG/WebP格式
   - 自动MIME类型检测

4. **Feed推荐系统** ✅ 已完成
   - 基于热度和时间衰减的推荐算法
   - 分页查询优化
   - 用户个人Feed流

5. **标签系统** ✅ 已完成
   - 标签创建和管理
   - 帖子标签关联（最多5个）
   - 标签搜索功能

6. **社交互动系统**（规划中）
   - 点赞功能
   - 收藏功能
   - 关注/粉丝系统
   - 评论功能

7. **分享系统**（规划中）
   - Deep Link生成
   - 分享统计
   - 外部平台分享

---

## 技术栈

### 核心技术

| 技术 | 版本 | 用途 |
|------|------|------|
| C++ | 17 | 高性能后端开发 |
| MySQL | 8.0.43 | 主数据库存储 |
| JsonCpp | 1.9.5 | JSON处理 |
| cpp-httplib | latest | HTTP服务器框架 |
| jwt-cpp | latest | JWT认证 |
| OpenSSL | latest | 加密和HTTPS支持 |
| spdlog | 1.9.2 | 日志管理 |

### 编译工具

- **CMake**: 3.10+
- **GCC/G++**: 支持C++17
- **Make**: 构建工具

### 开发环境

- **操作系统**: Linux (Ubuntu 20.04+)
- **IDE**: VSCode / CLion
- **版本控制**: Git

---

## 九层架构

### 架构概览

```
第1层：客户端层（HTTP客户端）
    ↓
第2层：HTTP服务器层（HTTPServer）
    ↓
第3层：API接口层/Handler（AuthHandler, PostHandler, ImageHandler）
    ↓
第4层：业务逻辑层/Service（AuthService, PostService, ImageService）
    ↓
第5层：数据访问层/Repository（UserRepository, PostRepository, ImageRepository, TagRepository）
    ↓
第6层：安全层（JWTManager, PasswordHasher）
    ↓
第7层：基础设施层（ConnectionPool, ConfigManager, Logger, ImageProcessor）
    ↓
第8层：数据模型层（User, Post, Image, Tag）
    ↓
第9层：数据库层（MySQL）
```

### 第1层：客户端层

**组件**: HTTP客户端（Postman、浏览器、移动端APP）

**职责**:
- 发送HTTP请求
- 接收HTTP响应
- 处理用户交互

### 第2层：HTTP服务器层

**组件**: `HttpServer`

**文件**:
- `src/server/http_server.h`
- `src/server/http_server.cpp`

**职责**:
- 监听HTTP请求
- 路由分发
- 请求/响应处理
- 中间件管理
- CORS配置
- 错误处理

**关键配置**:
- 监听地址: `0.0.0.0:8080`
- 线程池大小: 32
- 请求超时: 60秒
- 线程池大小: 32
- 监听队列: 128

### 第3层：API接口层/Handler

**组件**: `AuthHandler`, `PostHandler`, `ImageHandler`, `TagHandler`

**文件**:
- `src/api/auth_handler.h/cpp`
- `src/api/post_handler.h/cpp`
- `src/api/image_handler.h/cpp`
- `src/api/tag_handler.h/cpp`

**职责**:
- 解析HTTP请求
- JWT令牌验证
- 参数提取和验证
- 调用Service层
- 构造HTTP响应

**特点**:
- 协议转换（HTTP ↔ C++对象）
- 统一的错误处理
- 统一的响应格式

### 第4层：业务逻辑层/Service

**组件**: `AuthService`, `PostService`, `ImageService`, `TagService`

**文件**:
- `src/core/auth_service.h/cpp`
- `src/core/post_service.h/cpp`
- `src/core/image_service.h/cpp`
- `src/core/tag_service.h/cpp`

**职责**:
- 实现核心业务逻辑
- 数据验证
- 业务规则执行
- 调用Repository层
- 事务管理

**特点**:
- 纯业务逻辑，不涉及HTTP
- 可复用性高
- 易于单元测试

### 第5层：数据访问层/Repository

**组件**: `UserRepository`, `PostRepository`, `ImageRepository`, `TagRepository`

**文件**:
- `src/database/user_repository.h/cpp`
- `src/database/post_repository.h/cpp`
- `src/database/image_repository.h/cpp`
- `src/database/tag_repository.h/cpp`

**职责**:
- 数据库CRUD操作
- SQL查询执行
- 数据映射（数据库 ↔ 对象）
- 连接管理

**特点**:
- 使用预编译语句防止SQL注入
- 使用ConnectionGuard自动管理连接
- 统一的错误处理

### 第6层：安全层

**组件**: `JWTManager`, `PasswordHasher`

**文件**:
- `src/security/jwt_manager.h/cpp`
- `src/security/password_hasher.h/cpp`

**职责**:
- JWT令牌生成和验证
- 密码加密和验证
- 安全策略实施

**安全机制**:
- **密码加密**: PBKDF2-HMAC-SHA256，100,000次迭代
- **JWT签名**: HS256算法
- **令牌有效期**: 访问令牌1小时，刷新令牌24小时

### 第7层：基础设施层

**组件**: `DatabaseConnectionPool`, `ConfigManager`, `Logger`

**文件**:
- `src/database/connection_pool.h/cpp`
- `src/database/connection_guard.h/cpp`
- `src/utils/config_manager.h/cpp`
- `src/utils/logger.h/cpp`

**职责**:
- 数据库连接池管理
- 配置文件加载
- 日志记录
- 通用工具函数

**连接池配置**:
- 池大小: 10个连接
- 超时时间: 5秒
- 自动重连: 启用

### 第8层：数据模型层

**组件**: `User`, `Post`, `Image`, `Tag`

**文件**:
- `src/models/user.h/cpp`
- `src/models/post.h/cpp`
- `src/models/image.h/cpp`
- `src/models/tag.h/cpp`

**职责**:
- 数据结构定义
- JSON序列化/反序列化
- 数据验证
- 枚举类型定义

**特点**:
- 完整的getter/setter
- toJson/fromJson方法
- 类型安全的枚举

### 第9层：数据库层

**组件**: MySQL数据库

**职责**:
- 数据持久化存储
- 事务支持
- 索引优化
- 外键约束

**核心表**:
- `users`: 用户信息表
- `posts`: 帖子信息表
- `images`: 图片信息表
- `tags`: 标签信息表
- `post_tags`: 帖子标签关联表

---

## 系统架构图

### 完整架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Mobile App    │───▶│   HTTP API      │───▶│  Business Layer │
│   Web Client    │    │   Gateway       │    │   Services      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                       │
                                ▼                       ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │   Middleware    │    │ Data Access     │
                       │ (Auth, CORS)    │    │   Layer         │
                       └─────────────────┘    └─────────────────┘
                                                        │
                                                        ▼
                                               ┌─────────────────┐
                                               │ MySQL Database  │
                                               │ Connection Pool │
                                               └─────────────────┘
```

### 请求处理流程

```
1. 客户端发送HTTP请求
   ↓
2. HttpServer接收请求
   ↓
3. 路由到对应的Handler
   ↓
4. Handler验证JWT令牌
   ↓
5. Handler解析请求参数
   ↓
6. Handler调用Service层
   ↓
7. Service执行业务逻辑
   ↓
8. Service调用Repository层
   ↓
9. Repository执行数据库操作
   ↓
10. 结果逐层返回
   ↓
11. Handler构造HTTP响应
   ↓
12. HttpServer发送响应给客户端
```

---

## 目录结构

```
shared-parking/
├── src/
│   ├── api/                    # 第3层：API接口层
│   │   ├── auth_handler.h
│   │   ├── auth_handler.cpp
│   │   ├── parking_space_handler.h
│   │   └── parking_space_handler.cpp
│   ├── core/                   # 第4层：业务逻辑层
│   │   ├── auth_service.h
│   │   ├── auth_service.cpp
│   │   ├── parking_space_service.h
│   │   └── parking_space_service.cpp
│   ├── database/               # 第5层：数据访问层 + 第7层：连接池
│   │   ├── user_repository.h
│   │   ├── user_repository.cpp
│   │   ├── parking_space_repository.h
│   │   ├── parking_space_repository.cpp
│   │   ├── connection_pool.h
│   │   ├── connection_pool.cpp
│   │   ├── connection_guard.h
│   │   └── connection_guard.cpp
│   ├── security/               # 第6层：安全层
│   │   ├── jwt_manager.h
│   │   ├── jwt_manager.cpp
│   │   ├── password_hasher.h
│   │   └── password_hasher.cpp
│   ├── models/                 # 第8层：数据模型层
│   │   ├── user.h
│   │   ├── user.cpp
│   │   ├── parking_space.h
│   │   └── parking_space.cpp
│   ├── server/                 # 第2层：HTTP服务器层
│   │   ├── http_server.h
│   │   └── http_server.cpp
│   ├── utils/                  # 第7层：基础设施层
│   │   ├── config_manager.h
│   │   ├── config_manager.cpp
│   │   ├── logger.h
│   │   └── logger.cpp
│   └── main.cpp                # 程序入口
├── config/
│   └── config.json             # 配置文件
├── project_document/           # 项目文档
├── test/                       # 测试脚本
├── third_party/                # 第三方库
│   └── httplib.h
├── CMakeLists.txt              # CMake配置
└── README.md                   # 项目说明
```

---

## 设计模式

### 使用的设计模式

| 模式 | 应用位置 | 说明 |
|------|----------|------|
| **单例模式** | DatabaseConnectionPool, ConfigManager | 全局唯一实例 |
| **工厂模式** | Service层创建对象 | 对象创建逻辑封装 |
| **RAII模式** | ConnectionGuard | 自动资源管理 |
| **策略模式** | PasswordHasher | 不同加密算法 |
| **观察者模式** | Logger | 日志事件通知 |
| **依赖注入** | Handler → Service → Repository | 降低耦合度 |

### RAII模式示例

```cpp
// ConnectionGuard自动管理数据库连接
void someFunction() {
    ConnectionGuard connGuard(pool);
    if (!connGuard.isValid()) {
        return;
    }
    
    // 使用连接...
    
    // 函数结束，connGuard自动析构，归还连接
}
```

---

## 核心组件

### 数据库连接池

**特点**:
- 连接复用，提高性能
- 线程安全
- 自动重连
- 超时机制

**配置**:
```json
{
  "database": {
    "host": "localhost",
    "port": 3306,
    "database": "knot_image_sharing",
    "username": "knot_user",
    "password": "your_password",
    "pool_size": 10,
    "timeout_seconds": 5
  }
}
```

### JWT认证

**令牌类型**:
- **Access Token**: 有效期1小时，用于API访问
- **Refresh Token**: 有效期24小时，用于刷新Access Token

**令牌内容**:
```json
{
  "user_id": 1,
  "username": "zhangsan",
  "role": "driver",
  "exp": 1696147200
}
```

### 日志系统

**日志级别**:
- DEBUG: 调试信息
- INFO: 一般信息
- WARNING: 警告信息
- ERROR: 错误信息

**日志格式**:
```
[2025-10-02 16:29:38.007] [info] [thread 246947] Configuration loaded successfully
```

---

## 📝 总结

### 架构优势

1. **清晰的层次结构**: 九层架构确保职责分离
2. **高可维护性**: 每层独立，易于修改和扩展
3. **高性能**: 连接池、线程池优化
4. **安全性**: 多层安全机制
5. **可测试性**: 每层可独立测试

### 技术亮点

- ✅ C++17现代特性
- ✅ RAII自动资源管理
- ✅ 智能指针防止内存泄漏
- ✅ 预编译语句防止SQL注入
- ✅ JWT无状态认证
- ✅ 连接池和线程池优化
- ✅ 详细的中文注释

---

**文档版本**: v2.0.0
**最后更新**: 2025-10-10
**维护者**: Knot Development Team

