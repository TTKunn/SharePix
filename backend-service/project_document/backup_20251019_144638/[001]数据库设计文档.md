# Knot 图片分享平台 - 数据库设计文档

**文档编号**: [001]
**创建时间**: 2025-10-09
**项目**: Knot - Image Sharing Service
**版本**: v2.0.0
**状态**: ✅ 已完成

---

## 📋 目录

1. [数据库概述](#数据库概述)
2. [表结构设计](#表结构设计)
3. [表关系说明](#表关系说明)
4. [索引设计](#索引设计)
5. [约束说明](#约束说明)
6. [数据迁移](#数据迁移)

---

## 数据库概述

### 基本信息

| 属性 | 值 |
|------|-----|
| 数据库名称 | `knot_image_sharing` |
| 数据库引擎 | MySQL 8.0 |
| 字符集 | `utf8mb4` |
| 排序规则 | `utf8mb4_unicode_ci` |
| 默认端口 | 3306 |

### 设计原则

1. **规范化设计**：遵循第三范式（3NF），减少数据冗余
2. **性能优化**：合理使用索引，优化查询性能
3. **数据完整性**：使用外键约束保证数据一致性
4. **可扩展性**：预留扩展字段，支持未来功能
5. **安全性**：敏感数据加密存储（密码使用PBKDF2-HMAC-SHA256）

---

## 表结构设计

### 1. users 表（用户表）

**功能说明**：存储用户账户信息和认证数据

**表结构**：

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 用户物理ID，自增主键 |
| user_id | VARCHAR(50) | UNIQUE, NOT NULL | - | 用户业务ID，格式：USR_YYYYQX_XXXXXX |
| username | VARCHAR(50) | UNIQUE, NOT NULL | - | 用户名，3-50字符，唯一 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | - | 邮箱地址，唯一 |
| password_hash | VARCHAR(255) | NOT NULL | - | 密码哈希值（PBKDF2-HMAC-SHA256） |
| salt | VARCHAR(32) | NOT NULL | - | 密码盐值，每个用户独立 |
| role | ENUM('USER', 'ADMIN') | NOT NULL | 'USER' | 用户角色：USER=普通用户，ADMIN=管理员 |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 账户创建时间 |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 账户更新时间 |

**索引**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `user_id`, `username`, `email`

**示例数据**：
```sql
INSERT INTO users (user_id, username, email, password_hash, salt, role) VALUES
('USR_2025Q4_ABC123', 'john_doe', 'john@example.com', 'hashed_password', 'random_salt', 'USER');
```

---

### 2. posts 表（帖子表）

**功能说明**：存储帖子信息，包括标题、配文和统计数据

**表结构**：

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 帖子物理ID，自增主键 |
| post_id | VARCHAR(50) | UNIQUE, NOT NULL | - | 帖子业务ID，格式：PST_YYYYQX_XXXXXX |
| user_id | INT | FOREIGN KEY(users.id), NOT NULL | - | 用户ID，外键关联users表 |
| title | VARCHAR(255) | NOT NULL | - | 帖子标题，1-255字符 |
| description | TEXT | NULL | NULL | 帖子配文，最多65535字符 |
| image_count | INT | NOT NULL | 0 | 图片数量，范围：1-9 |
| like_count | INT | NOT NULL | 0 | 点赞数，非负整数 |
| favorite_count | INT | NOT NULL | 0 | 收藏数，非负整数 |
| view_count | INT | NOT NULL | 0 | 浏览数，非负整数 |
| status | ENUM('PENDING', 'APPROVED', 'REJECTED') | NOT NULL | 'APPROVED' | 审核状态：PENDING=待审核，APPROVED=已通过，REJECTED=已拒绝 |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 帖子创建时间 |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 帖子更新时间 |

**索引**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `post_id`
- FOREIGN KEY INDEX: `user_id`
- BUSINESS INDEX: `create_time` (用于Feed流排序)
- COMPOSITE INDEX: `(user_id, create_time)` (用于用户帖子列表)

**示例数据**：
```sql
INSERT INTO posts (post_id, user_id, title, description, image_count, status) VALUES
('PST_2025Q4_XYZ789', 1, '美好的一天', '今天天气真好！', 3, 'APPROVED');
```

---

### 3. images 表（图片表）

**功能说明**：存储图片文件信息和元数据

**表结构**：

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 图片物理ID，自增主键 |
| image_id | VARCHAR(50) | UNIQUE, NOT NULL | - | 图片业务ID，格式：IMG_YYYYQX_XXXXXX |
| post_id | INT | FOREIGN KEY(posts.id), NOT NULL | - | 帖子ID，外键关联posts表 |
| display_order | INT | NOT NULL | 1 | 显示顺序，范围：1-9 |
| user_id | INT | FOREIGN KEY(users.id), NOT NULL | - | 用户ID，外键关联users表 |
| file_url | VARCHAR(255) | NOT NULL | - | 原图文件URL路径 |
| thumbnail_url | VARCHAR(255) | NOT NULL | - | 缩略图文件URL路径 |
| file_size | BIGINT | NOT NULL | - | 文件大小（字节），最大5MB |
| width | INT | NOT NULL | - | 图片宽度（像素） |
| height | INT | NOT NULL | - | 图片高度（像素） |
| mime_type | VARCHAR(50) | NOT NULL | - | MIME类型，如：image/jpeg, image/png |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 图片上传时间 |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 图片更新时间 |

**索引**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `image_id`
- FOREIGN KEY INDEX: `post_id`, `user_id`
- COMPOSITE INDEX: `(post_id, display_order)` (用于按顺序获取帖子图片)

**示例数据**：
```sql
INSERT INTO images (image_id, post_id, display_order, user_id, file_url, thumbnail_url, file_size, width, height, mime_type) VALUES
('IMG_2025Q4_001', 1, 1, 1, '/uploads/images/abc123.jpg', '/uploads/thumbnails/abc123_thumb.jpg', 1024000, 1920, 1080, 'image/jpeg');
```

---

### 4. tags 表（标签表）

**功能说明**：存储标签信息和使用统计

**表结构**：

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 标签物理ID，自增主键 |
| name | VARCHAR(50) | UNIQUE, NOT NULL | - | 标签名称，1-50字符，唯一 |
| use_count | INT | NOT NULL | 0 | 使用次数，非负整数 |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 标签创建时间 |

**索引**：
- PRIMARY KEY: `id`
- UNIQUE INDEX: `name`
- BUSINESS INDEX: `use_count` (用于热门标签排序)

**示例数据**：
```sql
INSERT INTO tags (name, use_count) VALUES
('风景', 100),
('美食', 85),
('旅行', 120);
```

---

### 5. post_tags 表（帖子标签关联表）

**功能说明**：存储帖子和标签的多对多关系

**表结构**：

| 字段名 | 数据类型 | 约束 | 默认值 | 说明 |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | 关联物理ID，自增主键 |
| post_id | INT | FOREIGN KEY(posts.id), NOT NULL | - | 帖子ID，外键关联posts表 |
| tag_id | INT | FOREIGN KEY(tags.id), NOT NULL | - | 标签ID，外键关联tags表 |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | 关联创建时间 |

**索引**：
- PRIMARY KEY: `id`
- FOREIGN KEY INDEX: `post_id`, `tag_id`
- UNIQUE COMPOSITE INDEX: `(post_id, tag_id)` (防止重复关联)
- COMPOSITE INDEX: `(tag_id, create_time)` (用于按标签查询帖子)

**示例数据**：
```sql
INSERT INTO post_tags (post_id, tag_id) VALUES
(1, 1),  -- 帖子1关联标签1（风景）
(1, 3);  -- 帖子1关联标签3（旅行）
```

---

## 表关系说明

### ER关系图（文本形式）

```
┌─────────────┐
│   users     │
│  (用户表)    │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────┴──────┐
│   posts     │
│  (帖子表)    │
└──────┬──────┘
       │ 1
       │
       │ N
┌──────┴──────┐
│   images    │
│  (图片表)    │
└─────────────┘

┌─────────────┐         ┌─────────────┐
│   posts     │ N     N │    tags     │
│  (帖子表)    ├─────────┤  (标签表)    │
└─────────────┘         └─────────────┘
       │                       │
       │ 1                   1 │
       │                       │
       │ N                   N │
       └───────┬───────────────┘
               │
        ┌──────┴──────┐
        │  post_tags  │
        │ (关联表)     │
        └─────────────┘
```

### 关系详细说明

#### 1. users ← posts（一对多）

- **关系类型**：一对多（1:N）
- **说明**：一个用户可以创建多个帖子，一个帖子只属于一个用户
- **外键**：`posts.user_id` → `users.id`
- **级联操作**：`ON DELETE CASCADE`（删除用户时自动删除其所有帖子）

#### 2. posts ← images（一对多）

- **关系类型**：一对多（1:N）
- **说明**：一个帖子可以包含多张图片（1-9张），一张图片只属于一个帖子
- **外键**：`images.post_id` → `posts.id`
- **级联操作**：`ON DELETE CASCADE`（删除帖子时自动删除其所有图片）
- **业务规则**：
  - 图片数量范围：1-9张
  - 图片顺序：`display_order` 字段，范围1-9
  - 至少保留1张图片（不能删除最后一张）

#### 3. posts ← post_tags → tags（多对多）

- **关系类型**：多对多（N:M）
- **说明**：一个帖子可以有多个标签，一个标签可以关联多个帖子
- **中间表**：`post_tags`
- **外键**：
  - `post_tags.post_id` → `posts.id`
  - `post_tags.tag_id` → `tags.id`
- **级联操作**：`ON DELETE CASCADE`（删除帖子或标签时自动删除关联关系）
- **业务规则**：
  - 每个帖子最多5个标签
  - 标签名称唯一
  - 标签使用次数自动统计

---

## 索引设计

### 主键索引

| 表名 | 索引名 | 字段 | 说明 |
|------|--------|------|------|
| users | PRIMARY | id | 用户物理ID |
| posts | PRIMARY | id | 帖子物理ID |
| images | PRIMARY | id | 图片物理ID |
| tags | PRIMARY | id | 标签物理ID |
| post_tags | PRIMARY | id | 关联物理ID |

### 唯一索引

| 表名 | 索引名 | 字段 | 说明 |
|------|--------|------|------|
| users | idx_user_id | user_id | 用户业务ID唯一 |
| users | idx_username | username | 用户名唯一 |
| users | idx_email | email | 邮箱唯一 |
| posts | idx_post_id | post_id | 帖子业务ID唯一 |
| images | idx_image_id | image_id | 图片业务ID唯一 |
| tags | idx_tag_name | name | 标签名称唯一 |
| post_tags | idx_post_tag_unique | (post_id, tag_id) | 防止重复关联 |

### 外键索引

| 表名 | 索引名 | 字段 | 关联表 | 说明 |
|------|--------|------|--------|------|
| posts | idx_posts_user_id | user_id | users.id | 用户帖子查询 |
| images | idx_images_post_id | post_id | posts.id | 帖子图片查询 |
| images | idx_images_user_id | user_id | users.id | 用户图片查询 |
| post_tags | idx_post_tags_post_id | post_id | posts.id | 帖子标签查询 |
| post_tags | idx_post_tags_tag_id | tag_id | tags.id | 标签帖子查询 |

### 业务索引（性能优化）

| 表名 | 索引名 | 字段 | 说明 |
|------|--------|------|------|
| posts | idx_posts_create_time | create_time | Feed流按时间排序 |
| posts | idx_posts_user_create | (user_id, create_time) | 用户帖子列表 |
| images | idx_images_post_order | (post_id, display_order) | 按顺序获取帖子图片 |
| tags | idx_tags_use_count | use_count | 热门标签排序 |
| post_tags | idx_post_tags_tag_time | (tag_id, create_time) | 按标签查询帖子 |

---

## 约束说明

### 外键约束

| 约束名 | 子表 | 子表字段 | 父表 | 父表字段 | 级联操作 |
|--------|------|----------|------|----------|----------|
| fk_posts_user | posts | user_id | users | id | ON DELETE CASCADE |
| fk_images_post | images | post_id | posts | id | ON DELETE CASCADE |
| fk_images_user | images | user_id | users | id | ON DELETE CASCADE |
| fk_post_tags_post | post_tags | post_id | posts | id | ON DELETE CASCADE |
| fk_post_tags_tag | post_tags | tag_id | tags | id | ON DELETE CASCADE |

**级联删除规则**：
- 删除用户 → 自动删除其所有帖子 → 自动删除所有图片和标签关联
- 删除帖子 → 自动删除其所有图片和标签关联
- 删除标签 → 自动删除所有帖子关联

### 唯一约束

| 表名 | 约束名 | 字段 | 说明 |
|------|--------|------|------|
| users | uk_user_id | user_id | 用户业务ID唯一 |
| users | uk_username | username | 用户名唯一 |
| users | uk_email | email | 邮箱唯一 |
| posts | uk_post_id | post_id | 帖子业务ID唯一 |
| images | uk_image_id | image_id | 图片业务ID唯一 |
| tags | uk_tag_name | name | 标签名称唯一 |
| post_tags | uk_post_tag | (post_id, tag_id) | 防止重复关联 |

### 检查约束（业务规则）

| 表名 | 约束名 | 条件 | 说明 |
|------|--------|------|------|
| posts | chk_image_count | image_count >= 1 AND image_count <= 9 | 图片数量范围：1-9 |
| posts | chk_like_count | like_count >= 0 | 点赞数非负 |
| posts | chk_favorite_count | favorite_count >= 0 | 收藏数非负 |
| posts | chk_view_count | view_count >= 0 | 浏览数非负 |
| images | chk_display_order | display_order >= 1 AND display_order <= 9 | 显示顺序范围：1-9 |
| images | chk_file_size | file_size > 0 AND file_size <= 5242880 | 文件大小：0-5MB |
| images | chk_dimensions | width > 0 AND height > 0 | 图片尺寸必须大于0 |
| tags | chk_use_count | use_count >= 0 | 使用次数非负 |

---

## 数据迁移

### 从单图片模型到多图片帖子模型

**迁移时间**：2025-10-08

**迁移脚本**：`config/migration_to_posts.sql`

**迁移步骤**：

1. **创建posts表**
   ```sql
   CREATE TABLE posts (
       id INT AUTO_INCREMENT PRIMARY KEY,
       post_id VARCHAR(50) UNIQUE NOT NULL,
       user_id INT NOT NULL,
       title VARCHAR(255) NOT NULL,
       description TEXT,
       image_count INT DEFAULT 0,
       like_count INT DEFAULT 0,
       favorite_count INT DEFAULT 0,
       view_count INT DEFAULT 0,
       status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'APPROVED',
       create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
       update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
       FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
   );
   ```

2. **修改images表**
   ```sql
   ALTER TABLE images 
       DROP COLUMN title,
       DROP COLUMN description,
       DROP COLUMN like_count,
       DROP COLUMN favorite_count,
       DROP COLUMN view_count,
       DROP COLUMN status,
       ADD COLUMN post_id INT NOT NULL AFTER image_id,
       ADD COLUMN display_order INT DEFAULT 1 AFTER post_id,
       ADD FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE;
   ```

3. **重命名image_tags为post_tags**
   ```sql
   RENAME TABLE image_tags TO post_tags;
   ALTER TABLE post_tags CHANGE image_id post_id INT NOT NULL;
   ```

4. **数据迁移**
   - 将现有的3张图片转换为3个单图片帖子
   - 保留原有的标题、配文和统计数据

**迁移结果**：
- ✅ 3张图片 → 3个单图片帖子
- ✅ 数据完整性保持
- ✅ 外键关系正确
- ✅ 索引创建成功

---

**文档结束**

