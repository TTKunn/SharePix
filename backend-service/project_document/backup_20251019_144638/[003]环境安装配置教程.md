# [003] 环境安装配置教程

**创建时间**: 2024-09-29
**最后更新**: 2025-10-10
**项目**: Knot图片分享系统后端服务
**系统**: Ubuntu 20.04+ / CentOS 8+ / macOS  

## 1. 系统环境准备

### Ubuntu/Debian 系统
```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础开发工具
sudo apt install -y \
    build-essential \
    cmake \
    git \
    curl \
    wget \
    pkg-config \
    autoconf \
    libtool \
    unzip
```

### CentOS/RHEL 系统
```bash
# 更新系统包
sudo yum update -y

# 安装开发工具组
sudo yum groupinstall -y "Development Tools"
sudo yum install -y \
    cmake3 \
    git \
    curl \
    wget \
    pkg-config \
    autoconf \
    libtool \
    unzip

# 创建cmake软链接
sudo ln -s /usr/bin/cmake3 /usr/bin/cmake
```

## 2. MySQL 8.0 安装配置

### Ubuntu 安装 MySQL 8.0
```bash
# 下载MySQL APT配置包
wget https://dev.mysql.com/get/mysql-apt-config_0.8.24-1_all.deb
sudo dpkg -i mysql-apt-config_0.8.24-1_all.deb

# 更新包列表并安装MySQL
sudo apt update
sudo apt install -y mysql-server mysql-client libmysqlclient-dev

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

### CentOS 安装 MySQL 8.0
```bash
# 添加MySQL官方仓库
sudo yum install -y https://dev.mysql.com/get/mysql80-community-release-el8-1.noarch.rpm

# 安装MySQL
sudo yum install -y mysql-server mysql-devel

# 启动MySQL服务
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 获取临时密码
sudo grep 'temporary password' /var/log/mysqld.log

# 安全配置
sudo mysql_secure_installation
```

### MySQL 配置优化
```bash
# 编辑MySQL配置文件
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# 添加以下配置
[mysqld]
# 基础配置
default-authentication-plugin=mysql_native_password
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci

# 性能优化
innodb_buffer_pool_size=1G
max_connections=200
query_cache_size=64M
slow_query_log=1
long_query_time=2

# 重启MySQL服务
sudo systemctl restart mysql
```

### 创建项目数据库
```bash
# 登录MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE knot_image_sharing CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'knot_user'@'localhost' IDENTIFIED BY 'SecurePassword123!';
GRANT ALL PRIVILEGES ON knot_image_sharing.* TO 'knot_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

## 3. C++开发环境配置

### 安装C++17编译器
```bash
# Ubuntu
sudo apt install -y gcc-9 g++-9
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-9 90
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-9 90

# CentOS (需要启用devtoolset)
sudo yum install -y centos-release-scl
sudo yum install -y devtoolset-9-gcc devtoolset-9-gcc-c++
echo 'source /opt/rh/devtoolset-9/enable' >> ~/.bashrc
source ~/.bashrc
```

### 安装CMake 3.16+
```bash
# Ubuntu
sudo apt install -y cmake

# 如果版本过低，从源码安装
wget https://github.com/Kitware/CMake/releases/download/v3.25.0/cmake-3.25.0.tar.gz
tar -xzf cmake-3.25.0.tar.gz
cd cmake-3.25.0
./bootstrap
make -j$(nproc)
sudo make install
```

## 4. 依赖库安装

### 4.1 OpenSSL 安装
```bash
# Ubuntu
sudo apt install -y libssl-dev

# CentOS
sudo yum install -y openssl-devel

# 验证安装
openssl version
```

### 4.2 JsonCpp 编译安装 ⭐重要
```bash
# 下载JsonCpp源码
cd /tmp
git clone https://github.com/open-source-parsers/jsoncpp.git
cd jsoncpp

# 创建构建目录
mkdir build
cd build

# 配置编译选项
cmake -DCMAKE_BUILD_TYPE=Release \
      -DBUILD_SHARED_LIBS=ON \
      -DJSONCPP_WITH_TESTS=OFF \
      -DJSONCPP_WITH_POST_BUILD_UNITTEST=OFF \
      ..

# 编译和安装
make -j$(nproc)
sudo make install

# 更新链接库缓存
sudo ldconfig

# 验证安装
pkg-config --modversion jsoncpp
```

### 4.3 验证JsonCpp安装
```cpp
// 创建测试文件 test_jsoncpp.cpp
#include <json/json.h>
#include <iostream>

int main() {
    Json::Value root;
    root["name"] = "test";
    root["version"] = "1.0";
    
    Json::StreamWriterBuilder builder;
    std::string jsonString = Json::writeString(builder, root);
    std::cout << "JsonCpp works: " << jsonString << std::endl;
    
    return 0;
}
```

```bash
# 编译测试
g++ -std=c++17 test_jsoncpp.cpp -ljsoncpp -o test_jsoncpp
./test_jsoncpp
```

### 4.4 其他依赖库
```bash
# Ubuntu
sudo apt install -y \
    libcurl4-openssl-dev \
    zlib1g-dev \
    libpthread-stubs0-dev

# CentOS
sudo yum install -y \
    libcurl-devel \
    zlib-devel
```

## 5. 项目构建测试

### 5.1 测试当前项目编译
```bash
# 进入项目目录
cd /path/to/Knot/backend-service

# 清理之前的构建
rm -rf build
mkdir build
cd build

# 配置项目
cmake ..

# 编译项目
make -j$(nproc)

# 如果编译成功，会生成可执行文件
ls -la knot_image_sharing
```

### 5.2 常见编译问题解决

#### 问题1: JsonCpp找不到
```bash
# 解决方案1: 设置PKG_CONFIG_PATH
export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH

# 解决方案2: 手动指定路径
cmake -DJSONCPP_INCLUDE_DIRS=/usr/local/include \
      -DJSONCPP_LIBRARIES=/usr/local/lib/libjsoncpp.so \
      ..
```

#### 问题2: MySQL找不到
```bash
# Ubuntu
sudo apt install -y libmysqlclient-dev

# CentOS
sudo yum install -y mysql-devel

# 手动指定MySQL路径
cmake -DMYSQL_INCLUDE_DIR=/usr/include/mysql \
      -DMYSQL_LIBRARY=/usr/lib/x86_64-linux-gnu/libmysqlclient.so \
      ..
```

#### 问题3: C++17支持问题
```bash
# 确保使用支持C++17的编译器
gcc --version  # 需要GCC 7+
g++ --version

# 在CMakeLists.txt中确认C++标准设置
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

## 6. 开发工具推荐

### 6.1 IDE选择
- **VS Code**: 轻量级，插件丰富
- **CLion**: JetBrains出品，功能强大
- **Qt Creator**: 免费，C++支持好

### 6.2 VS Code 配置
```bash
# 安装VS Code
wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
sudo install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/
sudo sh -c 'echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list'
sudo apt update
sudo apt install -y code

# 推荐插件
code --install-extension ms-vscode.cpptools
code --install-extension ms-vscode.cmake-tools
code --install-extension ms-vscode.cpptools-extension-pack
```

## 7. 环境验证清单

### 7.1 系统环境检查
```bash
# 检查编译器版本
gcc --version    # 应该 >= 7.0
g++ --version    # 应该 >= 7.0
cmake --version  # 应该 >= 3.16

# 检查MySQL
mysql --version  # 应该是 8.0.x
systemctl status mysql  # 应该是 active (running)

# 检查JsonCpp
pkg-config --modversion jsoncpp  # 应该显示版本号
pkg-config --cflags jsoncpp      # 应该显示头文件路径
pkg-config --libs jsoncpp        # 应该显示库文件路径
```

### 7.2 项目编译检查
```bash
cd Knot/backend-service/build
make clean
make -j$(nproc)
echo $?  # 应该输出 0 (表示编译成功)
```

---
**下一步**: 环境配置完成后，我们就可以开始实施第一阶段的开发工作了！
