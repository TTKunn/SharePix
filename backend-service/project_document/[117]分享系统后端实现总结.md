# åˆ†äº«ç³»ç»Ÿåç«¯å®ç°æ€»ç»“

**æ–‡æ¡£ç¼–å·**: [117]  
**åˆ›å»ºæ—¶é—´**: 2025-10-16  
**ç‰ˆæœ¬**: v2.3.0  
**å®ç°çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ å®ç°æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„åˆ†äº«é“¾æ¥ç”Ÿæˆç³»ç»Ÿï¼Œæ”¯æŒå¼€å‘ç¯å¢ƒè‡ªå®šä¹‰Schemeå’Œç”Ÿäº§ç¯å¢ƒåŸŸåéªŒè¯ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **çŸ­é“¾æ¥ç”Ÿæˆ** - é›ªèŠ±IDç®—æ³• + Base62ç¼–ç 
2. **å»é‡é€»è¾‘** - åŒä¸€å¸–å­è¿”å›ç›¸åŒçŸ­é“¾æ¥
3. **ç¯å¢ƒé€‚é…** - æ ¹æ®é…ç½®è‡ªåŠ¨é€‰æ‹©Deep Linkæ ¼å¼
4. **APIæ¥å£** - åˆ›å»ºå’Œè§£æåˆ†äº«é“¾æ¥

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨

### share_links è¡¨

```sql
CREATE TABLE share_links (
  id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT 'ç‰©ç†ID',
  short_code VARCHAR(10) UNIQUE NOT NULL COMMENT 'çŸ­é“¾æ¥ç (Base62,8ä½)',
  target_type ENUM('POST') NOT NULL DEFAULT 'POST' COMMENT 'ç›®æ ‡ç±»å‹',
  target_id BIGINT NOT NULL COMMENT 'ç›®æ ‡å¸–å­ç‰©ç†ID',
  creator_id BIGINT COMMENT 'åˆ›å»ºè€…ID(å¯é€‰)',
  create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  expire_time TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´(å¯é€‰)',
  
  -- ç´¢å¼•
  UNIQUE KEY idx_short_code (short_code),
  KEY idx_target (target_type, target_id),
  KEY idx_creator (creator_id),
  KEY idx_create_time (create_time),
  
  -- å¤–é”®
  FOREIGN KEY (target_id) REFERENCES posts(id) ON DELETE CASCADE,
  FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åˆ†äº«é“¾æ¥è¡¨';
```

**å­—æ®µè¯´æ˜ï¼š**
- `short_code`: 8ä½Base62ç¼–ç ï¼Œ62^8 â‰ˆ 218ä¸‡äº¿ç§å¯èƒ½
- `target_type`: å½“å‰ä»…æ”¯æŒPOSTï¼Œé¢„ç•™USER/TAGæ‰©å±•
- `expire_time`: NULLè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ

---

## ğŸ”§ æ ¸å¿ƒå®ç°

### 1. Base62ç¼–ç å·¥å…·

**æ–‡ä»¶**: `src/utils/base62_encoder.{h,cpp}`

```cpp
// å°†int64ç¼–ç ä¸ºBase62å­—ç¬¦ä¸²
std::string Base62Encoder::encode(int64_t num, int minLength = 8);

// å°†Base62å­—ç¬¦ä¸²è§£ç ä¸ºint64
int64_t Base62Encoder::decode(const std::string& str);
```

**å­—ç¬¦é›†**: `0-9A-Za-z` (62ä¸ªå­—ç¬¦)

### 2. é›ªèŠ±IDç”Ÿæˆå™¨

**æ–‡ä»¶**: `src/utils/id_generator.{h,cpp}`

```cpp
// ç”Ÿæˆåˆ†äº«é“¾æ¥çŸ­ç 
std::string IdGenerator::generateShareCode();

// å†…éƒ¨ï¼šç”Ÿæˆé›ªèŠ±IDï¼ˆ64ä½ï¼‰
int64_t IdGenerator::generateSnowflakeId();
```

**é›ªèŠ±IDç»“æ„**:
- 1ä½ç¬¦å·ä½(0)
- 41ä½æ—¶é—´æˆ³(æ¯«ç§’)
- 10ä½æœºå™¨ID
- 12ä½åºåˆ—å·

### 3. ShareLinkæ¨¡å‹

**æ–‡ä»¶**: `src/models/share_link.{h,cpp}`

```cpp
class ShareLink {
    int64_t id_;
    std::string shortCode_;
    TargetType targetType_;
    int64_t targetId_;
    optional<int64_t> creatorId_;
    time_t createTime_;
    optional<time_t> expireTime_;
    
    bool isExpired() const;
    std::string getFullUrl() const;
    Json::Value toJson() const;
};
```

### 4. ShareLinkRepository

**æ–‡ä»¶**: `src/database/share_link_repository.{h,cpp}`

```cpp
class ShareLinkRepository {
    static bool create(ShareLink& link);
    static optional<ShareLink> findByShortCode(const string& code);
    static optional<ShareLink> findByTargetId(TargetType, int64_t id);
    static bool deleteById(int64_t id);
    static int deleteExpired();
};
```

### 5. ShareServiceä¸šåŠ¡é€»è¾‘

**æ–‡ä»¶**: `src/core/share_service.{h,cpp}`

```cpp
// åˆ›å»ºåˆ†äº«é“¾æ¥
CreateShareLinkResult createShareLink(
    int64_t postId,
    optional<int64_t> creatorId,
    int expireDays = 0
);

// è§£æåˆ†äº«é“¾æ¥
ResolveShareLinkResult resolveShareLink(const string& shortCode);
```

**æ ¸å¿ƒé€»è¾‘**:
1. æ£€æŸ¥å¸–å­æ˜¯å¦å­˜åœ¨
2. æŸ¥æ‰¾ç°æœ‰é“¾æ¥ï¼ˆå»é‡ï¼‰
3. ç”Ÿæˆå”¯ä¸€çŸ­ç 
4. ä¿å­˜åˆ°æ•°æ®åº“
5. ç”ŸæˆDeep Link URLsï¼ˆæ ¹æ®ç¯å¢ƒï¼‰

### 6. ShareHandler API

**æ–‡ä»¶**: `src/api/share_handler.{h,cpp}`

**æ¥å£1**: POST `/api/v1/posts/:post_id/share` (éœ€JWT)
```cpp
// åˆ›å»ºåˆ†äº«é“¾æ¥
Request Body: { "expire_days": 0 }
Response: { 
  "short_code": "kHr7ZS9a",
  "short_url": "http://host:port/s/kHr7ZS9a",
  "deep_links": { ... }
}
```

**æ¥å£2**: GET `/api/v1/share/:code` (å…¬å¼€)
```cpp
// è§£æåˆ†äº«é“¾æ¥
Response: { 
  "post": { ... },
  "expired": false
}
```

---

## ğŸŒ ç¯å¢ƒé…ç½®

### config.json é…ç½®

```json
{
  "server": {
    "domain": "knot.app",
    "environment": "development"  // æˆ– "production"
  }
}
```

### å¼€å‘ç¯å¢ƒ (development)

**è¿”å›æ ¼å¼**:
```json
{
  "deep_links": {
    "harmonyos": "knot://post/POST_XXX",
    "harmonyos_scheme": "knot://post/POST_XXX",
    "ios": "knot://post/POST_XXX",
    "android": "knot://post/POST_XXX",
    "environment": "development",
    "recommendation": "å¼€å‘ç¯å¢ƒï¼šå»ºè®®ä½¿ç”¨è‡ªå®šä¹‰Scheme (knot://)ï¼Œæ— éœ€åŸŸåå¤‡æ¡ˆ"
  }
}
```

**ç‰¹ç‚¹**:
- âœ… ä½¿ç”¨è‡ªå®šä¹‰Scheme (`knot://`)
- âœ… æ— éœ€åŸŸåå¤‡æ¡ˆ
- âœ… æ— éœ€HTTPSè¯ä¹¦
- âœ… æœ¬åœ°å³å¯æµ‹è¯•

### ç”Ÿäº§ç¯å¢ƒ (production)

**è¿”å›æ ¼å¼**:
```json
{
  "deep_links": {
    "harmonyos": "knot://post/POST_XXX",
    "harmonyos_scheme": "knot://post/POST_XXX",
    "harmonyos_app_link": "https://knot.app/post/POST_XXX",
    "ios": "https://knot.app/post/POST_XXX",
    "android": "https://knot.app/post/POST_XXX",
    "environment": "production"
  }
}
```

**è¦æ±‚**:
- âœ… åŸŸåå·²å¤‡æ¡ˆ
- âœ… é…ç½®HTTPSè¯ä¹¦
- âœ… éƒ¨ç½² .well-known éªŒè¯æ–‡ä»¶
- âœ… é…ç½®Nginxåå‘ä»£ç†

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

| æ¨¡å— | æ–‡ä»¶ | ä»£ç è¡Œæ•° |
|------|------|---------|
| Base62ç¼–ç  | base62_encoder.{h,cpp} | 136è¡Œ |
| IDç”Ÿæˆå™¨ | id_generator.{h,cpp} (æ‰©å±•) | +70è¡Œ |
| æ¨¡å‹å±‚ | share_link.{h,cpp} | 242è¡Œ |
| æ•°æ®å±‚ | share_link_repository.{h,cpp} | 783è¡Œ |
| ä¸šåŠ¡å±‚ | share_service.{h,cpp} | 315è¡Œ |
| APIå±‚ | share_handler.{h,cpp} | 261è¡Œ |
| **æ€»è®¡** | **10ä¸ªæ–‡ä»¶** | **1,737è¡Œ** |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### åˆ›å»ºåˆ†äº«é“¾æ¥

```bash
curl -X POST http://localhost:8080/api/v1/posts/1/share \
  -H "Authorization: Bearer JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"expire_days": 0}'
```

### è§£æåˆ†äº«é“¾æ¥

```bash
curl http://localhost:8080/api/v1/share/kHr7ZS9a
```

### é¢„æœŸç»“æœ

- âœ… çŸ­ç å”¯ä¸€ä¸”ç¨³å®šï¼ˆåŒä¸€å¸–å­è¿”å›ç›¸åŒçŸ­ç ï¼‰
- âœ… æ ¹æ®ç¯å¢ƒè¿”å›æ­£ç¡®çš„Deep Linkæ ¼å¼
- âœ… å»é‡é€»è¾‘æ­£å¸¸å·¥ä½œ
- âœ… è¿‡æœŸæ£€æŸ¥æ­£å¸¸

---

## ğŸ“ æŠ€æœ¯äº®ç‚¹

1. **é›ªèŠ±IDç®—æ³•** - ä¿è¯å…¨å±€å”¯ä¸€æ€§å’Œè¶‹åŠ¿é€’å¢
2. **Base62ç¼–ç ** - çŸ­å°ç²¾æ‚ï¼ŒURLå‹å¥½
3. **å»é‡é€»è¾‘** - é¿å…é‡å¤åˆ›å»ºï¼ŒèŠ‚çœå­˜å‚¨
4. **ç¯å¢ƒé€‚é…** - å¼€å‘/ç”Ÿäº§è‡ªåŠ¨åˆ‡æ¢
5. **çº§è”åˆ é™¤** - å¸–å­åˆ é™¤è‡ªåŠ¨æ¸…ç†åˆ†äº«é“¾æ¥
6. **è¿‡æœŸæœºåˆ¶** - æ”¯æŒä¸´æ—¶åˆ†äº«é“¾æ¥

---

## ğŸ”„ æœªæ¥æ‰©å±•

### æ”¯æŒæ›´å¤šç›®æ ‡ç±»å‹

```cpp
enum class TargetType {
    POST,   // âœ… å·²å®ç°
    USER,   // ğŸ”œ ç”¨æˆ·ä¸»é¡µ
    TAG     // ğŸ”œ æ ‡ç­¾é¡µ
};
```

### ç»Ÿè®¡åŠŸèƒ½

```sql
ALTER TABLE share_links ADD COLUMN click_count INT DEFAULT 0;
ALTER TABLE share_links ADD COLUMN last_click_time TIMESTAMP;
```

### çŸ­é“¾æ¥è·³è½¬

```nginx
# Nginxé…ç½®
location ~ ^/s/([a-zA-Z0-9]{8})$ {
    proxy_pass http://localhost:8080/api/v1/share/$1;
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [109]é˜¶æ®µD-3-åˆ†äº«ç³»ç»Ÿå®ç°è®¡åˆ’.md - å®Œæ•´å®æ–½æ–‡æ¡£
- [111]Deep Linké…ç½®ä½¿ç”¨æ•™ç¨‹-é¸¿è’™å¼€å‘æŒ‡å—.md - å‰ç«¯é…ç½®æŒ‡å—
- [000]APIæ–‡æ¡£.md - APIæ¥å£æ–‡æ¡£ï¼ˆv2.3.0ï¼‰

---

## âœ… å®Œæˆæ¸…å•

- [x] Base62ç¼–ç å·¥å…·
- [x] é›ªèŠ±IDç”Ÿæˆå™¨
- [x] ShareLinkæ¨¡å‹
- [x] ShareLinkRepositoryæ•°æ®è®¿é—®å±‚
- [x] ShareServiceä¸šåŠ¡é€»è¾‘å±‚
- [x] ShareHandler APIæ¥å£å±‚
- [x] è·¯ç”±æ³¨å†Œ
- [x] æ•°æ®åº“è¡¨åˆ›å»º
- [x] ç¯å¢ƒé…ç½®é€‚é…
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡
- [x] APIåŠŸèƒ½éªŒè¯

---

**å®ç°å®Œæˆæ—¥æœŸ**: 2025-10-16  
**ç¼–è¯‘çŠ¶æ€**: âœ… æˆåŠŸ  
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡




