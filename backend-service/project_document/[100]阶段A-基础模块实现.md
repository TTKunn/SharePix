# [007] é˜¶æ®µA - åŸºç¡€æ¨¡å—ä»£ç å®ç°è¯¦è§£

**åˆ›å»ºæ—¶é—´**: 2025-10-01
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è¯¦è§£
**ç›®æ ‡è¯»è€…**: å¼€å‘äººå‘˜
**è¦†ç›–èŒƒå›´**: é˜¶æ®µAï¼ˆé¡¹ç›®éª¨æ¶ï¼‰çš„æ‰€æœ‰åŸºç¡€æ¨¡å—

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£**é˜¶æ®µAï¼ˆé¡¹ç›®éª¨æ¶æ­å»ºï¼‰**ä¸­å®ç°çš„æ‰€æœ‰åŸºç¡€æ¨¡å—ä»£ç ã€‚

**å·²å®ç°æ¨¡å—**:
- âœ… é…ç½®ç®¡ç† (ConfigManager)
- âœ… æ—¥å¿—ç³»ç»Ÿ (Logger)
- âœ… ç”¨æˆ·æ¨¡å‹ (User)
- âœ… æ•°æ®åº“è¿æ¥æ±  (DatabaseConnectionPool)
- âœ… HTTP æœåŠ¡å™¨ (HttpServer)
- âœ… ä¸»ç¨‹åº (main.cpp)

**åç»­é˜¶æ®µ**:
- ğŸ”œ é˜¶æ®µB: è®¤è¯æ ¸å¿ƒæ¨¡å—ï¼ˆpassword_hasher, jwt_manager, auth_service, user_repositoryï¼‰
- ğŸ”œ é˜¶æ®µC: API æ¥å£æ¨¡å—ï¼ˆauth_handler, json_response, validatorï¼‰

---

## ğŸ“š ç›®å½•

1. [é…ç½®ç®¡ç†æ¨¡å— (ConfigManager)](#1-é…ç½®ç®¡ç†æ¨¡å—)
2. [æ—¥å¿—ç³»ç»Ÿæ¨¡å— (Logger)](#2-æ—¥å¿—ç³»ç»Ÿæ¨¡å—)
3. [ç”¨æˆ·æ¨¡å‹ (User)](#3-ç”¨æˆ·æ¨¡å‹)
4. [æ•°æ®åº“è¿æ¥æ±  (DatabaseConnectionPool)](#4-æ•°æ®åº“è¿æ¥æ± )
5. [HTTP æœåŠ¡å™¨ (HttpServer)](#5-http-æœåŠ¡å™¨)
6. [ä¸»ç¨‹åº (main.cpp)](#6-ä¸»ç¨‹åº)
7. [é¡¹ç›®æ¶æ„æ€»ç»“](#é¡¹ç›®æ¶æ„æ€»ç»“)

---

## 1. é…ç½®ç®¡ç†æ¨¡å—

### ğŸ“ æ–‡ä»¶ä½ç½®
- `src/utils/config_manager.h` - å¤´æ–‡ä»¶
- `src/utils/config_manager.cpp` - å®ç°æ–‡ä»¶

### ğŸ¯ ä½œç”¨
è´Ÿè´£ä» `config/config.json` åŠ è½½å’Œç®¡ç†åº”ç”¨ç¨‹åºçš„æ‰€æœ‰é…ç½®ä¿¡æ¯ã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡

#### 1.1 å•ä¾‹æ¨¡å¼ (Meyer's Singleton)
```cpp
static ConfigManager& getInstance() {
    static ConfigManager instance;  // C++11 ä¿è¯çº¿ç¨‹å®‰å…¨
    return instance;
}
```

**ä¸ºä»€ä¹ˆä½¿ç”¨å•ä¾‹ï¼Ÿ**
- å…¨å±€å”¯ä¸€çš„é…ç½®ç®¡ç†å™¨
- é¿å…é‡å¤åŠ è½½é…ç½®æ–‡ä»¶
- çº¿ç¨‹å®‰å…¨ï¼ˆC++11 æ ‡å‡†ä¿è¯ï¼‰

#### 1.2 é…ç½®åŠ è½½æµç¨‹
```cpp
bool loadConfig(const std::string& configPath) {
    // 1. æ‰“å¼€é…ç½®æ–‡ä»¶
    std::ifstream configFile(configPath);
    
    // 2. ä½¿ç”¨ JsonCpp è§£æ
    Json::CharReaderBuilder builder;
    Json::parseFromStream(builder, configFile, &config_, &errs);
    
    // 3. ä¿å­˜é…ç½®è·¯å¾„
    configPath_ = configPath;
}
```

#### 1.3 ç‚¹åˆ†è·¯å¾„è®¿é—®
```cpp
// æ”¯æŒåµŒå¥—è®¿é—®ï¼šconfig.get<int>("database.port")
const Json::Value* findValue(const std::string& keyPath) {
    // 1. æŒ‰ '.' åˆ†å‰²è·¯å¾„
    std::vector<std::string> keys;
    std::stringstream ss(keyPath);
    std::string key;
    while (std::getline(ss, key, '.')) {
        keys.push_back(key);
    }
    
    // 2. é€å±‚å¯¼èˆª JSON æ ‘
    const Json::Value* current = &config_;
    for (const auto& k : keys) {
        if (!current->isObject() || !current->isMember(k)) {
            return nullptr;  // è·¯å¾„ä¸å­˜åœ¨
        }
        current = &(*current)[k];
    }
    
    return current;
}
```

#### 1.4 æ¨¡æ¿æ–¹æ³• + ç‰¹åŒ–
```cpp
// æ¨¡æ¿å£°æ˜
template<typename T>
T get(const std::string& keyPath, const T& defaultValue = T{}) const;

// ç‰¹åŒ–å®ç°ï¼ˆæ”¯æŒ string, int, bool, doubleï¼‰
template<>
std::string ConfigManager::get<std::string>(
    const std::string& keyPath, 
    const std::string& defaultValue) const {
    const Json::Value* value = findValue(keyPath);
    if (value && value->isString()) {
        return value->asString();
    }
    return defaultValue;  // æ‰¾ä¸åˆ°æˆ–ç±»å‹ä¸åŒ¹é…è¿”å›é»˜è®¤å€¼
}
```

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
```cpp
auto& config = ConfigManager::getInstance();
config.loadConfig("config/config.json");

// è·å–é…ç½®
std::string host = config.get<std::string>("database.host", "localhost");
int port = config.get<int>("database.port", 3306);
bool enableCors = config.get<bool>("api.enable_cors", true);

// æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
if (config.has("jwt.secret")) {
    // ...
}
```

### âš ï¸ æ³¨æ„äº‹é¡¹
- é…ç½®æ–‡ä»¶å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼
- ç±»å‹ä¸åŒ¹é…æ—¶è¿”å›é»˜è®¤å€¼
- çº¿ç¨‹å®‰å…¨ï¼ˆconst æ–¹æ³•ï¼‰

---

## 2. æ—¥å¿—ç³»ç»Ÿæ¨¡å—

### ğŸ“ æ–‡ä»¶ä½ç½®
- `src/utils/logger.h` - å¤´æ–‡ä»¶
- `src/utils/logger.cpp` - å®ç°æ–‡ä»¶

### ğŸ¯ ä½œç”¨
å°è£… spdlog åº“ï¼Œæä¾›ç»Ÿä¸€çš„æ—¥å¿—æ¥å£ï¼Œæ”¯æŒæ–‡ä»¶å’Œæ§åˆ¶å°åŒè¾“å‡ºã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡

#### 2.1 æ—¥å¿—çº§åˆ«
```cpp
enum class LogLevel {
    DEBUG = 0,    // è°ƒè¯•ä¿¡æ¯
    INFO = 1,     // ä¸€èˆ¬ä¿¡æ¯
    WARNING = 2,  // è­¦å‘Š
    ERROR = 3,    // é”™è¯¯
    FATAL = 4     // è‡´å‘½é”™è¯¯
};
```

#### 2.2 åˆå§‹åŒ–æµç¨‹
```cpp
bool Logger::initialize(const std::string& logFile, 
                       LogLevel level,
                       bool consoleOutput) {
    std::lock_guard<std::mutex> lock(logMutex_);  // çº¿ç¨‹å®‰å…¨
    
    std::vector<spdlog::sink_ptr> sinks;
    
    // 1. æ§åˆ¶å°è¾“å‡º (å¸¦é¢œè‰²)
    if (consoleOutput) {
        auto console_sink = std::make_shared<spdlog::sinks::stdout_color_sink_mt>();
        sinks.push_back(console_sink);
    }
    
    // 2. æ–‡ä»¶è¾“å‡º (è½®è½¬)
    if (!logFile.empty()) {
        // è‡ªåŠ¨åˆ›å»ºæ—¥å¿—ç›®å½•
        createLogDirectory(logFile);
        
        // 10MB æ–‡ä»¶å¤§å°ï¼Œä¿ç•™ 5 ä¸ªæ–‡ä»¶
        auto file_sink = std::make_shared<spdlog::sinks::rotating_file_sink_mt>(
            logFile, 1024 * 1024 * 10, 5);
        sinks.push_back(file_sink);
    }
    
    // 3. åˆ›å»º logger
    auto logger = std::make_shared<spdlog::logger>("shared_parking", 
                                                   sinks.begin(), 
                                                   sinks.end());
    
    // 4. è®¾ç½®æ—¥å¿—æ ¼å¼
    logger->set_pattern("[%Y-%m-%d %H:%M:%S.%e] [%^%l%$] [thread %t] %v");
    //                   æ—¶é—´æˆ³              çº§åˆ«    çº¿ç¨‹ID   æ¶ˆæ¯
    
    // 5. æ³¨å†Œä¸ºé»˜è®¤ logger
    spdlog::set_default_logger(logger);
}
```

#### 2.3 è‡ªåŠ¨åˆ›å»ºæ—¥å¿—ç›®å½•
```cpp
// å¦‚æœæ—¥å¿—ç›®å½•ä¸å­˜åœ¨ï¼Œè‡ªåŠ¨åˆ›å»º
if (!logFile.empty()) {
    char* logFilePathCopy = strdup(logFileCopy.c_str());
    char* logDir = dirname(logFilePathCopy);  // è·å–ç›®å½•è·¯å¾„
    
    struct stat st;
    if (stat(logDir, &st) != 0) {
        // ç›®å½•ä¸å­˜åœ¨ï¼Œé€’å½’åˆ›å»º
        std::string mkdirCmd = "mkdir -p " + std::string(logDir);
        system(mkdirCmd.c_str());
    }
    free(logFilePathCopy);
}
```

#### 2.4 æ—¥å¿—è¾“å‡ºæ–¹æ³•
```cpp
// é™æ€æ–¹æ³•ï¼Œå…¨å±€å¯ç”¨
void Logger::info(const std::string& message) {
    if (currentLevel_ <= LogLevel::INFO) {
        spdlog::info(message);
    }
}

void Logger::error(const std::string& message) {
    if (currentLevel_ <= LogLevel::ERROR) {
        spdlog::error(message);
    }
}
```

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
```cpp
// åˆå§‹åŒ–
Logger::initialize("logs/app.log", LogLevel::INFO, true);

// ä½¿ç”¨
Logger::info("Server started successfully");
Logger::warning("Connection pool size is low");
Logger::error("Failed to connect to database: " + errorMsg);
Logger::debug("User data: " + userData);  // åªåœ¨ DEBUG çº§åˆ«è¾“å‡º
```

### ğŸ“Š æ—¥å¿—æ ¼å¼ç¤ºä¾‹
```
[2025-10-01 15:30:59.122] [info] [thread 113673] Configuration loaded successfully
[2025-10-01 15:30:59.155] [error] [thread 113673] Failed to connect to database
```

### âš ï¸ æ³¨æ„äº‹é¡¹
- çº¿ç¨‹å®‰å…¨ï¼ˆä½¿ç”¨ mutex ä¿æŠ¤ï¼‰
- æ—¥å¿—è½®è½¬è‡ªåŠ¨ç®¡ç†ï¼ˆ10MB ä¸€ä¸ªæ–‡ä»¶ï¼‰
- ERROR çº§åˆ«è‡ªåŠ¨åˆ·æ–°åˆ°ç£ç›˜

---

## 3. ç”¨æˆ·æ¨¡å‹

### ğŸ“ æ–‡ä»¶ä½ç½®
- `src/models/user.h` - å¤´æ–‡ä»¶
- `src/models/user.cpp` - å®ç°æ–‡ä»¶

### ğŸ¯ ä½œç”¨
è¡¨ç¤ºç³»ç»Ÿä¸­çš„ç”¨æˆ·å®ä½“ï¼Œæä¾› JSON åºåˆ—åŒ–/ååºåˆ—åŒ–å’ŒéªŒè¯åŠŸèƒ½ã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡

#### 3.1 ç”¨æˆ·çŠ¶æ€æšä¸¾
```cpp
enum class UserStatus {
    ACTIVE,      // æ´»è·ƒç”¨æˆ·
    INACTIVE,    // æœªæ¿€æ´»
    SUSPENDED    // å·²æš‚åœ
};
```

#### 3.2 ç”¨æˆ·å±æ€§
```cpp
class User {
private:
    int id_;                    // ç”¨æˆ·ID
    std::string username_;      // ç”¨æˆ·å
    std::string email_;         // é‚®ç®±
    std::string passwordHash_;  // å¯†ç å“ˆå¸Œ
    std::string salt_;          // ç›å€¼
    UserStatus status_;         // çŠ¶æ€
    std::time_t createdAt_;     // åˆ›å»ºæ—¶é—´
    std::time_t updatedAt_;     // æ›´æ–°æ—¶é—´
    std::time_t lastLoginAt_;   // æœ€åç™»å½•æ—¶é—´
};
```

#### 3.3 JSON åºåˆ—åŒ–
```cpp
Json::Value User::toJson(bool includeSecrets) const {
    Json::Value json;
    
    // åŸºæœ¬ä¿¡æ¯
    json["id"] = id_;
    json["username"] = username_;
    json["email"] = email_;
    
    // çŠ¶æ€è½¬æ¢
    switch (status_) {
        case UserStatus::ACTIVE:
            json["status"] = "active";
            break;
        case UserStatus::INACTIVE:
            json["status"] = "inactive";
            break;
        case UserStatus::SUSPENDED:
            json["status"] = "suspended";
            break;
    }
    
    // æ—¶é—´æˆ³
    json["created_at"] = static_cast<Json::Int64>(createdAt_);
    json["updated_at"] = static_cast<Json::Int64>(updatedAt_);
    
    // å¯é€‰ï¼šæœ€åç™»å½•æ—¶é—´
    if (lastLoginAt_ > 0) {
        json["last_login_at"] = static_cast<Json::Int64>(lastLoginAt_);
    } else {
        json["last_login_at"] = Json::Value::null;
    }
    
    // æ•æ„Ÿä¿¡æ¯ï¼ˆä»…å†…éƒ¨ä½¿ç”¨ï¼‰
    if (includeSecrets) {
        json["password_hash"] = passwordHash_;
        json["salt"] = salt_;
    }
    
    return json;
}
```

#### 3.4 JSON ååºåˆ—åŒ–
```cpp
User User::fromJson(const Json::Value& j) {
    User user;
    
    // å®‰å…¨åœ°æå–æ¯ä¸ªå­—æ®µ
    if (j.isMember("id") && j["id"].isInt()) {
        user.id_ = j["id"].asInt();
    }
    
    if (j.isMember("username") && j["username"].isString()) {
        user.username_ = j["username"].asString();
    }
    
    // çŠ¶æ€è½¬æ¢
    if (j.isMember("status") && j["status"].isString()) {
        std::string status = j["status"].asString();
        if (status == "active") {
            user.status_ = UserStatus::ACTIVE;
        } else if (status == "inactive") {
            user.status_ = UserStatus::INACTIVE;
        } else if (status == "suspended") {
            user.status_ = UserStatus::SUSPENDED;
        }
    }
    
    return user;
}
```

#### 3.5 æ•°æ®éªŒè¯
```cpp
std::string User::validate() const {
    // ç”¨æˆ·åéªŒè¯
    if (username_.empty()) {
        return "Username cannot be empty";
    }
    
    if (username_.length() < 3 || username_.length() > 50) {
        return "Username must be 3-50 characters";
    }
    
    // åªå…è®¸å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿
    std::regex usernameRegex("^[a-zA-Z0-9_]+$");
    if (!std::regex_match(username_, usernameRegex)) {
        return "Username can only contain letters, numbers, and underscores";
    }
    
    // é‚®ç®±éªŒè¯
    if (email_.empty()) {
        return "Email cannot be empty";
    }
    
    std::regex emailRegex(R"(^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$)");
    if (!std::regex_match(email_, emailRegex)) {
        return "Invalid email format";
    }
    
    if (email_.length() > 100) {
        return "Email cannot exceed 100 characters";
    }
    
    return "";  // éªŒè¯é€šè¿‡
}
```

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
```cpp
// åˆ›å»ºç”¨æˆ·
User user(1, "john_doe", "john@example.com");
user.setPasswordHash("hashed_password");
user.setSalt("random_salt");

// éªŒè¯
std::string error = user.validate();
if (!error.empty()) {
    Logger::error("Validation failed: " + error);
}

// è½¬æ¢ä¸º JSONï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰
Json::Value json = user.toJson(false);

// ä» JSON åˆ›å»ºç”¨æˆ·
User newUser = User::fromJson(json);
```

---


# [007-2] ä»£ç å®ç°è¯¦ç»†è®²è§£ - æ•°æ®åº“å’ŒHTTPæœåŠ¡å™¨

**åˆ›å»ºæ—¶é—´**: 2025-10-01  
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è¯¦è§£ï¼ˆç»­ï¼‰  
**å‰ç½®æ–‡æ¡£**: [007]ä»£ç å®ç°è¯¦ç»†è®²è§£.md

---

## 4. æ•°æ®åº“è¿æ¥æ± 

### ğŸ“ æ–‡ä»¶ä½ç½®
- `src/database/connection_pool.h` - å¤´æ–‡ä»¶
- `src/database/connection_pool.cpp` - å®ç°æ–‡ä»¶

### ğŸ¯ ä½œç”¨
ç®¡ç† MySQL æ•°æ®åº“è¿æ¥ï¼Œæä¾›è¿æ¥æ± åŠŸèƒ½ï¼Œé¿å…é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥ã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡

#### 4.1 RAII è¿æ¥å°è£…
```cpp
class MySQLConnection {
public:
    explicit MySQLConnection(MYSQL* conn) : connection_(conn) {}
    
    ~MySQLConnection() {
        if (connection_) {
            mysql_close(connection_);  // è‡ªåŠ¨å…³é—­è¿æ¥
            connection_ = nullptr;
        }
    }
    
    MYSQL* get() const { return connection_; }
    
    bool isValid() const {
        return connection_ && mysql_ping(connection_) == 0;
    }
    
private:
    MYSQL* connection_;
};
```

**RAII ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨èµ„æºç®¡ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- âœ… å¼‚å¸¸å®‰å…¨
- âœ… æ— éœ€æ‰‹åŠ¨è°ƒç”¨ `mysql_close()`

#### 4.2 è¿æ¥æ± æ¶æ„
```cpp
class DatabaseConnectionPool {
private:
    std::queue<std::unique_ptr<MySQLConnection>> connections_;  // è¿æ¥é˜Ÿåˆ—
    mutable std::mutex poolMutex_;                              // äº’æ–¥é”
    std::condition_variable poolCondition_;                     // æ¡ä»¶å˜é‡
    
    std::string host_;
    int port_;
    std::string database_;
    std::string username_;
    std::string password_;
    int poolSize_;          // è¿æ¥æ± å¤§å°
    bool initialized_;
};
```

**è®¾è®¡è¦ç‚¹**:
- `std::queue`: å…ˆè¿›å…ˆå‡ºï¼Œå…¬å¹³åˆ†é…è¿æ¥
- `std::mutex`: ä¿æŠ¤å…±äº«èµ„æº
- `std::condition_variable`: å®ç°ç­‰å¾…/é€šçŸ¥æœºåˆ¶
- `std::unique_ptr`: ç¡®ä¿è¿æ¥çš„å”¯ä¸€æ‰€æœ‰æƒ

#### 4.3 åˆå§‹åŒ–æµç¨‹
```cpp
bool DatabaseConnectionPool::initialize() {
    std::lock_guard<std::mutex> lock(poolMutex_);
    
    // 1. åˆå§‹åŒ– MySQL åº“
    mysql_library_init(0, nullptr, nullptr);
    
    // 2. ä»é…ç½®åŠ è½½å‚æ•°
    auto& config = ConfigManager::getInstance();
    host_ = config.get<std::string>("database.host", "localhost");
    port_ = config.get<int>("database.port", 3306);
    database_ = config.get<std::string>("database.database", "");
    username_ = config.get<std::string>("database.username", "");
    password_ = config.get<std::string>("database.password", "");
    poolSize_ = config.get<int>("database.pool_size", 10);
    
    Logger::info("Initializing database connection pool...");
    Logger::info("Host: " + host_ + ":" + std::to_string(port_));
    Logger::info("Database: " + database_);
    Logger::info("Pool size: " + std::to_string(poolSize_));
    
    // 3. æµ‹è¯•è¿æ¥
    if (!testConnection()) {
        Logger::error("Failed to connect to database");
        return false;
    }
    
    // 4. åˆ›å»ºè¿æ¥æ± 
    for (int i = 0; i < poolSize_; ++i) {
        auto conn = createConnection();
        if (conn) {
            connections_.push(std::move(conn));
        } else {
            Logger::error("Failed to create connection " + std::to_string(i + 1));
            return false;
        }
    }
    
    initialized_ = true;
    Logger::info("Database connection pool initialized successfully");
    
    return true;
}
```

#### 4.4 åˆ›å»ºè¿æ¥
```cpp
std::unique_ptr<MySQLConnection> DatabaseConnectionPool::createConnection() {
    MYSQL* mysql = mysql_init(nullptr);
    if (!mysql) {
        Logger::error("Failed to initialize MySQL connection");
        return nullptr;
    }
    
    // è®¾ç½®è¿æ¥é€‰é¡¹
    unsigned int timeout = connectionTimeout_;
    mysql_options(mysql, MYSQL_OPT_CONNECT_TIMEOUT, &timeout);
    mysql_options(mysql, MYSQL_OPT_READ_TIMEOUT, &timeout);
    mysql_options(mysql, MYSQL_OPT_WRITE_TIMEOUT, &timeout);
    
    // è‡ªåŠ¨é‡è¿ï¼ˆMySQL 8.0 å·²å¼ƒç”¨ï¼‰
    my_bool reconnect = 1;
    mysql_options(mysql, MYSQL_OPT_RECONNECT, &reconnect);
    
    // è®¾ç½®å­—ç¬¦é›†
    mysql_options(mysql, MYSQL_SET_CHARSET_NAME, "utf8mb4");
    
    // è¿æ¥æ•°æ®åº“
    if (!mysql_real_connect(mysql, 
                           host_.c_str(), 
                           username_.c_str(), 
                           password_.c_str(), 
                           database_.c_str(), 
                           port_, 
                           nullptr,  // unix_socket
                           0)) {     // client_flag
        Logger::error("MySQL connection failed: " + std::string(mysql_error(mysql)));
        mysql_close(mysql);
        return nullptr;
    }
    
    return std::make_unique<MySQLConnection>(mysql);
}
```

#### 4.5 è·å–è¿æ¥ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰
```cpp
std::unique_ptr<MySQLConnection> DatabaseConnectionPool::getConnection() {
    std::unique_lock<std::mutex> lock(poolMutex_);
    
    // ç­‰å¾…ç›´åˆ°æœ‰å¯ç”¨è¿æ¥
    poolCondition_.wait(lock, [this] { 
        return !connections_.empty(); 
    });
    
    // ä»é˜Ÿåˆ—å–å‡ºè¿æ¥
    auto conn = std::move(connections_.front());
    connections_.pop();
    
    // æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ
    if (!conn->isValid()) {
        Logger::warning("Connection is invalid, creating new one");
        lock.unlock();  // é‡Šæ”¾é”ï¼Œé¿å…æ­»é”
        conn = createConnection();
    }
    
    return conn;
}
```

**çº¿ç¨‹å®‰å…¨åˆ†æ**:
1. `unique_lock`: å¯ä»¥æ‰‹åŠ¨è§£é”ï¼Œæ¯” `lock_guard` æ›´çµæ´»
2. `condition_variable::wait()`: åŸå­åœ°é‡Šæ”¾é”å¹¶ç­‰å¾…
3. ç­‰å¾…æ¡ä»¶: `!connections_.empty()` - æœ‰å¯ç”¨è¿æ¥

#### 4.6 å½’è¿˜è¿æ¥
```cpp
void DatabaseConnectionPool::returnConnection(std::unique_ptr<MySQLConnection> conn) {
    if (!conn) {
        return;
    }
    
    std::lock_guard<std::mutex> lock(poolMutex_);
    
    // æ£€æŸ¥è¿æ¥æ˜¯å¦æœ‰æ•ˆ
    if (conn->isValid()) {
        connections_.push(std::move(conn));
    } else {
        // æ— æ•ˆè¿æ¥ï¼Œåˆ›å»ºæ–°çš„
        Logger::warning("Returned connection is invalid, creating new one");
        auto newConn = createConnection();
        if (newConn) {
            connections_.push(std::move(newConn));
        }
    }
    
    // é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
    poolCondition_.notify_one();
}
```

#### 4.7 æ‰§è¡ŒæŸ¥è¯¢
```cpp
// MySQLConnection ç±»çš„æ–¹æ³•
bool MySQLConnection::execute(const std::string& query) {
    if (!connection_) {
        return false;
    }
    
    int result = mysql_real_query(connection_, query.c_str(), query.length());
    if (result != 0) {
        Logger::error("MySQL query failed: " + std::string(mysql_error(connection_)));
        return false;
    }
    
    return true;
}

MYSQL_RES* MySQLConnection::executeQuery(const std::string& query) {
    if (!execute(query)) {
        return nullptr;
    }
    
    MYSQL_RES* result = mysql_store_result(connection_);
    if (!result && mysql_field_count(connection_) > 0) {
        Logger::error("MySQL store result failed: " + std::string(mysql_error(connection_)));
        return nullptr;
    }
    
    return result;
}
```

#### 4.8 ç»Ÿè®¡ä¿¡æ¯
```cpp
Json::Value DatabaseConnectionPool::getStats() const {
    std::lock_guard<std::mutex> lock(poolMutex_);
    
    Json::Value stats;
    stats["pool_size"] = poolSize_;
    stats["available_connections"] = static_cast<int>(connections_.size());
    stats["active_connections"] = poolSize_ - static_cast<int>(connections_.size());
    stats["initialized"] = initialized_;
    
    return stats;
}
```

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
```cpp
// åˆå§‹åŒ–è¿æ¥æ± 
auto& pool = DatabaseConnectionPool::getInstance();
if (!pool.initialize()) {
    Logger::error("Failed to initialize connection pool");
    return 1;
}

// è·å–è¿æ¥
auto conn = pool.getConnection();
if (conn && conn->isValid()) {
    // æ‰§è¡ŒæŸ¥è¯¢
    MYSQL_RES* result = conn->executeQuery("SELECT * FROM users WHERE id = 1");
    if (result) {
        // å¤„ç†ç»“æœ
        MYSQL_ROW row;
        while ((row = mysql_fetch_row(result))) {
            std::cout << "Username: " << row[1] << std::endl;
        }
        mysql_free_result(result);
    }
    
    // å½’è¿˜è¿æ¥
    pool.returnConnection(std::move(conn));
}

// æŸ¥çœ‹ç»Ÿè®¡
Json::Value stats = pool.getStats();
std::cout << "Available: " << stats["available_connections"].asInt() << std::endl;
std::cout << "Active: " << stats["active_connections"].asInt() << std::endl;
```

### ğŸ”’ çº¿ç¨‹å®‰å…¨æœºåˆ¶

| æœºåˆ¶ | ä½œç”¨ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `std::mutex` | ä¿æŠ¤å…±äº«èµ„æº | è®¿é—®è¿æ¥é˜Ÿåˆ—æ—¶ |
| `std::condition_variable` | ç­‰å¾…/é€šçŸ¥ | è¿æ¥æ± ä¸ºç©ºæ—¶ç­‰å¾… |
| `std::unique_ptr` | å”¯ä¸€æ‰€æœ‰æƒ | ç¡®ä¿è¿æ¥ä¸è¢«å¤åˆ¶ |
| `std::lock_guard` | è‡ªåŠ¨åŠ é”/è§£é” | ç®€å•çš„ä¸´ç•ŒåŒº |
| `std::unique_lock` | æ‰‹åŠ¨æ§åˆ¶é” | éœ€è¦æå‰è§£é”çš„åœºæ™¯ |

### âš ï¸ æ³¨æ„äº‹é¡¹
- è¿æ¥æ± å¤§å°å»ºè®®: CPU æ ¸å¿ƒæ•° Ã— 2-4
- `MYSQL_OPT_RECONNECT` åœ¨ MySQL 8.0 å·²å¼ƒç”¨
- ä½¿ç”¨ `mysql_ping()` æ£€æŸ¥è¿æ¥æœ‰æ•ˆæ€§
- å½’è¿˜è¿æ¥æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶é‡å»ºæ— æ•ˆè¿æ¥

---

## 5. HTTP æœåŠ¡å™¨

### ğŸ“ æ–‡ä»¶ä½ç½®
- `src/server/http_server.h` - å¤´æ–‡ä»¶
- `src/server/http_server.cpp` - å®ç°æ–‡ä»¶

### ğŸ¯ ä½œç”¨
åŸºäº cpp-httplib å®ç° HTTP æœåŠ¡å™¨ï¼Œæä¾› RESTful API æ¥å£ã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡

#### 5.1 æœåŠ¡å™¨æ¶æ„
```cpp
class HttpServer {
private:
    std::unique_ptr<httplib::Server> server_;  // HTTP æœåŠ¡å™¨å®ä¾‹
    std::string host_;                         // ç›‘å¬åœ°å€
    int port_;                                 // ç›‘å¬ç«¯å£
    bool running_;                             // è¿è¡ŒçŠ¶æ€
};
```

#### 5.2 åˆå§‹åŒ–æµç¨‹
```cpp
bool HttpServer::initialize() {
    try {
        // 1. åŠ è½½é…ç½®
        auto& config = ConfigManager::getInstance();
        host_ = config.get<std::string>("server.host", "0.0.0.0");
        port_ = config.get<int>("server.port", 8080);
        
        Logger::info("Initializing HTTP server on " + host_ + ":" + std::to_string(port_));
        
        // 2. è®¾ç½®ä¸­é—´ä»¶
        setupMiddleware();
        
        // 3. è®¾ç½® CORS
        setupCORS();
        
        // 4. è®¾ç½®è·¯ç”±
        setupRoutes();
        
        // 5. è®¾ç½®é”™è¯¯å¤„ç†
        setupErrorHandlers();
        
        Logger::info("HTTP server initialized successfully");
        return true;
        
    } catch (const std::exception& e) {
        Logger::error("Failed to initialize HTTP server: " + std::string(e.what()));
        return false;
    }
}
```

#### 5.3 ä¸­é—´ä»¶ï¼šè¯·æ±‚æ—¥å¿—
```cpp
void HttpServer::setupMiddleware() {
    // å‰ç½®è·¯ç”±å¤„ç†å™¨ï¼ˆè¯·æ±‚æ—¥å¿—ï¼‰
    server_->set_pre_routing_handler([](const httplib::Request& req, 
                                        httplib::Response& res) {
        Logger::info("Request: " + req.method + " " + req.path);
        return httplib::Server::HandlerResponse::Unhandled;
    });
}
```

**å·¥ä½œåŸç†**:
- åœ¨è·¯ç”±åŒ¹é…å‰æ‰§è¡Œ
- è®°å½•æ‰€æœ‰è¯·æ±‚
- è¿”å› `Unhandled` ç»§ç»­å¤„ç†

#### 5.4 CORS æ”¯æŒ
```cpp
void HttpServer::setupCORS() {
    // åç½®è·¯ç”±å¤„ç†å™¨ï¼ˆCORS å¤´ï¼‰
    server_->set_post_routing_handler([](const httplib::Request& req, 
                                         httplib::Response& res) {
        res.set_header("Access-Control-Allow-Origin", "*");
        res.set_header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
        res.set_header("Access-Control-Allow-Headers", "Content-Type, Authorization");
    });
}
```

**CORS å¤´è¯´æ˜**:
- `Access-Control-Allow-Origin`: å…è®¸çš„æ¥æºï¼ˆ`*` = æ‰€æœ‰ï¼‰
- `Access-Control-Allow-Methods`: å…è®¸çš„ HTTP æ–¹æ³•
- `Access-Control-Allow-Headers`: å…è®¸çš„è¯·æ±‚å¤´

âš ï¸ **ç”Ÿäº§ç¯å¢ƒå»ºè®®**: å°† `*` æ”¹ä¸ºå…·ä½“çš„åŸŸååˆ—è¡¨

#### 5.5 è·¯ç”±è®¾ç½®
```cpp
void HttpServer::setupRoutes() {
    // å¥åº·æ£€æŸ¥
    server_->Get("/health", [this](const httplib::Request& req, 
                                   httplib::Response& res) {
        handleHealthCheck(req, res);
    });
    
    // æŒ‡æ ‡æŸ¥è¯¢
    server_->Get("/metrics", [this](const httplib::Request& req, 
                                    httplib::Response& res) {
        handleMetrics(req, res);
    });
    
    // API ç‰ˆæœ¬
    server_->Get("/api/v1/version", [](const httplib::Request& req, 
                                       httplib::Response& res) {
        Json::Value response;
        response["version"] = "1.0.0";
        response["service"] = "Shared Parking Authentication Service";
        response["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
        
        Json::StreamWriterBuilder writer;
        std::string jsonStr = Json::writeString(writer, response);
        
        res.set_content(jsonStr, "application/json");
        res.status = 200;
    });
}
```

**Lambda è¡¨è¾¾å¼è¯´æ˜**:
- `[this]`: æ•è· `this` æŒ‡é’ˆï¼Œå¯ä»¥è°ƒç”¨æˆå‘˜æ–¹æ³•
- `[]`: ä¸æ•è·ä»»ä½•å˜é‡
- `const httplib::Request& req`: è¯·æ±‚å¯¹è±¡
- `httplib::Response& res`: å“åº”å¯¹è±¡

#### 5.6 å¥åº·æ£€æŸ¥ç«¯ç‚¹
```cpp
void HttpServer::handleHealthCheck(const httplib::Request& req, 
                                   httplib::Response& res) {
    Json::Value response;
    response["status"] = "healthy";
    response["service"] = "Shared Parking Authentication Service";
    response["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
    
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    auto& dbPool = DatabaseConnectionPool::getInstance();
    auto conn = dbPool.getConnection();
    
    if (conn && conn->isValid()) {
        response["database"] = "connected";
        dbPool.returnConnection(std::move(conn));
    } else {
        response["database"] = "disconnected";
        response["status"] = "unhealthy";
    }
    
    Json::StreamWriterBuilder writer;
    std::string jsonStr = Json::writeString(writer, response);
    
    res.set_content(jsonStr, "application/json");
    res.status = (response["status"].asString() == "healthy") ? 200 : 503;
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "status": "healthy",
  "service": "Shared Parking Authentication Service",
  "database": "connected",
  "timestamp": 1759303899
}
```

#### 5.7 æŒ‡æ ‡ç«¯ç‚¹
```cpp
void HttpServer::handleMetrics(const httplib::Request& req, 
                               httplib::Response& res) {
    Json::Value response;
    
    // æœåŠ¡å™¨æŒ‡æ ‡
    Json::Value serverMetrics;
    serverMetrics["running"] = running_;
    serverMetrics["host"] = host_;
    serverMetrics["port"] = port_;
    response["server"] = serverMetrics;
    
    // æ•°æ®åº“æŒ‡æ ‡
    auto& dbPool = DatabaseConnectionPool::getInstance();
    response["database"] = dbPool.getStats();
    
    // æ—¶é—´æˆ³
    response["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
    
    Json::StreamWriterBuilder writer;
    std::string jsonStr = Json::writeString(writer, response);
    
    res.set_content(jsonStr, "application/json");
    res.status = 200;
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "server": {
    "running": true,
    "host": "0.0.0.0",
    "port": 8080
  },
  "database": {
    "pool_size": 10,
    "available_connections": 10,
    "active_connections": 0,
    "initialized": true
  },
  "timestamp": 1759303910
}
```

#### 5.8 é”™è¯¯å¤„ç†
```cpp
void HttpServer::setupErrorHandlers() {
    // 404 Not Found
    server_->set_error_handler([](const httplib::Request& req, 
                                  httplib::Response& res) {
        Json::Value error;
        error["success"] = false;
        error["error"] = "Not Found";
        error["message"] = "The requested endpoint does not exist";
        error["path"] = req.path;
        error["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
        
        Json::StreamWriterBuilder writer;
        std::string jsonStr = Json::writeString(writer, error);
        
        res.set_content(jsonStr, "application/json");
    });
    
    // å¼‚å¸¸å¤„ç†
    server_->set_exception_handler([](const httplib::Request& req, 
                                      httplib::Response& res, 
                                      std::exception_ptr ep) {
        try {
            std::rethrow_exception(ep);
        } catch (const std::exception& e) {
            Logger::error("Exception in request handler: " + std::string(e.what()));
            
            Json::Value error;
            error["success"] = false;
            error["error"] = "Internal Server Error";
            error["message"] = "An unexpected error occurred";
            error["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
            
            Json::StreamWriterBuilder writer;
            std::string jsonStr = Json::writeString(writer, error);
            
            res.set_content(jsonStr, "application/json");
            res.status = 500;
        }
    });
}
```

### ğŸ“¡ API ç«¯ç‚¹æ€»ç»“

| ç«¯ç‚¹ | æ–¹æ³• | æè¿° | çŠ¶æ€ç  |
|------|------|------|--------|
| `/health` | GET | å¥åº·æ£€æŸ¥ | 200/503 |
| `/metrics` | GET | æœåŠ¡å™¨æŒ‡æ ‡ | 200 |
| `/api/v1/version` | GET | API ç‰ˆæœ¬ | 200 |
| å…¶ä»– | ANY | 404 é”™è¯¯ | 404 |

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# æŸ¥çœ‹æŒ‡æ ‡
curl http://localhost:8080/metrics

# API ç‰ˆæœ¬
curl http://localhost:8080/api/v1/version

# 404 æµ‹è¯•
curl http://localhost:8080/nonexistent
```

### âš ï¸ æ³¨æ„äº‹é¡¹
- `server->listen()` æ˜¯**é˜»å¡è°ƒç”¨**ï¼Œä¼šé˜»å¡å½“å‰çº¿ç¨‹
- CORS è®¾ç½®å…è®¸æ‰€æœ‰æ¥æºï¼ˆç”Ÿäº§ç¯å¢ƒéœ€é™åˆ¶ï¼‰
- æ‰€æœ‰é”™è¯¯å“åº”éƒ½æ˜¯ç»Ÿä¸€çš„ JSON æ ¼å¼
- å¼‚å¸¸ä¼šè¢«æ•è·å¹¶è¿”å› 500 é”™è¯¯

---

## ğŸ“š æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è®²è§£äº†ï¼š
1. **æ•°æ®åº“è¿æ¥æ± **: RAIIã€çº¿ç¨‹å®‰å…¨ã€è¿æ¥ç®¡ç†
2. **HTTP æœåŠ¡å™¨**: è·¯ç”±ã€ä¸­é—´ä»¶ã€CORSã€é”™è¯¯å¤„ç†

**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ [007-3]ä»£ç å®ç°è¯¦ç»†è®²è§£-ä¸»ç¨‹åº.md äº†è§£ä¸»ç¨‹åºçš„å®ç°ã€‚

# [007-3] ä»£ç å®ç°è¯¦ç»†è®²è§£ - ä¸»ç¨‹åºå’Œæ€»ç»“

**åˆ›å»ºæ—¶é—´**: 2025-10-01  
**æ–‡æ¡£ç±»å‹**: æŠ€æœ¯è¯¦è§£ï¼ˆå®Œç»“ç¯‡ï¼‰  
**å‰ç½®æ–‡æ¡£**: [007]ä»£ç å®ç°è¯¦ç»†è®²è§£.md, [007-2]ä»£ç å®ç°è¯¦ç»†è®²è§£-æ•°æ®åº“å’ŒHTTPæœåŠ¡å™¨.md

---

## 6. ä¸»ç¨‹åº (main.cpp)

### ğŸ“ æ–‡ä»¶ä½ç½®
- `src/main.cpp` - ä¸»ç¨‹åºå…¥å£

### ğŸ¯ ä½œç”¨
åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ï¼Œè´Ÿè´£åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—å¹¶å¯åŠ¨æœåŠ¡å™¨ã€‚

### ğŸ”‘ æ ¸å¿ƒè®¾è®¡

#### 6.1 ç¨‹åºå¯åŠ¨æµç¨‹
```
1. æ‰“å° Banner
2. è®¾ç½®ä¿¡å·å¤„ç†å™¨
3. åŠ è½½é…ç½®æ–‡ä»¶
4. åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
5. åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± 
6. åˆ›å»º HTTP æœåŠ¡å™¨
7. å¯åŠ¨æœåŠ¡å™¨ï¼ˆé˜»å¡ï¼‰
```

#### 6.2 Banner æ˜¾ç¤º
```cpp
void printBanner() {
    std::cout << R"(
    ____  __                      __   ____             __   _            
   / ___\/ /_  ____ _________  ___/ /  / __ \____ ______/ /__(_)___  ____ _
   \__ \/ __ \/ __ `/ ___/ _ \/ __  /  / /_/ / __ `/ ___/ //_/ / __ \/ __ `/
  ___/ / / / / /_/ / /  /  __/ /_/ /  / ____/ /_/ / /  / ,< / / / / / /_/ / 
 /____/_/ /_/\__,_/_/   \___/\__,_/  /_/    \__,_/_/  /_/|_/_/_/ /_/\__, /  
                                                                   /____/   
 Authentication Service v1.0.0
 )" << std::endl;
}
```

**ä½œç”¨**: ç¾åŒ–å¯åŠ¨ç•Œé¢ï¼Œæ˜¾ç¤ºåº”ç”¨åç§°å’Œç‰ˆæœ¬

#### 6.3 ä¿¡å·å¤„ç†å™¨
```cpp
// å…¨å±€æœåŠ¡å™¨å®ä¾‹ï¼ˆç”¨äºä¿¡å·å¤„ç†ï¼‰
std::unique_ptr<HttpServer> g_server;

void signalHandler(int signal) {
    Logger::info("Received signal " + std::to_string(signal) + 
                 ", shutting down gracefully...");
    
    if (g_server) {
        g_server->stop();
    }
    
    Logger::info("Server stopped successfully");
    exit(0);
}

void setupSignalHandlers() {
    signal(SIGINT, signalHandler);   // Ctrl+C
    signal(SIGTERM, signalHandler);  // kill å‘½ä»¤
    signal(SIGQUIT, signalHandler);  // Ctrl+\
}
```

**ä¼˜é›…å…³é—­æµç¨‹**:
1. æ¥æ”¶ä¿¡å·ï¼ˆSIGINT, SIGTERM, SIGQUITï¼‰
2. è®°å½•æ—¥å¿—
3. åœæ­¢ HTTP æœåŠ¡å™¨
4. é€€å‡ºç¨‹åº

#### 6.4 é…ç½®åŠ è½½
```cpp
// é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„
std::string configPath = "config/config.json";

// æ”¯æŒå‘½ä»¤è¡Œå‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶
if (argc > 1) {
    configPath = argv[1];
}

std::cout << "Loading configuration from: " << configPath << std::endl;

if (!ConfigManager::getInstance().loadConfig(configPath)) {
    std::cerr << "Failed to load configuration file: " << configPath << std::endl;
    return 1;
}
```

**ä½¿ç”¨æ–¹å¼**:
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
./shared_parking_auth

# æŒ‡å®šé…ç½®æ–‡ä»¶
./shared_parking_auth /path/to/custom/config.json
```

#### 6.5 æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–
```cpp
// ä»é…ç½®è¯»å–æ—¥å¿—å‚æ•°
auto& config = ConfigManager::getInstance();
std::string logFile = config.get<std::string>("logging.file", "logs/app.log");
std::string logLevelStr = config.get<std::string>("logging.level", "info");
bool consoleOutput = config.get<bool>("logging.console_output", true);

// è½¬æ¢æ—¥å¿—çº§åˆ«å­—ç¬¦ä¸²ä¸ºæšä¸¾
LogLevel logLevel = LogLevel::INFO;
if (logLevelStr == "debug") logLevel = LogLevel::DEBUG;
else if (logLevelStr == "info") logLevel = LogLevel::INFO;
else if (logLevelStr == "warning") logLevel = LogLevel::WARNING;
else if (logLevelStr == "error") logLevel = LogLevel::ERROR;
else if (logLevelStr == "fatal") logLevel = LogLevel::FATAL;

// åˆå§‹åŒ– Logger
if (!Logger::initialize(logFile, logLevel, consoleOutput)) {
    std::cerr << "Failed to initialize logger" << std::endl;
    return 1;
}

Logger::info("Configuration loaded successfully");
Logger::info("Initializing authentication service...");
```

**é…ç½®ç¤ºä¾‹**:
```json
{
  "logging": {
    "level": "info",
    "file": "logs/auth-service.log",
    "console_output": true
  }
}
```

#### 6.6 æ•°æ®åº“è¿æ¥æ± åˆå§‹åŒ–
```cpp
Logger::info("Initializing database connection pool...");

auto& dbPool = DatabaseConnectionPool::getInstance();
if (!dbPool.initialize()) {
    Logger::error("Failed to initialize database connection pool");
    return 1;
}

Logger::info("Database connection pool initialized successfully");
```

**åˆå§‹åŒ–å†…å®¹**:
- åŠ è½½æ•°æ®åº“é…ç½®
- æµ‹è¯•æ•°æ®åº“è¿æ¥
- åˆ›å»ºè¿æ¥æ± ï¼ˆé»˜è®¤ 10 ä¸ªè¿æ¥ï¼‰

#### 6.7 HTTP æœåŠ¡å™¨åˆ›å»ºå’Œå¯åŠ¨
```cpp
Logger::info("Creating HTTP server...");
g_server = std::make_unique<HttpServer>();

// åˆå§‹åŒ–æœåŠ¡å™¨
if (!g_server->initialize()) {
    Logger::error("Failed to initialize HTTP server");
    return 1;
}

Logger::info("HTTP server initialized successfully");

// å¯åŠ¨æœåŠ¡å™¨ï¼ˆé˜»å¡è°ƒç”¨ï¼‰
Logger::info("Starting HTTP server...");
if (!g_server->start()) {
    Logger::error("Failed to start HTTP server");
    return 1;
}

Logger::info("Authentication service started successfully");
Logger::info("Server is running and ready to accept connections");
```

**æ³¨æ„**: `g_server->start()` æ˜¯é˜»å¡è°ƒç”¨ï¼Œä¼šä¸€ç›´è¿è¡Œç›´åˆ°æœåŠ¡å™¨åœæ­¢

#### 6.8 å¼‚å¸¸å¤„ç†
```cpp
int main(int argc, char* argv[]) {
    try {
        // ... æ‰€æœ‰åˆå§‹åŒ–ä»£ç  ...
        
    } catch (const std::exception& e) {
        Logger::error("Fatal error: " + std::string(e.what()));
        return 1;
    } catch (...) {
        Logger::error("Unknown fatal error occurred");
        return 1;
    }
    
    return 0;
}
```

**å¼‚å¸¸å¤„ç†ç­–ç•¥**:
- æ•è·æ‰€æœ‰ `std::exception`
- æ•è·æœªçŸ¥å¼‚å¸¸ (`...`)
- è®°å½•é”™è¯¯æ—¥å¿—
- è¿”å›éé›¶é€€å‡ºç 

### ğŸ“Š å®Œæ•´å¯åŠ¨æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ‰“å° Banner                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      è®¾ç½®ä¿¡å·å¤„ç†å™¨                      â”‚
â”‚   (SIGINT, SIGTERM, SIGQUIT)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åŠ è½½é…ç½®æ–‡ä»¶                        â”‚
â”‚   (config/config.json)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ                      â”‚
â”‚   (Logger::initialize)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ±                     â”‚
â”‚   (DatabaseConnectionPool::initialize)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åˆ›å»º HTTP æœåŠ¡å™¨                    â”‚
â”‚   (HttpServer::initialize)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å¯åŠ¨ HTTP æœåŠ¡å™¨                    â”‚
â”‚   (HttpServer::start) - é˜»å¡            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æœåŠ¡å™¨è¿è¡Œä¸­...                     â”‚
â”‚   ç­‰å¾…è¯·æ±‚æˆ–ä¿¡å·                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

#### å¯åŠ¨æœåŠ¡å™¨
```bash
cd /home/kun/projects/shared-parking
./build/shared_parking_auth
```

#### ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
```bash
./build/shared_parking_auth /path/to/config.json
```

#### ä¼˜é›…åœæ­¢
```bash
# æ–¹æ³•1: Ctrl+C
^C

# æ–¹æ³•2: å‘é€ SIGTERM
kill <pid>

# æ–¹æ³•3: å‘é€ SIGQUIT
kill -QUIT <pid>
```

### ğŸ“ å¯åŠ¨æ—¥å¿—ç¤ºä¾‹
```
    ____  __                      __   ____             __   _            
   / ___\/ /_  ____ _________  ___/ /  / __ \____ ______/ /__(_)___  ____ _
   \__ \/ __ \/ __ `/ ___/ _ \/ __  /  / /_/ / __ `/ ___/ //_/ / __ \/ __ `/
  ___/ / / / / /_/ / /  /  __/ /_/ /  / ____/ /_/ / /  / ,< / / / / / /_/ / 
 /____/_/ /_/\__,_/_/   \___/\__,_/  /_/    \__,_/_/  /_/|_/_/_/ /_/\__, /  
                                                                   /____/   
 Authentication Service v1.0.0
 
Loading configuration from: config/config.json
[2025-10-01 15:30:59.122] [info] [thread 113673] Configuration loaded successfully
[2025-10-01 15:30:59.123] [info] [thread 113673] Initializing authentication service...
[2025-10-01 15:30:59.123] [info] [thread 113673] Initializing database connection pool...
[2025-10-01 15:30:59.126] [info] [thread 113673] Host: localhost:3306
[2025-10-01 15:30:59.126] [info] [thread 113673] Database: shared_parking
[2025-10-01 15:30:59.126] [info] [thread 113673] Pool size: 10
[2025-10-01 15:30:59.155] [info] [thread 113673] Database connection pool initialized successfully
[2025-10-01 15:30:59.155] [info] [thread 113673] Creating HTTP server...
[2025-10-01 15:30:59.155] [info] [thread 113673] Initializing HTTP server on 0.0.0.0:8080
[2025-10-01 15:30:59.155] [info] [thread 113673] HTTP server initialized successfully
[2025-10-01 15:30:59.155] [info] [thread 113673] Starting HTTP server...
```

### âš ï¸ æ³¨æ„äº‹é¡¹
- é…ç½®æ–‡ä»¶å¿…é¡»å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®
- æ•°æ®åº“å¿…é¡»å¯è®¿é—®
- ç«¯å£ 8080 å¿…é¡»æœªè¢«å ç”¨
- æ—¥å¿—ç›®å½•ä¼šè‡ªåŠ¨åˆ›å»º

---

## ğŸ“š é¡¹ç›®æ¶æ„æ€»ç»“

### ğŸ—ï¸ æ¨¡å—ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      main.cpp                           â”‚
â”‚                   (ç¨‹åºå…¥å£)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                  â”‚
        â–¼                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ConfigManager    â”‚                          â”‚   HttpServer     â”‚
â”‚  (é…ç½®ç®¡ç†)       â”‚                          â”‚  (HTTPæœåŠ¡å™¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                               â”‚
        â”‚                                               â”‚
        â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Logger        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ ConnectionPool   â”‚
â”‚   (æ—¥å¿—ç³»ç»Ÿ)      â”‚                          â”‚  (æ•°æ®åº“è¿æ¥æ± )  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                                                        â–¼
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚      User        â”‚
                                               â”‚   (ç”¨æˆ·æ¨¡å‹)     â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ è®¾è®¡æ¨¡å¼åº”ç”¨

| æ¨¡å¼ | åº”ç”¨ä½ç½® | ä½œç”¨ |
|------|----------|------|
| **å•ä¾‹æ¨¡å¼** | ConfigManager, Logger, DatabaseConnectionPool | å…¨å±€å”¯ä¸€å®ä¾‹ |
| **RAII** | MySQLConnection | è‡ªåŠ¨èµ„æºç®¡ç† |
| **å·¥å‚æ¨¡å¼** | DatabaseConnectionPool::createConnection() | åˆ›å»ºè¿æ¥å¯¹è±¡ |
| **æ¨¡æ¿æ–¹æ³•** | ConfigManager::get<T>() | ç±»å‹å®‰å…¨çš„é…ç½®è®¿é—® |
| **è§‚å¯Ÿè€…æ¨¡å¼** | ä¿¡å·å¤„ç†å™¨ | å“åº”ç³»ç»Ÿä¿¡å· |

### ğŸ”’ çº¿ç¨‹å®‰å…¨ä¿è¯

| æ¨¡å— | çº¿ç¨‹å®‰å…¨æœºåˆ¶ | è¯´æ˜ |
|------|--------------|------|
| ConfigManager | Meyer's Singleton + const æ–¹æ³• | C++11 ä¿è¯å•ä¾‹çº¿ç¨‹å®‰å…¨ |
| Logger | std::mutex | ä¿æŠ¤æ—¥å¿—è¾“å‡º |
| DatabaseConnectionPool | std::mutex + std::condition_variable | ä¿æŠ¤è¿æ¥é˜Ÿåˆ— |
| HttpServer | cpp-httplib å†…éƒ¨å¤„ç† | å¤šçº¿ç¨‹è¯·æ±‚å¤„ç† |

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **è¿æ¥æ± **: é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯æ•°æ®åº“è¿æ¥
2. **æ—¥å¿—è½®è½¬**: é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§
3. **RAII**: è‡ªåŠ¨èµ„æºç®¡ç†ï¼Œå‡å°‘å†…å­˜æ³„æ¼
4. **unique_ptr**: é›¶å¼€é”€çš„æ™ºèƒ½æŒ‡é’ˆ

### ğŸ›¡ï¸ é”™è¯¯å¤„ç†ç­–ç•¥

1. **é…ç½®åŠ è½½å¤±è´¥**: ç¨‹åºé€€å‡ºï¼Œè¿”å›é”™è¯¯ç  1
2. **æ—¥å¿—åˆå§‹åŒ–å¤±è´¥**: ç¨‹åºé€€å‡ºï¼Œè¿”å›é”™è¯¯ç  1
3. **æ•°æ®åº“è¿æ¥å¤±è´¥**: ç¨‹åºé€€å‡ºï¼Œè¿”å›é”™è¯¯ç  1
4. **HTTP æœåŠ¡å™¨å¯åŠ¨å¤±è´¥**: ç¨‹åºé€€å‡ºï¼Œè¿”å›é”™è¯¯ç  1
5. **è¿è¡Œæ—¶å¼‚å¸¸**: æ•è·å¹¶è®°å½•æ—¥å¿—ï¼Œä¼˜é›…å…³é—­

### ğŸ“ˆ å¯æ‰©å±•æ€§

#### å½“å‰æ¶æ„æ”¯æŒçš„æ‰©å±•ï¼š
- âœ… æ·»åŠ æ–°çš„ API ç«¯ç‚¹ï¼ˆåœ¨ HttpServer::setupRoutes()ï¼‰
- âœ… æ·»åŠ æ–°çš„é…ç½®é¡¹ï¼ˆåœ¨ config.jsonï¼‰
- âœ… æ·»åŠ æ–°çš„æ•°æ®æ¨¡å‹ï¼ˆå‚è€ƒ User ç±»ï¼‰
- âœ… æ·»åŠ æ–°çš„ä¸­é—´ä»¶ï¼ˆåœ¨ HttpServer::setupMiddleware()ï¼‰

#### ä¸‹ä¸€é˜¶æ®µå°†æ·»åŠ ï¼š
- ğŸ”œ è®¤è¯æœåŠ¡ (AuthService)
- ğŸ”œ JWT ç®¡ç† (JWTManager)
- ğŸ”œ å¯†ç å“ˆå¸Œ (PasswordHasher)
- ğŸ”œ ç”¨æˆ·ä»“å‚¨ (UserRepository)

---

## ğŸ“ å­¦ä¹ è¦ç‚¹æ€»ç»“

### 1. C++17 ç‰¹æ€§åº”ç”¨
- `std::unique_ptr`: æ™ºèƒ½æŒ‡é’ˆ
- `enum class`: å¼ºç±»å‹æšä¸¾
- `std::string_view`: å­—ç¬¦ä¸²è§†å›¾ï¼ˆJsonCpp 1.9.7ï¼‰
- Lambda è¡¨è¾¾å¼: HTTP è·¯ç”±å¤„ç†
- RAII: èµ„æºç®¡ç†

### 2. ç¬¬ä¸‰æ–¹åº“ä½¿ç”¨
- **JsonCpp**: JSON è§£æå’Œç”Ÿæˆ
- **spdlog**: é«˜æ€§èƒ½æ—¥å¿—åº“
- **cpp-httplib**: HTTP æœåŠ¡å™¨
- **MySQL C API**: æ•°æ®åº“è®¿é—®

### 3. å¹¶å‘ç¼–ç¨‹
- `std::mutex`: äº’æ–¥é”
- `std::condition_variable`: æ¡ä»¶å˜é‡
- `std::lock_guard`: è‡ªåŠ¨é”ç®¡ç†
- `std::unique_lock`: çµæ´»é”ç®¡ç†

### 4. è½¯ä»¶å·¥ç¨‹å®è·µ
- æ¨¡å—åŒ–è®¾è®¡
- å•ä¸€èŒè´£åŸåˆ™
- ä¾èµ–æ³¨å…¥
- é…ç½®å¤–éƒ¨åŒ–
- æ—¥å¿—è®°å½•
- é”™è¯¯å¤„ç†

---

## ğŸ“– é˜…è¯»å»ºè®®

æœ¬æ–‡æ¡£æŒ‰ç…§æ¨¡å—çš„ä¾èµ–å…³ç³»ç»„ç»‡ï¼Œå»ºè®®æŒ‰é¡ºåºé˜…è¯»ï¼š
1. **é…ç½®ç®¡ç†** â†’ 2. **æ—¥å¿—ç³»ç»Ÿ** â†’ 3. **ç”¨æˆ·æ¨¡å‹** â†’ 4. **æ•°æ®åº“è¿æ¥æ± ** â†’ 5. **HTTP æœåŠ¡å™¨** â†’ 6. **ä¸»ç¨‹åº** â†’ 7. **æ¶æ„æ€»ç»“**

---

## ğŸ¯ åç»­æ–‡æ¡£

å½“è¿›å…¥ä¸‹ä¸€é˜¶æ®µå¼€å‘æ—¶ï¼Œå°†åˆ›å»ºå¯¹åº”çš„ä»£ç è®²è§£æ–‡æ¡£ï¼š

### é˜¶æ®µB: è®¤è¯æ ¸å¿ƒæ¨¡å—
- ğŸ“„ `[008]é˜¶æ®µB-è®¤è¯æ ¸å¿ƒæ¨¡å—ä»£ç å®ç°è¯¦è§£.md`
  - password_hasher.cpp - å¯†ç å“ˆå¸Œï¼ˆPBKDF2ï¼‰
  - jwt_manager.cpp - JWT ä»¤ç‰Œç®¡ç†
  - auth_service.cpp - è®¤è¯æœåŠ¡å®ç°
  - user_repository.cpp - ç”¨æˆ·æ•°æ®è®¿é—®å±‚

### é˜¶æ®µC: API æ¥å£æ¨¡å—
- ğŸ“„ `[009]é˜¶æ®µC-APIæ¥å£æ¨¡å—ä»£ç å®ç°è¯¦è§£.md`
  - auth_handler.cpp - è®¤è¯ API å¤„ç†å™¨
  - json_response.cpp - ç»Ÿä¸€å“åº”æ ¼å¼
  - validator.cpp - è¾“å…¥éªŒè¯å·¥å…·

---

**æ–‡æ¡£å®Œæˆæ—¶é—´**: 2025-10-01
**ä½œè€…**: AI Assistant
**ç‰ˆæœ¬**: 1.0.0
**è¦†ç›–é˜¶æ®µ**: é˜¶æ®µAï¼ˆé¡¹ç›®éª¨æ¶ï¼‰

