# ç”¨æˆ·å¤´åƒä¸Šä¼ åŠŸèƒ½ - å®æ–½æ–¹æ¡ˆ

**æ–‡æ¡£ç¼–å·**: [120]
**åˆ›å»ºæ—¶é—´**: 2025-10-18
**ç‰ˆæœ¬**: v1.0.0
**ç›®æ ‡ç‰ˆæœ¬**: v2.6.0
**çŠ¶æ€**: ğŸ“‹ å¾…å®æ–½

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

ä¸ºKnotå›¾ç‰‡åˆ†äº«ç³»ç»Ÿè¡¥å……å®Œæ•´çš„ç”¨æˆ·å¤´åƒä¸Šä¼ åŠŸèƒ½ï¼Œå®ç°æ–‡ä»¶ç›´æ¥ä¸Šä¼ ã€è‡ªåŠ¨å‹ç¼©è£å‰ªã€æ—§æ–‡ä»¶åˆ é™¤ç­‰æ ¸å¿ƒç‰¹æ€§ã€‚

### åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·å¯ä»¥é€šè¿‡APIç›´æ¥ä¸Šä¼ å¤´åƒå›¾ç‰‡æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ï¼š
1. éªŒè¯æ–‡ä»¶æ ¼å¼å’Œå¤§å°ï¼ˆæ”¯æŒJPEG/PNG/GIF/WebPï¼Œæœ€å¤§5MBï¼‰
2. è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆå±…ä¸­è£å‰ªï¼‰
3. ç¼©æ”¾åˆ°æ ‡å‡†å°ºå¯¸ï¼ˆ200x200ï¼‰
4. å‹ç¼©ä¿å­˜ï¼ˆJPEG 80%è´¨é‡ï¼‰
5. åˆ é™¤æ—§å¤´åƒæ–‡ä»¶ï¼ˆèŠ‚çœå­˜å‚¨ç©ºé—´ï¼‰
6. è¿”å›å®Œæ•´å¤´åƒURLï¼ˆå¸¦æœåŠ¡å™¨å‰ç¼€ï¼‰

### å®æ–½èŒƒå›´

| åºå· | æ¨¡å— | æ–‡ä»¶ | å·¥ä½œå†…å®¹ | ä¼˜å…ˆçº§ | é¢„è®¡è€—æ—¶ |
|------|------|------|----------|--------|----------|
| 1 | åŸºç¡€è®¾æ–½ | å­˜å‚¨ç›®å½• | åˆ›å»º`/uploads/avatars/`ç›®å½• | P0 | 5åˆ†é’Ÿ |
| 2 | å·¥å…·å±‚ | `avatar_processor.h/cpp` | å¤´åƒå¤„ç†å·¥å…·ç±» | P0 | 2å°æ—¶ |
| 3 | Repositoryå±‚ | `user_repository.h/cpp` | æ·»åŠ `updateAvatarUrl()`æ–¹æ³• | P0 | 30åˆ†é’Ÿ |
| 4 | Serviceå±‚ | `auth_service.h/cpp` | æ·»åŠ `uploadAvatar()`æ–¹æ³• | P0 | 1å°æ—¶ |
| 5 | Handlerå±‚ | `auth_handler.h/cpp` | æ·»åŠ `handleUploadAvatar()`æ–¹æ³• | P0 | 1.5å°æ—¶ |
| 6 | æµ‹è¯•ä¸æ–‡æ¡£ | å„ç±»æ–‡æ¡£ | APIæµ‹è¯•ã€æ–‡æ¡£æ›´æ–° | P1 | 1å°æ—¶ |

**æ€»å·¥ä½œé‡**: çº¦6-7å°æ—¶

---

## ğŸ¯ å½“å‰åŠŸèƒ½ç°çŠ¶åˆ†æ

### âœ… å·²å®ç°çš„éƒ¨åˆ†

#### 1. æ•°æ®åº“å±‚é¢ï¼ˆå·²å®Œæˆï¼‰
- âœ… `users`è¡¨å·²æœ‰`avatar_url`å­—æ®µï¼ˆVARCHAR(255) NULLï¼‰
- âœ… æ”¯æŒå­˜å‚¨å¤´åƒURLè·¯å¾„

#### 2. Modelå±‚ï¼ˆå·²å®Œæˆï¼‰
- âœ… Userç±»å·²åŒ…å«`avatarUrl_`æˆå‘˜å˜é‡
- âœ… `getAvatarUrl()` / `setAvatarUrl()` æ–¹æ³•å·²å®ç°
- âœ… `toJson()`æ–¹æ³•é€šè¿‡`UrlHelper::toFullUrl()`è‡ªåŠ¨æ·»åŠ æœåŠ¡å™¨URLå‰ç¼€
- âœ… `fromJson()`æ–¹æ³•æ”¯æŒè§£æ`avatar_url`å­—æ®µ

#### 3. Repositoryå±‚ï¼ˆå·²å®Œæˆï¼‰
- âœ… `createUser()` - æ”¯æŒæ’å…¥å¤´åƒURL
- âœ… `updateUser()` - æ”¯æŒæ›´æ–°å¤´åƒURL
- âœ… `updateUserProfile()` - æ”¯æŒé€šè¿‡ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯APIæ›´æ–°å¤´åƒURL

#### 4. Serviceå±‚ï¼ˆå·²å®Œæˆï¼‰
- âœ… `updateUserProfile()` - æ”¯æŒé€šè¿‡å­—ç¬¦ä¸²å½¢å¼çš„URLæ›´æ–°å¤´åƒ
- âœ… ç©ºå€¼ä¿æŠ¤ï¼šå¦‚æœ`avatarUrl`å‚æ•°ä¸ºç©ºï¼Œä¿æŒåŸæœ‰å€¼

#### 5. Handlerå±‚ï¼ˆå·²å®Œæˆï¼‰
- âœ… `PUT /api/v1/users/profile` - æ”¯æŒé€šè¿‡JSONä¼ é€’`avatar_url`å­—æ®µ
- âœ… å“åº”ä¸­è‡ªåŠ¨åŒ…å«å®Œæ•´çš„å¤´åƒURLï¼ˆå¸¦æœåŠ¡å™¨å‰ç¼€ï¼‰

#### 6. URLè¾…åŠ©å·¥å…·ï¼ˆå·²å®Œæˆï¼‰
- âœ… `UrlHelper::toFullUrl()` - è‡ªåŠ¨ä¸ºç›¸å¯¹è·¯å¾„æ·»åŠ æœåŠ¡å™¨URLå‰ç¼€
- âœ… åœ¨æ‰€æœ‰è¿”å›ç”¨æˆ·ä¿¡æ¯çš„åœ°æ–¹éƒ½å·²åº”ç”¨

#### 7. å­˜å‚¨ç›®å½•ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
- âœ… `/uploads/images/` - å¸–å­åŸå›¾
- âœ… `/uploads/thumbnails/` - å¸–å­ç¼©ç•¥å›¾
- â³ `/uploads/avatars/` - **å¾…åˆ›å»º**

### âŒ ç¼ºå¤±çš„éƒ¨åˆ†ï¼ˆéœ€è¦å®ç°ï¼‰

#### 1. å¤´åƒä¸Šä¼ APIï¼ˆæ ¸å¿ƒç¼ºå¤±ï¼‰
```plaintext
âŒ POST /api/v1/users/avatar
   - æ¥æ”¶multipart/form-dataæ ¼å¼çš„æ–‡ä»¶ä¸Šä¼ 
   - JWTè®¤è¯
   - æ–‡ä»¶å¤§å°éªŒè¯ï¼ˆæœ€å¤§5MBï¼‰
   - æ ¼å¼éªŒè¯ï¼ˆJPEG/PNG/GIF/WebPï¼‰
```

**å½“å‰é—®é¢˜**ï¼šåªèƒ½é€šè¿‡`PUT /api/v1/users/profile`æ‰‹åŠ¨ä¼ é€’å®Œæ•´URLå­—ç¬¦ä¸²ï¼Œ**æ— æ³•ç›´æ¥ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶**ã€‚

#### 2. å¤´åƒå¤„ç†å·¥å…·ç±»ï¼ˆæœªå®ç°ï¼‰
```plaintext
âŒ src/utils/avatar_processor.h
âŒ src/utils/avatar_processor.cpp
```

éœ€è¦åŠŸèƒ½ï¼š
- å›¾ç‰‡è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆå±…ä¸­è£å‰ªï¼‰
- ç¼©æ”¾åˆ°æ ‡å‡†å°ºå¯¸ï¼ˆ200x200ï¼‰
- JPEGå‹ç¼©ï¼ˆ80%è´¨é‡ï¼‰
- è‡ªåŠ¨åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
- æ–‡ä»¶éªŒè¯ï¼ˆæ ¼å¼ã€å¤§å°ï¼‰

#### 3. Repositoryå±‚å¤´åƒä¸“ç”¨æ–¹æ³•ï¼ˆæœªå®ç°ï¼‰
```cpp
âŒ bool updateAvatarUrl(int userId, const std::string& avatarUrl);
```

è¯´æ˜ï¼šè™½ç„¶æœ‰`updateUserProfile()`ï¼Œä½†å¤´åƒä¸Šä¼ åœºæ™¯éœ€è¦å•ç‹¬çš„è½»é‡çº§æ›´æ–°æ–¹æ³•ã€‚

#### 4. Serviceå±‚å¤´åƒä¸Šä¼ æ–¹æ³•ï¼ˆæœªå®ç°ï¼‰
```cpp
âŒ struct UploadAvatarResult {
    bool success;
    std::string message;
    std::string avatarUrl;
    int width;
    int height;
    long long fileSize;
};

âŒ UploadAvatarResult uploadAvatar(int userId, const std::string& tempFilePath);
```

#### 5. Handlerå±‚å¤´åƒä¸Šä¼ å¤„ç†ï¼ˆæœªå®ç°ï¼‰
```cpp
âŒ void handleUploadAvatar(const httplib::Request& req, httplib::Response& res);
```

---

## ğŸ“ æŠ€æœ¯è®¾è®¡

### APIè®¾è®¡

**æ¥å£**: `POST /api/v1/users/avatar`

**è¯·æ±‚å¤´**:
```http
Authorization: Bearer {access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚å‚æ•°**:
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é™åˆ¶ |
|--------|------|------|------|------|
| avatar | File | æ˜¯ | å¤´åƒå›¾ç‰‡æ–‡ä»¶ | æœ€å¤§5MBï¼Œæ”¯æŒJPEG/PNG/GIF/WebP |

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg",
    "width": 200,
    "height": 200,
    "file_size": 45678
  },
  "timestamp": 1729584000
}
```

**é”™è¯¯å“åº”**:
| çŠ¶æ€ç  | è¯´æ˜ | messageç¤ºä¾‹ |
|--------|------|-------------|
| 400 | æœªæä¾›æ–‡ä»¶ | "è¯·ä¸Šä¼ å¤´åƒæ–‡ä»¶" |
| 400 | æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ | "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œä»…æ”¯æŒJPEG/PNG/GIF/WebP" |
| 400 | æ–‡ä»¶è¿‡å¤§ | "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§5MBï¼‰" |
| 401 | æœªæˆæƒ | "æœªæä¾›è®¤è¯ä»¤ç‰Œ" / "ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ" |
| 500 | æœåŠ¡å™¨é”™è¯¯ | "å¤´åƒå¤„ç†å¤±è´¥" / "æ•°æ®åº“æ›´æ–°å¤±è´¥" |

### æŠ€æœ¯å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| å¤´åƒå°ºå¯¸ | 200x200 | å›ºå®šæ­£æ–¹å½¢ |
| JPEGè´¨é‡ | 80% | å‹ç¼©è´¨é‡ |
| æœ€å¤§æ–‡ä»¶å¤§å° | 5MB | ä¸Šä¼ é™åˆ¶ |
| æ”¯æŒæ ¼å¼ | JPEG, PNG, GIF, WebP | å›¾ç‰‡æ ¼å¼ç™½åå• |
| å­˜å‚¨è·¯å¾„ | `/uploads/avatars/` | ç›¸å¯¹è·¯å¾„ |
| æ–‡ä»¶å‘½å | `{USER_ID}_{timestamp}.jpg` | ä¾‹ï¼šUSR_2025Q4_abc123_1729584000.jpg |

### æ–‡ä»¶å¤„ç†æµç¨‹

```
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶ï¼ˆmultipart/form-dataï¼‰
       â†“
Handlerå±‚æ¥æ”¶æ–‡ä»¶ + JWTéªŒè¯
       â†“
ä¿å­˜ä¸´æ—¶æ–‡ä»¶ï¼ˆ/tmp/avatar_xxxxxï¼‰
       â†“
Serviceå±‚ï¼šè°ƒç”¨AvatarProcessorå¤„ç†
       â†“
AvatarProcessorå·¥ä½œæµç¨‹ï¼š
  1. åŠ è½½å›¾ç‰‡ï¼ˆstb_imageï¼‰
  2. éªŒè¯æ ¼å¼å’Œå¤§å°
  3. å±…ä¸­è£å‰ªä¸ºæ­£æ–¹å½¢
  4. ç¼©æ”¾åˆ°200x200ï¼ˆstb_image_resizeï¼‰
  5. ä¿å­˜ä¸ºJPEG 80%è´¨é‡ï¼ˆstb_image_writeï¼‰
       â†“
è·å–æ—§å¤´åƒURL â†’ åˆ é™¤æ—§æ–‡ä»¶
       â†“
Repositoryå±‚ï¼šæ›´æ–°æ•°æ®åº“avatar_urlå­—æ®µ
       â†“
åˆ é™¤ä¸´æ—¶æ–‡ä»¶
       â†“
è¿”å›æ–°å¤´åƒURLï¼ˆå¸¦æœåŠ¡å™¨å‰ç¼€ï¼‰
```

### æ•°æ®åº“è®¾è®¡

**æ— éœ€ä¿®æ”¹æ•°æ®åº“ç»“æ„**ï¼Œå¤ç”¨ç°æœ‰`users`è¡¨çš„`avatar_url`å­—æ®µï¼š

```sql
-- usersè¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL UNIQUE,
    username VARCHAR(50) NOT NULL UNIQUE,
    avatar_url VARCHAR(255) NULL COMMENT 'å¤´åƒURL',  -- å¤ç”¨æ­¤å­—æ®µ
    ...
);
```

**å­˜å‚¨å€¼ç¤ºä¾‹**ï¼š
```
/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg
```

**è¿”å›ç»™å®¢æˆ·ç«¯**ï¼š
```
http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg
```

---

## ğŸ“ è¯¦ç»†å®æ–½æ­¥éª¤

### é˜¶æ®µ0ï¼šå‰ç½®å‡†å¤‡ï¼ˆ5åˆ†é’Ÿï¼‰

#### ä»»åŠ¡0.1ï¼šåˆ›å»ºå­˜å‚¨ç›®å½•

**æ‰§è¡Œå‘½ä»¤**ï¼š
```bash
cd /home/kun/projects/SharePix/backend-service
mkdir -p uploads/avatars
chmod 755 uploads/avatars
```

**éªŒè¯**ï¼š
```bash
ls -la uploads/
# åº”æ˜¾ç¤ºï¼šdrwxr-xr-x  avatars
```

---

### é˜¶æ®µ1ï¼šå·¥å…·å±‚ - å¤´åƒå¤„ç†å™¨ï¼ˆ2å°æ—¶ï¼‰

#### ä»»åŠ¡1.1ï¼šåˆ›å»º `src/utils/avatar_processor.h`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/utils/avatar_processor.h`

**å®Œæ•´ä»£ç **ï¼š
```cpp
/**
 * @file avatar_processor.h
 * @brief å¤´åƒå¤„ç†å·¥å…·ç±»å®šä¹‰
 * @author Knot Team
 * @date 2025-10-18
 */

#pragma once

#include <string>
#include <utility>

/**
 * @brief å¤´åƒå¤„ç†ç»“æœç»“æ„ä½“
 */
struct AvatarProcessResult {
    bool success;              // å¤„ç†æ˜¯å¦æˆåŠŸ
    std::string message;       // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
    std::string avatarPath;    // å¤´åƒè·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„ï¼Œä¾‹ï¼š/uploads/avatars/USR_xxx_1234567890.jpgï¼‰
    int width;                 // å›¾ç‰‡å®½åº¦ï¼ˆå›ºå®š200ï¼‰
    int height;                // å›¾ç‰‡é«˜åº¦ï¼ˆå›ºå®š200ï¼‰
    long long fileSize;        // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    
    AvatarProcessResult() : success(false), width(0), height(0), fileSize(0) {}
};

/**
 * @brief å¤´åƒå¤„ç†å·¥å…·ç±»
 * 
 * ä¸“é—¨ç”¨äºå¤„ç†ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼ŒåŒ…æ‹¬è£å‰ªã€å‹ç¼©ã€ä¿å­˜
 * æŠ€æœ¯æ ˆï¼šstb_image, stb_image_resize, stb_image_write
 */
class AvatarProcessor {
public:
    /**
     * @brief å¤„ç†å¤´åƒå›¾ç‰‡ï¼ˆè£å‰ªä¸ºæ­£æ–¹å½¢ + ç¼©æ”¾ + å‹ç¼©ï¼‰
     * 
     * å¤„ç†æµç¨‹ï¼š
     * 1. åŠ è½½å›¾ç‰‡
     * 2. éªŒè¯æ ¼å¼å’Œå¤§å°
     * 3. å¦‚æœä¸æ˜¯æ­£æ–¹å½¢ï¼Œå±…ä¸­è£å‰ªä¸ºæ­£æ–¹å½¢
     * 4. ç¼©æ”¾åˆ°200x200
     * 5. ä¿å­˜ä¸ºJPEGï¼ˆ80%è´¨é‡ï¼‰
     * 
     * @param inputPath è¾“å…¥å›¾ç‰‡è·¯å¾„ï¼ˆä¸´æ—¶æ–‡ä»¶ï¼‰
     * @param userId ç”¨æˆ·é€»è¾‘IDï¼ˆç”¨äºç”Ÿæˆæ–‡ä»¶åï¼Œä¾‹ï¼šUSR_2025Q4_abc123ï¼‰
     * @param outputDir è¾“å‡ºç›®å½•ï¼ˆä¾‹ï¼šuploads/avatars/ï¼‰
     * @return AvatarProcessResult å¤„ç†ç»“æœ
     */
    static AvatarProcessResult processAvatar(
        const std::string& inputPath,
        const std::string& userId,
        const std::string& outputDir
    );
    
    /**
     * @brief åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
     * 
     * @param avatarUrl æ—§å¤´åƒURLï¼ˆç›¸å¯¹è·¯å¾„ï¼Œä¾‹ï¼š/uploads/avatars/USR_xxx_1234567890.jpgï¼‰
     * @return bool æˆåŠŸè¿”å›trueï¼Œå¤±è´¥æˆ–æ–‡ä»¶ä¸å­˜åœ¨è¿”å›false
     */
    static bool deleteOldAvatar(const std::string& avatarUrl);
    
    /**
     * @brief éªŒè¯å¤´åƒæ–‡ä»¶æ ¼å¼å’Œå¤§å°
     * 
     * @param filePath æ–‡ä»¶è·¯å¾„
     * @param maxSize æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œé»˜è®¤5MB
     * @return std::pair<bool, std::string> {æ˜¯å¦æœ‰æ•ˆ, é”™è¯¯ä¿¡æ¯}
     */
    static std::pair<bool, std::string> validateAvatarFile(
        const std::string& filePath,
        long long maxSize = 5 * 1024 * 1024
    );

private:
    // å¸¸é‡å®šä¹‰
    static constexpr int AVATAR_SIZE = 200;        // å¤´åƒå°ºå¯¸ï¼ˆ200x200ï¼‰
    static constexpr int JPEG_QUALITY = 80;        // JPEGå‹ç¼©è´¨é‡ï¼ˆ80%ï¼‰
    static constexpr long long MAX_FILE_SIZE = 5 * 1024 * 1024;  // æœ€å¤§æ–‡ä»¶å¤§å°ï¼ˆ5MBï¼‰
    
    /**
     * @brief è£å‰ªå›¾ç‰‡ä¸ºæ­£æ–¹å½¢ï¼ˆå±…ä¸­è£å‰ªï¼‰
     * 
     * @param inputData è¾“å…¥å›¾ç‰‡æ•°æ®
     * @param width åŸå›¾å®½åº¦
     * @param height åŸå›¾é«˜åº¦
     * @param channels é€šé“æ•°
     * @param outSize è¾“å‡ºæ­£æ–¹å½¢è¾¹é•¿ï¼ˆè¿”å›å€¼ï¼‰
     * @return unsigned char* è£å‰ªåçš„å›¾ç‰‡æ•°æ®ï¼ˆéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼‰
     */
    static unsigned char* cropToSquare(
        unsigned char* inputData,
        int width,
        int height,
        int channels,
        int& outSize
    );
};
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨`AvatarProcessResult`ç»“æ„ä½“ç»Ÿä¸€è¿”å›ç»“æœ
- æ–‡ä»¶å‘½åæ ¼å¼ï¼š`{userId}_{timestamp}.jpg`
- æ”¯æŒæ ¼å¼éªŒè¯ã€å¤§å°éªŒè¯ã€è£å‰ªã€ç¼©æ”¾ã€å‹ç¼©
- è‡ªåŠ¨åˆ é™¤æ—§å¤´åƒæ–‡ä»¶

---

#### ä»»åŠ¡1.2ï¼šå®ç° `src/utils/avatar_processor.cpp`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/utils/avatar_processor.cpp`

**å®Œæ•´ä»£ç **ï¼š
```cpp
/**
 * @file avatar_processor.cpp
 * @brief å¤´åƒå¤„ç†å·¥å…·ç±»å®ç°
 * @author Knot Team
 * @date 2025-10-18
 */

#include "avatar_processor.h"
#include "logger.h"

#define STB_IMAGE_IMPLEMENTATION
#include "stb_image.h"

#define STB_IMAGE_RESIZE_IMPLEMENTATION
#include "stb_image_resize.h"

#define STB_IMAGE_WRITE_IMPLEMENTATION
#include "stb_image_write.h"

#include <ctime>
#include <cstdio>
#include <sys/stat.h>
#include <unistd.h>
#include <cstring>

// å¤„ç†å¤´åƒå›¾ç‰‡
AvatarProcessResult AvatarProcessor::processAvatar(
    const std::string& inputPath,
    const std::string& userId,
    const std::string& outputDir
) {
    AvatarProcessResult result;
    
    try {
        Logger::info("å¼€å§‹å¤„ç†å¤´åƒ: userId=" + userId + ", inputPath=" + inputPath);
        
        // 1. éªŒè¯æ–‡ä»¶
        auto [valid, errorMsg] = validateAvatarFile(inputPath);
        if (!valid) {
            result.message = errorMsg;
            Logger::error("å¤´åƒæ–‡ä»¶éªŒè¯å¤±è´¥: " + errorMsg);
            return result;
        }
        
        // 2. åŠ è½½å›¾ç‰‡
        int width, height, channels;
        unsigned char* imageData = stbi_load(inputPath.c_str(), &width, &height, &channels, 0);
        
        if (!imageData) {
            result.message = "æ— æ³•åŠ è½½å›¾ç‰‡æ–‡ä»¶";
            Logger::error("stbi_loadå¤±è´¥: " + inputPath);
            return result;
        }
        
        Logger::info("å›¾ç‰‡åŠ è½½æˆåŠŸ: " + std::to_string(width) + "x" + std::to_string(height) + ", channels=" + std::to_string(channels));
        
        // 3. è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
        unsigned char* squareData = nullptr;
        int squareSize = 0;
        
        if (width != height) {
            squareData = cropToSquare(imageData, width, height, channels, squareSize);
            stbi_image_free(imageData);  // é‡Šæ”¾åŸå›¾æ•°æ®
            
            if (!squareData) {
                result.message = "å›¾ç‰‡è£å‰ªå¤±è´¥";
                Logger::error("cropToSquareå¤±è´¥");
                return result;
            }
            
            Logger::info("å›¾ç‰‡è£å‰ªæˆåŠŸ: " + std::to_string(squareSize) + "x" + std::to_string(squareSize));
        } else {
            squareData = imageData;
            squareSize = width;
        }
        
        // 4. ç¼©æ”¾åˆ°200x200
        unsigned char* resizedData = (unsigned char*)malloc(AVATAR_SIZE * AVATAR_SIZE * channels);
        if (!resizedData) {
            result.message = "å†…å­˜åˆ†é…å¤±è´¥";
            Logger::error("mallocå¤±è´¥");
            if (squareData != imageData) free(squareData);
            return result;
        }
        
        int resizeResult = stbir_resize_uint8(
            squareData, squareSize, squareSize, 0,
            resizedData, AVATAR_SIZE, AVATAR_SIZE, 0,
            channels
        );
        
        // é‡Šæ”¾æ­£æ–¹å½¢æ•°æ®
        if (squareData != imageData) {
            free(squareData);
        }
        
        if (!resizeResult) {
            result.message = "å›¾ç‰‡ç¼©æ”¾å¤±è´¥";
            Logger::error("stbir_resize_uint8å¤±è´¥");
            free(resizedData);
            return result;
        }
        
        Logger::info("å›¾ç‰‡ç¼©æ”¾æˆåŠŸ: " + std::to_string(AVATAR_SIZE) + "x" + std::to_string(AVATAR_SIZE));
        
        // 5. ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
        std::time_t now = std::time(nullptr);
        std::string filename = userId + "_" + std::to_string(now) + ".jpg";
        std::string outputPath = outputDir + filename;
        
        // 6. ä¿å­˜ä¸ºJPEG
        int writeResult = stbi_write_jpg(
            outputPath.c_str(),
            AVATAR_SIZE,
            AVATAR_SIZE,
            channels,
            resizedData,
            JPEG_QUALITY
        );
        
        free(resizedData);  // é‡Šæ”¾ç¼©æ”¾åçš„æ•°æ®
        
        if (!writeResult) {
            result.message = "ä¿å­˜å›¾ç‰‡å¤±è´¥";
            Logger::error("stbi_write_jpgå¤±è´¥: " + outputPath);
            return result;
        }
        
        // 7. è·å–æ–‡ä»¶å¤§å°
        struct stat fileStat;
        if (stat(outputPath.c_str(), &fileStat) == 0) {
            result.fileSize = fileStat.st_size;
        }
        
        // 8. å¡«å……ç»“æœ
        result.success = true;
        result.message = "å¤´åƒå¤„ç†æˆåŠŸ";
        result.avatarPath = "/uploads/avatars/" + filename;
        result.width = AVATAR_SIZE;
        result.height = AVATAR_SIZE;
        
        Logger::info("å¤´åƒå¤„ç†å®Œæˆ: " + result.avatarPath + ", fileSize=" + std::to_string(result.fileSize));
        
        return result;
        
    } catch (const std::exception& e) {
        result.message = "å¤´åƒå¤„ç†å¼‚å¸¸: " + std::string(e.what());
        Logger::error(result.message);
        return result;
    }
}

// åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
bool AvatarProcessor::deleteOldAvatar(const std::string& avatarUrl) {
    if (avatarUrl.empty() || avatarUrl.find("/uploads/avatars/") == std::string::npos) {
        return false;  // ä¸æ˜¯å¤´åƒæ–‡ä»¶è·¯å¾„ï¼Œä¸å¤„ç†
    }
    
    // æ„å»ºå®Œæ•´æ–‡ä»¶è·¯å¾„
    std::string filePath = "." + avatarUrl;  // ç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•
    
    if (unlink(filePath.c_str()) == 0) {
        Logger::info("æ—§å¤´åƒå·²åˆ é™¤: " + avatarUrl);
        return true;
    } else {
        Logger::warning("åˆ é™¤æ—§å¤´åƒå¤±è´¥: " + avatarUrl + " (æ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨)");
        return false;
    }
}

// éªŒè¯å¤´åƒæ–‡ä»¶
std::pair<bool, std::string> AvatarProcessor::validateAvatarFile(
    const std::string& filePath,
    long long maxSize
) {
    // 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    struct stat fileStat;
    if (stat(filePath.c_str(), &fileStat) != 0) {
        return {false, "æ–‡ä»¶ä¸å­˜åœ¨"};
    }
    
    // 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
    if (fileStat.st_size > maxSize) {
        return {false, "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§5MBï¼‰"};
    }
    
    if (fileStat.st_size == 0) {
        return {false, "æ–‡ä»¶ä¸ºç©º"};
    }
    
    // 3. æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼ˆé€šè¿‡stb_imageå°è¯•åŠ è½½ï¼‰
    int width, height, channels;
    if (!stbi_info(filePath.c_str(), &width, &height, &channels)) {
        return {false, "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œä»…æ”¯æŒJPEG/PNG/GIF/WebP"};
    }
    
    // 4. æ£€æŸ¥å›¾ç‰‡å°ºå¯¸åˆæ³•æ€§
    if (width <= 0 || height <= 0) {
        return {false, "æ— æ•ˆçš„å›¾ç‰‡å°ºå¯¸"};
    }
    
    if (width > 10000 || height > 10000) {
        return {false, "å›¾ç‰‡å°ºå¯¸è¿‡å¤§ï¼ˆæœ€å¤§10000x10000ï¼‰"};
    }
    
    return {true, ""};
}

// è£å‰ªå›¾ç‰‡ä¸ºæ­£æ–¹å½¢ï¼ˆå±…ä¸­è£å‰ªï¼‰
unsigned char* AvatarProcessor::cropToSquare(
    unsigned char* inputData,
    int width,
    int height,
    int channels,
    int& outSize
) {
    if (!inputData || width <= 0 || height <= 0 || channels <= 0) {
        return nullptr;
    }
    
    // è®¡ç®—æ­£æ–¹å½¢è¾¹é•¿ï¼ˆå–è¾ƒå°å€¼ï¼‰
    int size = (width < height) ? width : height;
    outSize = size;
    
    // è®¡ç®—è£å‰ªèµ·å§‹ä½ç½®ï¼ˆå±…ä¸­ï¼‰
    int offsetX = (width - size) / 2;
    int offsetY = (height - size) / 2;
    
    // åˆ†é…è¾“å‡ºå†…å­˜
    unsigned char* outputData = (unsigned char*)malloc(size * size * channels);
    if (!outputData) {
        return nullptr;
    }
    
    // é€è¡Œå¤åˆ¶åƒç´ æ•°æ®
    for (int y = 0; y < size; y++) {
        int srcY = offsetY + y;
        int srcOffset = (srcY * width + offsetX) * channels;
        int dstOffset = (y * size) * channels;
        
        memcpy(
            outputData + dstOffset,
            inputData + srcOffset,
            size * channels
        );
    }
    
    return outputData;
}
```

**å…³é”®å®ç°ç‚¹**ï¼š
1. **éªŒè¯æ–‡ä»¶**ï¼šæ£€æŸ¥å¤§å°ã€æ ¼å¼ã€å°ºå¯¸åˆæ³•æ€§
2. **åŠ è½½å›¾ç‰‡**ï¼šä½¿ç”¨`stbi_load()`åŠ è½½ä»»æ„æ ¼å¼
3. **è£å‰ªä¸ºæ­£æ–¹å½¢**ï¼šå±…ä¸­è£å‰ªï¼ˆå–çŸ­è¾¹ï¼‰
4. **ç¼©æ”¾**ï¼šä½¿ç”¨`stbir_resize_uint8()`ç¼©æ”¾åˆ°200x200
5. **ä¿å­˜**ï¼šä½¿ç”¨`stbi_write_jpg()`ä¿å­˜ä¸ºJPEGï¼ˆ80%è´¨é‡ï¼‰
6. **å†…å­˜ç®¡ç†**ï¼šåŠæ—¶é‡Šæ”¾stbåˆ†é…çš„å†…å­˜
7. **é”™è¯¯å¤„ç†**ï¼šæ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯

---

#### ä»»åŠ¡1.3ï¼šæ›´æ–°CMakeLists.txt

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/CMakeLists.txt`

**åœ¨æºæ–‡ä»¶åˆ—è¡¨ä¸­æ·»åŠ **ï¼š
```cmake
# åœ¨ set(SOURCES ...) ä¸­æ·»åŠ 
src/utils/avatar_processor.cpp
```

**ç¤ºä¾‹ä½ç½®**ï¼š
```cmake
set(SOURCES
    src/main.cpp
    src/server/http_server.cpp
    src/utils/logger.cpp
    src/utils/config_manager.cpp
    src/utils/id_generator.cpp
    src/utils/image_processor.cpp
    src/utils/avatar_processor.cpp  # â† æ–°å¢
    ...
)
```

---

### é˜¶æ®µ2ï¼šRepositoryå±‚ï¼ˆ30åˆ†é’Ÿï¼‰

#### ä»»åŠ¡2.1ï¼šä¿®æ”¹ `src/database/user_repository.h`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/database/user_repository.h`

**åœ¨ç±»å®šä¹‰ä¸­æ·»åŠ æ–¹æ³•å£°æ˜**ï¼ˆåœ¨`updateUserProfile()`æ–¹æ³•ä¹‹åï¼‰ï¼š

```cpp
/**
 * @brief æ›´æ–°ç”¨æˆ·å¤´åƒURLï¼ˆè½»é‡çº§æ›´æ–°æ–¹æ³•ï¼‰
 * 
 * ä¸“ç”¨äºå¤´åƒä¸Šä¼ åœºæ™¯ï¼Œä»…æ›´æ–°avatar_urlå­—æ®µ
 * 
 * @param userId ç”¨æˆ·ç‰©ç†ID
 * @param avatarUrl æ–°çš„å¤´åƒURLï¼ˆç›¸å¯¹è·¯å¾„ï¼Œä¾‹ï¼š/uploads/avatars/USR_xxx_1234567890.jpgï¼‰
 * @return true æ›´æ–°æˆåŠŸï¼Œfalse æ›´æ–°å¤±è´¥
 */
bool updateAvatarUrl(int userId, const std::string& avatarUrl);
```

**æ’å…¥ä½ç½®å‚è€ƒ**ï¼š
```cpp
class UserRepository {
public:
    // ... å…¶ä»–æ–¹æ³• ...
    
    bool updateUserProfile(int userId,
                          const std::string& realName,
                          const std::string& email,
                          const std::string& phone,
                          const std::string& avatarUrl,
                          const std::string& bio,
                          const std::string& gender,
                          const std::string& location);
    
    bool updateAvatarUrl(int userId, const std::string& avatarUrl);  // â† æ–°å¢
    
    // ... å…¶ä»–æ–¹æ³• ...
};
```

---

#### ä»»åŠ¡2.2ï¼šå®ç° `src/database/user_repository.cpp`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/database/user_repository.cpp`

**åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–¹æ³•å®ç°**ï¼š

```cpp
// æ›´æ–°ç”¨æˆ·å¤´åƒURL
bool UserRepository::updateAvatarUrl(int userId, const std::string& avatarUrl) {
    try {
        Logger::info("æ›´æ–°ç”¨æˆ·å¤´åƒURL: userId=" + std::to_string(userId));
        
        // 1. ä½¿ç”¨ConnectionGuardè‡ªåŠ¨ç®¡ç†è¿æ¥
        ConnectionGuard connGuard(DatabaseConnectionPool::getInstance());
        if (!connGuard.isValid()) {
            Logger::error("è·å–æ•°æ®åº“è¿æ¥å¤±è´¥");
            return false;
        }
        
        MYSQL* conn = connGuard.get();
        
        // 2. å‡†å¤‡SQLè¯­å¥
        const char* query = "UPDATE users SET avatar_url = ?, update_time = CURRENT_TIMESTAMP WHERE id = ?";
        
        // 3. åˆ›å»ºé¢„ç¼–è¯‘è¯­å¥
        MYSQL_STMT* stmt = mysql_stmt_init(conn);
        if (!stmt) {
            Logger::error("mysql_stmt_initå¤±è´¥");
            return false;
        }
        
        // 4. é¢„ç¼–è¯‘SQL
        if (mysql_stmt_prepare(stmt, query, strlen(query)) != 0) {
            Logger::error("mysql_stmt_prepareå¤±è´¥: " + std::string(mysql_stmt_error(stmt)));
            mysql_stmt_close(stmt);
            return false;
        }
        
        // 5. ç»‘å®šå‚æ•°
        MYSQL_BIND bind[2];
        memset(bind, 0, sizeof(bind));
        
        // avatar_url (å¯ä¸ºç©º)
        bool avatar_is_null = avatarUrl.empty();
        
        bind[0].buffer_type = MYSQL_TYPE_STRING;
        bind[0].buffer = (char*)avatarUrl.c_str();
        bind[0].buffer_length = avatarUrl.length();
        bind[0].is_null = &avatar_is_null;
        
        // userId
        bind[1].buffer_type = MYSQL_TYPE_LONG;
        bind[1].buffer = (char*)&userId;
        bind[1].is_null = nullptr;
        
        if (mysql_stmt_bind_param(stmt, bind) != 0) {
            Logger::error("mysql_stmt_bind_paramå¤±è´¥: " + std::string(mysql_stmt_error(stmt)));
            mysql_stmt_close(stmt);
            return false;
        }
        
        // 6. æ‰§è¡Œæ›´æ–°
        if (mysql_stmt_execute(stmt) != 0) {
            Logger::error("mysql_stmt_executeå¤±è´¥: " + std::string(mysql_stmt_error(stmt)));
            mysql_stmt_close(stmt);
            return false;
        }
        
        // 7. æ£€æŸ¥å½±å“è¡Œæ•°
        my_ulonglong affected = mysql_stmt_affected_rows(stmt);
        mysql_stmt_close(stmt);
        
        if (affected == 0) {
            Logger::warning("æ›´æ–°å¤´åƒURLå¤±è´¥: ç”¨æˆ·ä¸å­˜åœ¨, userId=" + std::to_string(userId));
            return false;
        }
        
        Logger::info("å¤´åƒURLæ›´æ–°æˆåŠŸ: userId=" + std::to_string(userId));
        return true;
        
    } catch (const std::exception& e) {
        Logger::error("updateAvatarUrlå¼‚å¸¸: " + std::string(e.what()));
        return false;
    }
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨`ConnectionGuard`è‡ªåŠ¨ç®¡ç†è¿æ¥
- ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²æ­¢SQLæ³¨å…¥
- æ”¯æŒç©ºå€¼å¤„ç†ï¼ˆå…è®¸åˆ é™¤å¤´åƒï¼‰
- è‡ªåŠ¨æ›´æ–°`update_time`å­—æ®µ
- æ£€æŸ¥å½±å“è¡Œæ•°ç¡®ä¿ç”¨æˆ·å­˜åœ¨

---

#### ä»»åŠ¡2.3ï¼šç¼–è¯‘æµ‹è¯•

```bash
cd /home/kun/projects/SharePix/backend-service/build
make -j4
```

**é¢„æœŸç»“æœ**ï¼šç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

---

### é˜¶æ®µ3ï¼šServiceå±‚ï¼ˆ1å°æ—¶ï¼‰

#### ä»»åŠ¡3.1ï¼šä¿®æ”¹ `src/core/auth_service.h`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/core/auth_service.h`

**åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ ç»“æ„ä½“å®šä¹‰**ï¼ˆåœ¨`UsernameCheckResult`ä¹‹åï¼‰ï¼š

```cpp
/**
 * @brief å¤´åƒä¸Šä¼ ç»“æœç»“æ„ä½“
 */
struct UploadAvatarResult {
    bool success;              // ä¸Šä¼ æ˜¯å¦æˆåŠŸ
    std::string message;       // é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœå¤±è´¥ï¼‰
    std::string avatarUrl;     // å¤´åƒURLï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
    int width;                 // å›¾ç‰‡å®½åº¦ï¼ˆå›ºå®š200ï¼‰
    int height;                // å›¾ç‰‡é«˜åº¦ï¼ˆå›ºå®š200ï¼‰
    long long fileSize;        // æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
    
    UploadAvatarResult() : success(false), width(0), height(0), fileSize(0) {}
};
```

**åœ¨ç±»å®šä¹‰ä¸­æ·»åŠ æ–¹æ³•å£°æ˜**ï¼ˆåœ¨`getUserPublicInfo()`ä¹‹åï¼‰ï¼š

```cpp
/**
 * @brief ä¸Šä¼ ç”¨æˆ·å¤´åƒï¼ˆv2.6.0ï¼‰
 * 
 * å¤„ç†æµç¨‹ï¼š
 * 1. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè·å–userIdé€»è¾‘IDï¼‰
 * 2. è°ƒç”¨AvatarProcessorå¤„ç†å›¾ç‰‡
 * 3. åˆ é™¤æ—§å¤´åƒæ–‡ä»¶
 * 4. æ›´æ–°æ•°æ®åº“ä¸­çš„avatar_urlå­—æ®µ
 * 5. è¿”å›ç»“æœï¼ˆåŒ…å«æ–°å¤´åƒURLï¼‰
 * 
 * @param userId ç”¨æˆ·ç‰©ç†ID
 * @param tempFilePath ä¸´æ—¶æ–‡ä»¶è·¯å¾„
 * @return UploadAvatarResult ä¸Šä¼ ç»“æœ
 */
UploadAvatarResult uploadAvatar(int userId, const std::string& tempFilePath);
```

---

#### ä»»åŠ¡3.2ï¼šå®ç° `src/core/auth_service.cpp`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/core/auth_service.cpp`

**åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¤´æ–‡ä»¶**ï¼š
```cpp
#include "../utils/avatar_processor.h"
```

**åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–¹æ³•å®ç°**ï¼š

```cpp
// ä¸Šä¼ ç”¨æˆ·å¤´åƒ
UploadAvatarResult AuthService::uploadAvatar(int userId, const std::string& tempFilePath) {
    UploadAvatarResult result;
    
    try {
        Logger::info("å¼€å§‹ä¸Šä¼ å¤´åƒ: userId=" + std::to_string(userId) + ", tempFilePath=" + tempFilePath);
        
        // 1. è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆè·å–user_idé€»è¾‘IDï¼‰
        auto existingUser = userRepo_->findById(userId);
        if (!existingUser.has_value()) {
            result.message = "ç”¨æˆ·ä¸å­˜åœ¨";
            Logger::error(result.message + ", userId=" + std::to_string(userId));
            return result;
        }
        
        std::string userIdStr = existingUser->getUserId();
        
        // 2. è°ƒç”¨AvatarProcessorå¤„ç†å›¾ç‰‡
        std::string avatarDir = "uploads/avatars/";
        auto processResult = AvatarProcessor::processAvatar(tempFilePath, userIdStr, avatarDir);
        
        if (!processResult.success) {
            result.message = processResult.message;
            Logger::error("å¤´åƒå¤„ç†å¤±è´¥: " + result.message);
            return result;
        }
        
        Logger::info("å¤´åƒå¤„ç†æˆåŠŸ: " + processResult.avatarPath);
        
        // 3. è·å–æ—§å¤´åƒURLï¼Œåˆ é™¤æ—§æ–‡ä»¶
        std::string oldAvatarUrl = existingUser->getAvatarUrl();
        if (!oldAvatarUrl.empty()) {
            AvatarProcessor::deleteOldAvatar(oldAvatarUrl);
        }
        
        // 4. æ›´æ–°æ•°æ®åº“ä¸­çš„avatar_urlå­—æ®µ
        bool updateSuccess = userRepo_->updateAvatarUrl(userId, processResult.avatarPath);
        
        if (!updateSuccess) {
            result.message = "æ›´æ–°æ•°æ®åº“å¤±è´¥";
            Logger::error(result.message);
            
            // å›æ»šï¼šåˆ é™¤æ–°ä¸Šä¼ çš„å¤´åƒæ–‡ä»¶
            AvatarProcessor::deleteOldAvatar(processResult.avatarPath);
            
            return result;
        }
        
        Logger::info("æ•°æ®åº“æ›´æ–°æˆåŠŸ: userId=" + std::to_string(userId));
        
        // 5. å¡«å……ç»“æœ
        result.success = true;
        result.message = "å¤´åƒä¸Šä¼ æˆåŠŸ";
        result.avatarUrl = processResult.avatarPath;
        result.width = processResult.width;
        result.height = processResult.height;
        result.fileSize = processResult.fileSize;
        
        Logger::info("å¤´åƒä¸Šä¼ å®Œæˆ: userId=" + std::to_string(userId) + ", avatarUrl=" + result.avatarUrl);
        
        return result;
        
    } catch (const std::exception& e) {
        result.message = "å¤´åƒä¸Šä¼ å¼‚å¸¸: " + std::string(e.what());
        Logger::error(result.message);
        return result;
    }
}
```

**å…³é”®ç‚¹**ï¼š
1. **è·å–ç”¨æˆ·é€»è¾‘ID**ï¼šç”¨äºç”Ÿæˆæ–‡ä»¶å
2. **è°ƒç”¨AvatarProcessor**ï¼šå¤„ç†å›¾ç‰‡ï¼ˆè£å‰ª+ç¼©æ”¾+å‹ç¼©ï¼‰
3. **åˆ é™¤æ—§å¤´åƒ**ï¼šèŠ‚çœå­˜å‚¨ç©ºé—´
4. **äº‹åŠ¡æ€§å›æ»š**ï¼šå¦‚æœæ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œåˆ é™¤æ–°ä¸Šä¼ çš„æ–‡ä»¶
5. **è¯¦ç»†æ—¥å¿—**ï¼šè®°å½•æ¯ä¸ªæ­¥éª¤çš„æ‰§è¡Œæƒ…å†µ

---

#### ä»»åŠ¡3.3ï¼šç¼–è¯‘æµ‹è¯•

```bash
cd /home/kun/projects/SharePix/backend-service/build
make -j4
```

**é¢„æœŸç»“æœ**ï¼šç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

---

### é˜¶æ®µ4ï¼šHandlerå±‚ï¼ˆ1.5å°æ—¶ï¼‰

#### ä»»åŠ¡4.1ï¼šä¿®æ”¹ `src/api/auth_handler.h`

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/api/auth_handler.h`

**åœ¨ç±»å®šä¹‰çš„privateéƒ¨åˆ†æ·»åŠ æ–¹æ³•å£°æ˜**ï¼ˆåœ¨`handleCheckUsername()`ä¹‹åï¼‰ï¼š

```cpp
/**
 * @brief å¤„ç†å¤´åƒä¸Šä¼ è¯·æ±‚
 *
 * POST /api/v1/users/avatar
 */
void handleUploadAvatar(const httplib::Request& req, httplib::Response& res);
```

---

#### ä»»åŠ¡4.2ï¼šå®ç° `src/api/auth_handler.cpp` - è·¯ç”±æ³¨å†Œ

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/src/api/auth_handler.cpp`

**åœ¨`registerRoutes()`æ–¹æ³•ä¸­æ·»åŠ è·¯ç”±**ï¼ˆåœ¨ç”¨æˆ·ä¿¡æ¯ç›¸å…³è·¯ç”±ä¹‹åï¼‰ï¼š

```cpp
void AuthHandler::registerRoutes(httplib::Server& server) {
    // ... ç°æœ‰è·¯ç”± ...
    
    // æ£€æŸ¥ç”¨æˆ·åå¯ç”¨æ€§
    server.Get("/api/v1/users/check-username", [this](const httplib::Request& req, httplib::Response& res) {
        handleCheckUsername(req, res);
    });
    
    // ä¸Šä¼ ç”¨æˆ·å¤´åƒ (v2.6.0)
    server.Post("/api/v1/users/avatar", [this](const httplib::Request& req, httplib::Response& res) {
        handleUploadAvatar(req, res);
    });
    
    Logger::info("Auth routes registered");
}
```

---

#### ä»»åŠ¡4.3ï¼šå®ç° `src/api/auth_handler.cpp` - å¤„ç†æ–¹æ³•

**åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ–¹æ³•å®ç°**ï¼š

```cpp
// å¤„ç†å¤´åƒä¸Šä¼ è¯·æ±‚
void AuthHandler::handleUploadAvatar(const httplib::Request& req, httplib::Response& res) {
    Logger::info("å¤„ç†å¤´åƒä¸Šä¼ è¯·æ±‚");
    
    // 1. æå–å¹¶éªŒè¯JWTä»¤ç‰Œ
    std::string authHeader = req.get_header_value("Authorization");
    if (authHeader.empty() || authHeader.substr(0, 7) != "Bearer ") {
        sendJsonResponse(res, 401, false, "æœªæä¾›è®¤è¯ä»¤ç‰Œ");
        return;
    }
    
    std::string token = authHeader.substr(7);
    
    // 2. éªŒè¯ä»¤ç‰Œ
    TokenValidationResult validation = authService_->validateToken(token);
    
    if (!validation.valid) {
        sendJsonResponse(res, 401, false, validation.message);
        return;
    }
    
    // 3. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ä¸Šä¼ 
    if (!req.has_file("avatar")) {
        sendJsonResponse(res, 400, false, "è¯·ä¸Šä¼ å¤´åƒæ–‡ä»¶");
        Logger::warning("æœªæä¾›å¤´åƒæ–‡ä»¶");
        return;
    }
    
    // 4. è·å–ä¸Šä¼ çš„æ–‡ä»¶
    const auto& file = req.get_file_value("avatar");
    
    Logger::info("æ¥æ”¶åˆ°å¤´åƒæ–‡ä»¶: filename=" + file.filename + 
                 ", content_type=" + file.content_type + 
                 ", size=" + std::to_string(file.content.size()));
    
    // 5. éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ5MBé™åˆ¶ï¼‰
    if (file.content.size() > 5 * 1024 * 1024) {
        sendJsonResponse(res, 400, false, "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§5MBï¼‰");
        Logger::warning("æ–‡ä»¶è¿‡å¤§: " + std::to_string(file.content.size()) + " bytes");
        return;
    }
    
    if (file.content.empty()) {
        sendJsonResponse(res, 400, false, "æ–‡ä»¶ä¸ºç©º");
        Logger::warning("ç©ºæ–‡ä»¶");
        return;
    }
    
    // 6. ä¿å­˜ä¸´æ—¶æ–‡ä»¶
    std::string tempDir = "/tmp/";
    std::string tempFilename = "avatar_" + std::to_string(validation.userId) + "_" + std::to_string(std::time(nullptr));
    std::string tempFilePath = tempDir + tempFilename;
    
    FILE* tempFile = fopen(tempFilePath.c_str(), "wb");
    if (!tempFile) {
        sendJsonResponse(res, 500, false, "æ— æ³•åˆ›å»ºä¸´æ—¶æ–‡ä»¶");
        Logger::error("fopenå¤±è´¥: " + tempFilePath);
        return;
    }
    
    size_t written = fwrite(file.content.data(), 1, file.content.size(), tempFile);
    fclose(tempFile);
    
    if (written != file.content.size()) {
        sendJsonResponse(res, 500, false, "ä¸´æ—¶æ–‡ä»¶å†™å…¥å¤±è´¥");
        Logger::error("fwriteå¤±è´¥: written=" + std::to_string(written) + ", expected=" + std::to_string(file.content.size()));
        unlink(tempFilePath.c_str());
        return;
    }
    
    Logger::info("ä¸´æ—¶æ–‡ä»¶å·²ä¿å­˜: " + tempFilePath);
    
    // 7. è°ƒç”¨Serviceå±‚å¤„ç†å¤´åƒä¸Šä¼ 
    UploadAvatarResult result = authService_->uploadAvatar(validation.userId, tempFilePath);
    
    // 8. åˆ é™¤ä¸´æ—¶æ–‡ä»¶
    unlink(tempFilePath.c_str());
    Logger::info("ä¸´æ—¶æ–‡ä»¶å·²åˆ é™¤: " + tempFilePath);
    
    // 9. è¿”å›ç»“æœ
    if (!result.success) {
        sendJsonResponse(res, 400, false, result.message);
        return;
    }
    
    // 10. æ„å»ºå“åº”æ•°æ®
    Json::Value data;
    data["avatar_url"] = UrlHelper::toFullUrl(result.avatarUrl);  // æ·»åŠ æœåŠ¡å™¨URLå‰ç¼€
    data["width"] = result.width;
    data["height"] = result.height;
    data["file_size"] = static_cast<Json::Int64>(result.fileSize);
    
    sendJsonResponse(res, 200, true, result.message, data);
    Logger::info("å¤´åƒä¸Šä¼ æˆåŠŸ: userId=" + std::to_string(validation.userId) + ", avatarUrl=" + result.avatarUrl);
}
```

**å…³é”®ç‚¹**ï¼š
1. **JWTéªŒè¯**ï¼šç¡®ä¿ç”¨æˆ·å·²ç™»å½•
2. **æ–‡ä»¶æ£€æŸ¥**ï¼šä½¿ç”¨`req.has_file("avatar")`æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
3. **å¤§å°éªŒè¯**ï¼šå‰ç½®éªŒè¯ï¼Œé¿å…å¤„ç†è¶…å¤§æ–‡ä»¶
4. **ä¸´æ—¶æ–‡ä»¶**ï¼šä¿å­˜åˆ°`/tmp/`ç›®å½•ï¼Œå¤„ç†å®Œåç«‹å³åˆ é™¤
5. **URLå‰ç¼€**ï¼šä½¿ç”¨`UrlHelper::toFullUrl()`æ·»åŠ æœåŠ¡å™¨URL
6. **é”™è¯¯å¤„ç†**ï¼šæ¯ä¸€æ­¥éƒ½æœ‰è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

---

#### ä»»åŠ¡4.4ï¼šç¼–è¯‘æµ‹è¯•

```bash
cd /home/kun/projects/SharePix/backend-service/build
make -j4
```

**é¢„æœŸç»“æœ**ï¼šç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯

---

### é˜¶æ®µ5ï¼šé›†æˆæµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰

#### ä»»åŠ¡5.1ï¼šå¯åŠ¨æœåŠ¡å™¨

```bash
cd /home/kun/projects/SharePix/backend-service
./build/knot_image_sharing config/config.json
```

**éªŒè¯å¯åŠ¨æˆåŠŸ**ï¼š
```
[INFO] AvatarProcessor initialized
[INFO] Auth routes registered (including POST /api/v1/users/avatar)
[INFO] HTTP Server started on 0.0.0.0:8080
```

---

#### ä»»åŠ¡5.2ï¼šä½¿ç”¨Apifoxæµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹1ï¼šæˆåŠŸä¸Šä¼ å¤´åƒ**

**æ¥å£**ï¼š`POST http://43.142.157.145:8080/api/v1/users/avatar`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {æœ‰æ•ˆçš„access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚Body**ï¼ˆForm-dataï¼‰ï¼š
| Key | Type | Value |
|-----|------|-------|
| avatar | File | [é€‰æ‹©ä¸€å¼ å›¾ç‰‡æ–‡ä»¶] |

**é¢„æœŸå“åº”**ï¼ˆ200ï¼‰ï¼š
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg",
    "width": 200,
    "height": 200,
    "file_size": 45678
  },
  "timestamp": 1729584000
}
```

**æµ‹è¯•ç”¨ä¾‹2ï¼šæœªæä¾›æ–‡ä»¶**

**æ¥å£**ï¼š`POST http://43.142.157.145:8080/api/v1/users/avatar`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {æœ‰æ•ˆçš„access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚Body**ï¼šï¼ˆç©ºï¼‰

**é¢„æœŸå“åº”**ï¼ˆ400ï¼‰ï¼š
```json
{
  "success": false,
  "message": "è¯·ä¸Šä¼ å¤´åƒæ–‡ä»¶",
  "data": null,
  "timestamp": 1729584000
}
```

**æµ‹è¯•ç”¨ä¾‹3ï¼šæ–‡ä»¶è¿‡å¤§**

**æ¥å£**ï¼š`POST http://43.142.157.145:8080/api/v1/users/avatar`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {æœ‰æ•ˆçš„access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚Body**ï¼ˆForm-dataï¼‰ï¼š
| Key | Type | Value |
|-----|------|-------|
| avatar | File | [é€‰æ‹©ä¸€å¼ >5MBçš„å›¾ç‰‡] |

**é¢„æœŸå“åº”**ï¼ˆ400ï¼‰ï¼š
```json
{
  "success": false,
  "message": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§5MBï¼‰",
  "data": null,
  "timestamp": 1729584000
}
```

**æµ‹è¯•ç”¨ä¾‹4ï¼šæœªæˆæƒ**

**æ¥å£**ï¼š`POST http://43.142.157.145:8080/api/v1/users/avatar`

**è¯·æ±‚å¤´**ï¼š
```
Content-Type: multipart/form-data
```

**è¯·æ±‚Body**ï¼ˆForm-dataï¼‰ï¼š
| Key | Type | Value |
|-----|------|-------|
| avatar | File | [é€‰æ‹©ä¸€å¼ å›¾ç‰‡æ–‡ä»¶] |

**é¢„æœŸå“åº”**ï¼ˆ401ï¼‰ï¼š
```json
{
  "success": false,
  "message": "æœªæä¾›è®¤è¯ä»¤ç‰Œ",
  "data": null,
  "timestamp": 1729584000
}
```

**æµ‹è¯•ç”¨ä¾‹5ï¼šä¸æ”¯æŒçš„æ ¼å¼**

**æ¥å£**ï¼š`POST http://43.142.157.145:8080/api/v1/users/avatar`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {æœ‰æ•ˆçš„access_token}
Content-Type: multipart/form-data
```

**è¯·æ±‚Body**ï¼ˆForm-dataï¼‰ï¼š
| Key | Type | Value |
|-----|------|-------|
| avatar | File | [é€‰æ‹©ä¸€ä¸ª.txtæˆ–.pdfæ–‡ä»¶] |

**é¢„æœŸå“åº”**ï¼ˆ400ï¼‰ï¼š
```json
{
  "success": false,
  "message": "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œä»…æ”¯æŒJPEG/PNG/GIF/WebP",
  "data": null,
  "timestamp": 1729584000
}
```

---

#### ä»»åŠ¡5.3ï¼šéªŒè¯æ–‡ä»¶ç³»ç»Ÿ

**æ£€æŸ¥å¤´åƒæ–‡ä»¶æ˜¯å¦ç”Ÿæˆ**ï¼š
```bash
ls -lh /home/kun/projects/SharePix/backend-service/uploads/avatars/
```

**é¢„æœŸè¾“å‡º**ï¼š
```
-rw-r--r-- 1 kun kun 44K Oct 18 10:30 USR_2025Q4_abc123_1729584000.jpg
```

**æ£€æŸ¥æ–‡ä»¶å°ºå¯¸å’Œè´¨é‡**ï¼š
```bash
file /home/kun/projects/SharePix/backend-service/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg
```

**é¢„æœŸè¾“å‡º**ï¼š
```
JPEG image data, JFIF standard 1.01, resolution (DPI), density 72x72, segment length 16, baseline, precision 8, 200x200, components 3
```

---

#### ä»»åŠ¡5.4ï¼šéªŒè¯æ•°æ®åº“

**æŸ¥è¯¢ç”¨æˆ·å¤´åƒURL**ï¼š
```sql
SELECT id, user_id, username, avatar_url, update_time 
FROM users 
WHERE id = {æµ‹è¯•ç”¨æˆ·ID};
```

**é¢„æœŸç»“æœ**ï¼š
```
id  | user_id              | username | avatar_url                                      | update_time
----|----------------------|----------|-------------------------------------------------|-------------------
123 | USR_2025Q4_abc123    | testuser | /uploads/avatars/USR_2025Q4_abc123_1729584000.jpg | 2025-10-18 10:30:00
```

---

#### ä»»åŠ¡5.5ï¼šéªŒè¯æ—§å¤´åƒåˆ é™¤

**æ­¥éª¤**ï¼š
1. ä¸Šä¼ ç¬¬ä¸€å¼ å¤´åƒ â†’ è®°å½•æ–‡ä»¶åï¼š`USR_xxx_1729584000.jpg`
2. ä¸Šä¼ ç¬¬äºŒå¼ å¤´åƒ â†’ è®°å½•æ–‡ä»¶åï¼š`USR_xxx_1729584100.jpg`
3. æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿ

**é¢„æœŸç»“æœ**ï¼š
```bash
ls -lh uploads/avatars/
# ä»…æ˜¾ç¤ºæœ€æ–°çš„å¤´åƒæ–‡ä»¶
-rw-r--r-- 1 kun kun 42K Oct 18 10:32 USR_2025Q4_abc123_1729584100.jpg
```

æ—§æ–‡ä»¶`USR_xxx_1729584000.jpg`åº”å·²è¢«åˆ é™¤ã€‚

---

#### ä»»åŠ¡5.6ï¼šéªŒè¯GETç”¨æˆ·ä¿¡æ¯æ¥å£

**æ¥å£**ï¼š`GET http://43.142.157.145:8080/api/v1/users/profile`

**è¯·æ±‚å¤´**ï¼š
```
Authorization: Bearer {æœ‰æ•ˆçš„access_token}
```

**é¢„æœŸå“åº”**ï¼ˆ200ï¼‰ï¼š
```json
{
  "success": true,
  "message": "è·å–ç”¨æˆ·ä¿¡æ¯æˆåŠŸ",
  "data": {
    "id": 123,
    "user_id": "USR_2025Q4_abc123",
    "username": "testuser",
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584100.jpg",  // â† å®Œæ•´URL
    ...
  },
  "timestamp": 1729584000
}
```

**éªŒè¯ç‚¹**ï¼š`avatar_url`å­—æ®µåº”åŒ…å«æœåŠ¡å™¨URLå‰ç¼€ã€‚

---

### é˜¶æ®µ6ï¼šæ–‡æ¡£æ›´æ–°ï¼ˆ30åˆ†é’Ÿï¼‰

#### ä»»åŠ¡6.1ï¼šæ›´æ–°APIæ–‡æ¡£

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/project_document/[000]APIæ–‡æ¡£.md`

**åœ¨"ç”¨æˆ·ä¿¡æ¯ç®¡ç†"ç« èŠ‚æ·»åŠ æ–°æ¥å£**ï¼š

```markdown
## 5. ä¸Šä¼ ç”¨æˆ·å¤´åƒ (v2.6.0)

### æ¥å£ä¿¡æ¯
- **æ¥å£åç§°**: ä¸Šä¼ ç”¨æˆ·å¤´åƒ
- **æ¥å£è·¯å¾„**: `/api/v1/users/avatar`
- **è¯·æ±‚æ–¹å¼**: POST
- **æ¥å£è¯´æ˜**: ç”¨æˆ·ä¸Šä¼ å¤´åƒå›¾ç‰‡ï¼Œç³»ç»Ÿè‡ªåŠ¨è£å‰ªã€å‹ç¼©ã€ç”Ÿæˆ200x200æ­£æ–¹å½¢å¤´åƒ
- **è®¤è¯è¦æ±‚**: éœ€è¦JWTä»¤ç‰Œï¼ˆBearer Tokenï¼‰

### è¯·æ±‚å‚æ•°

#### è¯·æ±‚å¤´
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|------|
| Authorization | string | æ˜¯ | JWTè®¿é—®ä»¤ç‰Œ | Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... |
| Content-Type | string | æ˜¯ | å†…å®¹ç±»å‹ | multipart/form-data |

#### è¯·æ±‚Body (Form-data)
| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é™åˆ¶ |
|--------|------|------|------|------|
| avatar | File | æ˜¯ | å¤´åƒå›¾ç‰‡æ–‡ä»¶ | æœ€å¤§5MBï¼Œæ”¯æŒJPEG/PNG/GIF/WebP |

### å“åº”å‚æ•°

#### æˆåŠŸå“åº” (200)
| å‚æ•°è·¯å¾„ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|----------|------|------|------|
| success | boolean | è¯·æ±‚æ˜¯å¦æˆåŠŸ | true |
| message | string | å“åº”æ¶ˆæ¯ | "å¤´åƒä¸Šä¼ æˆåŠŸ" |
| data.avatar_url | string | å¤´åƒå®Œæ•´URL | "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg" |
| data.width | integer | å›¾ç‰‡å®½åº¦ | 200 |
| data.height | integer | å›¾ç‰‡é«˜åº¦ | 200 |
| data.file_size | integer | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ | 45678 |
| timestamp | integer | æ—¶é—´æˆ³ | 1729584000 |

#### æˆåŠŸå“åº”ç¤ºä¾‹
```json
{
  "success": true,
  "message": "å¤´åƒä¸Šä¼ æˆåŠŸ",
  "data": {
    "avatar_url": "http://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg",
    "width": 200,
    "height": 200,
    "file_size": 45678
  },
  "timestamp": 1729584000
}
```

#### é”™è¯¯å“åº”

| HTTPçŠ¶æ€ç  | message | è¯´æ˜ |
|-----------|---------|------|
| 400 | è¯·ä¸Šä¼ å¤´åƒæ–‡ä»¶ | æœªæä¾›æ–‡ä»¶ |
| 400 | æ–‡ä»¶ä¸ºç©º | ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹ä¸ºç©º |
| 400 | æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§5MBï¼‰ | æ–‡ä»¶è¿‡å¤§ |
| 400 | ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼Œä»…æ”¯æŒJPEG/PNG/GIF/WebP | æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ |
| 400 | å›¾ç‰‡å°ºå¯¸è¿‡å¤§ï¼ˆæœ€å¤§10000x10000ï¼‰ | å›¾ç‰‡å°ºå¯¸è¶…å‡ºé™åˆ¶ |
| 400 | å¤´åƒå¤„ç†å¤±è´¥ | å›¾ç‰‡å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™ |
| 401 | æœªæä¾›è®¤è¯ä»¤ç‰Œ | ç¼ºå°‘Authorizationå¤´ |
| 401 | ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ | TokenéªŒè¯å¤±è´¥ |
| 500 | æ— æ³•åˆ›å»ºä¸´æ—¶æ–‡ä»¶ | æœåŠ¡å™¨ä¸´æ—¶ç›®å½•å†™å…¥å¤±è´¥ |
| 500 | æ•°æ®åº“æ›´æ–°å¤±è´¥ | æ•°æ®åº“æ“ä½œå¤±è´¥ |

#### é”™è¯¯å“åº”ç¤ºä¾‹
```json
{
  "success": false,
  "message": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆæœ€å¤§5MBï¼‰",
  "data": null,
  "timestamp": 1729584000
}
```

### åŠŸèƒ½è¯´æ˜

#### è‡ªåŠ¨å¤„ç†æµç¨‹
1. **æ ¼å¼éªŒè¯**ï¼šæ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦ä¸ºJPEG/PNG/GIF/WebP
2. **å¤§å°éªŒè¯**ï¼šæ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦â‰¤5MB
3. **è£å‰ª**ï¼šå¦‚æœå›¾ç‰‡ä¸æ˜¯æ­£æ–¹å½¢ï¼Œè‡ªåŠ¨å±…ä¸­è£å‰ª
4. **ç¼©æ”¾**ï¼šç¼©æ”¾åˆ°200x200æ ‡å‡†å°ºå¯¸
5. **å‹ç¼©**ï¼šä¿å­˜ä¸ºJPEGæ ¼å¼ï¼ˆ80%è´¨é‡ï¼‰
6. **åˆ é™¤æ—§å¤´åƒ**ï¼šè‡ªåŠ¨åˆ é™¤æ—§çš„å¤´åƒæ–‡ä»¶
7. **æ›´æ–°æ•°æ®åº“**ï¼šæ›´æ–°usersè¡¨çš„avatar_urlå­—æ®µ

#### æ–‡ä»¶å‘½åè§„åˆ™
```
{ç”¨æˆ·é€»è¾‘ID}_{æ—¶é—´æˆ³}.jpg
ç¤ºä¾‹ï¼šUSR_2025Q4_abc123_1729584000.jpg
```

#### å­˜å‚¨è·¯å¾„
```
ç›¸å¯¹è·¯å¾„ï¼š/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg
å®Œæ•´URLï¼šhttp://43.142.157.145:8080/uploads/avatars/USR_2025Q4_abc123_1729584000.jpg
```

### è°ƒç”¨ç¤ºä¾‹

#### cURLç¤ºä¾‹
```bash
curl -X POST "http://43.142.157.145:8080/api/v1/users/avatar" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -F "avatar=@/path/to/avatar.jpg"
```

#### JavaScript (fetch)ç¤ºä¾‹
```javascript
const formData = new FormData();
formData.append('avatar', fileInput.files[0]);

fetch('http://43.142.157.145:8080/api/v1/users/avatar', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`
  },
  body: formData
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    console.log('å¤´åƒä¸Šä¼ æˆåŠŸ:', data.data.avatar_url);
  }
});
```

#### Python (requests)ç¤ºä¾‹
```python
import requests

url = "http://43.142.157.145:8080/api/v1/users/avatar"
headers = {
    "Authorization": f"Bearer {access_token}"
}
files = {
    "avatar": open("/path/to/avatar.jpg", "rb")
}

response = requests.post(url, headers=headers, files=files)
data = response.json()

if data["success"]:
    print(f"å¤´åƒä¸Šä¼ æˆåŠŸ: {data['data']['avatar_url']}")
```

### æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶æ ¼å¼**ï¼šä»…æ”¯æŒJPEGã€PNGã€GIFã€WebPæ ¼å¼
2. **æ–‡ä»¶å¤§å°**ï¼šæœ€å¤§5MBï¼Œå»ºè®®å‹ç¼©åå†ä¸Šä¼ 
3. **å›¾ç‰‡å°ºå¯¸**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨è£å‰ªå’Œç¼©æ”¾ï¼Œå»ºè®®ä¸Šä¼ æ­£æ–¹å½¢å›¾ç‰‡
4. **æ—§å¤´åƒ**ï¼šä¸Šä¼ æ–°å¤´åƒåï¼Œæ—§å¤´åƒæ–‡ä»¶ä¼šè¢«è‡ªåŠ¨åˆ é™¤
5. **URLå‰ç¼€**ï¼šè¿”å›çš„`avatar_url`åŒ…å«æœåŠ¡å™¨URLå‰ç¼€ï¼Œå¯ç›´æ¥ä½¿ç”¨
6. **è®¤è¯è¦æ±‚**ï¼šå¿…é¡»æä¾›æœ‰æ•ˆçš„JWTä»¤ç‰Œ
7. **å¹¶å‘ä¸Šä¼ **ï¼šåŒä¸€ç”¨æˆ·çš„å¤šæ¬¡ä¸Šä¼ ä¼šä¾æ¬¡å¤„ç†ï¼Œä¸ä¼šé€ æˆå†²çª

### ç›¸å…³æ¥å£

- **è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯**: `GET /api/v1/users/profile` - å¯æŸ¥çœ‹ä¸Šä¼ åçš„å¤´åƒURL
- **ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯**: `PUT /api/v1/users/profile` - ä¹Ÿå¯é€šè¿‡æ­¤æ¥å£ä¼ é€’å¤´åƒURLå­—ç¬¦ä¸²ï¼ˆä¸æ¨èï¼‰
```

---

#### ä»»åŠ¡6.2ï¼šæ›´æ–°CLAUDE.md

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/CLAUDE.md`

**æ›´æ–°"å½“å‰çŠ¶æ€"éƒ¨åˆ†**ï¼š
```markdown
**å½“å‰ç‰ˆæœ¬**: v2.6.0

**å½“å‰çŠ¶æ€**:
- âœ… ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼ˆæ³¨å†Œã€ç™»å½•ã€JWTä»¤ç‰Œç®¡ç†ã€å¯†ç ä¿®æ”¹ï¼‰
- âœ… ç”¨æˆ·ä¿¡æ¯ç®¡ç†ç³»ç»Ÿï¼ˆv2.1.0 - è·å–/ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯ã€ç”¨æˆ·åæ£€æŸ¥ã€å…¬å¼€ä¿¡æ¯æŸ¥è¯¢ï¼‰
- âœ… **ç”¨æˆ·å¤´åƒä¸Šä¼ ï¼ˆv2.6.0 - æ–‡ä»¶ä¸Šä¼ ã€è‡ªåŠ¨è£å‰ªå‹ç¼©ã€æ—§æ–‡ä»¶åˆ é™¤ï¼‰**
- âœ… å¤šå›¾ç‰‡å¸–å­ç³»ç»Ÿï¼ˆv2.0.0 - 1-9å¼ å›¾ç‰‡å‘å¸ƒã€ç¼–è¾‘ã€åˆ é™¤ï¼‰
- âœ… å›¾ç‰‡ç®¡ç†ç³»ç»Ÿï¼ˆå›¾ç‰‡å‹ç¼©ã€ç¼©ç•¥å›¾ç”Ÿæˆã€Feedæ¨èï¼‰
- âœ… æ ‡ç­¾ç³»ç»Ÿï¼ˆå¸–å­æ ‡ç­¾å…³è”ã€æ ‡ç­¾ç®¡ç†ï¼‰
- âœ… åˆ†äº«ç³»ç»Ÿï¼ˆv2.3.0 - çŸ­é“¾æ¥ç”Ÿæˆã€ä¸‰ç«¯Deep Linkã€å¸–å­åˆ†äº«ï¼‰
- âœ… Feedæµä¼˜åŒ–ï¼ˆv2.5.0 - æ‰¹é‡æŸ¥è¯¢ã€å¯é€‰è®¤è¯ã€ä½œè€…ä¿¡æ¯ã€äº’åŠ¨çŠ¶æ€ï¼‰
- â³ ç¤¾äº¤äº’åŠ¨ç³»ç»Ÿï¼ˆç‚¹èµã€æ”¶è—ã€å…³æ³¨ã€è¯„è®º - è§„åˆ’ä¸­ï¼‰
```

**æ·»åŠ APIç‰ˆæœ¬å†å²**ï¼š
```markdown
### v2.6.0 (2025-10-18) - ç”¨æˆ·å¤´åƒä¸Šä¼ 
**æ–°å¢åŠŸèƒ½ï¼š**
- âœ… ç”¨æˆ·å¤´åƒä¸Šä¼ API
  - POST /api/v1/users/avatar - ä¸Šä¼ å¤´åƒæ–‡ä»¶ï¼ˆmultipart/form-dataï¼‰
- âœ… å¤´åƒè‡ªåŠ¨å¤„ç†
  - å±…ä¸­è£å‰ªä¸ºæ­£æ–¹å½¢
  - ç¼©æ”¾åˆ°200x200æ ‡å‡†å°ºå¯¸
  - JPEGå‹ç¼©ï¼ˆ80%è´¨é‡ï¼‰
  - è‡ªåŠ¨åˆ é™¤æ—§å¤´åƒæ–‡ä»¶

**æŠ€æœ¯å®ç°ï¼š**
- æ–°å¢å·¥å…·ç±»ï¼šAvatarProcessorï¼ˆå¤´åƒå¤„ç†å™¨ï¼‰
- Repositoryå±‚ï¼šupdateAvatarUrl()æ–¹æ³•
- Serviceå±‚ï¼šuploadAvatar()æ–¹æ³•
- Handlerå±‚ï¼šhandleUploadAvatar()æ–¹æ³•

**æŠ€æœ¯äº®ç‚¹ï¼š**
- ä½¿ç”¨stb_imageåº“è¿›è¡Œè·¨æ ¼å¼å›¾ç‰‡å¤„ç†
- æ”¯æŒJPEG/PNG/GIF/WebPæ ¼å¼
- äº‹åŠ¡æ€§å›æ»šï¼šæ•°æ®åº“æ›´æ–°å¤±è´¥æ—¶è‡ªåŠ¨åˆ é™¤æ–°ä¸Šä¼ çš„æ–‡ä»¶
- æ–‡ä»¶å¤§å°é™åˆ¶5MBï¼Œå›¾ç‰‡å°ºå¯¸é™åˆ¶10000x10000

**æ–‡æ¡£ï¼š** `[120]ç”¨æˆ·å¤´åƒä¸Šä¼ åŠŸèƒ½-å®æ–½æ–¹æ¡ˆ.md`
```

---

#### ä»»åŠ¡6.3ï¼šæ›´æ–°README.md

**æ–‡ä»¶è·¯å¾„**ï¼š`/home/kun/projects/SharePix/backend-service/README.md`

**åœ¨"åŠŸèƒ½æ¨¡å—ç»Ÿè®¡"è¡¨æ ¼ä¸­æ·»åŠ **ï¼š
```markdown
| åŠŸèƒ½æ¨¡å— | çŠ¶æ€ | APIæ•°é‡ | æ•°æ®è¡¨ |
|---------|------|---------|--------|
| ç”¨æˆ·è®¤è¯ | âœ… å·²å®Œæˆ | 6ä¸ª | users |
| ç”¨æˆ·ä¿¡æ¯ç®¡ç† | âœ… å·²å®Œæˆ (v2.1.0) | 4ä¸ª | users |
| ç”¨æˆ·å¤´åƒä¸Šä¼  | âœ… å·²å®Œæˆ (v2.6.0) | 1ä¸ª | users |
| å¤šå›¾ç‰‡å¸–å­ | âœ… å·²å®Œæˆ (v2.0.0) | 8ä¸ª | posts, images |
| æ ‡ç­¾ç³»ç»Ÿ | âœ… å·²å®Œæˆ | 4ä¸ª | tags, post_tags |
| åˆ†äº«ç³»ç»Ÿ | âœ… å·²å®Œæˆ (v2.3.0) | 2ä¸ª | share_links |
| Feedæµä¼˜åŒ– | âœ… å·²å®Œæˆ (v2.5.0) | - | - |
| ç¤¾äº¤äº’åŠ¨ | â³ è§„åˆ’ä¸­ | é¢„è®¡12ä¸ª | likes, favorites, follows, comments |
```

---

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] ç”¨æˆ·å¯ä»¥æˆåŠŸä¸Šä¼ å¤´åƒï¼ˆJPEG/PNG/GIF/WebPæ ¼å¼ï¼‰
- [ ] ç³»ç»Ÿè‡ªåŠ¨è£å‰ªä¸ºæ­£æ–¹å½¢ï¼ˆå±…ä¸­è£å‰ªï¼‰
- [ ] ç³»ç»Ÿè‡ªåŠ¨ç¼©æ”¾åˆ°200x200
- [ ] ç³»ç»Ÿè‡ªåŠ¨å‹ç¼©ä¿å­˜ä¸ºJPEGï¼ˆ80%è´¨é‡ï¼‰
- [ ] ä¸Šä¼ æ–°å¤´åƒåï¼Œæ—§å¤´åƒæ–‡ä»¶è¢«è‡ªåŠ¨åˆ é™¤
- [ ] è¿”å›çš„avatar_urlåŒ…å«æœåŠ¡å™¨URLå‰ç¼€
- [ ] GET /api/v1/users/profileæ¥å£è¿”å›æœ€æ–°çš„å¤´åƒURL
- [ ] æ–‡ä»¶å¤§å°è¶…è¿‡5MBæ—¶è¿”å›é”™è¯¯æç¤º
- [ ] ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼è¿”å›é”™è¯¯æç¤º
- [ ] æœªæä¾›JWTä»¤ç‰Œæ—¶è¿”å›401é”™è¯¯

### æŠ€æœ¯éªŒæ”¶

- [ ] AvatarProcessorç±»æ­£ç¡®å®ç°å›¾ç‰‡å¤„ç†é€»è¾‘
- [ ] Repositoryå±‚çš„updateAvatarUrl()æ–¹æ³•æ­£ç¡®æ›´æ–°æ•°æ®åº“
- [ ] Serviceå±‚çš„uploadAvatar()æ–¹æ³•æ­£ç¡®å¤„ç†ä¸šåŠ¡é€»è¾‘
- [ ] Handlerå±‚çš„handleUploadAvatar()æ–¹æ³•æ­£ç¡®å¤„ç†HTTPè¯·æ±‚
- [ ] ä¸´æ—¶æ–‡ä»¶åœ¨å¤„ç†å®Œåè¢«æ­£ç¡®åˆ é™¤
- [ ] æ•°æ®åº“æ›´æ–°å¤±è´¥æ—¶ï¼Œæ–°ä¸Šä¼ çš„æ–‡ä»¶è¢«æ­£ç¡®å›æ»šåˆ é™¤
- [ ] æ‰€æœ‰é”™è¯¯æƒ…å†µéƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•
- [ ] ç¼–è¯‘æ— è­¦å‘Šæ— é”™è¯¯

### æ€§èƒ½éªŒæ”¶

- [ ] å•æ¬¡å¤´åƒä¸Šä¼ å¤„ç†æ—¶é—´ < 2ç§’ï¼ˆ1MBå›¾ç‰‡ï¼‰
- [ ] å¹¶å‘10ä¸ªå¤´åƒä¸Šä¼ è¯·æ±‚ï¼ŒæˆåŠŸç‡100%
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹é€šè¿‡ï¼ˆvalgrindï¼‰
- [ ] å‹ç¼©åçš„æ–‡ä»¶å¤§å° < 100KBï¼ˆå…¸å‹å€¼ï¼‰

### æ–‡æ¡£éªŒæ”¶

- [ ] [000]APIæ–‡æ¡£.mdå·²æ›´æ–°
- [ ] CLAUDE.mdå·²æ›´æ–°ï¼ˆAPIç‰ˆæœ¬å†å²ã€å½“å‰çŠ¶æ€ï¼‰
- [ ] README.mdå·²æ›´æ–°ï¼ˆåŠŸèƒ½æ¨¡å—ç»Ÿè®¡ï¼‰
- [ ] æœ¬æ–‡æ¡£æ ‡è®°ä¸ºå·²å®Œæˆ

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ”¯æŒå¤´åƒåˆ é™¤ï¼ˆv2.7.0ï¼‰
```
DELETE /api/v1/users/avatar
// å°†avatar_urlè®¾ç½®ä¸ºNULLï¼Œåˆ é™¤æ–‡ä»¶
```

### 2. æ”¯æŒBase64ä¸Šä¼ ï¼ˆv2.7.0ï¼‰
```json
POST /api/v1/users/avatar
{
  "avatar": "data:image/jpeg;base64,/9j/4AAQSkZJRgABA..."
}
```

### 3. æ”¯æŒå¤šå°ºå¯¸å¤´åƒï¼ˆv2.8.0ï¼‰
- å°å°ºå¯¸ï¼š50x50ï¼ˆç”¨äºåˆ—è¡¨å±•ç¤ºï¼‰
- ä¸­å°ºå¯¸ï¼š100x100ï¼ˆç”¨äºè¯„è®ºåŒºï¼‰
- å¤§å°ºå¯¸ï¼š200x200ï¼ˆç”¨äºä¸ªäººä¸»é¡µï¼‰

### 4. æ”¯æŒCDNåŠ é€Ÿï¼ˆv3.0.0ï¼‰
- é›†æˆé˜¿é‡Œäº‘OSSæˆ–ä¸ƒç‰›äº‘
- è‡ªåŠ¨åŒæ­¥å¤´åƒåˆ°CDN
- è¿”å›CDN URL

### 5. æ”¯æŒå¤´åƒå®¡æ ¸ï¼ˆv3.0.0ï¼‰
- æ¥å…¥é˜¿é‡Œäº‘å†…å®¹å®‰å…¨API
- è‡ªåŠ¨æ£€æµ‹è¿è§„å›¾ç‰‡
- å¼‚æ­¥å®¡æ ¸ï¼Œå…ˆä¸Šä¼ åå®¡æ ¸

---

## ğŸ“Œ å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: ä¸ºä»€ä¹ˆå¤´åƒå›ºå®šä¸º200x200ï¼Ÿ
**A**: ä¸ºäº†ç»Ÿä¸€UIé£æ ¼å’ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚200x200æ˜¯å¸¸è§çš„å¤´åƒå°ºå¯¸ï¼Œæ—¢æ¸…æ™°åˆä¸å ç”¨è¿‡å¤šç©ºé—´ã€‚

### Q2: ä¸ºä»€ä¹ˆåªæ”¯æŒJPEG/PNG/GIF/WebPï¼Ÿ
**A**: è¿™äº›æ˜¯Webç«¯æœ€å¸¸ç”¨çš„å›¾ç‰‡æ ¼å¼ï¼Œstb_imageåº“åŸç”Ÿæ”¯æŒã€‚ä¸æ”¯æŒBMPã€TIFFç­‰æ ¼å¼æ˜¯ä¸ºäº†é¿å…ç”¨æˆ·ä¸Šä¼ è¿‡å¤§çš„æœªå‹ç¼©æ–‡ä»¶ã€‚

### Q3: å¯ä»¥ä¸è£å‰ªï¼Œä¿ç•™åŸå§‹æ¯”ä¾‹å—ï¼Ÿ
**A**: ä¸å»ºè®®ã€‚å¤´åƒéœ€è¦åœ¨å„ç§åœºæ™¯ä¸‹å±•ç¤ºï¼ˆåœ†å½¢ã€æ–¹å½¢ï¼‰ï¼Œä¿æŒæ­£æ–¹å½¢å¯ä»¥é¿å…å˜å½¢ã€‚

### Q4: æ—§å¤´åƒåˆ é™¤å¤±è´¥ä¼šå½±å“æ–°å¤´åƒä¸Šä¼ å—ï¼Ÿ
**A**: ä¸ä¼šã€‚åˆ é™¤æ—§å¤´åƒæ˜¯éå…³é”®æ“ä½œï¼Œå³ä½¿å¤±è´¥ä¹Ÿä¸ä¼šå½±å“æ–°å¤´åƒçš„ä¸Šä¼ å’Œæ•°æ®åº“æ›´æ–°ã€‚

### Q5: ä¸ºä»€ä¹ˆé€‰æ‹©JPEGè€Œä¸æ˜¯PNGï¼Ÿ
**A**: JPEGå‹ç¼©ç‡æ›´é«˜ï¼Œé€‚åˆç…§ç‰‡ç±»å¤´åƒã€‚80%è´¨é‡å·²è¶³å¤Ÿæ¸…æ™°ï¼Œæ–‡ä»¶å¤§å°é€šå¸¸åªæœ‰PNGçš„1/5ã€‚

### Q6: å¯ä»¥é€šè¿‡PUT /api/v1/users/profileæ›´æ–°å¤´åƒå—ï¼Ÿ
**A**: å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚é€šè¿‡è¯¥æ¥å£åªèƒ½ä¼ é€’URLå­—ç¬¦ä¸²ï¼Œæ— æ³•äº«å—è‡ªåŠ¨è£å‰ªå‹ç¼©ç­‰åŠŸèƒ½ã€‚å»ºè®®ä½¿ç”¨POST /api/v1/users/avatarã€‚

### Q7: ä¸Šä¼ å¤´åƒåéœ€è¦åˆ·æ–°tokenå—ï¼Ÿ
**A**: ä¸éœ€è¦ã€‚å¤´åƒURLå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼ŒJWTä»¤ç‰Œä¸åŒ…å«å¤´åƒä¿¡æ¯ã€‚

### Q8: æ”¯æŒåŠ¨ç”»GIFå—ï¼Ÿ
**A**: ç†è®ºæ”¯æŒåŠ è½½GIFï¼Œä½†ä¼šè¢«è½¬æ¢ä¸ºé™æ€JPEGã€‚å¦‚éœ€æ”¯æŒåŠ¨ç”»ï¼Œéœ€è¦ä¿®æ”¹ä»£ç è·³è¿‡GIFçš„å‹ç¼©æ­¥éª¤ã€‚

---

## ğŸ“… æ—¶é—´è§„åˆ’

| æ—¥æœŸ | é˜¶æ®µ | å·¥ä½œå†…å®¹ | é¢„è®¡è€—æ—¶ | è´Ÿè´£äºº |
|------|------|----------|----------|--------|
| Day 1ä¸Šåˆ | é˜¶æ®µ0-1 | åˆ›å»ºç›®å½• + å·¥å…·å±‚å¼€å‘ | 2å°æ—¶ | å¼€å‘ |
| Day 1ä¸‹åˆ | é˜¶æ®µ2-3 | Repositoryå±‚ + Serviceå±‚ | 1.5å°æ—¶ | å¼€å‘ |
| Day 1æ™šä¸Š | é˜¶æ®µ4 | Handlerå±‚å¼€å‘ | 1.5å°æ—¶ | å¼€å‘ |
| Day 2ä¸Šåˆ | é˜¶æ®µ5 | é›†æˆæµ‹è¯• | 1å°æ—¶ | æµ‹è¯• |
| Day 2ä¸‹åˆ | é˜¶æ®µ6 | æ–‡æ¡£æ›´æ–° + éªŒæ”¶ | 0.5å°æ—¶ | æ–‡æ¡£ |

**æ€»è®¡**: çº¦6.5å°æ—¶ï¼ˆåˆ†2å¤©å®Œæˆï¼‰

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ
- [ ] é˜¶æ®µ0ï¼šåˆ›å»ºå­˜å‚¨ç›®å½• (5åˆ†é’Ÿ)
- [ ] é˜¶æ®µ1ï¼šå®ç°AvatarProcessorå·¥å…·ç±» (2å°æ—¶)
- [ ] é˜¶æ®µ2ï¼šRepositoryå±‚ - updateAvatarUrl() (30åˆ†é’Ÿ)
- [ ] é˜¶æ®µ3ï¼šServiceå±‚ - uploadAvatar() (1å°æ—¶)
- [ ] é˜¶æ®µ4ï¼šHandlerå±‚ - handleUploadAvatar() (1.5å°æ—¶)

### æµ‹è¯•é˜¶æ®µ
- [ ] é˜¶æ®µ5ï¼šé›†æˆæµ‹è¯• (1å°æ—¶)
  - [ ] æµ‹è¯•ç”¨ä¾‹1ï¼šæˆåŠŸä¸Šä¼ å¤´åƒ
  - [ ] æµ‹è¯•ç”¨ä¾‹2ï¼šæœªæä¾›æ–‡ä»¶
  - [ ] æµ‹è¯•ç”¨ä¾‹3ï¼šæ–‡ä»¶è¿‡å¤§
  - [ ] æµ‹è¯•ç”¨ä¾‹4ï¼šæœªæˆæƒ
  - [ ] æµ‹è¯•ç”¨ä¾‹5ï¼šä¸æ”¯æŒçš„æ ¼å¼
  - [ ] éªŒè¯æ–‡ä»¶ç³»ç»Ÿ
  - [ ] éªŒè¯æ•°æ®åº“
  - [ ] éªŒè¯æ—§å¤´åƒåˆ é™¤
  - [ ] éªŒè¯GETç”¨æˆ·ä¿¡æ¯æ¥å£

### æ–‡æ¡£é˜¶æ®µ
- [ ] é˜¶æ®µ6ï¼šæ–‡æ¡£æ›´æ–° (30åˆ†é’Ÿ)
  - [ ] æ›´æ–°[000]APIæ–‡æ¡£.md
  - [ ] æ›´æ–°CLAUDE.md
  - [ ] æ›´æ–°README.md
  - [ ] æ ‡è®°æœ¬æ–‡æ¡£ä¸ºå·²å®Œæˆ

### éªŒæ”¶é˜¶æ®µ
- [ ] åŠŸèƒ½éªŒæ”¶ï¼ˆ10é¡¹ï¼‰
- [ ] æŠ€æœ¯éªŒæ”¶ï¼ˆ8é¡¹ï¼‰
- [ ] æ€§èƒ½éªŒæ”¶ï¼ˆ4é¡¹ï¼‰
- [ ] æ–‡æ¡£éªŒæ”¶ï¼ˆ4é¡¹ï¼‰

---

## ğŸ“– å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£
- [stb_image æ–‡æ¡£](https://github.com/nothings/stb)
- [cpp-httplib multipart/form-data](https://github.com/yhirose/cpp-httplib#multipartform-data)
- [JPEGå‹ç¼©è´¨é‡å‚è€ƒ](https://stackoverflow.com/questions/418181/recommended-compression-quality-settings)

### ç›¸å…³æ–‡æ¡£
- `[106]ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŠŸèƒ½å®Œå–„-å®æ–½è®¡åˆ’.md` - ç”¨æˆ·ä¿¡æ¯ç®¡ç†åŸºç¡€
- `[102]é˜¶æ®µC-å›¾ç‰‡ç®¡ç†æ¨¡å—.md` - ImageProcessorå®ç°å‚è€ƒ
- `[110]v2.4.0-å›¾ç‰‡URLè‡ªåŠ¨å‰ç¼€åŠŸèƒ½.md` - UrlHelperä½¿ç”¨æŒ‡å—

---

**æ–‡æ¡£ç»“æŸ**

*åˆ›å»ºäººï¼šClaude*
*åˆ›å»ºæ—¶é—´ï¼š2025-10-18*
*æœ€åæ›´æ–°ï¼š2025-10-18*

