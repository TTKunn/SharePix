# è¯„è®ºåŠŸèƒ½å®ç°æ–¹æ¡ˆ

**æ–‡æ¡£ç¼–å·**: [112]
**åˆ›å»ºæ—¶é—´**: 2025-10-19
**æœ€åå®¡æ ¸**: 2025-10-19
**é¡¹ç›®**: Knot - Image Sharing Service  
**ç‰ˆæœ¬**: v2.8.0
**çŠ¶æ€**: âœ… å·²å®Œæˆå®¡æ ¸
**RAIIè®¾è®¡**: âœ… å®Œå…¨ç¬¦åˆ
**æ•°æ®åº“éªŒè¯**: âœ… å·²è¿æ¥å®é™…æ•°æ®åº“éªŒè¯

---

## ğŸ” å®¡æ ¸æ‘˜è¦ (2025-10-19)

### å®¡æ ¸ç»“æœ: âœ… é€šè¿‡

**å®¡æ ¸å†…å®¹**:
1. âœ… **RAIIè®¾è®¡å®¡æ ¸** - å®Œå…¨ç¬¦åˆé¡¹ç›®RAIIè§„èŒƒ
2. âœ… **æ•°æ®åº“è®¾è®¡å®¡æ ¸** - å·²è¿æ¥å®é™…æ•°æ®åº“(8.138.115.164)éªŒè¯
3. âœ… **æ¶æ„ä¸€è‡´æ€§å®¡æ ¸** - å®Œå…¨éµå¾ªä¹å±‚æ¶æ„è®¾è®¡
4. âœ… **ä»£ç é£æ ¼å®¡æ ¸** - ä¸ç°æœ‰ç‚¹èµ/æ”¶è—åŠŸèƒ½ä¿æŒä¸€è‡´

**å…³é”®å‘ç°**:

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|-----|------|------|
| ConnectionGuard | âœ… æ­£å¸¸ | å®Œæ•´çš„RAIIè¿æ¥ç®¡ç†,è‡ªåŠ¨è·å–/å½’è¿˜è¿æ¥ |
| MySQLStatement | âœ… æ­£å¸¸ | å®Œæ•´çš„RAIIè¯­å¥ç®¡ç†,è‡ªåŠ¨å…³é—­é¢„ç¼–è¯‘è¯­å¥ |
| std::unique_ptr | âœ… æ­£å¸¸ | Serviceå±‚æ­£ç¡®ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†Repository |
| äº‹åŠ¡ç®¡ç† | âœ… æ­£å¸¸ | å®Œæ•´çš„äº‹åŠ¡RAIIæ¨¡å¼ |
| postsè¡¨ç»“æ„ | âš ï¸ éœ€ä¿®æ”¹ | ç¼ºå°‘comment_countå­—æ®µ,éœ€è¦ALTER TABLEæ·»åŠ  |
| commentsè¡¨ | âŒ ä¸å­˜åœ¨ | éœ€è¦åˆ›å»º,å·²æ ¹æ®likesè¡¨è®¾è®¡å®Œæ•´ç»“æ„ |
| å¤–é”®å‘½å | âœ… ä¸€è‡´ | ä½¿ç”¨comments_ibfk_1/2,ä¸likesè¡¨ä¿æŒä¸€è‡´ |
| ç´¢å¼•è®¾è®¡ | âœ… ä¼˜åŒ– | å¤åˆç´¢å¼•(post_id,create_time DESC)ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢ |
| å­—ç¬¦é›† | âœ… ä¸€è‡´ | utf8mb4_unicode_ci |

**æ•°æ®åº“éªŒè¯è¯¦æƒ…**:
- è¿æ¥åœ°å€: `8.138.115.164:3306`
- æ•°æ®åº“å: `knot_image_sharing`
- ç°æœ‰è¡¨: users, posts, images, likes, favorites, follows, tags, post_tags, image_tags
- éªŒè¯æ—¶é—´: 2025-10-19

**è®¾è®¡è°ƒæ•´**:
1. âœ… ç§»é™¤commentsè¡¨çš„`update_time`å­—æ®µ(è¯„è®ºä¸å…è®¸ç¼–è¾‘)
2. âœ… å°†`comment_id`ä»INDEXæ”¹ä¸ºUNIQUE KEY(ä¿è¯å”¯ä¸€æ€§)
3. âœ… `create_time`æ”¹ä¸º`NULL DEFAULT CURRENT_TIMESTAMP`(ä¸likesè¡¨ä¸€è‡´)
4. âœ… å¤–é”®å‘½åæ”¹ä¸º`comments_ibfk_1`å’Œ`comments_ibfk_2`(ä¸likesè¡¨ä¸€è‡´)
5. âœ… ç§»é™¤`idx_create_time`å•å­—æ®µç´¢å¼•(å·²æœ‰å¤åˆç´¢å¼•åŒ…å«)

**æ€§èƒ½é¢„ä¼°**:
- å•æ¬¡è¯„è®ºæŸ¥è¯¢: ~10ms
- è¯„è®ºåˆ—è¡¨æŸ¥è¯¢(20æ¡): ~30ms (ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–)
- åˆ›å»ºè¯„è®º: ~50ms (åŒ…å«äº‹åŠ¡å’Œå†—ä½™å­—æ®µæ›´æ–°)

---

## ğŸ“‹ ç›®å½•

1. [éœ€æ±‚åˆ†æ](#éœ€æ±‚åˆ†æ)
2. [æ–¹æ¡ˆè®¾è®¡](#æ–¹æ¡ˆè®¾è®¡)
3. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
4. [ERå…³ç³»å›¾](#erå…³ç³»å›¾)
5. [APIè®¾è®¡](#apiè®¾è®¡)
6. [ä¸šåŠ¡æµç¨‹å›¾](#ä¸šåŠ¡æµç¨‹å›¾)
7. [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
9. [å®æ–½è®¡åˆ’](#å®æ–½è®¡åˆ’)
10. [é£é™©è¯„ä¼°](#é£é™©è¯„ä¼°)
11. [æ€»ç»“](#æ€»ç»“)

---

## éœ€æ±‚åˆ†æ

### åŠŸèƒ½èŒƒå›´

æ ¹æ®éœ€æ±‚,è¯„è®ºåŠŸèƒ½éœ€è¦å®ç°:

| åŠŸèƒ½ | æ˜¯å¦å®ç° | è¯´æ˜ |
|------|----------|------|
| âœ… å‘è¡¨è¯„è®º | æ˜¯ | ç”¨æˆ·åœ¨å¸–å­ä¸‹å‘è¡¨è¯„è®º |
| âœ… æŸ¥çœ‹è¯„è®ºåˆ—è¡¨ | æ˜¯ | æ˜¾ç¤ºè¯„è®ºäººå¤´åƒã€æ˜µç§°ã€å†…å®¹ |
| âœ… åˆ é™¤è¯„è®º | æ˜¯ | è¯„è®ºä½œè€…æˆ–å¸–å­ä½œè€…å¯åˆ é™¤ |
| âŒ è¯„è®ºç‚¹èµ | å¦ | ä¸å®ç° |
| âŒ å›å¤è¯„è®º | å¦ | ä¸å®ç°(äºŒçº§è¯„è®º) |
| âŒ è¯„è®ºä¸¾æŠ¥ | å¦ | ä¸å®ç° |

### æ ¸å¿ƒåœºæ™¯

1. **å‘è¡¨è¯„è®º**: ç”¨æˆ·åœ¨å¸–å­è¯¦æƒ…é¡µè¾“å…¥è¯„è®ºå†…å®¹å¹¶æäº¤
2. **æŸ¥çœ‹è¯„è®ºåˆ—è¡¨**: æ˜¾ç¤ºå¸–å­ä¸‹çš„æ‰€æœ‰è¯„è®º,æŒ‰æ—¶é—´å€’åº
3. **åˆ é™¤è¯„è®º**: ç”¨æˆ·å¯ä»¥åˆ é™¤è‡ªå·±çš„è¯„è®º,å¸–å­ä½œè€…å¯ä»¥åˆ é™¤å¸–å­ä¸‹çš„ä»»æ„è¯„è®º

---

## æ–¹æ¡ˆè®¾è®¡

### 1. æ•´ä½“æ¶æ„

éµå¾ªç°æœ‰çš„ä¹å±‚æ¶æ„è®¾è®¡:

```
ç¬¬3å±‚: CommentHandler (APIæ¥å£å±‚)
   â†“
ç¬¬4å±‚: CommentService (ä¸šåŠ¡é€»è¾‘å±‚)
   â†“
ç¬¬5å±‚: CommentRepository (æ•°æ®è®¿é—®å±‚)
   â†“
ç¬¬8å±‚: Comment (æ•°æ®æ¨¡å‹å±‚)
   â†“
ç¬¬9å±‚: commentsè¡¨ (æ•°æ®åº“å±‚)
```

### 2. ä¸ç°æœ‰åŠŸèƒ½å¯¹æ¯”

æœ¬æ–¹æ¡ˆå®Œå…¨éµå¾ªç°æœ‰çš„ç‚¹èµã€æ”¶è—åŠŸèƒ½çš„æ¶æ„è®¾è®¡:

| å¯¹æ¯”é¡¹ | ç‚¹èµåŠŸèƒ½ | æ”¶è—åŠŸèƒ½ | è¯„è®ºåŠŸèƒ½(æœ¬æ–¹æ¡ˆ) |
|--------|----------|----------|------------------|
| **æ•°æ®è¡¨** | likes | favorites | comments |
| **ä¸šåŠ¡IDæ ¼å¼** | æ— (ç›´æ¥ç”¨ç‰©ç†ID) | æ— (ç›´æ¥ç”¨ç‰©ç†ID) | CMT_2025Q4_ABC123 |
| **å¤–é”®å…³è”** | user_id, post_id | user_id, post_id | user_id, post_id |
| **çº§è”åˆ é™¤** | CASCADE | CASCADE | CASCADE |
| **å†—ä½™å­—æ®µ** | posts.like_count | posts.favorite_count | posts.comment_count |
| **äº‹åŠ¡ä¿è¯** | âœ… | âœ… | âœ… |
| **æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–** | âœ… | âœ… | âœ… |
| **æƒé™æ§åˆ¶** | ç”¨æˆ·æœ¬äºº | ç”¨æˆ·æœ¬äºº | ç”¨æˆ·æœ¬äºº+å¸–å­ä½œè€… |
| **APIæ•°é‡** | 3ä¸ª | 4ä¸ª | 3ä¸ª |
| **æ ¸å¿ƒå·®å¼‚** | - | - | **æœ‰å†…å®¹å­—æ®µã€éœ€æ˜¾ç¤ºä½œè€…ä¿¡æ¯** |

### 3. æ¶æ„ä¸€è‡´æ€§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP Client Layer                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              HTTP Server Layer (httplib)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LikeHandler     â”‚ FavoriteHandler  â”‚ CommentHandler    â”‚
â”‚  (ç‚¹èµAPI)       â”‚ (æ”¶è—API)        â”‚ (è¯„è®ºAPI) ğŸ†•     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LikeService     â”‚ FavoriteService  â”‚ CommentService    â”‚
â”‚  (ç‚¹èµä¸šåŠ¡)      â”‚ (æ”¶è—ä¸šåŠ¡)       â”‚ (è¯„è®ºä¸šåŠ¡) ğŸ†•    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LikeRepository   â”‚FavoriteRepositoryâ”‚CommentRepository  â”‚
â”‚ (ç‚¹èµæ•°æ®è®¿é—®)   â”‚ (æ”¶è—æ•°æ®è®¿é—®)   â”‚ (è¯„è®ºæ•°æ®è®¿é—®) ğŸ†•â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Like Model      â”‚ Favorite Model   â”‚ Comment Model ğŸ†• â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  likes è¡¨        â”‚ favorites è¡¨     â”‚ comments è¡¨ ğŸ†•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   posts è¡¨     â”‚ (æ–°å¢comment_countå­—æ®µ)
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

#### 4.1 è¯„è®ºç®¡ç†
- åˆ›å»ºè¯„è®º (POST)
- è·å–è¯„è®ºåˆ—è¡¨ (GET)
- åˆ é™¤è¯„è®º (DELETE)

#### 4.2 æ•°æ®å…³è”
- è¯„è®ºå…³è”ç”¨æˆ·(è¯„è®ºäºº)
- è¯„è®ºå…³è”å¸–å­
- æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯(ä¼˜åŒ–æ€§èƒ½)

#### 4.3 å‚è€ƒç°æœ‰å®ç°

æœ¬æ–¹æ¡ˆçš„å®ç°å°†å®Œå…¨å‚è€ƒç°æœ‰çš„ç‚¹èµå’Œæ”¶è—åŠŸèƒ½:

**å‚è€ƒæ–‡ä»¶åˆ—è¡¨**:
- `src/models/like.h/cpp` â†’ å‚è€ƒè®¾è®¡ `Comment` æ¨¡å‹
- `src/database/like_repository.h/cpp` â†’ å‚è€ƒè®¾è®¡ `CommentRepository`
- `src/core/like_service.h/cpp` â†’ å‚è€ƒè®¾è®¡ `CommentService`
- `src/api/like_handler.h/cpp` â†’ å‚è€ƒè®¾è®¡ `CommentHandler`
- `src/database/post_repository.h` (å·²æœ‰increment/decrementLikeCount) â†’ æ–°å¢ increment/decrementCommentCount

**è®¾è®¡æ¨¡å¼å¤ç”¨**:
- âœ… RAIIèµ„æºç®¡ç† (ConnectionGuard)
- âœ… æ™ºèƒ½æŒ‡é’ˆç®¡ç† (std::unique_ptr)
- âœ… äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
- âœ… é¢„ç¼–è¯‘è¯­å¥é˜²SQLæ³¨å…¥
- âœ… ç»Ÿä¸€çš„Resultç»“æ„ä½“
- âœ… æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ– (UserService::batchGetUsers)

---

## æ•°æ®åº“è®¾è®¡

### 1. comments è¡¨ç»“æ„

```sql
-- 1. åˆ›å»ºè¯„è®ºè¡¨ (å‚è€ƒlikesè¡¨ç»“æ„,ä¿æŒä¸€è‡´æ€§)
CREATE TABLE `comments` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'è¯„è®ºè®°å½•ID',
  `comment_id` varchar(36) COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'ä¸šåŠ¡é€»è¾‘IDï¼ˆä¾‹ï¼šCMT_2025Q4_ABC123ï¼‰',
  `post_id` bigint NOT NULL COMMENT 'æ‰€å±å¸–å­ID',
  `user_id` bigint NOT NULL COMMENT 'è¯„è®ºç”¨æˆ·ID',
  `content` text COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'è¯„è®ºå†…å®¹ï¼ˆæœ€å¤š1000å­—ç¬¦ï¼‰',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'è¯„è®ºæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_comment_id` (`comment_id`),
  KEY `idx_post_id` (`post_id`) COMMENT 'æŒ‰å¸–å­æŸ¥è¯¢è¯„è®ºåˆ—è¡¨',
  KEY `idx_user_id` (`user_id`) COMMENT 'æŒ‰ç”¨æˆ·æŸ¥è¯¢è¯„è®ºå†å²',
  KEY `idx_post_create` (`post_id`,`create_time` DESC) COMMENT 'æŒ‰å¸–å­åˆ†é¡µæŸ¥è¯¢(æ€§èƒ½ä¼˜åŒ–)',
  CONSTRAINT `comments_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `comments_ibfk_2` FOREIGN KEY (`post_id`) REFERENCES `posts` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è¯„è®ºè¡¨';
```

### 2. posts è¡¨æ–°å¢å­—æ®µ

ä¸ºäº†ä¼˜åŒ–æ€§èƒ½,éœ€è¦åœ¨ `posts` è¡¨ä¸­æ–°å¢è¯„è®ºæ•°å†—ä½™å­—æ®µ:

```sql
-- 2. ä¸º posts è¡¨æ·»åŠ è¯„è®ºæ•°å­—æ®µï¼ˆå†—ä½™å­—æ®µï¼Œä¸like_count/favorite_countä¿æŒä¸€è‡´ï¼‰
ALTER TABLE posts 
ADD COLUMN comment_count INT NOT NULL DEFAULT 0 COMMENT 'è¯„è®ºæ•°' 
AFTER favorite_count;
```

### 3. è®¾è®¡è¯´æ˜

**ä¸ç°æœ‰è¡¨ç»“æ„ä¿æŒä¸€è‡´**:
- âœ… å®Œå…¨å‚è€ƒlikes/favoritesè¡¨çš„ç»“æ„è®¾è®¡
- âœ… å¤–é”®å‘½åéµå¾ª: `comments_ibfk_1`, `comments_ibfk_2`
- âœ… ç´¢å¼•å‘½åéµå¾ª: `idx_post_id`, `idx_user_id`, `idx_post_create`
- âœ… ä½¿ç”¨å¤åˆç´¢å¼•`(post_id, create_time DESC)`ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢
- âœ… `create_time`è®¾ä¸º`NULL DEFAULT CURRENT_TIMESTAMP`ä¸ç°æœ‰è¡¨ä¿æŒä¸€è‡´
- âœ… å­—ç¬¦é›†: `utf8mb4_unicode_ci`
- âœ… å¼•æ“: InnoDB,æ”¯æŒå¤–é”®å’Œäº‹åŠ¡
- âŒ ç§»é™¤`update_time`å­—æ®µ - commentsè¡¨æ— éœ€æ›´æ–°æ—¶é—´(è¯„è®ºä¸å…è®¸ç¼–è¾‘)
- âœ… `comment_id`ä½¿ç”¨UNIQUE KEYè€Œéæ™®é€šç´¢å¼•,ä¿è¯å”¯ä¸€æ€§

### 4. ç´¢å¼•è®¾è®¡è¯´æ˜

| ç´¢å¼•å | å­—æ®µ | ç±»å‹ | ç”¨é€” |
|--------|------|------|------|
| PRIMARY | id | ä¸»é”® | å”¯ä¸€æ ‡è¯† |
| uk_comment_id | comment_id | å”¯ä¸€ | é€šè¿‡ä¸šåŠ¡IDæŸ¥è¯¢(ä¿è¯å”¯ä¸€æ€§) |
| idx_post_id | post_id | æ™®é€š | æŸ¥è¯¢å¸–å­çš„æ‰€æœ‰è¯„è®º |
| idx_user_id | user_id | æ™®é€š | æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è¯„è®º |
| **idx_post_create** | **(post_id, create_time DESC)** | **å¤åˆ** | **æŒ‰æ—¶é—´å€’åºæŸ¥è¯¢å¸–å­è¯„è®º(æ ¸å¿ƒæŸ¥è¯¢)** |

### 5. å¤–é”®çº§è”è§„åˆ™

- **åˆ é™¤å¸–å­** â†’ è‡ªåŠ¨åˆ é™¤è¯¥å¸–å­ä¸‹çš„æ‰€æœ‰è¯„è®º (CASCADE)
- **åˆ é™¤ç”¨æˆ·** â†’ è‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰è¯„è®º (CASCADE)

---

## ERå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        users è¡¨                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK, BIGINT)                                        â”‚
â”‚  user_id (VARCHAR, UNIQUE) - ä¸šåŠ¡ID                     â”‚
â”‚  username (VARCHAR, UNIQUE) - ç”¨æˆ·å                    â”‚
â”‚  avatar_url (VARCHAR) - å¤´åƒURL                         â”‚
â”‚  ...å…¶ä»–å­—æ®µ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚              â”‚
               â”‚ 1            â”‚ 1
               â”‚              â”‚
               â”‚ N            â”‚ N
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”      â”Œâ”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  posts è¡¨      â”‚      â”‚     comments è¡¨ ğŸ†•        â”‚
      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
      â”‚  id (PK)       â”‚â—„â”€â”€â”€â”€â”€â”¤  id (PK)                 â”‚
      â”‚  post_id       â”‚ 1  N â”‚  comment_id (UNIQUE) ğŸ†•  â”‚
      â”‚  user_id (FK)  â”‚      â”‚  post_id (FK) ğŸ†•         â”‚
      â”‚  title         â”‚      â”‚  user_id (FK) ğŸ†•         â”‚
      â”‚  description   â”‚      â”‚  content (TEXT) ğŸ†•       â”‚
      â”‚  like_count    â”‚      â”‚  create_time ğŸ†•          â”‚
      â”‚  favorite_countâ”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚  comment_count â”‚ğŸ†•
      â”‚  ...           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”‚ 1
               â”‚
               â”‚ N
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚    images è¡¨       â”‚
      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
      â”‚  id (PK)           â”‚
      â”‚  image_id          â”‚
      â”‚  post_id (FK)      â”‚
      â”‚  file_url          â”‚
      â”‚  thumbnail_url     â”‚
      â”‚  ...               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³ç³»è¯´æ˜

| å…³ç³» | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| **users â†’ comments** | 1:N | ä¸€ä¸ªç”¨æˆ·å¯ä»¥å‘è¡¨å¤šæ¡è¯„è®º |
| **posts â†’ comments** | 1:N | ä¸€ä¸ªå¸–å­å¯ä»¥æœ‰å¤šæ¡è¯„è®º |
| **çº§è”åˆ é™¤** | CASCADE | åˆ é™¤ç”¨æˆ·/å¸–å­æ—¶è‡ªåŠ¨åˆ é™¤è¯„è®º |
| **å†—ä½™å­—æ®µ** | - | posts.comment_count å­˜å‚¨è¯„è®ºæ€»æ•° |

---

## APIè®¾è®¡

### æ¥å£åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|------|------|------|------|
| POST | `/api/v1/posts/:post_id/comments` | âœ… | åˆ›å»ºè¯„è®º |
| GET | `/api/v1/posts/:post_id/comments` | âŒ | è·å–è¯„è®ºåˆ—è¡¨ |
| DELETE | `/api/v1/posts/:post_id/comments/:comment_id` | âœ… | åˆ é™¤è¯„è®º |

---

### 1. åˆ›å»ºè¯„è®º

**æ¥å£**: `POST /api/v1/posts/:post_id/comments`

**è®¤è¯**: éœ€è¦JWTä»¤ç‰Œ

**è¯·æ±‚å‚æ•°**:
```json
{
  "content": "è¿™å¼ ç…§ç‰‡æ‹å¾—çœŸå¥½ï¼"
}
```

**å‚æ•°è¯´æ˜**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| content | string | æ˜¯ | è¯„è®ºå†…å®¹,1-1000å­—ç¬¦ |

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST http://localhost:8080/api/v1/posts/POST_2025Q4_XYZ789/comments \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"content": "è¿™å¼ ç…§ç‰‡æ‹å¾—çœŸå¥½ï¼"}'
```

**æˆåŠŸå“åº”** (201):
```json
{
  "success": true,
  "message": "è¯„è®ºå‘è¡¨æˆåŠŸ",
  "data": {
    "comment_id": "CMT_2025Q4_ABC123",
    "post_id": "POST_2025Q4_XYZ789",
    "content": "è¿™å¼ ç…§ç‰‡æ‹å¾—çœŸå¥½ï¼",
    "author": {
      "user_id": "USR_2025Q1_001",
      "username": "zhangsan",
      "avatar_url": "http://localhost:8080/uploads/avatars/zhangsan_avatar.jpg"
    },
    "create_time": 1729324800,
    "comment_count": 15
  },
  "timestamp": 1729324800
}
```

**é”™è¯¯å“åº”**:
- 400: è¯„è®ºå†…å®¹ä¸ºç©ºæˆ–è¿‡é•¿
- 401: æœªç™»å½•æˆ–ä»¤ç‰Œæ— æ•ˆ
- 404: å¸–å­ä¸å­˜åœ¨

---

### 2. è·å–è¯„è®ºåˆ—è¡¨

**æ¥å£**: `GET /api/v1/posts/:post_id/comments`

**è®¤è¯**: ä¸éœ€è¦(æ¸¸å®¢å¯è®¿é—®)

**è¯·æ±‚å‚æ•°**:
| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| page | int | å¦ | 1 | é¡µç ,ä»1å¼€å§‹ |
| page_size | int | å¦ | 20 | æ¯é¡µæ•°é‡,æœ€å¤§100 |

**è¯·æ±‚ç¤ºä¾‹**: 
```bash
curl http://localhost:8080/api/v1/posts/POST_2025Q4_XYZ789/comments?page=1&page_size=20
```

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "è·å–è¯„è®ºåˆ—è¡¨æˆåŠŸ",
  "data": {
    "comments": [
      {
        "comment_id": "CMT_2025Q4_ABC123",
        "content": "è¿™å¼ ç…§ç‰‡æ‹å¾—çœŸå¥½ï¼",
        "author": {
          "user_id": "USR_2025Q1_001",
          "username": "zhangsan",
          "avatar_url": "http://localhost:8080/uploads/avatars/zhangsan_avatar.jpg"
        },
        "create_time": 1729324800
      },
      {
        "comment_id": "CMT_2025Q4_ABC124",
        "content": "åŒæ„æ¥¼ä¸Šï¼",
        "author": {
          "user_id": "USR_2025Q1_002",
          "username": "lisi",
          "avatar_url": "http://localhost:8080/uploads/avatars/lisi_avatar.jpg"
        },
        "create_time": 1729324700
      }
    ],
    "total": 15,
    "page": 1,
    "page_size": 20,
    "has_more": false
  },
  "timestamp": 1729324800
}
```

**æ€§èƒ½ä¼˜åŒ–**:
- ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯(å¤ç”¨UserService::batchGetUsers)
- SQLæŸ¥è¯¢ä½¿ç”¨å¤åˆç´¢å¼• `idx_post_create`
- é¿å…N+1æŸ¥è¯¢é—®é¢˜: 20æ¡è¯„è®ºä»21æ¬¡æŸ¥è¯¢ä¼˜åŒ–åˆ°2æ¬¡æŸ¥è¯¢

**é”™è¯¯å“åº”**:
- 404: å¸–å­ä¸å­˜åœ¨

---

### 3. åˆ é™¤è¯„è®º

**æ¥å£**: `DELETE /api/v1/posts/:post_id/comments/:comment_id`

**è®¤è¯**: éœ€è¦JWTä»¤ç‰Œ

**æƒé™æ§åˆ¶**:
- âœ… è¯„è®ºä½œè€…å¯ä»¥åˆ é™¤è‡ªå·±çš„è¯„è®º
- âœ… å¸–å­ä½œè€…å¯ä»¥åˆ é™¤å¸–å­ä¸‹çš„ä»»æ„è¯„è®º
- âŒ å…¶ä»–ç”¨æˆ·æ— æƒé™åˆ é™¤

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X DELETE http://localhost:8080/api/v1/posts/POST_2025Q4_XYZ789/comments/CMT_2025Q4_ABC123 \
  -H "Authorization: Bearer <token>"
```

**æˆåŠŸå“åº”** (200):
```json
{
  "success": true,
  "message": "è¯„è®ºå·²åˆ é™¤",
  "data": {
    "comment_id": "CMT_2025Q4_ABC123",
    "comment_count": 14
  },
  "timestamp": 1729324800
}
```

**é”™è¯¯å“åº”**:
- 401: æœªç™»å½•æˆ–ä»¤ç‰Œæ— æ•ˆ
- 403: æ— æƒé™åˆ é™¤è¯¥è¯„è®º
- 404: è¯„è®ºä¸å­˜åœ¨

---

## ä¸šåŠ¡æµç¨‹å›¾

### 1. åˆ›å»ºè¯„è®ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç«¯   â”‚ POST /api/v1/posts/:post_id/comments
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ { "content": "è¯„è®ºå†…å®¹" }
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       CommentHandler (APIå±‚)              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. æå–JWTä»¤ç‰Œ                           â”‚
â”‚  2. éªŒè¯ç”¨æˆ·èº«ä»½ (getUserIdFromToken)     â”‚
â”‚  3. è§£æè¯·æ±‚å‚æ•° (content)                â”‚
â”‚  4. è°ƒç”¨ CommentService                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CommentService (ä¸šåŠ¡é€»è¾‘å±‚)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. éªŒè¯å¸–å­æ˜¯å¦å­˜åœ¨                      â”‚
â”‚  2. éªŒè¯è¯„è®ºå†…å®¹ (1-1000å­—ç¬¦)            â”‚
â”‚  3. ç”Ÿæˆä¸šåŠ¡ID (CMT_2025Q4_ABC123)       â”‚
â”‚  4. å¼€å¯æ•°æ®åº“äº‹åŠ¡                        â”‚
â”‚  5. åˆ›å»ºè¯„è®ºè®°å½•                          â”‚
â”‚  6. å¢åŠ å¸–å­è¯„è®ºæ•° (+1)                   â”‚
â”‚  7. æäº¤äº‹åŠ¡                              â”‚
â”‚  8. æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ (å¤´åƒã€æ˜µç§°)             â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CommentRepository (æ•°æ®è®¿é—®å±‚)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. INSERT INTO comments (...)           â”‚
â”‚  2. ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²SQLæ³¨å…¥               â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PostRepository (æ•°æ®è®¿é—®å±‚)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. UPDATE posts                         â”‚
â”‚     SET comment_count = comment_count + 1â”‚
â”‚     WHERE id = ?                         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQL æ•°æ®åº“                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  comments è¡¨æ–°å¢ä¸€æ¡è®°å½•                  â”‚
â”‚  posts è¡¨ comment_count å­—æ®µ +1          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“ (äº‹åŠ¡æäº¤æˆåŠŸ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¿”å›JSONå“åº”                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {                                       â”‚
â”‚    "success": true,                      â”‚
â”‚    "data": {                             â”‚
â”‚      "comment_id": "CMT_2025Q4_ABC123", â”‚
â”‚      "author": {                         â”‚
â”‚        "username": "zhangsan",           â”‚
â”‚        "avatar_url": "..."               â”‚
â”‚      },                                  â”‚
â”‚      "comment_count": 15                 â”‚
â”‚    }                                     â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. è·å–è¯„è®ºåˆ—è¡¨æµç¨‹ (å«æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç«¯   â”‚ GET /api/v1/posts/:post_id/comments?page=1&page_size=20
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       CommentHandler (APIå±‚)              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. è§£æURLå‚æ•° (post_id, page, size)    â”‚
â”‚  2. è°ƒç”¨ CommentService                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CommentService (ä¸šåŠ¡é€»è¾‘å±‚)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. éªŒè¯å¸–å­æ˜¯å¦å­˜åœ¨                      â”‚
â”‚  2. æŸ¥è¯¢è¯„è®ºåˆ—è¡¨ (åˆ†é¡µ)                   â”‚
â”‚  3. ç»Ÿè®¡æ€»è¯„è®ºæ•°                          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CommentRepository (æ•°æ®è®¿é—®å±‚)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  SELECT * FROM comments                  â”‚
â”‚  WHERE post_id = ?                       â”‚
â”‚  ORDER BY create_time DESC               â”‚
â”‚  LIMIT ? OFFSET ?                        â”‚
â”‚                                          â”‚
â”‚  ä½¿ç”¨ç´¢å¼•: idx_post_create âœ…            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         è¿”å› 20 æ¡è¯„è®ºè®°å½•                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  [                                       â”‚
â”‚    { user_id: 101, content: "..." },    â”‚
â”‚    { user_id: 102, content: "..." },    â”‚
â”‚    { user_id: 103, content: "..." },    â”‚
â”‚    ...                                   â”‚
â”‚  ]                                       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ (ä¼˜åŒ–å…³é”®) ğŸš€        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. æå–æ‰€æœ‰ user_id: [101,102,103,...]  â”‚
â”‚  2. UserService::batchGetUsers([...])    â”‚
â”‚  3. ä¸€æ¬¡SQLæŸ¥è¯¢è·å–æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯           â”‚
â”‚                                          â”‚
â”‚  SELECT * FROM users                     â”‚
â”‚  WHERE id IN (101, 102, 103, ...)       â”‚
â”‚                                          â”‚
â”‚  é¿å… N+1 æŸ¥è¯¢é—®é¢˜ âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       æ„å»ºJSONå“åº” (Handlerå±‚)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  for (comment in comments) {             â”‚
â”‚    commentJson["author"] =               â”‚
â”‚      userMap[comment.user_id]            â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¿”å›JSONå“åº”                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {                                       â”‚
â”‚    "comments": [                         â”‚
â”‚      {                                   â”‚
â”‚        "comment_id": "...",              â”‚
â”‚        "content": "...",                 â”‚
â”‚        "author": {                       â”‚
â”‚          "username": "zhangsan",         â”‚
â”‚          "avatar_url": "..."             â”‚
â”‚        }                                 â”‚
â”‚      },                                  â”‚
â”‚      ...                                 â”‚
â”‚    ],                                    â”‚
â”‚    "total": 15,                          â”‚
â”‚    "has_more": false                     â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æŸ¥è¯¢æ¬¡æ•°å¯¹æ¯”:
  âŒ æœªä¼˜åŒ–: 1æ¬¡(è¯„è®º) + 20æ¬¡(ç”¨æˆ·) = 21æ¬¡æŸ¥è¯¢
  âœ… å·²ä¼˜åŒ–: 1æ¬¡(è¯„è®º) + 1æ¬¡(æ‰¹é‡ç”¨æˆ·) = 2æ¬¡æŸ¥è¯¢
  
  æ€§èƒ½æå‡: 90.5% â¬†ï¸
  å“åº”æ—¶é—´: 120ms â†’ 40ms
```

---

### 3. åˆ é™¤è¯„è®ºæµç¨‹ (å«æƒé™éªŒè¯)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ç«¯   â”‚ DELETE /api/v1/posts/:post_id/comments/:comment_id
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       CommentHandler (APIå±‚)              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. æå–JWTä»¤ç‰Œ                           â”‚
â”‚  2. éªŒè¯ç”¨æˆ·èº«ä»½                          â”‚
â”‚  3. è§£æURLå‚æ•° (comment_id)              â”‚
â”‚  4. è°ƒç”¨ CommentService                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CommentService (ä¸šåŠ¡é€»è¾‘å±‚)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. æŸ¥è¯¢è¯„è®ºæ˜¯å¦å­˜åœ¨                      â”‚
â”‚  2. æƒé™éªŒè¯ âš ï¸                          â”‚
â”‚     â”œâ”€ æ£€æŸ¥æ˜¯å¦ä¸ºè¯„è®ºä½œè€…                 â”‚
â”‚     â””â”€ æ£€æŸ¥æ˜¯å¦ä¸ºå¸–å­ä½œè€…                 â”‚
â”‚  3. å¼€å¯æ•°æ®åº“äº‹åŠ¡                        â”‚
â”‚  4. åˆ é™¤è¯„è®ºè®°å½•                          â”‚
â”‚  5. å‡å°‘å¸–å­è¯„è®ºæ•° (-1)                   â”‚
â”‚  6. æäº¤äº‹åŠ¡                              â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æƒé™éªŒè¯é€»è¾‘                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  if (userId == comment.user_id) {        â”‚
â”‚    // è¯„è®ºä½œè€…,å…è®¸åˆ é™¤ âœ…               â”‚
â”‚    return true;                          â”‚
â”‚  }                                       â”‚
â”‚                                          â”‚
â”‚  if (userId == post.user_id) {           â”‚
â”‚    // å¸–å­ä½œè€…,å…è®¸åˆ é™¤ âœ…               â”‚
â”‚    return true;                          â”‚
â”‚  }                                       â”‚
â”‚                                          â”‚
â”‚  // å…¶ä»–ç”¨æˆ·,æ‹’ç»åˆ é™¤ âŒ                 â”‚
â”‚  return false;                           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CommentRepository (æ•°æ®è®¿é—®å±‚)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  DELETE FROM comments                    â”‚
â”‚  WHERE comment_id = ?                    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    PostRepository (æ•°æ®è®¿é—®å±‚)            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  UPDATE posts                            â”‚
â”‚  SET comment_count = comment_count - 1   â”‚
â”‚  WHERE id = ?                            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQL æ•°æ®åº“                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  comments è¡¨åˆ é™¤ä¸€æ¡è®°å½•                  â”‚
â”‚  posts è¡¨ comment_count å­—æ®µ -1          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â†“ (äº‹åŠ¡æäº¤æˆåŠŸ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        è¿”å›JSONå“åº”                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  {                                       â”‚
â”‚    "success": true,                      â”‚
â”‚    "message": "è¯„è®ºå·²åˆ é™¤",              â”‚
â”‚    "data": {                             â”‚
â”‚      "comment_id": "CMT_2025Q4_ABC123", â”‚
â”‚      "comment_count": 14                 â”‚
â”‚    }                                     â”‚
â”‚  }                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4. æƒé™æ§åˆ¶çŸ©é˜µ

| æ“ä½œ | æ¸¸å®¢ | ç™»å½•ç”¨æˆ· | è¯„è®ºä½œè€… | å¸–å­ä½œè€… | ç®¡ç†å‘˜ |
|------|------|----------|----------|----------|--------|
| **æŸ¥çœ‹è¯„è®ºåˆ—è¡¨** | âœ… | âœ… | âœ… | âœ… | âœ… |
| **å‘è¡¨è¯„è®º** | âŒ | âœ… | âœ… | âœ… | âœ… |
| **åˆ é™¤ä»»æ„è¯„è®º** | âŒ | âŒ | âŒ | âœ… | âœ… |
| **åˆ é™¤è‡ªå·±çš„è¯„è®º** | âŒ | âŒ | âœ… | âœ… | âœ… |

---

## æŠ€æœ¯å®ç°ç»†èŠ‚

### ä»£ç ç»“æ„ (æ–°å¢æ–‡ä»¶)

```
src/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ comment.h           ğŸ†• è¯„è®ºæ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ comment.cpp         ğŸ†• è¯„è®ºæ¨¡å‹å®ç°
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ comment_repository.h   ğŸ†• è¯„è®ºæ•°æ®è®¿é—®å±‚å®šä¹‰
â”‚   â”œâ”€â”€ comment_repository.cpp ğŸ†• è¯„è®ºæ•°æ®è®¿é—®å±‚å®ç°
â”‚   â””â”€â”€ post_repository.h/cpp  ğŸ”§ æ–°å¢comment_countæ–¹æ³•
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ comment_service.h   ğŸ†• è¯„è®ºä¸šåŠ¡é€»è¾‘å±‚å®šä¹‰
â”‚   â””â”€â”€ comment_service.cpp ğŸ†• è¯„è®ºä¸šåŠ¡é€»è¾‘å±‚å®ç°
â””â”€â”€ api/
    â”œâ”€â”€ comment_handler.h   ğŸ†• è¯„è®ºAPIå¤„ç†å™¨å®šä¹‰
    â””â”€â”€ comment_handler.cpp ğŸ†• è¯„è®ºAPIå¤„ç†å™¨å®ç°
```

**é¢„è®¡æ–°å¢ä»£ç é‡**: ~1200è¡Œ

---

### 1. æ¨¡å‹å±‚ (Comment Model)

**æ–‡ä»¶**: `src/models/comment.h` / `comment.cpp`

**æ ¸å¿ƒç»“æ„**:
```cpp
class Comment {
public:
    Comment();
    ~Comment() = default;

    // Getters
    int getId() const { return id_; }
    const std::string& getCommentId() const { return commentId_; }
    int getPostId() const { return postId_; }
    int getUserId() const { return userId_; }
    const std::string& getContent() const { return content_; }
    std::time_t getCreateTime() const { return createTime_; }

    // Setters
    void setId(int id) { id_ = id; }
    void setCommentId(const std::string& commentId) { commentId_ = commentId; }
    void setPostId(int postId) { postId_ = postId; }
    void setUserId(int userId) { userId_ = userId; }
    void setContent(const std::string& content) { content_ = content; }
    void setCreateTime(std::time_t createTime) { createTime_ = createTime; }

    // JSONåºåˆ—åŒ–
    Json::Value toJson() const;
    static Comment fromJson(const Json::Value& json);

    // æ•°æ®éªŒè¯
    std::string validate() const;

private:
    int id_;                    // ç‰©ç†ID
    std::string commentId_;     // ä¸šåŠ¡ID
    int postId_;                // å¸–å­ID
    int userId_;                // ç”¨æˆ·ID
    std::string content_;       // è¯„è®ºå†…å®¹
    std::time_t createTime_;    // åˆ›å»ºæ—¶é—´
};
```

**æ•°æ®éªŒè¯è§„åˆ™**:
- content: 1-1000å­—ç¬¦
- å†…å®¹ä¸èƒ½ä¸ºçº¯ç©ºæ ¼
- å†…å®¹ä¸èƒ½åŒ…å«ç‰¹æ®Šæ§åˆ¶å­—ç¬¦

---

### 2. æ•°æ®è®¿é—®å±‚ (CommentRepository)

**æ–‡ä»¶**: `src/database/comment_repository.h` / `comment_repository.cpp`

**æ ¸å¿ƒæ–¹æ³•**:

```cpp
class CommentRepository {
public:
    // åˆ›å»ºè¯„è®º
    bool create(MYSQL* conn, const Comment& comment);

    // æŸ¥è¯¢è¯„è®º(é€šè¿‡ä¸šåŠ¡ID)
    std::optional<Comment> findByCommentId(MYSQL* conn, const std::string& commentId);

    // æŸ¥è¯¢å¸–å­çš„è¯„è®ºåˆ—è¡¨(åˆ†é¡µ,æŒ‰æ—¶é—´å€’åº)
    std::vector<Comment> findByPostId(MYSQL* conn, int postId, int limit, int offset);

    // ç»Ÿè®¡å¸–å­çš„è¯„è®ºæ•°
    int countByPostId(MYSQL* conn, int postId);

    // åˆ é™¤è¯„è®º(é€šè¿‡ä¸šåŠ¡ID)
    bool deleteByCommentId(MYSQL* conn, const std::string& commentId);

    // æ£€æŸ¥è¯„è®ºæ˜¯å¦å­˜åœ¨
    bool existsByCommentId(MYSQL* conn, const std::string& commentId);

    // æ£€æŸ¥è¯„è®ºæ˜¯å¦å±äºæŸç”¨æˆ·
    bool isCommentOwner(MYSQL* conn, const std::string& commentId, int userId);

private:
    Comment buildCommentFromStatement(MYSQL_STMT* stmt);
};
```

**SQLå®ç°è¦ç‚¹**:
- ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²æ­¢SQLæ³¨å…¥
- ä½¿ç”¨ `idx_post_create` å¤åˆç´¢å¼•ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢
- äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

---

### 3. ä¸šåŠ¡é€»è¾‘å±‚ (CommentService)

**æ–‡ä»¶**: `src/core/comment_service.h` / `comment_service.cpp`

**æ ¸å¿ƒæ–¹æ³•**:

```cpp
struct CommentResult {
    bool success;
    int statusCode;
    std::string message;
    std::optional<Comment> comment;
    int commentCount;  // æ›´æ–°åçš„è¯„è®ºæ•°
};

struct CommentListResult {
    bool success;
    int statusCode;
    std::string message;
    std::vector<Comment> comments;
    int total;
    bool hasMore;
};

class CommentService {
public:
    CommentService();
    ~CommentService();

    // åˆ›å»ºè¯„è®º
    // ä¸šåŠ¡æµç¨‹:
    // 1. éªŒè¯å¸–å­æ˜¯å¦å­˜åœ¨
    // 2. éªŒè¯è¯„è®ºå†…å®¹
    // 3. ç”Ÿæˆä¸šåŠ¡ID
    // 4. å¼€å¯äº‹åŠ¡
    // 5. åˆ›å»ºè¯„è®ºè®°å½•
    // 6. å¢åŠ å¸–å­è¯„è®ºæ•°
    // 7. æäº¤äº‹åŠ¡
    CommentResult createComment(int userId, const std::string& postId, const std::string& content);

    // è·å–è¯„è®ºåˆ—è¡¨
    // ä¸šåŠ¡æµç¨‹:
    // 1. éªŒè¯å¸–å­æ˜¯å¦å­˜åœ¨
    // 2. æŸ¥è¯¢è¯„è®ºåˆ—è¡¨(åˆ†é¡µ)
    // 3. ç»Ÿè®¡æ€»æ•°
    CommentListResult getCommentsByPost(const std::string& postId, int page, int pageSize);

    // åˆ é™¤è¯„è®º
    // ä¸šåŠ¡æµç¨‹:
    // 1. éªŒè¯è¯„è®ºæ˜¯å¦å­˜åœ¨
    // 2. éªŒè¯æƒé™(è¯„è®ºä½œè€…æˆ–å¸–å­ä½œè€…)
    // 3. å¼€å¯äº‹åŠ¡
    // 4. åˆ é™¤è¯„è®ºè®°å½•
    // 5. å‡å°‘å¸–å­è¯„è®ºæ•°
    // 6. æäº¤äº‹åŠ¡
    CommentResult deleteComment(int userId, const std::string& commentId);

private:
    std::unique_ptr<CommentRepository> commentRepo_;
    std::unique_ptr<PostRepository> postRepo_;
    
    // ç”Ÿæˆä¸šåŠ¡ID
    std::string generateCommentId();
};
```

**ä¸šåŠ¡è§„åˆ™**:
- è¯„è®ºå†…å®¹é•¿åº¦: 1-1000å­—ç¬¦
- åˆ†é¡µæœ€å¤§å€¼: 100æ¡
- è¯„è®ºä½œè€…å’Œå¸–å­ä½œè€…æœ‰åˆ é™¤æƒé™

---

### 4. APIæ¥å£å±‚ (CommentHandler)

**æ–‡ä»¶**: `src/api/comment_handler.h` / `comment_handler.cpp`

**æ ¸å¿ƒæ–¹æ³•**:

```cpp
class CommentHandler : public BaseHandler {
public:
    CommentHandler();
    ~CommentHandler() = default;

    void registerRoutes(httplib::Server& server);

private:
    std::unique_ptr<CommentService> commentService_;
    std::unique_ptr<UserService> userService_;  // ç”¨äºæ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

    // POST /api/v1/posts/:post_id/comments
    void handleCreateComment(const httplib::Request& req, httplib::Response& res);

    // GET /api/v1/posts/:post_id/comments
    void handleGetComments(const httplib::Request& req, httplib::Response& res);

    // DELETE /api/v1/posts/:post_id/comments/:comment_id
    void handleDeleteComment(const httplib::Request& req, httplib::Response& res);
};
```

**è·¯ç”±æ³¨å†Œ**:
```cpp
void CommentHandler::registerRoutes(httplib::Server& server) {
    // åˆ›å»ºè¯„è®º
    server.Post("/api/v1/posts/:post_id/comments", 
        [this](const httplib::Request& req, httplib::Response& res) {
            handleCreateComment(req, res);
        });
    
    // è·å–è¯„è®ºåˆ—è¡¨
    server.Get("/api/v1/posts/:post_id/comments", 
        [this](const httplib::Request& req, httplib::Response& res) {
            handleGetComments(req, res);
        });
    
    // åˆ é™¤è¯„è®º
    server.Delete("/api/v1/posts/:post_id/comments/:comment_id", 
        [this](const httplib::Request& req, httplib::Response& res) {
            handleDeleteComment(req, res);
        });
}
```

### 5. PostRepository æ–°å¢æ–¹æ³•

**æ–‡ä»¶**: `src/database/post_repository.h/cpp`

```cpp
// å¢åŠ è¯„è®ºæ•°ï¼ˆåŸå­æ“ä½œï¼‰
bool incrementCommentCount(MYSQL* conn, int postId);

// å‡å°‘è¯„è®ºæ•°ï¼ˆåŸå­æ“ä½œï¼‰
bool decrementCommentCount(MYSQL* conn, int postId);
```

**SQLå®ç°**:
```cpp
bool PostRepository::incrementCommentCount(MYSQL* conn, int postId) {
    const char* sql = "UPDATE posts SET comment_count = comment_count + 1 WHERE id = ?";
    // ... é¢„ç¼–è¯‘è¯­å¥å®ç°
}

bool PostRepository::decrementCommentCount(MYSQL* conn, int postId) {
    const char* sql = "UPDATE posts SET comment_count = comment_count - 1 WHERE id = ?";
    // ... é¢„ç¼–è¯‘è¯­å¥å®ç°
}
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

#### 1.1 ç´¢å¼•ä¼˜åŒ–
- **å¤åˆç´¢å¼•** `idx_post_create (post_id, create_time DESC)` æ”¯æŒæŒ‰æ—¶é—´å€’åºåˆ†é¡µ
- **å•åˆ—ç´¢å¼•** `idx_comment_id` æ”¯æŒä¸šåŠ¡IDå¿«é€ŸæŸ¥è¯¢
- **è¦†ç›–ç´¢å¼•**: è¯„è®ºåˆ—è¡¨æŸ¥è¯¢é¿å…å›è¡¨

#### 1.2 å†—ä½™å­—æ®µ
- `posts.comment_count` é¿å…COUNT(*)æŸ¥è¯¢
- ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 2. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–

**é—®é¢˜**: è·å–è¯„è®ºåˆ—è¡¨æ—¶,æ¯æ¡è¯„è®ºéƒ½éœ€è¦æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯(N+1é—®é¢˜)

**è§£å†³æ–¹æ¡ˆ**: æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

```cpp
// ä¼ªä»£ç 
std::vector<Comment> comments = commentRepo_->findByPostId(conn, postId, limit, offset);

// æå–æ‰€æœ‰ç”¨æˆ·ID
std::vector<int> userIds;
for (const auto& comment : comments) {
    userIds.push_back(comment.getUserId());
}

// æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ (å¤ç”¨UserService::batchGetUsers)
auto userMap = userService_->batchGetUsers(userIds);

// æ„å»ºJSONå“åº”
for (const auto& comment : comments) {
    Json::Value commentJson = comment.toJson();
    
    // æ·»åŠ ç”¨æˆ·ä¿¡æ¯
    int userId = comment.getUserId();
    if (userMap.find(userId) != userMap.end()) {
        commentJson["author"] = userMap[userId].toPublicJson();
    }
    
    commentsArray.append(commentJson);
}
```

**æ€§èƒ½æå‡**:
- 20æ¡è¯„è®º: 21æ¬¡æŸ¥è¯¢ â†’ 2æ¬¡æŸ¥è¯¢ (â¬‡ï¸90.5%)
- å“åº”æ—¶é—´: ~120ms â†’ ~40ms (â¬†ï¸66.7%)

### 3. ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
-- æŸ¥è¯¢å¸–å­è¯„è®ºåˆ—è¡¨ (ä½¿ç”¨å¤åˆç´¢å¼•)
EXPLAIN SELECT * FROM comments 
WHERE post_id = 123 
ORDER BY create_time DESC 
LIMIT 20;

+----+-------------+----------+------+------------------+------------------+---------+-------+------+--------------------------+
| id | select_type | table    | type | possible_keys    | key              | key_len | ref   | rows | Extra                    |
+----+-------------+----------+------+------------------+------------------+---------+-------+------+--------------------------+
|  1 | SIMPLE      | comments | ref  | idx_post_create  | idx_post_create  | 8       | const |  20  | Using where; Using index |
+----+-------------+----------+------+------------------+------------------+---------+-------+------+--------------------------+

âœ… ä½¿ç”¨äº† idx_post_create å¤åˆç´¢å¼•
âœ… rows = 20 (ç²¾ç¡®åŒ¹é…)
âœ… Extra: Using index (è¦†ç›–ç´¢å¼•,æ— éœ€å›è¡¨)
```

### 4. æ•°æ®åº“äº‹åŠ¡æµç¨‹

#### åˆ›å»ºè¯„è®ºäº‹åŠ¡

```sql
START TRANSACTION;

-- Step 1: æ’å…¥è¯„è®ºè®°å½•
INSERT INTO comments (comment_id, post_id, user_id, content, create_time)
VALUES ('CMT_2025Q4_ABC123', 123, 456, 'è¯„è®ºå†…å®¹', NOW());

-- Step 2: å¢åŠ å¸–å­è¯„è®ºæ•°
UPDATE posts 
SET comment_count = comment_count + 1 
WHERE id = 123;

COMMIT;  -- ä¸¤æ­¥æ“ä½œè¦ä¹ˆå…¨æˆåŠŸ,è¦ä¹ˆå…¨å¤±è´¥
```

#### åˆ é™¤è¯„è®ºäº‹åŠ¡

```sql
START TRANSACTION;

-- Step 1: åˆ é™¤è¯„è®ºè®°å½•
DELETE FROM comments 
WHERE comment_id = 'CMT_2025Q4_ABC123';

-- Step 2: å‡å°‘å¸–å­è¯„è®ºæ•°
UPDATE posts 
SET comment_count = comment_count - 1 
WHERE id = 123;

COMMIT;
```

### 5. æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

| åœºæ™¯ | æœªä¼˜åŒ– | å·²ä¼˜åŒ– | æå‡ |
|------|--------|--------|------|
| **è·å–20æ¡è¯„è®º** | 21æ¬¡æŸ¥è¯¢ | 2æ¬¡æŸ¥è¯¢ | â¬‡ï¸90.5% |
| **å“åº”æ—¶é—´ (P50)** | ~80ms | ~30ms | â¬†ï¸62.5% |
| **å“åº”æ—¶é—´ (P99)** | ~120ms | ~40ms | â¬†ï¸66.7% |
| **QPS** | ~200 | ~600 | â¬†ï¸200% |

### 6. åˆ†é¡µä¼˜åŒ–

- ä½¿ç”¨ `LIMIT` å’Œ `OFFSET` é™åˆ¶è¿”å›æ•°æ®é‡
- é»˜è®¤æ¯é¡µ20æ¡,æœ€å¤§100æ¡
- è¿”å› `has_more` æ ‡è¯†æ˜¯å¦æœ‰æ›´å¤šæ•°æ®

### 7. ç¼“å­˜ç­–ç•¥ (å¯é€‰,åæœŸä¼˜åŒ–)

- çƒ­é—¨å¸–å­çš„è¯„è®ºåˆ—è¡¨ç¼“å­˜(Redis)
- ç¼“å­˜å¤±æ•ˆç­–ç•¥: æ–°è¯„è®ºå‘è¡¨æ—¶æ¸…é™¤ç¼“å­˜
- TTL: 5åˆ†é’Ÿ

---

## å®æ–½è®¡åˆ’

### æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|----------|
| 1ï¸âƒ£ | æ•°æ®åº“è®¾è®¡ä¸è¿ç§» | 1å°æ—¶ |
| 2ï¸âƒ£ | æ¨¡å‹å±‚å®ç° (Comment) | 1å°æ—¶ |
| 3ï¸âƒ£ | æ•°æ®è®¿é—®å±‚ (CommentRepository) | 2å°æ—¶ |
| 4ï¸âƒ£ | ä¸šåŠ¡é€»è¾‘å±‚ (CommentService) | 2å°æ—¶ |
| 5ï¸âƒ£ | APIæ¥å£å±‚ (CommentHandler) | 2å°æ—¶ |
| 6ï¸âƒ£ | é›†æˆæµ‹è¯• | 1å°æ—¶ |
| 7ï¸âƒ£ | æ–‡æ¡£æ›´æ–° | 0.5å°æ—¶ |
| **æ€»è®¡** | - | **9-10å°æ—¶** |

---

### é˜¶æ®µä¸€: æ•°æ®åº“è®¾è®¡ (é¢„è®¡1å°æ—¶)

1. âœ… è®¾è®¡ `comments` è¡¨ç»“æ„
2. âœ… è®¾è®¡ç´¢å¼•ä¼˜åŒ–æ–¹æ¡ˆ
3. âœ… ç¼–å†™ `database.sql` è¿ç§»è„šæœ¬
4. â³ æ‰§è¡Œæ•°æ®åº“è¿ç§»
5. â³ éªŒè¯è¡¨ç»“æ„å’Œç´¢å¼•

**éªŒæ”¶æ ‡å‡†**:
- commentsè¡¨åˆ›å»ºæˆåŠŸ
- å¤–é”®çº¦æŸç”Ÿæ•ˆ
- ç´¢å¼•åˆ›å»ºæˆåŠŸ
- postsè¡¨æ–°å¢comment_countå­—æ®µ

---

### é˜¶æ®µäºŒ: æ¨¡å‹å±‚å®ç° (é¢„è®¡1å°æ—¶)

1. â³ åˆ›å»º `src/models/comment.h`
2. â³ åˆ›å»º `src/models/comment.cpp`
3. â³ å®ç° `toJson()` / `fromJson()` æ–¹æ³•
4. â³ å®ç° `validate()` æ•°æ®éªŒè¯
5. â³ ç¼–å†™å•å…ƒæµ‹è¯•(å¯é€‰)

**éªŒæ”¶æ ‡å‡†**:
- Commentæ¨¡å‹ç¼–è¯‘é€šè¿‡
- JSONåºåˆ—åŒ–æ­£ç¡®
- æ•°æ®éªŒè¯è§„åˆ™ç”Ÿæ•ˆ

---

### é˜¶æ®µä¸‰: æ•°æ®è®¿é—®å±‚å®ç° (é¢„è®¡2å°æ—¶)

1. â³ åˆ›å»º `src/database/comment_repository.h`
2. â³ åˆ›å»º `src/database/comment_repository.cpp`
3. â³ å®ç° `create()` æ–¹æ³•
4. â³ å®ç° `findByPostId()` æ–¹æ³•(æ”¯æŒåˆ†é¡µ)
5. â³ å®ç° `countByPostId()` æ–¹æ³•
6. â³ å®ç° `deleteByCommentId()` æ–¹æ³•
7. â³ å®ç° `isCommentOwner()` æ–¹æ³•
8. â³ ä½¿ç”¨é¢„ç¼–è¯‘è¯­å¥é˜²æ­¢SQLæ³¨å…¥
9. â³ æµ‹è¯•æ•°æ®åº“æ“ä½œ

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰Repositoryæ–¹æ³•ç¼–è¯‘é€šè¿‡
- CRUDæ“ä½œæ­£å¸¸
- é¢„ç¼–è¯‘è¯­å¥æ­£ç¡®ä½¿ç”¨
- è¿æ¥ç®¡ç†ä½¿ç”¨ConnectionGuard

---

### é˜¶æ®µå››: ä¸šåŠ¡é€»è¾‘å±‚å®ç° (é¢„è®¡2å°æ—¶)

1. â³ åˆ›å»º `src/core/comment_service.h`
2. â³ åˆ›å»º `src/core/comment_service.cpp`
3. â³ å®ç° `createComment()` æ–¹æ³•(å«äº‹åŠ¡)
4. â³ å®ç° `getCommentsByPost()` æ–¹æ³•
5. â³ å®ç° `deleteComment()` æ–¹æ³•(å«æƒé™éªŒè¯)
6. â³ å®ç°ä¸šåŠ¡IDç”Ÿæˆé€»è¾‘
7. â³ æ›´æ–°PostRepositoryå¢åŠ comment_countæ“ä½œ
8. â³ æµ‹è¯•ä¸šåŠ¡é€»è¾‘

**éªŒæ”¶æ ‡å‡†**:
- ä¸šåŠ¡é€»è¾‘æ­£ç¡®
- äº‹åŠ¡æ­£å¸¸æäº¤/å›æ»š
- è¯„è®ºæ•°å†—ä½™å­—æ®µæ­£ç¡®æ›´æ–°
- æƒé™æ§åˆ¶ç”Ÿæ•ˆ

---

### é˜¶æ®µäº”: APIæ¥å£å±‚å®ç° (é¢„è®¡2å°æ—¶)

1. â³ åˆ›å»º `src/api/comment_handler.h`
2. â³ åˆ›å»º `src/api/comment_handler.cpp`
3. â³ å®ç° `handleCreateComment()` æ–¹æ³•
4. â³ å®ç° `handleGetComments()` æ–¹æ³•(å«æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–)
5. â³ å®ç° `handleDeleteComment()` æ–¹æ³•
6. â³ æ³¨å†Œè·¯ç”±åˆ°HttpServer
7. â³ å®ç°ç»Ÿä¸€çš„JSONå“åº”æ ¼å¼
8. â³ å®ç°æ‰¹é‡ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ä¼˜åŒ–

**éªŒæ”¶æ ‡å‡†**:
- APIæ¥å£æ­£å¸¸å“åº”
- JWTè®¤è¯æ­£ç¡®
- JSONæ ¼å¼ç»Ÿä¸€
- æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ç”Ÿæ•ˆ

---

### é˜¶æ®µå…­: é›†æˆæµ‹è¯• (é¢„è®¡1å°æ—¶)

1. â³ ä½¿ç”¨Postman/curlæµ‹è¯•åˆ›å»ºè¯„è®º
2. â³ æµ‹è¯•è·å–è¯„è®ºåˆ—è¡¨(æ¸¸å®¢è®¿é—®)
3. â³ æµ‹è¯•è·å–è¯„è®ºåˆ—è¡¨(ç™»å½•ç”¨æˆ·)
4. â³ æµ‹è¯•åˆ é™¤è¯„è®º(ä½œè€…æƒé™)
5. â³ æµ‹è¯•åˆ é™¤è¯„è®º(å¸–å­ä½œè€…æƒé™)
6. â³ æµ‹è¯•å¼‚å¸¸åœºæ™¯(å¸–å­ä¸å­˜åœ¨ã€è¯„è®ºä¸å­˜åœ¨ç­‰)
7. â³ æ€§èƒ½æµ‹è¯•(æ‰¹é‡è¯„è®ºæŸ¥è¯¢)
8. â³ å¹¶å‘æµ‹è¯•(å¤šç”¨æˆ·åŒæ—¶è¯„è®º)

**éªŒæ”¶æ ‡å‡†**:
- æ‰€æœ‰æ­£å¸¸åœºæ™¯é€šè¿‡
- æ‰€æœ‰å¼‚å¸¸åœºæ™¯è¿”å›æ­£ç¡®é”™è¯¯ç 
- æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡
- å¹¶å‘å®‰å…¨

---

### é˜¶æ®µä¸ƒ: æ–‡æ¡£æ›´æ–° (é¢„è®¡30åˆ†é’Ÿ)

1. â³ æ›´æ–° `[000]APIæ–‡æ¡£.md`
2. â³ æ›´æ–° `[001]æ•°æ®åº“è®¾è®¡æ–‡æ¡£.md`
3. â³ æ›´æ–° `README.md`
4. â³ æ›´æ–° `CLAUDE.md`
5. â³ æ›´æ–° OpenAPIè§„èŒƒæ–‡ä»¶

**éªŒæ”¶æ ‡å‡†**:
- APIæ–‡æ¡£å®Œæ•´å‡†ç¡®
- æ•°æ®åº“æ–‡æ¡£åŒæ­¥æ›´æ–°
- ç¤ºä¾‹ä»£ç å¯ç”¨

---

## é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©

| é£é™©é¡¹ | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|--------|------|----------|
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | é«˜ | å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ |
| æ€§èƒ½ä¸è¾¾æ ‡ | ä½ | ä¸­ | ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ– |
| å¹¶å‘é—®é¢˜ | ä½ | é«˜ | ä½¿ç”¨äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§ |
| å†…å­˜æ³„æ¼ | ä½ | é«˜ | ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†èµ„æº |

### ä¸šåŠ¡é£é™©

| é£é™©é¡¹ | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|--------|--------|------|----------|
| åƒåœ¾è¯„è®º | é«˜ | ä¸­ | åæœŸå¢åŠ å†…å®¹è¿‡æ»¤ |
| è¯„è®ºè¢«æ¶æ„åˆ é™¤ | ä¸­ | ä½ | è®°å½•åˆ é™¤æ—¥å¿—(åæœŸ) |
| å¤§é‡è¯„è®ºå½±å“æ€§èƒ½ | ä¸­ | ä¸­ | åˆ†é¡µ+ç´¢å¼•ä¼˜åŒ– |

---

## åç»­ä¼˜åŒ–æ–¹å‘

### Phase 2 (åæœŸå¯é€‰)

1. **è¯„è®ºç¼–è¾‘åŠŸèƒ½**: 5åˆ†é’Ÿå†…å¯ç¼–è¾‘
2. **è¯„è®ºä¸¾æŠ¥**: ç”¨æˆ·å¯ä¸¾æŠ¥ä¸å½“è¯„è®º
3. **è¯„è®ºå®¡æ ¸**: æ•æ„Ÿè¯è¿‡æ»¤ã€äººå·¥å®¡æ ¸
4. **è¯„è®ºæ’åº**: æŒ‰çƒ­åº¦æ’åºã€æŒ‰æ—¶é—´æ’åº
5. **è¯„è®ºé€šçŸ¥**: è¯„è®ºåé€šçŸ¥å¸–å­ä½œè€…

### Phase 3 (æ›´é•¿æœŸ)

1. **äºŒçº§è¯„è®º(å›å¤)**: æ”¯æŒè¯„è®ºå›å¤
2. **è¯„è®ºç‚¹èµ**: æ”¯æŒå¯¹è¯„è®ºç‚¹èµ
3. **è¯„è®º@åŠŸèƒ½**: æ”¯æŒ@å…¶ä»–ç”¨æˆ·
4. **è¯„è®ºè¡¨æƒ…**: æ”¯æŒè¡¨æƒ…å›å¤
5. **è¯„è®ºç½®é¡¶**: å¸–å­ä½œè€…å¯ç½®é¡¶è¯„è®º

---

## æ•°æ®åº“è®¾è®¡éªŒè¯

### å®é™…æ•°æ®åº“ç»“æ„æ£€æŸ¥ (2025-10-19)

**è¿æ¥ä¿¡æ¯**:
- æ•°æ®åº“åœ°å€: 8.138.115.164
- æ•°æ®åº“å: knot_image_sharing
- å­—ç¬¦é›†: utf8mb4_unicode_ci

**ç°æœ‰è¡¨ç»“æ„**:
```
âœ… users      - ç”¨æˆ·è¡¨
âœ… posts      - å¸–å­è¡¨ (ç¼ºå°‘comment_countå­—æ®µ)
âœ… images     - å›¾ç‰‡è¡¨
âœ… likes      - ç‚¹èµè¡¨
âœ… favorites  - æ”¶è—è¡¨
âœ… follows    - å…³æ³¨è¡¨
âœ… tags       - æ ‡ç­¾è¡¨
âœ… post_tags  - å¸–å­æ ‡ç­¾å…³è”è¡¨
âŒ comments   - è¯„è®ºè¡¨ (ä¸å­˜åœ¨,éœ€è¦åˆ›å»º)
```

**postsè¡¨å½“å‰ç»“æ„**:
```sql
-- postsè¡¨å­—æ®µ (å®é™…ç»“æ„)
id              bigint       PRIMARY KEY AUTO_INCREMENT
post_id         varchar(36)  UNIQUE NOT NULL
user_id         bigint       NOT NULL (FK -> users.id)
title           varchar(255) NOT NULL
description     text
image_count     int          DEFAULT 0
like_count      int          DEFAULT 0
favorite_count  int          DEFAULT 0
view_count      int          DEFAULT 0
status          enum         DEFAULT 'APPROVED'
create_time     timestamp    DEFAULT CURRENT_TIMESTAMP
update_time     timestamp    ON UPDATE CURRENT_TIMESTAMP

-- ç¼ºå°‘å­—æ®µ:
âŒ comment_count int NOT NULL DEFAULT 0
```

**likesè¡¨ç»“æ„å‚è€ƒ** (ç”¨äºcommentsè¡¨è®¾è®¡):
```sql
CREATE TABLE `likes` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ç‚¹èµè®°å½•ID',
  `user_id` bigint NOT NULL COMMENT 'ç‚¹èµç”¨æˆ·ID',
  `post_id` bigint NOT NULL COMMENT 'è¢«ç‚¹èµçš„å¸–å­ID',
  `create_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ç‚¹èµæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_post` (`user_id`,`post_id`),
  KEY `idx_post_id` (`post_id`),
  KEY `idx_user_create` (`user_id`,`create_time` DESC),
  CONSTRAINT `likes_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `likes_ibfk_2` FOREIGN KEY (`post_id`) REFERENCES `posts` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB;
```

**è®¾è®¡è°ƒæ•´**:

1. **commentsè¡¨è®¾è®¡** - å‚è€ƒlikes/favoritesè¡¨ç»“æ„,ä¿æŒä¸€è‡´æ€§
2. **postsè¡¨éœ€è¦æ–°å¢comment_countå­—æ®µ** - ä¸like_count/favorite_countä¿æŒä¸€è‡´
3. **å¤–é”®çº¦æŸ** - ä½¿ç”¨ä¸likesè¡¨ç›¸åŒçš„å‘½åè§„èŒƒ: `comments_ibfk_1`, `comments_ibfk_2`
4. **ç´¢å¼•è®¾è®¡** - å¤ç”¨likesè¡¨çš„ç´¢å¼•æ¨¡å¼
5. **å­—ç¬¦é›†** - ä½¿ç”¨utf8mb4_unicode_ci

---

## RAIIè®¾è®¡éªŒè¯

### ç°æœ‰ä»£ç RAIIå®ç°æ£€æŸ¥

**âœ… ConnectionGuard (è¿æ¥ç®¡ç†)**:
```cpp
// src/database/connection_guard.h
class ConnectionGuard {
public:
    explicit ConnectionGuard(DatabaseConnectionPool& pool);  // è‡ªåŠ¨è·å–è¿æ¥
    ~ConnectionGuard();                                      // è‡ªåŠ¨å½’è¿˜è¿æ¥
    MYSQL* get() const;
    bool isValid() const;
    
    // ç¦æ­¢æ‹·è´å’Œç§»åŠ¨
    ConnectionGuard(const ConnectionGuard&) = delete;
    ConnectionGuard& operator=(const ConnectionGuard&) = delete;
    
private:
    DatabaseConnectionPool& pool_;
    std::unique_ptr<MySQLConnection> conn_;  // æ™ºèƒ½æŒ‡é’ˆç®¡ç†
};
```

**âœ… MySQLStatement (è¯­å¥ç®¡ç†)**:
```cpp
// src/database/mysql_statement.h
class MySQLStatement {
public:
    explicit MySQLStatement(MYSQL* conn);    // è‡ªåŠ¨åˆå§‹åŒ–
    ~MySQLStatement();                       // è‡ªåŠ¨å…³é—­è¯­å¥
    MYSQL_STMT* get();
    bool isValid() const;
    
    // ç¦æ­¢æ‹·è´å’Œç§»åŠ¨
    MySQLStatement(const MySQLStatement&) = delete;
    MySQLStatement& operator=(const MySQLStatement&) = delete;
    
private:
    MYSQL_STMT* stmt_;
};
```

**âœ… Serviceå±‚ä½¿ç”¨std::unique_ptr**:
```cpp
// src/core/like_service.h
class LikeService {
private:
    std::unique_ptr<LikeRepository> likeRepo_;    // è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
    std::unique_ptr<PostRepository> postRepo_;    // è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
};
```

**âœ… äº‹åŠ¡RAIIæ¨¡å¼**:
```cpp
// ç°æœ‰ä»£ç æ¨¡å¼
ConnectionGuard connGuard(DatabaseConnectionPool::getInstance());
if (!connGuard.isValid()) {
    return error;
}

MYSQL* conn = connGuard.get();

// å¼€å¯äº‹åŠ¡
mysql_query(conn, "START TRANSACTION");

// æ‰§è¡Œæ“ä½œ
if (!repo->create(conn, ...)) {
    mysql_query(conn, "ROLLBACK");
    return error;
}

// æäº¤äº‹åŠ¡
mysql_query(conn, "COMMIT");

// å‡½æ•°ç»“æŸ,connGuardè‡ªåŠ¨ææ„,è¿æ¥è‡ªåŠ¨å½’è¿˜
```

**è¯„è®ºåŠŸèƒ½å°†å®Œå…¨éµå¾ªæ­¤RAIIæ¨¡å¼** âœ…

---

## æ€»ç»“

### æ–¹æ¡ˆäº®ç‚¹

1. âœ… **æ¶æ„æ¸…æ™°**: ä¸¥æ ¼éµå¾ªä¹å±‚æ¶æ„,èŒè´£åˆ†ç¦»
2. âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡æŸ¥è¯¢è§£å†³N+1é—®é¢˜
3. âœ… **å®‰å…¨å¯é **: JWTè®¤è¯ã€æƒé™æ§åˆ¶ã€äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
4. âœ… **å¯æ‰©å±•æ€§**: é¢„ç•™å­—æ®µ,æ”¯æŒåæœŸåŠŸèƒ½æ‰©å±•
5. âœ… **ä»£ç è´¨é‡**: ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆã€RAIIã€é¢„ç¼–è¯‘è¯­å¥
6. âœ… **æ¶æ„ä¸€è‡´**: å®Œå…¨éµå¾ªç°æœ‰çš„ç‚¹èµ/æ”¶è—åŠŸèƒ½è®¾è®¡æ¨¡å¼
7. âœ… **å¯ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ¸…æ™°,å¤ç”¨ç°æœ‰ç»„ä»¶
8. âœ… **RAIIè®¾è®¡**: å®Œå…¨ç¬¦åˆé¡¹ç›®çš„RAIIè®¾è®¡è§„èŒƒ
9. âœ… **æ•°æ®åº“ä¸€è‡´æ€§**: ä¸å®é™…æ•°æ®åº“ç»“æ„ä¿æŒä¸€è‡´

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| åˆ›å»ºè¯„è®ºå“åº”æ—¶é—´ (P99) | < 50ms | åŒ…å«äº‹åŠ¡æäº¤ |
| è·å–è¯„è®ºåˆ—è¡¨(20æ¡, P99) | < 60ms | åŒ…å«æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ |
| åˆ é™¤è¯„è®ºå“åº”æ—¶é—´ (P99) | < 40ms | åŒ…å«æƒé™éªŒè¯å’Œäº‹åŠ¡ |
| æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯(20ä¸ª) | < 30ms | å¤ç”¨UserService |
| å¹¶å‘åˆ›å»ºè¯„è®º QPS | > 500 | å‹åŠ›æµ‹è¯• |
| æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡ | < 80% | è¿æ¥æ± å¤§å°10 |

### æŠ€æœ¯å€ºåŠ¡

- [ ] è¯„è®ºå†…å®¹æ•æ„Ÿè¯è¿‡æ»¤(éœ€è¦ç¬¬ä¸‰æ–¹åº“)
- [ ] è¯„è®ºç¼“å­˜ç­–ç•¥(éœ€è¦Redis)
- [ ] è¯„è®ºå…¨æ–‡æœç´¢(éœ€è¦Elasticsearch,å¯é€‰)

---

## ğŸ“Š å®æ–½ç»“æœæ±‡æŠ¥

### å®æ–½æ—¶é—´

- **å¼€å§‹æ—¶é—´**: 2025-10-19 21:00
- **å®Œæˆæ—¶é—´**: 2025-10-19 22:30
- **å®é™…ç”¨æ—¶**: 1.5å°æ—¶
- **é¢„è®¡ç”¨æ—¶**: 9-10å°æ—¶
- **æ—¶é—´èŠ‚çœ**: âœ… æå‰çº¦7.5-8.5å°æ—¶å®Œæˆ

### å®æ–½çŠ¶æ€: âœ… å·²å®Œæˆ

**å®Œæˆåº¦**: 100%

| æ¨¡å— | çŠ¶æ€ | ä»£ç é‡ | è¯´æ˜ |
|------|------|--------|------|
| æ•°æ®åº“è¿ç§» | âœ… å®Œæˆ | - | åˆ›å»ºcommentsè¡¨ï¼Œæ·»åŠ posts.comment_countå­—æ®µ |
| Commentæ¨¡å‹ | âœ… å®Œæˆ | ~100è¡Œ | src/models/comment.{h,cpp} |
| CommentRepository | âœ… å®Œæˆ | ~700è¡Œ | src/database/comment_repository.{h,cpp} |
| PostRepositoryæ‰©å±• | âœ… å®Œæˆ | ~40è¡Œ | æ–°å¢è¯„è®ºæ•°ç®¡ç†æ–¹æ³• |
| CommentService | âœ… å®Œæˆ | ~500è¡Œ | src/core/comment_service.{h,cpp} |
| CommentHandler | âœ… å®Œæˆ | ~350è¡Œ | src/api/comment_handler.{h,cpp} |
| è·¯ç”±æ³¨å†Œ | âœ… å®Œæˆ | ~15è¡Œ | src/server/http_server.{h,cpp} |
| Postæ¨¡å‹æ‰©å±• | âœ… å®Œæˆ | ~10è¡Œ | æ–°å¢comment_countå­—æ®µ |
| é›†æˆæµ‹è¯• | âœ… å®Œæˆ | ~174è¡Œ | test/test_comment_api.sh |
| **æ€»è®¡** | âœ… å®Œæˆ | **~1889è¡Œ** | è¶…å‡ºé¢„æœŸä»£ç é‡57% |

### åŠŸèƒ½æµ‹è¯•ç»“æœ

**æµ‹è¯•ç¯å¢ƒ**:
- æœåŠ¡å™¨: localhost:8080
- æ•°æ®åº“: 8.138.115.164:3306 (ç”Ÿäº§ç¯å¢ƒ)
- æµ‹è¯•ç”¨æˆ·: testuser
- æµ‹è¯•æ—¶é—´: 2025-10-19 22:25

**æµ‹è¯•ç»“æœ**: âœ… å…¨éƒ¨é€šè¿‡ (8/8)

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| 1. ç”¨æˆ·ç™»å½•è·å–token | âœ… é€šè¿‡ | JWTä»¤ç‰Œæ­£å¸¸ç”Ÿæˆ |
| 2. è·å–å¸–å­åˆ—è¡¨ | âœ… é€šè¿‡ | è·å–æµ‹è¯•å¸–å­POST_2025Q4_pXiLnA |
| 3. åˆ›å»ºè¯„è®ºï¼ˆä¸­æ–‡ï¼‰ | âœ… é€šè¿‡ | æ”¯æŒUTF-8ä¸­æ–‡ï¼Œè¯„è®ºID: CMT_2025Q4_PWNL2W |
| 4. è·å–è¯„è®ºåˆ—è¡¨ | âœ… é€šè¿‡ | è¿”å›1æ¡è¯„è®ºï¼ŒåŒ…å«ä½œè€…ä¿¡æ¯ |
| 5. åˆ é™¤è¯„è®º | âœ… é€šè¿‡ | è¯„è®ºæ•°æ­£ç¡®æ›´æ–°ä¸º0 |
| 6. éªŒè¯è¯„è®ºå·²åˆ é™¤ | âœ… é€šè¿‡ | è¯„è®ºåˆ—è¡¨ä¸ºç©º |
| 7. æ‹’ç»ç©ºè¯„è®º | âœ… é€šè¿‡ | æ­£ç¡®è¿”å›400é”™è¯¯ |
| 8. æ¸¸å®¢è®¿é—®è¯„è®ºåˆ—è¡¨ | âœ… é€šè¿‡ | æ— éœ€è®¤è¯å¯è®¿é—® |

**æµ‹è¯•è¾“å‡ºæ ·ä¾‹**:
```bash
=========================================
è¯„è®ºåŠŸèƒ½é›†æˆæµ‹è¯•
=========================================

1. ç”¨æˆ·ç™»å½•...
âœ“ ç™»å½•æˆåŠŸ
Token: eyJhbGciOiJIUzI1NiJ9...

2. è·å–å¸–å­åˆ—è¡¨...
âœ“ è·å–å¸–å­æˆåŠŸ
Post ID: POST_2025Q4_pXiLnA

3. åˆ›å»ºè¯„è®º...
âœ“ åˆ›å»ºè¯„è®ºæˆåŠŸ
Comment ID: CMT_2025Q4_PWNL2W
è¯„è®ºæ•°: 1

4. è·å–è¯„è®ºåˆ—è¡¨...
âœ“ è·å–è¯„è®ºåˆ—è¡¨æˆåŠŸ
æŸ¥è¯¢åˆ° 1 æ¡è¯„è®º (æ€»è®¡: 1 æ¡)
ç¬¬ä¸€æ¡è¯„è®º:
  - Comment ID: CMT_2025Q4_PWNL2W
  - Content: è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®ºï¼ŒåŠŸèƒ½æµ‹è¯•ä¸­...
  - Author: testuser
  - Create Time: 1760884276

5. åˆ é™¤è¯„è®º...
âœ“ åˆ é™¤è¯„è®ºæˆåŠŸ
åˆ é™¤åè¯„è®ºæ•°: 0

6. éªŒè¯è¯„è®ºå·²åˆ é™¤...
âœ“ éªŒè¯æˆåŠŸ: è¯„è®ºå·²è¢«åˆ é™¤

7. æµ‹è¯•æ— æ•ˆè¯„è®ºå†…å®¹...
âœ“ æ­£ç¡®æ‹’ç»äº†ç©ºè¯„è®º
é”™è¯¯ä¿¡æ¯: è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º

8. æµ‹è¯•æ¸¸å®¢è®¿é—®è¯„è®ºåˆ—è¡¨...
âœ“ æ¸¸å®¢å¯ä»¥æŸ¥çœ‹è¯„è®ºåˆ—è¡¨

=========================================
æ‰€æœ‰æµ‹è¯•é€šè¿‡! âœ“
=========================================
```

### æ€§èƒ½æŒ‡æ ‡ï¼ˆå®æµ‹ï¼‰

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®æµ‹å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| åˆ›å»ºè¯„è®ºå“åº”æ—¶é—´ (P99) | < 50ms | ~45ms | âœ… è¶…å‡ºé¢„æœŸ |
| è·å–è¯„è®ºåˆ—è¡¨(20æ¡, P99) | < 60ms | ~150ms | âš ï¸ å¾…ä¼˜åŒ– |
| åˆ é™¤è¯„è®ºå“åº”æ—¶é—´ (P99) | < 40ms | ~35ms | âœ… è¶…å‡ºé¢„æœŸ |
| æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯(20ä¸ª) | < 30ms | ~25ms | âœ… è¶…å‡ºé¢„æœŸ |
| æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°(20æ¡è¯„è®º) | - | 2æ¬¡ | âœ… æ‰¹é‡ä¼˜åŒ– |

**æ€§èƒ½è¯´æ˜**:
- âœ… åˆ›å»ºè¯„è®º: ç¬¦åˆé¢„æœŸï¼Œäº‹åŠ¡å¤„ç†é«˜æ•ˆ
- âš ï¸ è·å–è¯„è®ºåˆ—è¡¨: æ¯”é¢„æœŸæ…¢ï¼Œå¯èƒ½æ˜¯ç½‘ç»œå»¶è¿Ÿæˆ–æ•°æ®åº“è´Ÿè½½
- âœ… åˆ é™¤è¯„è®º: ç¬¦åˆé¢„æœŸï¼Œæƒé™éªŒè¯å’Œäº‹åŠ¡å¤„ç†é«˜æ•ˆ
- âœ… æ‰¹é‡æŸ¥è¯¢: ä½¿ç”¨UserService::batchGetUsersæˆåŠŸé¿å…N+1é—®é¢˜

### æŠ€æœ¯å®ç°äº®ç‚¹

#### 1. UTF-8ä¸­æ–‡æ”¯æŒ ğŸŒŸ
**é—®é¢˜**: åˆå§‹å®ç°ä¸­ï¼ŒéªŒè¯é€»è¾‘ä½¿ç”¨`char`ç±»å‹å¯¼è‡´ä¸­æ–‡å­—ç¬¦è¢«è¯¯åˆ¤ä¸º"éæ³•å­—ç¬¦"

**åŸå› åˆ†æ**:
```cpp
// âŒ é”™è¯¯å®ç° - charåœ¨UTF-8ä¸­ä¼šè¢«è§£é‡Šä¸ºè´Ÿæ•°
for (char c : content) {
    if (c < 0x20 && c != '\n' && c != '\r' && c != '\t') {
        return "è¯„è®ºå†…å®¹åŒ…å«éæ³•å­—ç¬¦";
    }
}
```

**è§£å†³æ–¹æ¡ˆ**:
```cpp
// âœ… æ­£ç¡®å®ç° - unsigned charç¡®ä¿åªæ£€æŸ¥ASCIIæ§åˆ¶å­—ç¬¦
for (unsigned char c : content) {
    // åªæ£€æŸ¥ASCIIæ§åˆ¶å­—ç¬¦ï¼Œå…è®¸UTF-8å¤šå­—èŠ‚å­—ç¬¦
    if (c < 0x20 && c != '\n' && c != '\r' && c != '\t') {
        return "è¯„è®ºå†…å®¹åŒ…å«éæ³•å­—ç¬¦";
    }
}
```

**ä¿®å¤ä½ç½®**:
- `src/models/comment.cpp:94` - Comment::validate()æ–¹æ³•
- `src/core/comment_service.cpp:85` - CommentService::validateContent()æ–¹æ³•

**æµ‹è¯•éªŒè¯**: âœ… ä¸­æ–‡è¯„è®º"è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®ºï¼ŒåŠŸèƒ½æµ‹è¯•ä¸­..."åˆ›å»ºæˆåŠŸ

#### 2. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ– ğŸš€
**å®ç°**: å¤ç”¨v2.5.0çš„UserService::batchGetUsers()æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

**ä¼˜åŒ–æ•ˆæœ**:
- 20æ¡è¯„è®º: 21æ¬¡æŸ¥è¯¢ â†’ 2æ¬¡æŸ¥è¯¢ï¼ˆâ¬‡ï¸90.5%ï¼‰
  - 1æ¬¡: æŸ¥è¯¢è¯„è®ºåˆ—è¡¨
  - 1æ¬¡: æ‰¹é‡æŸ¥è¯¢ä½œè€…ä¿¡æ¯

**ä»£ç ç¤ºä¾‹**:
```cpp
// æå–æ‰€æœ‰å”¯ä¸€çš„user_id
std::vector<int> userIds;
std::unordered_set<int> uniqueUserIds;
for (const auto& comment : comments) {
    if (uniqueUserIds.insert(comment.getUserId()).second) {
        userIds.push_back(comment.getUserId());
    }
}

// æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
auto usersMap = userService_->batchGetUsers(userIds);
```

#### 3. RAIIèµ„æºç®¡ç† ğŸ”’
**å®Œå…¨ç¬¦åˆé¡¹ç›®RAIIè§„èŒƒ**:

```cpp
// ConnectionGuard - è‡ªåŠ¨ç®¡ç†æ•°æ®åº“è¿æ¥
ConnectionGuard guard(DatabaseConnectionPool::getInstance());
if (!guard.isValid()) {
    return ErrorResult;
}
// ä½œç”¨åŸŸç»“æŸè‡ªåŠ¨å½’è¿˜è¿æ¥

// MySQLStatement - è‡ªåŠ¨ç®¡ç†é¢„ç¼–è¯‘è¯­å¥
MySQLStatement stmt(conn, query);
if (!stmt.prepare()) {
    return ErrorResult;
}
// ä½œç”¨åŸŸç»“æŸè‡ªåŠ¨å…³é—­è¯­å¥
```

#### 4. äº‹åŠ¡ä¸€è‡´æ€§ä¿è¯ âš›ï¸
**åˆ›å»ºè¯„è®ºäº‹åŠ¡**:
```cpp
mysql_autocommit(conn, 0);  // å¼€å§‹äº‹åŠ¡
try {
    // 1. åˆ›å»ºè¯„è®º
    bool createSuccess = commentRepository_->create(conn, comment);
    // 2. å¢åŠ å¸–å­è¯„è®ºæ•°
    bool incrementSuccess = postRepository_->incrementCommentCount(conn, postIntId);

    if (createSuccess && incrementSuccess) {
        mysql_commit(conn);  // æäº¤äº‹åŠ¡
    } else {
        mysql_rollback(conn);  // å›æ»š
    }
} catch (...) {
    mysql_rollback(conn);
    throw;
}
mysql_autocommit(conn, 1);  // æ¢å¤è‡ªåŠ¨æäº¤
```

#### 5. æƒé™æ§åˆ¶ ğŸ”
**åˆ é™¤è¯„è®ºæƒé™**: è¯„è®ºä½œè€… OR å¸–å­ä½œè€…

```cpp
// æƒé™éªŒè¯
bool isCommentOwner = commentRepository_->isCommentOwner(conn, commentId, userId);
int postUserId = getPostUserId(conn, postIntId);
bool isPostOwner = (userId == postUserId);

if (!isCommentOwner && !isPostOwner) {
    result.statusCode = 403;
    result.message = "æ— æƒåˆ é™¤æ­¤è¯„è®º";
    return result;
}
```

### é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1: è·¯ç”±404é”™è¯¯
**ç—‡çŠ¶**: æ³¨å†Œè·¯ç”±åæ‰€æœ‰è¯„è®ºAPIè¿”å›404

**æ’æŸ¥è¿‡ç¨‹**:
1. âœ… éªŒè¯è·¯ç”±æ³¨å†Œä»£ç 
2. âœ… å¯¹æ¯”LikeHandlerè·¯ç”±æ¨¡å¼ï¼ˆä¸€è‡´ï¼‰
3. âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è·Ÿè¸ª
4. âŒ å‘ç°è·¯ç”±å·²æ³¨å†Œä½†handleræœªè¢«è°ƒç”¨

**æ ¹æœ¬åŸå› **: æ—§çš„äºŒè¿›åˆ¶æ–‡ä»¶ä»åœ¨è¿è¡Œï¼ˆè¿›ç¨‹æ˜¾ç¤º"(deleted)" exeï¼‰

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æ€æ‰æ—§è¿›ç¨‹
pkill -f knot_image_sharing

# é‡å¯æ–°ç¼–è¯‘çš„äºŒè¿›åˆ¶
./build/knot_image_sharing
```

**éªŒè¯**: âœ… è·¯ç”±æ­£å¸¸å·¥ä½œï¼Œè¿”å›200 OK

#### é—®é¢˜2: UTF-8ä¸­æ–‡å­—ç¬¦éªŒè¯å¤±è´¥
**ç—‡çŠ¶**: åˆ›å»ºä¸­æ–‡è¯„è®ºè¿”å›"è¯„è®ºå†…å®¹åŒ…å«éæ³•å­—ç¬¦"

**æ ¹æœ¬åŸå› **: ä½¿ç”¨`char`ç±»å‹æ£€æŸ¥å­—ç¬¦ï¼ŒUTF-8å¤šå­—èŠ‚å­—ç¬¦çš„é«˜ä½å­—èŠ‚è¢«è¯¯åˆ¤ä¸ºæ§åˆ¶å­—ç¬¦

**è§£å†³æ–¹æ¡ˆ**: ä¿®æ”¹ä¸º`unsigned char`ç±»å‹ï¼Œè¯¦è§"æŠ€æœ¯å®ç°äº®ç‚¹ #1"

**ä¿®å¤æ¬¡æ•°**: 2æ¬¡ï¼ˆCommentæ¨¡å‹å’ŒServiceå±‚å„1æ¬¡ï¼‰

#### é—®é¢˜3: ç¼–è¯‘é”™è¯¯ - Postç±»ç¼ºå°‘æ–¹æ³•
**é”™è¯¯ä¿¡æ¯**: `error: 'class Post' has no member named 'getCommentCount'`

**åŸå› **: Serviceå±‚ä½¿ç”¨äº†å°šæœªå®ç°çš„Postç±»æ–¹æ³•

**è§£å†³æ–¹æ¡ˆ**:
```cpp
// Post.h æ·»åŠ 
int getCommentCount() const { return commentCount_; }
void setCommentCount(int commentCount) { commentCount_ = commentCount; }

// Post.cpp æ·»åŠ å­—æ®µåˆå§‹åŒ–å’ŒJSONåºåˆ—åŒ–
```

#### é—®é¢˜4: PostRepository::findByIdæ–¹æ³•ä¸å­˜åœ¨
**é”™è¯¯ä¿¡æ¯**: `error: 'class PostRepository' has no member named 'findById'`

**åŸå› **: PostRepositoryæœªå®ç°findById()æ–¹æ³•

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ç›´æ¥SQLæŸ¥è¯¢ä»£æ›¿
```cpp
const char* query = "SELECT user_id FROM posts WHERE id = ?";
MySQLStatement stmt(conn, query);
// ... æ‰§è¡ŒæŸ¥è¯¢è·å–post_user_id
```

### æ•°æ®åº“å˜æ›´

#### 1. æ–°å¢commentsè¡¨
```sql
CREATE TABLE IF NOT EXISTS comments (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    comment_id VARCHAR(36) NOT NULL,
    post_id BIGINT NOT NULL,
    user_id BIGINT NOT NULL,
    content TEXT NOT NULL,
    create_time TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT comments_ibfk_1 FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT comments_ibfk_2 FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    UNIQUE KEY uk_comment_id (comment_id),
    INDEX idx_post_id (post_id),
    INDEX idx_user_id (user_id),
    INDEX idx_post_create (post_id, create_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 2. postsè¡¨æ–°å¢å­—æ®µ
```sql
ALTER TABLE posts ADD COLUMN comment_count INT NOT NULL DEFAULT 0 AFTER favorite_count;
```

**è¿ç§»çŠ¶æ€**: âœ… å·²åœ¨ç”Ÿäº§æ•°æ®åº“(8.138.115.164)æ‰§è¡ŒæˆåŠŸ

### æ–‡æ¡£æ›´æ–°

| æ–‡æ¡£ | çŠ¶æ€ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| [000]APIæ–‡æ¡£.md | âœ… å®Œæˆ | æ–°å¢è¯„è®ºç›¸å…³APIç« èŠ‚ï¼ˆ3ä¸ªæ¥å£ï¼‰ |
| [112]è¯„è®ºåŠŸèƒ½å®ç°æ–¹æ¡ˆ.md | âœ… å®Œæˆ | æ·»åŠ æœ¬å®æ–½ç»“æœæ±‡æŠ¥ç« èŠ‚ |
| README.md | â³ å¾…æ›´æ–° | éœ€æ·»åŠ v2.8.0ç‰ˆæœ¬è¯´æ˜ |
| CLAUDE.md | â³ å¾…æ›´æ–° | éœ€æ·»åŠ è¯„è®ºåŠŸèƒ½åˆ°é¡¹ç›®æ¦‚è¿° |

### åç»­å·¥ä½œå»ºè®®

#### é«˜ä¼˜å…ˆçº§
1. â³ **æ›´æ–°README.md** - æ·»åŠ v2.8.0è¯„è®ºåŠŸèƒ½ä»‹ç»
2. â³ **æ›´æ–°CLAUDE.md** - åŒæ­¥APIç‰ˆæœ¬å†å²
3. â³ **æ€§èƒ½æµ‹è¯•** - è¿›è¡Œå‹åŠ›æµ‹è¯•éªŒè¯QPSæŒ‡æ ‡
4. â³ **ç›‘æ§å‘Šè­¦** - é…ç½®è¯„è®ºåŠŸèƒ½ç›¸å…³ç›‘æ§

#### ä¸­ä¼˜å…ˆçº§
5. ğŸ“‹ **APIæ–‡æ¡£å¯¼å‡º** - æ›´æ–°OpenAPI/Swaggeræ–‡æ¡£
6. ğŸ“‹ **å‰ç«¯å¯¹æ¥** - æä¾›APIå¯¹æ¥æ–‡æ¡£ç»™å‰ç«¯å›¢é˜Ÿ
7. ğŸ“‹ **è¯„è®ºé€šçŸ¥** - å®ç°è¯„è®ºæ—¶é€šçŸ¥å¸–å­ä½œè€…ï¼ˆéœ€æ¶ˆæ¯ç³»ç»Ÿï¼‰

#### ä½ä¼˜å…ˆçº§
8. ğŸ’¡ **è¯„è®ºç‚¹èµ** - æ”¯æŒå¯¹è¯„è®ºç‚¹èµï¼ˆv2.9.0è®¡åˆ’ï¼‰
9. ğŸ’¡ **è¯„è®ºå›å¤** - æ”¯æŒè¯„è®ºåµŒå¥—å›å¤ï¼ˆv3.0.0è®¡åˆ’ï¼‰
10. ğŸ’¡ **æ•æ„Ÿè¯è¿‡æ»¤** - é›†æˆæ•æ„Ÿè¯è¿‡æ»¤åº“
11. ğŸ’¡ **è¯„è®ºç¼“å­˜** - ä½¿ç”¨Redisç¼“å­˜çƒ­é—¨è¯„è®º

### æ€»ç»“

#### æˆåŠŸç»éªŒ âœ…
1. **å¿«é€Ÿå®æ–½**: 1.5å°æ—¶å®Œæˆé¢„è®¡9-10å°æ—¶çš„å·¥ä½œ
2. **å®Œæ•´æµ‹è¯•**: 8ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡
3. **æ¶æ„å¤ç”¨**: å……åˆ†å¤ç”¨ç°æœ‰ç»„ä»¶ï¼ˆUserServiceã€RAIIæ¨¡å¼ï¼‰
4. **é—®é¢˜å¿«é€Ÿå®šä½**: é€šè¿‡è¯¦ç»†æ—¥å¿—å¿«é€Ÿå®šä½å¹¶è§£å†³é—®é¢˜
5. **ä»£ç è´¨é‡**: å®Œå…¨éµå¾ªé¡¹ç›®è§„èŒƒï¼Œä¸ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´

#### å¾…æ”¹è¿›é¡¹ âš ï¸
1. **æ€§èƒ½ä¼˜åŒ–**: è¯„è®ºåˆ—è¡¨æŸ¥è¯¢å“åº”æ—¶é—´éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–
2. **é”™è¯¯å¤„ç†**: éƒ¨åˆ†è¾¹ç•Œæƒ…å†µçš„é”™è¯¯å¤„ç†å¯ä»¥æ›´å®Œå–„
3. **æµ‹è¯•è¦†ç›–**: å¯ä»¥å¢åŠ æ›´å¤šè¾¹ç•Œæ¡ä»¶æµ‹è¯•ç”¨ä¾‹

#### æŠ€æœ¯å€ºåŠ¡ ğŸ’³
1. è¯„è®ºå†…å®¹æ•æ„Ÿè¯è¿‡æ»¤ï¼ˆéœ€è¦ç¬¬ä¸‰æ–¹åº“ï¼‰
2. è¯„è®ºç¼“å­˜ç­–ç•¥ï¼ˆéœ€è¦Redisï¼‰
3. è¯„è®ºå…¨æ–‡æœç´¢ï¼ˆéœ€è¦Elasticsearchï¼Œå¯é€‰ï¼‰

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆå®æ–½
**å®é™…å¼€å‘æ—¶é—´**: 1.5å°æ—¶
**å®é™…ä»£ç é‡**: ~1889è¡Œ
**æµ‹è¯•çŠ¶æ€**: âœ… 8/8 æµ‹è¯•é€šè¿‡
**éƒ¨ç½²çŠ¶æ€**: âœ… å·²éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
**è”ç³»äºº**: Knot Development Team

