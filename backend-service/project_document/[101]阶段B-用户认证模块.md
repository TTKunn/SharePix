# 阶段B: 用户认证模块完整文档

**文档编号**: [101]
**创建时间**: 2025-10-02
**版本**: v1.0.0
**状态**: ✅ 已完成

---

## 📋 目录

1. [阶段概述](#阶段概述)
2. [架构设计](#架构设计)
3. [核心组件](#核心组件)
4. [数据库设计](#数据库设计)
5. [API接口](#api接口)
6. [安全机制](#安全机制)
7. [业务流程](#业务流程)
8. [完成总结](#完成总结)

---

## 阶段概述

### 任务目标

实现用户认证系统的核心功能，包括：
- 用户注册/登录
- JWT令牌管理
- 密码安全
- 用户数据访问

### 完成的模块

| 模块 | 文件 | 状态 |
|------|------|------|
| PasswordHasher | src/security/password_hasher.h/cpp | ✅ |
| JWTManager | src/security/jwt_manager.h/cpp | ✅ |
| UserRepository | src/database/user_repository.h/cpp | ✅ |
| AuthService | src/core/auth_service.h/cpp | ✅ |
| AuthHandler | src/api/auth_handler.h/cpp | ✅ |
| User Model | src/models/user.h/cpp | ✅ |

---

## 架构设计

### 九层架构中的位置

```
第1层：客户端层（HTTP客户端）
    ↓
第2层：HTTP服务器层（HTTPServer）
    ↓
第3层：API接口层（AuthHandler）← 🎯 本阶段核心
    ↓
第4层：业务逻辑层（AuthService）← 🎯 本阶段核心
    ↓
第5层：数据访问层（UserRepository）← 🎯 本阶段核心
    ↓
第6层：安全层（PasswordHasher, JWTManager）← 🎯 本阶段核心
    ↓
第7层：基础设施层（ConnectionPool, ConfigManager, Logger）
    ↓
第8层：数据模型层（User）← 🎯 本阶段核心
    ↓
第9层：数据库层（MySQL）
```

### AuthHandler的定位

**AuthHandler是HTTP层和业务逻辑层之间的桥梁**

**职责**:
- **上游**: 接收来自HTTPServer的HTTP请求
- **下游**: 调用AuthService的业务方法
- **作用**: 协议转换（HTTP ↔ C++对象）

**不负责**:
- ❌ 业务逻辑（由AuthService负责）
- ❌ 数据库操作（由UserRepository负责）
- ❌ 密码加密（由PasswordHasher负责）
- ❌ JWT生成（由JWTManager负责）

### 请求处理流程

```
1. 客户端发送HTTP请求
   ↓
2. HttpServer接收请求
   ↓
3. 路由到AuthHandler
   ↓
4. AuthHandler解析JSON请求体
   ↓
5. AuthHandler提取JWT令牌（如需要）
   ↓
6. AuthHandler调用AuthService
   ↓
7. AuthService执行业务逻辑
   ↓
8. AuthService调用UserRepository
   ↓
9. UserRepository执行数据库操作
   ↓
10. 结果逐层返回
   ↓
11. AuthHandler构造JSON响应
   ↓
12. HttpServer发送响应给客户端
```

---

## 核心组件

### 1. PasswordHasher - 密码哈希模块

**文件**: `src/security/password_hasher.h/cpp`

**功能**:
- `generateSalt()` - 生成16字节随机盐值（Base64编码）
- `hashPassword()` - 使用PBKDF2-HMAC-SHA256哈希密码
- `verifyPassword()` - 验证密码
- `base64Encode()` / `base64Decode()` - Base64编解码

**技术细节**:
- 算法: PBKDF2-HMAC-SHA256
- 迭代次数: 100,000次（OWASP 2023标准）
- 盐值长度: 16字节
- 哈希输出: 32字节
- 编码方式: Base64

**使用示例**:
```cpp
// 注册时：生成盐值和哈希
std::string salt = PasswordHasher::generateSalt();
std::string hash = PasswordHasher::hashPassword(password, salt);

// 登录时：验证密码
bool valid = PasswordHasher::verifyPassword(inputPassword, storedHash, storedSalt);
```

---

### 2. JWTManager - JWT令牌管理模块

**文件**: `src/security/jwt_manager.h/cpp`

**功能**:
- `generateAccessToken()` - 生成访问令牌（1小时）
- `generateRefreshToken()` - 生成刷新令牌（24小时）
- `validateToken()` - 验证令牌签名和有效期
- `decodeToken()` - 解析令牌内容

**技术细节**:
- 算法: HS256 (HMAC-SHA256)
- 库: jwt-cpp + jsoncpp traits
- 访问令牌有效期: 1小时
- 刷新令牌有效期: 24小时
- 令牌声明: issuer, subject, issued_at, expires_at, username

**令牌结构**:
```json
{
  "iss": "shared-parking-auth",
  "sub": "1",
  "iat": 1696147200,
  "exp": 1696150800,
  "username": "zhangsan"
}
```

**使用示例**:
```cpp
// 生成令牌
std::string accessToken = jwtManager.generateAccessToken(userId, username);
std::string refreshToken = jwtManager.generateRefreshToken(userId, username);

// 验证令牌
if (jwtManager.validateToken(token)) {
    auto decoded = jwtManager.decodeToken(token);
    int userId = std::stoi(decoded.get_subject());
}
```

---

### 3. UserRepository - 用户数据访问模块

**文件**: `src/database/user_repository.h/cpp`

**功能**:
- `createUser()` - 创建用户
- `findById()` - 根据物理ID查询
- `findByUserId()` - 根据逻辑ID查询
- `findByUsername()` - 根据用户名查询
- `findByEmail()` - 根据邮箱查询
- `findByPhone()` - 根据手机号查询
- `updateUser()` - 更新用户信息
- `usernameExists()` - 检查用户名是否存在
- `emailExists()` - 检查邮箱是否存在
- `phoneExists()` - 检查手机号是否存在

**技术细节**:
- 使用MySQL预编译语句（防SQL注入）
- 使用ConnectionGuard自动管理连接
- 返回std::optional表示可能不存在的结果
- 完善的错误处理和日志记录

**使用示例**:
```cpp
// 创建用户
User newUser;
newUser.setUsername("zhangsan");
// ... 设置其他字段
if (userRepo.createUser(newUser)) {
    Logger::info("User created successfully");
}

// 查询用户
auto user = userRepo.findByUsername("zhangsan");
if (user.has_value()) {
    Logger::info("User found: " + user->getUsername());
}
```

---

### 4. AuthService - 认证服务模块

**文件**: `src/core/auth_service.h/cpp`

**功能**:
- `registerUser()` - 用户注册
- `loginUser()` - 用户登录（支持用户名/手机号/邮箱）
- `validateToken()` - 验证JWT令牌
- `refreshTokens()` - 刷新令牌
- `logoutUser()` - 用户登出（简化实现）
- `changePassword()` - 修改密码
- `generateUserId()` - 生成唯一用户ID
- `validateUserInput()` - 验证用户输入

**业务逻辑**:

#### 用户注册流程
```
1. 验证输入（用户名、密码、手机号等）
2. 检查用户名/邮箱/手机号是否已存在
3. 生成唯一用户ID（USR_2025Q1_XXXXXX）
4. 生成盐值
5. 哈希密码
6. 创建用户记录
7. 返回用户信息
```

#### 用户登录流程
```
1. 根据用户名/手机号/邮箱查询用户
2. 验证密码
3. 检查账户状态（active/inactive/banned）
4. 生成访问令牌和刷新令牌
5. 返回令牌和用户信息
```

**使用示例**:
```cpp
// 注册
User newUser;
newUser.setUsername("zhangsan");
newUser.setPassword("password123");
// ... 设置其他字段
auto result = authService.registerUser(newUser);
if (result.has_value()) {
    Logger::info("User registered: " + result->getUserId());
}

// 登录
auto loginResult = authService.loginUser("zhangsan", "password123");
if (loginResult.has_value()) {
    std::string accessToken = loginResult->first;
    std::string refreshToken = loginResult->second;
}
```

---

### 5. AuthHandler - API接口层

**文件**: `src/api/auth_handler.h/cpp`

**功能**:
- `handleRegister()` - 处理注册请求
- `handleLogin()` - 处理登录请求
- `handleValidate()` - 处理令牌验证请求
- `handleRefresh()` - 处理令牌刷新请求
- `handleLogout()` - 处理登出请求
- `handleChangePassword()` - 处理修改密码请求

**辅助方法**:
- `parseJsonBody()` - 解析JSON请求体
- `sendJsonResponse()` - 发送JSON响应
- `extractToken()` - 提取JWT令牌
- `getUserIdFromToken()` - 从令牌中获取用户ID

**响应格式**:
```json
{
  "success": true/false,
  "message": "消息内容",
  "data": {}
}
```

---

### 6. User Model - 数据模型

**文件**: `src/models/user.h/cpp`

**字段**:
- `id` - 物理ID（自增）
- `user_id` - 逻辑ID（USR_2025Q1_XXXXXX）
- `username` - 用户名
- `password_hash` - 密码哈希
- `salt` - 盐值
- `real_name` - 真实姓名
- `phone` - 手机号
- `email` - 邮箱
- `role` - 角色（owner/driver/both）
- `status` - 状态（active/inactive/banned）
- `avatar_url` - 头像URL
- `device_count` - 设备数量
- `create_time` - 创建时间
- `update_time` - 更新时间

**方法**:
- 完整的getter/setter
- `toJson()` - 序列化为JSON
- `fromJson()` - 从JSON反序列化

---

## 数据库设计

### users表结构

```sql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '物理ID',
    user_id VARCHAR(50) NOT NULL UNIQUE COMMENT '逻辑ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    salt VARCHAR(64) NOT NULL COMMENT '盐值',
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    phone VARCHAR(20) NOT NULL UNIQUE COMMENT '手机号',
    email VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
    role ENUM('owner', 'driver', 'both') DEFAULT 'driver' COMMENT '角色',
    status ENUM('active', 'inactive', 'banned') DEFAULT 'active' COMMENT '状态',
    avatar_url VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
    device_count INT DEFAULT 0 COMMENT '设备数量',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    INDEX idx_user_id (user_id),
    INDEX idx_username (username),
    INDEX idx_phone (phone),
    INDEX idx_email (email),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户信息表';
```

### 索引说明

| 索引名 | 字段 | 类型 | 用途 |
|--------|------|------|------|
| PRIMARY | id | 主键 | 唯一标识 |
| UNIQUE | user_id | 唯一索引 | 逻辑ID查询 |
| UNIQUE | username | 唯一索引 | 用户名查询 |
| UNIQUE | phone | 唯一索引 | 手机号查询 |
| INDEX | email | 普通索引 | 邮箱查询 |
| INDEX | create_time | 普通索引 | 时间范围查询 |

---

## API接口

### 1. 用户注册

**请求**: `POST /api/v1/auth/register`

**请求体**:
```json
{
  "username": "zhangsan",
  "password": "password123",
  "real_name": "张三",
  "phone": "13800138000",
  "email": "zhangsan@example.com",
  "role": "driver"
}
```

**响应**:
```json
{
  "success": true,
  "message": "注册成功",
  "data": {
    "id": 1,
    "user_id": "USR_2025Q1_A1B2C3",
    "username": "zhangsan",
    "real_name": "张三",
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "role": "driver",
    "status": "active"
  }
}
```

### 2. 用户登录

**请求**: `POST /api/v1/auth/login`

**请求体**:
```json
{
  "username": "zhangsan",
  "password": "password123"
}
```

**响应**:
```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "user_id": "USR_2025Q1_A1B2C3",
      "username": "zhangsan",
      "real_name": "张三",
      "role": "driver",
      "status": "active"
    }
  }
}
```

### 3. 令牌验证

**请求**: `POST /api/v1/auth/validate`

**请求头**: `Authorization: Bearer {access_token}`

**响应**:
```json
{
  "valid": true,
  "message": "令牌有效",
  "data": {
    "user_id": 1,
    "username": "zhangsan"
  }
}
```

### 4. 令牌刷新

**请求**: `POST /api/v1/auth/refresh`

**请求体**:
```json
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**响应**:
```json
{
  "success": true,
  "message": "令牌刷新成功",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

### 5. 用户登出

**请求**: `POST /api/v1/auth/logout`

**请求头**: `Authorization: Bearer {access_token}`

**响应**:
```json
{
  "success": true,
  "message": "登出成功"
}
```

### 6. 修改密码

**请求**: `POST /api/v1/auth/change-password`

**请求头**: `Authorization: Bearer {access_token}`

**请求体**:
```json
{
  "user_id": 1,
  "old_password": "password123",
  "new_password": "newpassword456"
}
```

**响应**:
```json
{
  "success": true,
  "message": "密码修改成功"
}
```

---

## 安全机制

### 1. 密码安全

**加密算法**: PBKDF2-HMAC-SHA256
**迭代次数**: 100,000次
**盐值**: 16字节随机生成
**哈希长度**: 32字节

**安全特性**:
- ✅ 每个用户独立的盐值
- ✅ 高迭代次数防止暴力破解
- ✅ 使用OpenSSL标准库
- ✅ 符合OWASP 2023标准

### 2. JWT令牌安全

**签名算法**: HS256 (HMAC-SHA256)
**密钥管理**: 从配置文件加载
**令牌有效期**: 
- 访问令牌: 1小时
- 刷新令牌: 24小时

**安全特性**:
- ✅ 签名验证防止篡改
- ✅ 过期时间验证
- ✅ 无状态认证
- ✅ 支持令牌刷新

### 3. SQL注入防护

**防护措施**:
- ✅ 所有查询使用预编译语句
- ✅ 参数绑定
- ✅ 输入验证

**示例**:
```cpp
// 使用预编译语句
const char* query = "SELECT * FROM users WHERE username = ?";
MYSQL_STMT* stmt = mysql_stmt_init(conn->get());
mysql_stmt_prepare(stmt, query, strlen(query));

// 绑定参数
MYSQL_BIND bind[1];
bind[0].buffer_type = MYSQL_TYPE_STRING;
bind[0].buffer = (char*)username.c_str();
bind[0].buffer_length = username.length();
mysql_stmt_bind_param(stmt, bind);
```

### 4. 输入验证

**验证规则**:
- 用户名: 3-50字符，字母数字下划线
- 密码: 6-100字符
- 手机号: 11位中国手机号
- 邮箱: 标准邮箱格式

---

## 业务流程

### 用户注册流程图

```
开始
  ↓
接收注册请求
  ↓
验证输入格式
  ↓
检查用户名是否存在 → 是 → 返回错误
  ↓ 否
检查手机号是否存在 → 是 → 返回错误
  ↓ 否
检查邮箱是否存在 → 是 → 返回错误
  ↓ 否
生成用户ID
  ↓
生成盐值
  ↓
哈希密码
  ↓
创建用户记录
  ↓
返回用户信息
  ↓
结束
```

### 用户登录流程图

```
开始
  ↓
接收登录请求
  ↓
根据用户名/手机号/邮箱查询用户
  ↓
用户存在？ → 否 → 返回错误
  ↓ 是
验证密码
  ↓
密码正确？ → 否 → 返回错误
  ↓ 是
检查账户状态
  ↓
状态正常？ → 否 → 返回错误
  ↓ 是
生成访问令牌
  ↓
生成刷新令牌
  ↓
返回令牌和用户信息
  ↓
结束
```

---

## 完成总结

### 完成情况

- ✅ **架构设计**: 完整的九层架构
- ✅ **核心功能**: 6个API全部实现
- ✅ **安全机制**: PBKDF2 + JWT + SQL注入防护
- ✅ **代码质量**: 详细中文注释，符合规范
- ✅ **文档完整**: 完整的技术文档
- ✅ **测试验证**: 注册和登录功能已测试通过

### 技术亮点

1. **安全性**
   - PBKDF2-HMAC-SHA256密码加密
   - JWT无状态认证
   - SQL预编译语句防注入

2. **可维护性**
   - 清晰的层次结构
   - 详细的中文注释
   - 统一的错误处理

3. **性能**
   - 数据库连接池
   - 预编译语句缓存
   - 索引优化

4. **可扩展性**
   - 模块化设计
   - 依赖注入
   - 接口抽象

### 代码统计

| 模块 | 文件数 | 代码行数 |
|------|--------|----------|
| PasswordHasher | 2 | ~200 |
| JWTManager | 2 | ~150 |
| UserRepository | 2 | ~800 |
| AuthService | 2 | ~600 |
| AuthHandler | 2 | ~500 |
| User Model | 2 | ~300 |
| **总计** | **12** | **~2550** |

---

**文档版本**: v1.0.0
**最后更新**: 2025-10-02
**维护者**: Shared Parking Team

