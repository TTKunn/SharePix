# Knot å›¾ç‰‡åˆ†äº«å¹³å° - æ•°æ®åº“è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç¼–å·**: [001]
**åˆ›å»ºæ—¶é—´**: 2025-10-09
**é¡¹ç›®**: Knot - Image Sharing Service
**ç‰ˆæœ¬**: v2.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
2. [è¡¨ç»“æ„è®¾è®¡](#è¡¨ç»“æ„è®¾è®¡)
3. [è¡¨å…³ç³»è¯´æ˜](#è¡¨å…³ç³»è¯´æ˜)
4. [ç´¢å¼•è®¾è®¡](#ç´¢å¼•è®¾è®¡)
5. [çº¦æŸè¯´æ˜](#çº¦æŸè¯´æ˜)
6. [æ•°æ®è¿ç§»](#æ•°æ®è¿ç§»)

---

## æ•°æ®åº“æ¦‚è¿°

### åŸºæœ¬ä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| æ•°æ®åº“åç§° | `knot_image_sharing` |
| æ•°æ®åº“å¼•æ“ | MySQL 8.0 |
| å­—ç¬¦é›† | `utf8mb4` |
| æ’åºè§„åˆ™ | `utf8mb4_unicode_ci` |
| é»˜è®¤ç«¯å£ | 3306 |

### è®¾è®¡åŸåˆ™

1. **è§„èŒƒåŒ–è®¾è®¡**ï¼šéµå¾ªç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ï¼Œå‡å°‘æ•°æ®å†—ä½™
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
3. **æ•°æ®å®Œæ•´æ€§**ï¼šä½¿ç”¨å¤–é”®çº¦æŸä¿è¯æ•°æ®ä¸€è‡´æ€§
4. **å¯æ‰©å±•æ€§**ï¼šé¢„ç•™æ‰©å±•å­—æ®µï¼Œæ”¯æŒæœªæ¥åŠŸèƒ½
5. **å®‰å…¨æ€§**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ï¼ˆå¯†ç ä½¿ç”¨PBKDF2-HMAC-SHA256ï¼‰

---

## è¡¨ç»“æ„è®¾è®¡

### 1. users è¡¨ï¼ˆç”¨æˆ·è¡¨ï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šå­˜å‚¨ç”¨æˆ·è´¦æˆ·ä¿¡æ¯å’Œè®¤è¯æ•°æ®

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | ç”¨æˆ·ç‰©ç†IDï¼Œè‡ªå¢ä¸»é”® |
| user_id | VARCHAR(50) | UNIQUE, NOT NULL | - | ç”¨æˆ·ä¸šåŠ¡IDï¼Œæ ¼å¼ï¼šUSR_YYYYQX_XXXXXX |
| username | VARCHAR(50) | UNIQUE, NOT NULL | - | ç”¨æˆ·åï¼Œ3-50å­—ç¬¦ï¼Œå”¯ä¸€ |
| email | VARCHAR(100) | UNIQUE, NOT NULL | - | é‚®ç®±åœ°å€ï¼Œå”¯ä¸€ |
| password_hash | VARCHAR(255) | NOT NULL | - | å¯†ç å“ˆå¸Œå€¼ï¼ˆPBKDF2-HMAC-SHA256ï¼‰ |
| salt | VARCHAR(32) | NOT NULL | - | å¯†ç ç›å€¼ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ |
| role | ENUM('USER', 'ADMIN') | NOT NULL | 'USER' | ç”¨æˆ·è§’è‰²ï¼šUSER=æ™®é€šç”¨æˆ·ï¼ŒADMIN=ç®¡ç†å‘˜ |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | è´¦æˆ·åˆ›å»ºæ—¶é—´ |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | è´¦æˆ·æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: `id`
- UNIQUE INDEX: `user_id`, `username`, `email`

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO users (user_id, username, email, password_hash, salt, role) VALUES
('USR_2025Q4_ABC123', 'john_doe', 'john@example.com', 'hashed_password', 'random_salt', 'USER');
```

---

### 2. posts è¡¨ï¼ˆå¸–å­è¡¨ï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šå­˜å‚¨å¸–å­ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€é…æ–‡å’Œç»Ÿè®¡æ•°æ®

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | å¸–å­ç‰©ç†IDï¼Œè‡ªå¢ä¸»é”® |
| post_id | VARCHAR(50) | UNIQUE, NOT NULL | - | å¸–å­ä¸šåŠ¡IDï¼Œæ ¼å¼ï¼šPST_YYYYQX_XXXXXX |
| user_id | INT | FOREIGN KEY(users.id), NOT NULL | - | ç”¨æˆ·IDï¼Œå¤–é”®å…³è”usersè¡¨ |
| title | VARCHAR(255) | NOT NULL | - | å¸–å­æ ‡é¢˜ï¼Œ1-255å­—ç¬¦ |
| description | TEXT | NULL | NULL | å¸–å­é…æ–‡ï¼Œæœ€å¤š65535å­—ç¬¦ |
| image_count | INT | NOT NULL | 0 | å›¾ç‰‡æ•°é‡ï¼ŒèŒƒå›´ï¼š1-9 |
| like_count | INT | NOT NULL | 0 | ç‚¹èµæ•°ï¼Œéè´Ÿæ•´æ•° |
| favorite_count | INT | NOT NULL | 0 | æ”¶è—æ•°ï¼Œéè´Ÿæ•´æ•° |
| view_count | INT | NOT NULL | 0 | æµè§ˆæ•°ï¼Œéè´Ÿæ•´æ•° |
| status | ENUM('PENDING', 'APPROVED', 'REJECTED') | NOT NULL | 'APPROVED' | å®¡æ ¸çŠ¶æ€ï¼šPENDING=å¾…å®¡æ ¸ï¼ŒAPPROVED=å·²é€šè¿‡ï¼ŒREJECTED=å·²æ‹’ç» |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | å¸–å­åˆ›å»ºæ—¶é—´ |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | å¸–å­æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: `id`
- UNIQUE INDEX: `post_id`
- FOREIGN KEY INDEX: `user_id`
- BUSINESS INDEX: `create_time` (ç”¨äºFeedæµæ’åº)
- COMPOSITE INDEX: `(user_id, create_time)` (ç”¨äºç”¨æˆ·å¸–å­åˆ—è¡¨)

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO posts (post_id, user_id, title, description, image_count, status) VALUES
('PST_2025Q4_XYZ789', 1, 'ç¾å¥½çš„ä¸€å¤©', 'ä»Šå¤©å¤©æ°”çœŸå¥½ï¼', 3, 'APPROVED');
```

---

### 3. images è¡¨ï¼ˆå›¾ç‰‡è¡¨ï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šå­˜å‚¨å›¾ç‰‡æ–‡ä»¶ä¿¡æ¯å’Œå…ƒæ•°æ®

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | å›¾ç‰‡ç‰©ç†IDï¼Œè‡ªå¢ä¸»é”® |
| image_id | VARCHAR(50) | UNIQUE, NOT NULL | - | å›¾ç‰‡ä¸šåŠ¡IDï¼Œæ ¼å¼ï¼šIMG_YYYYQX_XXXXXX |
| post_id | INT | FOREIGN KEY(posts.id), NOT NULL | - | å¸–å­IDï¼Œå¤–é”®å…³è”postsè¡¨ |
| display_order | INT | NOT NULL | 1 | æ˜¾ç¤ºé¡ºåºï¼ŒèŒƒå›´ï¼š1-9 |
| user_id | INT | FOREIGN KEY(users.id), NOT NULL | - | ç”¨æˆ·IDï¼Œå¤–é”®å…³è”usersè¡¨ |
| file_url | VARCHAR(255) | NOT NULL | - | åŸå›¾æ–‡ä»¶URLè·¯å¾„ |
| thumbnail_url | VARCHAR(255) | NOT NULL | - | ç¼©ç•¥å›¾æ–‡ä»¶URLè·¯å¾„ |
| file_size | BIGINT | NOT NULL | - | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œæœ€å¤§5MB |
| width | INT | NOT NULL | - | å›¾ç‰‡å®½åº¦ï¼ˆåƒç´ ï¼‰ |
| height | INT | NOT NULL | - | å›¾ç‰‡é«˜åº¦ï¼ˆåƒç´ ï¼‰ |
| mime_type | VARCHAR(50) | NOT NULL | - | MIMEç±»å‹ï¼Œå¦‚ï¼šimage/jpeg, image/png |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | å›¾ç‰‡ä¸Šä¼ æ—¶é—´ |
| update_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | å›¾ç‰‡æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: `id`
- UNIQUE INDEX: `image_id`
- FOREIGN KEY INDEX: `post_id`, `user_id`
- COMPOSITE INDEX: `(post_id, display_order)` (ç”¨äºæŒ‰é¡ºåºè·å–å¸–å­å›¾ç‰‡)

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO images (image_id, post_id, display_order, user_id, file_url, thumbnail_url, file_size, width, height, mime_type) VALUES
('IMG_2025Q4_001', 1, 1, 1, '/uploads/images/abc123.jpg', '/uploads/thumbnails/abc123_thumb.jpg', 1024000, 1920, 1080, 'image/jpeg');
```

---

### 4. tags è¡¨ï¼ˆæ ‡ç­¾è¡¨ï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šå­˜å‚¨æ ‡ç­¾ä¿¡æ¯å’Œä½¿ç”¨ç»Ÿè®¡

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | æ ‡ç­¾ç‰©ç†IDï¼Œè‡ªå¢ä¸»é”® |
| name | VARCHAR(50) | UNIQUE, NOT NULL | - | æ ‡ç­¾åç§°ï¼Œ1-50å­—ç¬¦ï¼Œå”¯ä¸€ |
| use_count | INT | NOT NULL | 0 | ä½¿ç”¨æ¬¡æ•°ï¼Œéè´Ÿæ•´æ•° |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | æ ‡ç­¾åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: `id`
- UNIQUE INDEX: `name`
- BUSINESS INDEX: `use_count` (ç”¨äºçƒ­é—¨æ ‡ç­¾æ’åº)

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO tags (name, use_count) VALUES
('é£æ™¯', 100),
('ç¾é£Ÿ', 85),
('æ—…è¡Œ', 120);
```

---

### 5. post_tags è¡¨ï¼ˆå¸–å­æ ‡ç­¾å…³è”è¡¨ï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šå­˜å‚¨å¸–å­å’Œæ ‡ç­¾çš„å¤šå¯¹å¤šå…³ç³»

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | æ•°æ®ç±»å‹ | çº¦æŸ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|----------|------|--------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | - | å…³è”ç‰©ç†IDï¼Œè‡ªå¢ä¸»é”® |
| post_id | INT | FOREIGN KEY(posts.id), NOT NULL | - | å¸–å­IDï¼Œå¤–é”®å…³è”postsè¡¨ |
| tag_id | INT | FOREIGN KEY(tags.id), NOT NULL | - | æ ‡ç­¾IDï¼Œå¤–é”®å…³è”tagsè¡¨ |
| create_time | TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | å…³è”åˆ›å»ºæ—¶é—´ |

**ç´¢å¼•**ï¼š
- PRIMARY KEY: `id`
- FOREIGN KEY INDEX: `post_id`, `tag_id`
- UNIQUE COMPOSITE INDEX: `(post_id, tag_id)` (é˜²æ­¢é‡å¤å…³è”)
- COMPOSITE INDEX: `(tag_id, create_time)` (ç”¨äºæŒ‰æ ‡ç­¾æŸ¥è¯¢å¸–å­)

**ç¤ºä¾‹æ•°æ®**ï¼š
```sql
INSERT INTO post_tags (post_id, tag_id) VALUES
(1, 1),  -- å¸–å­1å…³è”æ ‡ç­¾1ï¼ˆé£æ™¯ï¼‰
(1, 3);  -- å¸–å­1å…³è”æ ‡ç­¾3ï¼ˆæ—…è¡Œï¼‰
```

---

## è¡¨å…³ç³»è¯´æ˜

### ERå…³ç³»å›¾ï¼ˆæ–‡æœ¬å½¢å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚
â”‚  (ç”¨æˆ·è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚   posts     â”‚
â”‚  (å¸–å­è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1
       â”‚
       â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚   images    â”‚
â”‚  (å›¾ç‰‡è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   posts     â”‚ N     N â”‚    tags     â”‚
â”‚  (å¸–å­è¡¨)    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  (æ ‡ç­¾è¡¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â”‚ 1                   1 â”‚
       â”‚                       â”‚
       â”‚ N                   N â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â”‚  post_tags  â”‚
        â”‚ (å…³è”è¡¨)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³ç³»è¯¦ç»†è¯´æ˜

#### 1. users â† postsï¼ˆä¸€å¯¹å¤šï¼‰

- **å…³ç³»ç±»å‹**ï¼šä¸€å¯¹å¤šï¼ˆ1:Nï¼‰
- **è¯´æ˜**ï¼šä¸€ä¸ªç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ªå¸–å­ï¼Œä¸€ä¸ªå¸–å­åªå±äºä¸€ä¸ªç”¨æˆ·
- **å¤–é”®**ï¼š`posts.user_id` â†’ `users.id`
- **çº§è”æ“ä½œ**ï¼š`ON DELETE CASCADE`ï¼ˆåˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤å…¶æ‰€æœ‰å¸–å­ï¼‰

#### 2. posts â† imagesï¼ˆä¸€å¯¹å¤šï¼‰

- **å…³ç³»ç±»å‹**ï¼šä¸€å¯¹å¤šï¼ˆ1:Nï¼‰
- **è¯´æ˜**ï¼šä¸€ä¸ªå¸–å­å¯ä»¥åŒ…å«å¤šå¼ å›¾ç‰‡ï¼ˆ1-9å¼ ï¼‰ï¼Œä¸€å¼ å›¾ç‰‡åªå±äºä¸€ä¸ªå¸–å­
- **å¤–é”®**ï¼š`images.post_id` â†’ `posts.id`
- **çº§è”æ“ä½œ**ï¼š`ON DELETE CASCADE`ï¼ˆåˆ é™¤å¸–å­æ—¶è‡ªåŠ¨åˆ é™¤å…¶æ‰€æœ‰å›¾ç‰‡ï¼‰
- **ä¸šåŠ¡è§„åˆ™**ï¼š
  - å›¾ç‰‡æ•°é‡èŒƒå›´ï¼š1-9å¼ 
  - å›¾ç‰‡é¡ºåºï¼š`display_order` å­—æ®µï¼ŒèŒƒå›´1-9
  - è‡³å°‘ä¿ç•™1å¼ å›¾ç‰‡ï¼ˆä¸èƒ½åˆ é™¤æœ€åä¸€å¼ ï¼‰

#### 3. posts â† post_tags â†’ tagsï¼ˆå¤šå¯¹å¤šï¼‰

- **å…³ç³»ç±»å‹**ï¼šå¤šå¯¹å¤šï¼ˆN:Mï¼‰
- **è¯´æ˜**ï¼šä¸€ä¸ªå¸–å­å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾ï¼Œä¸€ä¸ªæ ‡ç­¾å¯ä»¥å…³è”å¤šä¸ªå¸–å­
- **ä¸­é—´è¡¨**ï¼š`post_tags`
- **å¤–é”®**ï¼š
  - `post_tags.post_id` â†’ `posts.id`
  - `post_tags.tag_id` â†’ `tags.id`
- **çº§è”æ“ä½œ**ï¼š`ON DELETE CASCADE`ï¼ˆåˆ é™¤å¸–å­æˆ–æ ‡ç­¾æ—¶è‡ªåŠ¨åˆ é™¤å…³è”å…³ç³»ï¼‰
- **ä¸šåŠ¡è§„åˆ™**ï¼š
  - æ¯ä¸ªå¸–å­æœ€å¤š5ä¸ªæ ‡ç­¾
  - æ ‡ç­¾åç§°å”¯ä¸€
  - æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°è‡ªåŠ¨ç»Ÿè®¡

---

## ç´¢å¼•è®¾è®¡

### ä¸»é”®ç´¢å¼•

| è¡¨å | ç´¢å¼•å | å­—æ®µ | è¯´æ˜ |
|------|--------|------|------|
| users | PRIMARY | id | ç”¨æˆ·ç‰©ç†ID |
| posts | PRIMARY | id | å¸–å­ç‰©ç†ID |
| images | PRIMARY | id | å›¾ç‰‡ç‰©ç†ID |
| tags | PRIMARY | id | æ ‡ç­¾ç‰©ç†ID |
| post_tags | PRIMARY | id | å…³è”ç‰©ç†ID |

### å”¯ä¸€ç´¢å¼•

| è¡¨å | ç´¢å¼•å | å­—æ®µ | è¯´æ˜ |
|------|--------|------|------|
| users | idx_user_id | user_id | ç”¨æˆ·ä¸šåŠ¡IDå”¯ä¸€ |
| users | idx_username | username | ç”¨æˆ·åå”¯ä¸€ |
| users | idx_email | email | é‚®ç®±å”¯ä¸€ |
| posts | idx_post_id | post_id | å¸–å­ä¸šåŠ¡IDå”¯ä¸€ |
| images | idx_image_id | image_id | å›¾ç‰‡ä¸šåŠ¡IDå”¯ä¸€ |
| tags | idx_tag_name | name | æ ‡ç­¾åç§°å”¯ä¸€ |
| post_tags | idx_post_tag_unique | (post_id, tag_id) | é˜²æ­¢é‡å¤å…³è” |

### å¤–é”®ç´¢å¼•

| è¡¨å | ç´¢å¼•å | å­—æ®µ | å…³è”è¡¨ | è¯´æ˜ |
|------|--------|------|--------|------|
| posts | idx_posts_user_id | user_id | users.id | ç”¨æˆ·å¸–å­æŸ¥è¯¢ |
| images | idx_images_post_id | post_id | posts.id | å¸–å­å›¾ç‰‡æŸ¥è¯¢ |
| images | idx_images_user_id | user_id | users.id | ç”¨æˆ·å›¾ç‰‡æŸ¥è¯¢ |
| post_tags | idx_post_tags_post_id | post_id | posts.id | å¸–å­æ ‡ç­¾æŸ¥è¯¢ |
| post_tags | idx_post_tags_tag_id | tag_id | tags.id | æ ‡ç­¾å¸–å­æŸ¥è¯¢ |

### ä¸šåŠ¡ç´¢å¼•ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

| è¡¨å | ç´¢å¼•å | å­—æ®µ | è¯´æ˜ |
|------|--------|------|------|
| posts | idx_posts_create_time | create_time | FeedæµæŒ‰æ—¶é—´æ’åº |
| posts | idx_posts_user_create | (user_id, create_time) | ç”¨æˆ·å¸–å­åˆ—è¡¨ |
| images | idx_images_post_order | (post_id, display_order) | æŒ‰é¡ºåºè·å–å¸–å­å›¾ç‰‡ |
| tags | idx_tags_use_count | use_count | çƒ­é—¨æ ‡ç­¾æ’åº |
| post_tags | idx_post_tags_tag_time | (tag_id, create_time) | æŒ‰æ ‡ç­¾æŸ¥è¯¢å¸–å­ |

---

## çº¦æŸè¯´æ˜

### å¤–é”®çº¦æŸ

| çº¦æŸå | å­è¡¨ | å­è¡¨å­—æ®µ | çˆ¶è¡¨ | çˆ¶è¡¨å­—æ®µ | çº§è”æ“ä½œ |
|--------|------|----------|------|----------|----------|
| fk_posts_user | posts | user_id | users | id | ON DELETE CASCADE |
| fk_images_post | images | post_id | posts | id | ON DELETE CASCADE |
| fk_images_user | images | user_id | users | id | ON DELETE CASCADE |
| fk_post_tags_post | post_tags | post_id | posts | id | ON DELETE CASCADE |
| fk_post_tags_tag | post_tags | tag_id | tags | id | ON DELETE CASCADE |

**çº§è”åˆ é™¤è§„åˆ™**ï¼š
- åˆ é™¤ç”¨æˆ· â†’ è‡ªåŠ¨åˆ é™¤å…¶æ‰€æœ‰å¸–å­ â†’ è‡ªåŠ¨åˆ é™¤æ‰€æœ‰å›¾ç‰‡å’Œæ ‡ç­¾å…³è”
- åˆ é™¤å¸–å­ â†’ è‡ªåŠ¨åˆ é™¤å…¶æ‰€æœ‰å›¾ç‰‡å’Œæ ‡ç­¾å…³è”
- åˆ é™¤æ ‡ç­¾ â†’ è‡ªåŠ¨åˆ é™¤æ‰€æœ‰å¸–å­å…³è”

### å”¯ä¸€çº¦æŸ

| è¡¨å | çº¦æŸå | å­—æ®µ | è¯´æ˜ |
|------|--------|------|------|
| users | uk_user_id | user_id | ç”¨æˆ·ä¸šåŠ¡IDå”¯ä¸€ |
| users | uk_username | username | ç”¨æˆ·åå”¯ä¸€ |
| users | uk_email | email | é‚®ç®±å”¯ä¸€ |
| posts | uk_post_id | post_id | å¸–å­ä¸šåŠ¡IDå”¯ä¸€ |
| images | uk_image_id | image_id | å›¾ç‰‡ä¸šåŠ¡IDå”¯ä¸€ |
| tags | uk_tag_name | name | æ ‡ç­¾åç§°å”¯ä¸€ |
| post_tags | uk_post_tag | (post_id, tag_id) | é˜²æ­¢é‡å¤å…³è” |

### æ£€æŸ¥çº¦æŸï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰

| è¡¨å | çº¦æŸå | æ¡ä»¶ | è¯´æ˜ |
|------|--------|------|------|
| posts | chk_image_count | image_count >= 1 AND image_count <= 9 | å›¾ç‰‡æ•°é‡èŒƒå›´ï¼š1-9 |
| posts | chk_like_count | like_count >= 0 | ç‚¹èµæ•°éè´Ÿ |
| posts | chk_favorite_count | favorite_count >= 0 | æ”¶è—æ•°éè´Ÿ |
| posts | chk_view_count | view_count >= 0 | æµè§ˆæ•°éè´Ÿ |
| images | chk_display_order | display_order >= 1 AND display_order <= 9 | æ˜¾ç¤ºé¡ºåºèŒƒå›´ï¼š1-9 |
| images | chk_file_size | file_size > 0 AND file_size <= 5242880 | æ–‡ä»¶å¤§å°ï¼š0-5MB |
| images | chk_dimensions | width > 0 AND height > 0 | å›¾ç‰‡å°ºå¯¸å¿…é¡»å¤§äº0 |
| tags | chk_use_count | use_count >= 0 | ä½¿ç”¨æ¬¡æ•°éè´Ÿ |

---

## æ•°æ®è¿ç§»

### ä»å•å›¾ç‰‡æ¨¡å‹åˆ°å¤šå›¾ç‰‡å¸–å­æ¨¡å‹

**è¿ç§»æ—¶é—´**ï¼š2025-10-08

**è¿ç§»è„šæœ¬**ï¼š`config/migration_to_posts.sql`

**è¿ç§»æ­¥éª¤**ï¼š

1. **åˆ›å»ºpostsè¡¨**
   ```sql
   CREATE TABLE posts (
       id INT AUTO_INCREMENT PRIMARY KEY,
       post_id VARCHAR(50) UNIQUE NOT NULL,
       user_id INT NOT NULL,
       title VARCHAR(255) NOT NULL,
       description TEXT,
       image_count INT DEFAULT 0,
       like_count INT DEFAULT 0,
       favorite_count INT DEFAULT 0,
       view_count INT DEFAULT 0,
       status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'APPROVED',
       create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
       update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
       FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
   );
   ```

2. **ä¿®æ”¹imagesè¡¨**
   ```sql
   ALTER TABLE images 
       DROP COLUMN title,
       DROP COLUMN description,
       DROP COLUMN like_count,
       DROP COLUMN favorite_count,
       DROP COLUMN view_count,
       DROP COLUMN status,
       ADD COLUMN post_id INT NOT NULL AFTER image_id,
       ADD COLUMN display_order INT DEFAULT 1 AFTER post_id,
       ADD FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE;
   ```

3. **é‡å‘½åimage_tagsä¸ºpost_tags**
   ```sql
   RENAME TABLE image_tags TO post_tags;
   ALTER TABLE post_tags CHANGE image_id post_id INT NOT NULL;
   ```

4. **æ•°æ®è¿ç§»**
   - å°†ç°æœ‰çš„3å¼ å›¾ç‰‡è½¬æ¢ä¸º3ä¸ªå•å›¾ç‰‡å¸–å­
   - ä¿ç•™åŸæœ‰çš„æ ‡é¢˜ã€é…æ–‡å’Œç»Ÿè®¡æ•°æ®

**è¿ç§»ç»“æœ**ï¼š
- âœ… 3å¼ å›¾ç‰‡ â†’ 3ä¸ªå•å›¾ç‰‡å¸–å­
- âœ… æ•°æ®å®Œæ•´æ€§ä¿æŒ
- âœ… å¤–é”®å…³ç³»æ­£ç¡®
- âœ… ç´¢å¼•åˆ›å»ºæˆåŠŸ

---

**æ–‡æ¡£ç»“æŸ**

