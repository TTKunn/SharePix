# Knot - 图片分享社区 MVP需求分析

**项目定位**: 简约而不简单的图片分享社区，让创作回归本质
**版本**: v1.0 MVP
**更新时间**: 2025-10-07

---

## 一、产品定位与核心理念

### 🎯 产品定位
Knot是一个**轻量级图片分享社区**，专注于提供简洁、流畅的图片分享体验。

**核心差异化**:
- 🎨 **创作优先**: 快速上传→一键发布，降低创作门槛
- 🔍 **发现为王**: 瀑布流+智能推荐，沉浸式浏览体验
- 💬 **轻社交**: 点赞/收藏/关注，简单高效的互动方式
- 🚀 **性能极致**: 图片压缩+CDN加速，秒开体验

### 🎨 设计理念
- **简约不简单**: 去除冗余功能，专注核心体验
- **移动优先**: 为移动端设计，兼顾Web端
- **渐进增强**: MVP验证核心价值，后续迭代扩展功能

---

## 二、用户角色分析

### 1. 核心用户角色

| 角色 | 核心需求 | 痛点 | 优先级 |
|------|---------|------|--------|
| **内容创作者** | 快速上传图片、获得互动反馈、管理作品 | 上传流程繁琐、缺少曝光 | P0 |
| **内容消费者** | 浏览优质图片、点赞收藏、关注创作者 | 内容质量参差不齐、发现困难 | P0 |

**MVP阶段暂不考虑**:
- ❌ 系统管理员(内容审核后置到V1.1)
- ❌ 商业用户(广告/付费功能V2.0考虑)

### 2. 用户故事

**创作者**:
- "作为一名摄影爱好者，我希望能快速上传照片并获得曝光，而不需要复杂的编辑和设置"
- "我想知道有多少人喜欢我的作品，并能方便地管理我的图片库"

**消费者**:
- "我想在碎片时间浏览有趣的图片，简单的点赞/收藏就能记录喜欢的内容"
- "关注喜欢的创作者后，能优先看到他们的新作品"

---

## 三、MVP功能范围

### ✅ V1.0 MVP 核心功能

#### 🔐 模块1: 用户管理系统 (基础)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 注册/登录 | 手机号或邮箱注册，JWT令牌认证 | P0 |
| 个人主页 | 展示用户名、头像、简介、发布数/关注数/粉丝数 | P0 |
| 编辑资料 | 修改头像、用户名、个人简介 | P0 |
| 基础设置 | 主题切换(浅色/深色) | P1 |

**流程图**:
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant A as 认证服务
    participant D as 数据库

    U->>F: 1. 输入手机号/邮箱+密码
    F->>A: 2. 发送注册/登录请求
    A->>D: 3. 验证凭据/创建用户
    D-->>A: 4. 返回用户信息
    A-->>F: 5. 返回JWT令牌
    F->>F: 6. 存储令牌到本地
    F-->>U: 7. 跳转到首页
```

#### 📸 模块2: 图片管理系统 (核心)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **上传功能** |  | |
| - 图片上传 | 支持JPEG/PNG/WebP，单图≤5MB | P0 |
| - 自动压缩 | 压缩到合适大小(质量80%)，生成缩略图 | P0 |
| - 元数据填写 | 标题(必填)、描述(可选)、标签(最多5个) | P0 |
| **浏览功能** |  | |
| - 首页Feed | 瀑布流布局，智能推荐(热度+时间加权) | P0 |
| - 图片详情 | 大图查看+作者信息+互动数据 | P0 |
| - 标签搜索 | 按标签搜索图片 | P0 |
| - 用户图片墙 | 个人主页展示该用户的所有图片 | P0 |
| **管理功能** |  | |
| - 我的图片 | 查看/编辑/删除自己的图片 | P0 |

**上传流程**:
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant I as 图片服务
    participant S as 存储服务
    participant D as 数据库

    U->>F: 1. 选择图片
    F->>F: 2. 客户端压缩预览
    U->>F: 3. 填写标题/标签/描述
    F->>I: 4. 上传图片+元数据
    I->>I: 5. 验证格式/大小
    I->>I: 6. 压缩图片(质量80%)
    I->>I: 7. 生成缩略图(300x300)
    I->>S: 8. 保存原图+缩略图
    S-->>I: 9. 返回文件URL
    I->>D: 10. 保存图片记录
    I-->>F: 11. 返回成功+图片ID
    F-->>U: 12. 跳转到图片详情页
```

**Feed推荐流程**:
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant R as 推荐服务
    participant D as 数据库

    U->>F: 1. 打开首页
    F->>R: 2. 请求Feed(页码/每页数量)
    R->>D: 3. 查询推荐算法结果
    Note over R,D: 简单推荐算法:<br/>热度=(点赞数*0.7+收藏数*0.3)<br/>时间衰减=1/((当前时间-发布时间)+2)^1.5<br/>排序=热度*时间衰减
    D-->>R: 4. 返回图片列表(缩略图URL)
    R-->>F: 5. 返回分页数据
    F-->>U: 6. 渲染瀑布流
    U->>F: 7. 下拉加载更多
    F->>R: 8. 请求下一页
```

#### 💕 模块3: 互动系统 (轻量化)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **点赞系统** | | |
| - 点赞/取消 | 一键点赞，实时更新点赞数 | P0 |
| - 我的点赞 | 查看我点赞过的图片列表 | P1 |
| **收藏系统** | | |
| - 收藏/取消 | 收藏到"我的收藏" | P0 |
| - 我的收藏 | 查看收藏列表 | P0 |
| **关注系统** | | |
| - 关注/取关 | 关注/取消关注用户 | P0 |
| - 关注列表 | 查看我关注的人 | P0 |
| - 粉丝列表 | 查看关注我的人 | P0 |
| - 关注Feed | 优先展示关注用户的图片 | P1 |
| **分享系统** | | |
| - 生成分享链接 | 为图片生成短链接(如knot.app/s/ABC123) | P0 |
| - Deep Link唤起 | 点击链接自动唤起APP | P0 |
| - H5落地页 | 未安装用户的引导页 | P0 |
| - Web Share API | 调用系统原生分享面板 | P0 |
| - 社交平台分享 | 微信/微博/QQ快捷分享 | P1 |
| - 分享数据统计 | 追踪分享点击/转化数据 | P1 |

**点赞流程**:
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant I as 互动服务
    participant D as 数据库

    U->>F: 1. 点击点赞按钮
    F->>F: 2. 乐观更新UI(立即显示已点赞)
    F->>I: 3. 发送点赞请求
    I->>D: 4. 插入点赞记录
    I->>D: 5. 更新图片点赞数(+1)
    D-->>I: 6. 返回操作结果

    alt 成功
        I-->>F: 7. 返回成功
    else 失败(如重复点赞)
        I-->>F: 7. 返回失败
        F->>F: 8. 回滚UI状态
    end
```

**分享流程**:
```mermaid
sequenceDiagram
    participant U as 用户
    participant F as 前端
    participant S as 分享服务
    participant D as 数据库
    participant H5 as H5落地页

    U->>F: 1. 点击分享按钮
    F->>S: 2. 请求生成分享链接
    S->>S: 3. 生成短链接码(Base62)
    S->>D: 4. 保存分享记录
    D-->>S: 5. 返回保存结果
    S-->>F: 6. 返回短链接(knot.app/s/ABC123)
    F->>F: 7. 调用Web Share API/显示分享面板

    Note over F: 用户选择分享到微信
    F->>外部: 8. 分享链接到微信

    Note over H5: 好友点击链接
    外部->>H5: 9. 打开链接
    H5->>S: 10. 解析短链接码
    S->>D: 11. 查询目标信息+记录访问
    D-->>S: 12. 返回图片详情
    S-->>H5: 13. 返回数据

    alt 已安装APP
        H5->>APP: 14. 唤起APP(Universal Link)
        APP->>详情页: 15. 跳转到图片详情页
    else 未安装APP
        H5->>H5: 14. 显示落地页+下载引导
    end
```

#### 🛡️ 模块4: 系统支持 (基础)

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 图片存储 | 本地存储/对象存储(MinIO/阿里云OSS) | P0 |
| 图片压缩 | 自动压缩+缩略图生成 | P0 |
| 用户统计 | 发布数/关注数/粉丝数冗余表 | P0 |

---

### ❌ V1.0 MVP 暂不实现

以下功能延后到后续版本:

| 功能 | 计划版本 | 原因 |
|------|---------|------|
| 评论系统 | V1.1 | MVP专注浏览+轻互动 |
| 内容审核 | V1.1 | 初期用户少，人工巡查 |
| 图片编辑 | V1.2 | 使用系统编辑器 |
| 通知系统 | V1.1 | 依赖评论系统 |
| 第三方登录 | V1.2 | 简化开发流程 |
| 第三方分享SDK | V1.1 | MVP使用URL Scheme |
| 地理位置 | V2.0 | 非核心功能 |
| 话题挑战 | V2.0 | 运营向功能 |

---

## 四、数据库设计 (MVP精简版)

### 表结构总览

**9张核心表** (vs 原设计14张，精简36%):

| 表名 | 说明 | 记录数预估 |
|------|------|-----------|
| users | 用户表 | ~1万 |
| images | 图片表 | ~10万 |
| tags | 标签表 | ~1000 |
| image_tags | 图片标签关联表 | ~50万 |
| likes | 点赞表 | ~100万 |
| favorites | 收藏表 | ~50万 |
| follows | 关注表 | ~5万 |
| user_stats | 用户统计表(冗余) | ~1万 |
| share_links | 分享链接表 | ~10万 |

### 核心表设计

#### 1. 用户表 (users)

```sql
CREATE TABLE users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '物理主键',
    user_id VARCHAR(36) NOT NULL UNIQUE COMMENT '业务逻辑ID',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希(PBKDF2)',
    email VARCHAR(100) UNIQUE COMMENT '邮箱',
    phone VARCHAR(20) UNIQUE COMMENT '手机号',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    bio VARCHAR(500) COMMENT '个人简介',
    status ENUM('ACTIVE', 'INACTIVE', 'BANNED') DEFAULT 'ACTIVE',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**精简说明**:
- ✅ 去掉`is_deleted`(直接硬删除，简化逻辑)
- ✅ 去掉`last_login_time`(非核心统计)
- ✅ 统一密码存储在users表，不需要独立的user_auths表

#### 2. 图片表 (images)

```sql
CREATE TABLE images (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    image_id VARCHAR(36) NOT NULL UNIQUE COMMENT '业务逻辑ID',
    user_id BIGINT NOT NULL COMMENT '上传用户ID',
    title VARCHAR(255) NOT NULL COMMENT '图片标题',
    description TEXT COMMENT '图片描述',
    file_url VARCHAR(500) NOT NULL COMMENT '原图URL',
    thumbnail_url VARCHAR(500) NOT NULL COMMENT '缩略图URL',
    file_size BIGINT NOT NULL COMMENT '文件大小(字节)',
    width INT COMMENT '宽度',
    height INT COMMENT '高度',
    mime_type VARCHAR(50) NOT NULL COMMENT 'image/jpeg等',
    like_count INT DEFAULT 0 COMMENT '点赞数(冗余)',
    favorite_count INT DEFAULT 0 COMMENT '收藏数(冗余)',
    view_count INT DEFAULT 0 COMMENT '浏览数',
    status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'APPROVED' COMMENT '审核状态',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    update_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_status_create (status, create_time),
    INDEX idx_like_count (like_count),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片表';
```

**优化说明**:
- ✅ 去掉`file_key`(直接用URL)
- ✅ 增加`thumbnail_url`(缩略图独立存储)
- ✅ `status`默认`APPROVED`(MVP无审核)
- ✅ 去掉`is_deleted`(直接删除)
- ✅ 冗余`like_count/favorite_count`提升查询性能

#### 3. 标签表 (tags)

```sql
CREATE TABLE tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE COMMENT '标签名(如"风景")',
    use_count INT DEFAULT 0 COMMENT '使用次数(冗余)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_name (name),
    INDEX idx_use_count (use_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签表';
```

**优化说明**:
- ✅ 去掉`tag_id`业务ID(简化查询)
- ✅ 增加`use_count`统计热门标签

#### 4. 图片标签关联表 (image_tags)

```sql
CREATE TABLE image_tags (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    image_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE,
    UNIQUE KEY uk_image_tag (image_id, tag_id),
    INDEX idx_tag_id (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='图片标签关联表';
```

#### 5. 点赞表 (likes)

```sql
CREATE TABLE likes (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '点赞用户ID',
    image_id BIGINT NOT NULL COMMENT '被点赞图片ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_image (user_id, image_id),
    INDEX idx_image_id (image_id),
    INDEX idx_user_create (user_id, create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点赞表';
```

**优化说明**:
- ✅ 去掉`like_id`业务ID(简化设计)

#### 6. 收藏表 (favorites)

```sql
CREATE TABLE favorites (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '收藏用户ID',
    image_id BIGINT NOT NULL COMMENT '被收藏图片ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_image (user_id, image_id),
    INDEX idx_image_id (image_id),
    INDEX idx_user_create (user_id, create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='收藏表';
```

#### 7. 关注表 (follows)

```sql
CREATE TABLE follows (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    follower_id BIGINT NOT NULL COMMENT '关注者ID',
    followed_id BIGINT NOT NULL COMMENT '被关注者ID',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (follower_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (followed_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_follower_followed (follower_id, followed_id),
    INDEX idx_follower_id (follower_id),
    INDEX idx_followed_id (followed_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='关注表';
```

#### 8. 用户统计表 (user_stats)

```sql
CREATE TABLE user_stats (
    user_id BIGINT PRIMARY KEY COMMENT '关联用户ID',
    image_count INT DEFAULT 0 COMMENT '发布图片数',
    follower_count INT DEFAULT 0 COMMENT '粉丝数',
    following_count INT DEFAULT 0 COMMENT '关注数',
    total_likes INT DEFAULT 0 COMMENT '获赞总数',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户统计表';
```

**设计说明**:
- ✅ 冗余设计，避免高频COUNT查询
- ✅ 通过触发器或定时任务更新统计数据

#### 9. 分享链接表 (share_links)

```sql
CREATE TABLE share_links (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    short_code VARCHAR(10) NOT NULL UNIQUE COMMENT '短链接码(如ABC123)',
    target_type ENUM('IMAGE', 'USER', 'TAG') NOT NULL COMMENT '分享目标类型',
    target_id BIGINT NOT NULL COMMENT '目标ID',
    creator_id BIGINT COMMENT '创建者ID',
    visit_count INT DEFAULT 0 COMMENT '访问次数',
    install_count INT DEFAULT 0 COMMENT '带来的安装次数',
    share_platform VARCHAR(20) COMMENT '分享平台(wechat/weibo/qq)',
    create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expire_time DATETIME COMMENT '过期时间(可选)',
    FOREIGN KEY (creator_id) REFERENCES users(id) ON DELETE SET NULL,
    INDEX idx_short_code (short_code),
    INDEX idx_target (target_type, target_id),
    INDEX idx_creator (creator_id),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='分享链接表';
```

**设计说明**:
- ✅ `short_code`使用Base62编码(0-9/A-Z/a-z)，8位可支持62^8≈218万亿条记录
- ✅ `target_type`支持多种分享对象(图片/用户/标签)，扩展性强
- ✅ `visit_count`和`install_count`用于数据分析和运营优化
- ✅ `expire_time`支持临时分享链接(如活动专属链接)

### ER图

```mermaid
erDiagram
    users ||--o{ images : "发布"
    users ||--o{ likes : "点赞"
    users ||--o{ favorites : "收藏"
    users ||--o{ follows : "关注者"
    users ||--o{ follows : "被关注"
    users ||--|| user_stats : "统计"
    users ||--o{ share_links : "创建"

    images ||--o{ image_tags : "标签"
    images ||--o{ likes : "被点赞"
    images ||--o{ favorites : "被收藏"
    images ||--o{ share_links : "被分享"

    tags ||--o{ image_tags : "图片"

    users {
        bigint id PK
        varchar user_id UK
        varchar username UK
        varchar password_hash
        varchar email UK
        varchar phone UK
        varchar avatar_url
        varchar bio
        enum status
    }

    images {
        bigint id PK
        varchar image_id UK
        bigint user_id FK
        varchar title
        text description
        varchar file_url
        varchar thumbnail_url
        int like_count
        int favorite_count
        int view_count
        enum status
    }

    tags {
        bigint id PK
        varchar name UK
        int use_count
    }

    likes {
        bigint id PK
        bigint user_id FK
        bigint image_id FK
        datetime create_time
    }

    favorites {
        bigint id PK
        bigint user_id FK
        bigint image_id FK
        datetime create_time
    }

    follows {
        bigint id PK
        bigint follower_id FK
        bigint followed_id FK
        datetime create_time
    }

    user_stats {
        bigint user_id PK_FK
        int image_count
        int follower_count
        int following_count
        int total_likes
    }

    share_links {
        bigint id PK
        varchar short_code UK
        enum target_type
        bigint target_id
        bigint creator_id FK
        int visit_count
        int install_count
        varchar share_platform
        datetime expire_time
    }
```

---

## 五、API接口设计

### 接口规范

**请求格式**:
- 协议: HTTP/HTTPS
- 认证: JWT Bearer Token (除注册/登录外所有接口需要)
- Content-Type: `application/json`

**响应格式**:
```json
{
  "success": true,
  "message": "操作成功",
  "data": { ... },
  "timestamp": 1696147200
}
```

**错误码**:
| Code | 说明 |
|------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未认证 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

### API清单

#### 1. 用户认证接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 注册 | POST | `/api/v1/auth/register` | 用户注册 |
| 登录 | POST | `/api/v1/auth/login` | 用户登录 |
| 刷新令牌 | POST | `/api/v1/auth/refresh` | 刷新Token |
| 获取用户信息 | GET | `/api/v1/auth/me` | 获取当前用户 |
| 更新用户资料 | PUT | `/api/v1/auth/profile` | 编辑头像/简介 |

**示例: 注册接口**
```http
POST /api/v1/auth/register
Content-Type: application/json

{
  "username": "john_doe",
  "email": "john@example.com",
  "password": "SecurePass123"
}

// 响应
{
  "success": true,
  "data": {
    "user_id": "USR_2025_ABC123",
    "username": "john_doe",
    "access_token": "eyJhbGciOiJIUzI1NiIs...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIs..."
  }
}
```

#### 2. 图片管理接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 上传图片 | POST | `/api/v1/images` | 上传图片 |
| 获取图片详情 | GET | `/api/v1/images/:id` | 图片详情 |
| 编辑图片 | PUT | `/api/v1/images/:id` | 编辑标题/描述/标签 |
| 删除图片 | DELETE | `/api/v1/images/:id` | 删除图片 |
| 用户图片列表 | GET | `/api/v1/users/:id/images` | 某用户的图片 |

**示例: 上传图片**
```http
POST /api/v1/images
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
Content-Type: multipart/form-data

{
  "image": <binary>,
  "title": "日落",
  "description": "今天在海边拍的",
  "tags": ["风景", "日落", "大海"]
}

// 响应
{
  "success": true,
  "data": {
    "image_id": "IMG_2025_XYZ789",
    "file_url": "https://cdn.knot.com/images/abc123.jpg",
    "thumbnail_url": "https://cdn.knot.com/thumbs/abc123.jpg"
  }
}
```

#### 3. Feed流接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 推荐Feed | GET | `/api/v1/feed` | 首页推荐 |
| 关注Feed | GET | `/api/v1/feed/following` | 关注用户的图片 |
| 搜索图片 | GET | `/api/v1/search?tag=风景` | 按标签搜索 |
| 热门标签 | GET | `/api/v1/tags/trending` | 热门标签列表 |

**示例: 获取Feed**
```http
GET /api/v1/feed?page=1&limit=20
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...

// 响应
{
  "success": true,
  "data": {
    "images": [
      {
        "image_id": "IMG_2025_XYZ789",
        "title": "日落",
        "thumbnail_url": "https://cdn.knot.com/thumbs/abc123.jpg",
        "user": {
          "user_id": "USR_2025_ABC123",
          "username": "john_doe",
          "avatar_url": "https://cdn.knot.com/avatars/123.jpg"
        },
        "like_count": 42,
        "favorite_count": 15,
        "tags": ["风景", "日落"]
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 1000,
      "has_more": true
    }
  }
}
```

#### 4. 互动接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 点赞 | POST | `/api/v1/images/:id/like` | 点赞图片 |
| 取消点赞 | DELETE | `/api/v1/images/:id/like` | 取消点赞 |
| 收藏 | POST | `/api/v1/images/:id/favorite` | 收藏图片 |
| 取消收藏 | DELETE | `/api/v1/images/:id/favorite` | 取消收藏 |
| 关注用户 | POST | `/api/v1/users/:id/follow` | 关注 |
| 取消关注 | DELETE | `/api/v1/users/:id/follow` | 取关 |
| 我的点赞 | GET | `/api/v1/me/likes` | 我点赞的图片 |
| 我的收藏 | GET | `/api/v1/me/favorites` | 我的收藏 |
| 关注列表 | GET | `/api/v1/users/:id/following` | 关注的人 |
| 粉丝列表 | GET | `/api/v1/users/:id/followers` | 粉丝 |

#### 5. 分享接口

| 接口 | 方法 | 路径 | 说明 |
|------|------|------|------|
| 生成分享链接 | POST | `/api/v1/images/:id/share` | 创建分享短链接 |
| 解析分享链接 | GET | `/api/v1/share/:code` | 获取分享目标信息(公开) |
| 分享统计 | GET | `/api/v1/share/:code/stats` | 查看分享数据(仅创建者) |

**示例: 生成分享链接**
```http
POST /api/v1/images/IMG_2025_XYZ789/share
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
Content-Type: application/json

{
  "platform": "wechat"  // wechat/weibo/qq/copy_link
}

// 响应
{
  "success": true,
  "data": {
    "short_link": "https://knot.app/s/ABC123",
    "short_code": "ABC123",
    "qr_code_url": "https://api.knot.app/qrcode/ABC123.png",
    "expire_time": null
  }
}
```

**示例: 解析分享链接**
```http
GET /api/v1/share/ABC123
// 无需认证，公开接口

// 响应
{
  "success": true,
  "data": {
    "target_type": "IMAGE",
    "target_id": 12345,
    "image": {
      "image_id": "IMG_2025_XYZ789",
      "title": "日落",
      "description": "今天在海边拍的",
      "file_url": "https://cdn.knot.com/images/abc123.jpg",
      "thumbnail_url": "https://cdn.knot.com/thumbs/abc123.jpg",
      "user": {
        "user_id": "USR_2025_ABC123",
        "username": "john_doe",
        "avatar_url": "https://cdn.knot.com/avatars/123.jpg"
      },
      "like_count": 42,
      "favorite_count": 15,
      "tags": ["风景", "日落"]
    },
    "deep_link": {
      "ios": "knot://i/12345",
      "android": "knot://i/12345"
    }
  }
}
```

---

## 六、技术方案

### 1. 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| C++ | 17 | 高性能后端 |
| MySQL | 8.0+ | 主数据库 |
| cpp-httplib | 0.11.0 | HTTP服务器 |
| jwt-cpp | 0.6.0 | JWT认证 |
| JsonCpp | 1.9.5 | JSON处理 |
| OpenSSL | 1.1.1 | 密码哈希 |
| spdlog | 1.9.2 | 日志 |

### 2. 图片存储方案

**阶段1(MVP)**: 本地存储
- 原图: `/var/www/knot/images/original/`
- 缩略图: `/var/www/knot/images/thumbnails/`
- 通过Nginx提供静态文件服务

**阶段2(V1.1+)**: 对象存储
- 迁移到MinIO/阿里云OSS/腾讯云COS
- 使用CDN加速访问

### 3. 图片处理流程

```cpp
// 伪代码
class ImageProcessor {
public:
    ProcessedImage process(const RawImage& raw) {
        // 1. 验证格式
        validateFormat(raw);

        // 2. 压缩原图(质量80%)
        auto compressed = compress(raw, 0.8);

        // 3. 生成缩略图(300x300)
        auto thumbnail = generateThumbnail(compressed, 300, 300);

        // 4. 保存文件
        auto originalUrl = storage->save(compressed, "original");
        auto thumbnailUrl = storage->save(thumbnail, "thumbnails");

        return {originalUrl, thumbnailUrl};
    }
};
```

### 4. Feed推荐算法(MVP简化版)

**排序公式**:
```
热度分数 = (点赞数 * 0.7 + 收藏数 * 0.3)
时间衰减 = 1 / ((当前时间 - 发布时间小时数) + 2) ^ 1.5
最终分数 = 热度分数 * 时间衰减
```

**SQL实现**:
```sql
SELECT i.*
FROM images i
WHERE i.status = 'APPROVED'
ORDER BY
  (i.like_count * 0.7 + i.favorite_count * 0.3) /
  POW(TIMESTAMPDIFF(HOUR, i.create_time, NOW()) + 2, 1.5) DESC
LIMIT 20 OFFSET 0;
```

### 5. 分享链接Deep Link方案

#### 5.1 短链接生成算法

**技术选型**: 雪花算法 + Base62编码

```cpp
class ShareLinkGenerator {
private:
    const char* BASE62_CHARS =
        "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

public:
    // 生成短链接
    std::string generate(const std::string& targetType, int64_t targetId,
                        int64_t creatorId, const std::string& platform) {
        // 1. 生成雪花ID (保证全局唯一)
        int64_t snowflakeId = SnowflakeIdGenerator::getInstance().nextId();

        // 2. Base62编码 (取前8位)
        std::string shortCode = base62Encode(snowflakeId).substr(0, 8);

        // 3. 保存到数据库
        ShareLink link;
        link.shortCode = shortCode;
        link.targetType = targetType;
        link.targetId = targetId;
        link.creatorId = creatorId;
        link.sharePlatform = platform;
        repository->save(link);

        return "https://knot.app/s/" + shortCode;
    }

private:
    std::string base62Encode(int64_t num) {
        if (num == 0) return "0";

        std::string result;
        while (num > 0) {
            result = BASE62_CHARS[num % 62] + result;
            num /= 62;
        }
        return result;
    }
};
```

#### 5.2 Deep Link配置

**iOS Universal Links**:

服务器配置 `https://knot.app/.well-known/apple-app-site-association`:
```json
{
  "applinks": {
    "apps": [],
    "details": [{
      "appID": "TEAMID.com.knot.app",
      "paths": ["/s/*", "/i/*", "/u/*"]
    }]
  }
}
```

**Android App Links**:

服务器配置 `https://knot.app/.well-known/assetlinks.json`:
```json
[{
  "relation": ["delegate_permission/common.handle_all_urls"],
  "target": {
    "namespace": "android_app",
    "package_name": "com.knot.app",
    "sha256_cert_fingerprints": ["YOUR_CERT_FINGERPRINT"]
  }
}]
```

#### 5.3 H5落地页设计

**用途**: 未安装APP用户的引导页

**核心功能**:
1. 展示分享内容(图片预览+作者信息)
2. 智能唤起APP(已安装用户)
3. 下载引导(未安装用户)
4. OpenGraph标签(社交平台预览优化)

**技术实现**:
```html
<!DOCTYPE html>
<html>
<head>
    <meta property="og:title" content="日落 - Knot">
    <meta property="og:image" content="https://cdn.knot.com/thumbs/abc123.jpg">
    <meta property="og:description" content="今天在海边拍的">
</head>
<body>
    <script>
        // 智能唤起APP
        const ua = navigator.userAgent;
        const isIOS = /iPhone|iPad|iPod/i.test(ua);
        const isAndroid = /Android/i.test(ua);

        function openApp() {
            if (isIOS) {
                window.location.href = 'knot://s/ABC123';
                setTimeout(() => {
                    window.location.href = 'https://apps.apple.com/app/knot/id...';
                }, 2000);
            } else if (isAndroid) {
                window.location.href = 'knot://s/ABC123';
                setTimeout(() => {
                    window.location.href = 'https://play.google.com/store/apps/...';
                }, 2000);
            }
        }
    </script>
</body>
</html>
```

#### 5.4 社交平台快捷分享

**无需SDK方案** (URL Scheme):

```javascript
const shareUrls = {
    // 微博
    weibo: (link, title) =>
        `https://service.weibo.com/share/share.php?url=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}`,

    // QQ
    qq: (link, title) =>
        `mqqapi://share/to_fri?src_type=web&version=1&file_type=news&url=${encodeURIComponent(link)}&title=${encodeURIComponent(title)}`,

    // Twitter
    twitter: (link, title) =>
        `https://twitter.com/intent/tweet?url=${encodeURIComponent(link)}&text=${encodeURIComponent(title)}`,

    // 微信：复制链接+引导
    wechat: (link) => {
        navigator.clipboard.writeText(link);
        alert('链接已复制，请打开微信粘贴分享');
    }
};
```

#### 5.5 分享数据统计

**追踪指标**:
- 分享次数
- 点击次数 (visit_count)
- 转化次数 (install_count)
- 分享平台分布
- 最受欢迎内容

**分析SQL**:
```sql
-- 分享漏斗分析
SELECT
    share_platform AS 平台,
    COUNT(*) AS 分享次数,
    SUM(visit_count) AS 点击次数,
    SUM(install_count) AS 带来安装,
    ROUND(SUM(install_count) * 100.0 / NULLIF(SUM(visit_count), 0), 2) AS 转化率
FROM share_links
WHERE create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY share_platform
ORDER BY 分享次数 DESC;
```

---

## 七、性能指标

### MVP性能目标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 并发用户数 | 100+ | 同时在线用户 |
| API响应时间 | <100ms | P95 |
| 图片上传时间 | <3s | 5MB图片 |
| Feed加载时间 | <500ms | 首屏20张图 |
| 数据库QPS | 500+ | 查询每秒 |

---

## 八、开发计划

### 迁移工作量估算

| 阶段 | 任务 | 工作量 |
|------|------|--------|
| 阶段1 | 清理停车位模块 | 0.5天 |
| 阶段2 | 精简用户模块 | 1天 |
| 阶段3 | 实现图片模块 | 3天 |
| 阶段4 | 实现互动模块(点赞/收藏/关注) | 2天 |
| 阶段5 | 实现分享功能(短链接+Deep Link) | 1.5天 |
| 阶段6 | 实现Feed流推荐 | 1天 |
| 阶段7 | H5落地页开发 | 0.5天 |
| 阶段8 | 测试与优化 | 1天 |
| **总计** | | **10.5天** |

### 里程碑

- **Week 1**: 完成数据库设计+用户模块迁移
- **Week 2**: 完成图片上传+浏览功能+分享系统
- **Week 3**: 完成互动系统+Feed推荐+H5落地页
- **Week 4**: 测试+优化+上线

---

## 九、后续版本规划

### V1.1 (MVP+1个月)
- ✅ 评论系统
- ✅ 通知中心
- ✅ 内容审核(接入第三方API)
- ✅ 第三方分享SDK(微信SDK/微博SDK)
- ✅ 分享海报生成(带二维码)

### V1.2 (MVP+3个月)
- ✅ 图片编辑器(滤镜/裁剪)
- ✅ 第三方登录(微信/QQ)
- ✅ 邀请码系统(分享赚积分)

### V2.0 (MVP+6个月)
- ✅ 话题挑战
- ✅ 创作者激励计划
- ✅ 广告系统

---

## 十、附录

### A. 数据库完整建表SQL

见 `database/init.sql` 文件

### B. 与原需求对比

| 维度 | 原需求 | MVP版本 | 变化 |
|------|--------|---------|------|
| 数据表数量 | 14张 | 9张 | -36% |
| 核心功能 | 9个模块 | 4个模块(含分享) | 聚焦核心 |
| 开发周期 | ~4周 | ~2.5周 | 快速验证 |
| 复杂度 | 高 | 中 | 降低风险 |

### C. 可复用资源

**100%复用**:
- 安全层(JWT/密码哈希)
- 基础设施(连接池/日志/配置)
- HTTP服务器

**90%复用**:
- 用户管理模块

**全新开发**:
- 图片管理+互动+Feed

---

**文档版本**: v1.0.0
**最后更新**: 2025-10-07
**维护者**: Knot Team
