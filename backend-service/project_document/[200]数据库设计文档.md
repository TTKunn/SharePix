# 数据库设计文档

**文档编号**: [200]
**创建时间**: 2025-10-02
**版本**: v1.1.0
**状态**: 正式版

---

## 📋 目录

1. [数据库概述](#数据库概述)
2. [users表设计](#users表设计)
3. [parking_spaces表设计](#parking_spaces表设计)
4. [表关系设计](#表关系设计)
5. [索引设计](#索引设计)
6. [数据完整性](#数据完整性)

---

## 数据库概述

### 基本信息

| 项目 | 值 |
|------|-----|
| 数据库名称 | shared_parking |
| 数据库引擎 | InnoDB |
| 字符集 | utf8mb4 |
| 排序规则 | utf8mb4_general_ci |
| MySQL版本 | 8.0.43 |

### 表清单

| 表名 | 说明 | 状态 |
|------|------|------|
| users | 用户信息表 | ✅ 已实现 |
| parking_spaces | 停车位信息表 | ✅ 已实现 |
| bookings | 预订信息表 | ⏳ 规划中 |
| payments | 支付信息表 | ⏳ 规划中 |
| reviews | 评价信息表 | ⏳ 规划中 |

---

## users表设计

### 表结构

```sql
CREATE TABLE users (
    -- 主键和标识
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '物理ID',
    user_id VARCHAR(50) NOT NULL UNIQUE COMMENT '逻辑ID',
    
    -- 登录信息
    username VARCHAR(50) NOT NULL UNIQUE COMMENT '用户名',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    salt VARCHAR(64) NOT NULL COMMENT '盐值',
    
    -- 基本信息
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名',
    phone VARCHAR(20) NOT NULL UNIQUE COMMENT '手机号',
    email VARCHAR(100) DEFAULT NULL COMMENT '邮箱',
    
    -- 角色和状态
    role ENUM('owner', 'driver', 'both') DEFAULT 'driver' COMMENT '角色',
    status ENUM('active', 'inactive', 'banned') DEFAULT 'active' COMMENT '状态',
    
    -- 扩展信息
    avatar_url VARCHAR(255) DEFAULT NULL COMMENT '头像URL',
    device_count INT DEFAULT 0 COMMENT '设备数量',
    
    -- 时间戳
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    -- 索引
    INDEX idx_user_id (user_id),
    INDEX idx_username (username),
    INDEX idx_phone (phone),
    INDEX idx_email (email),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户信息表';
```

### 字段说明

#### 主键和标识字段

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 物理ID | 1, 2, 3 |
| user_id | VARCHAR(50) | NOT NULL, UNIQUE | 逻辑ID | USR_2025Q1_A1B2C3 |

**user_id生成规则**:
```
格式: USR_YYYYQX_XXXXXX
- USR: User的缩写
- YYYY: 年份（2025）
- QX: 季度（Q1-Q4）
- XXXXXX: 6位随机字符（大写字母+数字）
```

#### 登录信息字段

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| username | VARCHAR(50) | NOT NULL, UNIQUE | 用户名（3-50字符） |
| password_hash | VARCHAR(255) | NOT NULL | PBKDF2-HMAC-SHA256哈希 |
| salt | VARCHAR(64) | NOT NULL | 16字节盐值（Base64编码） |

#### 基本信息字段

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| real_name | VARCHAR(50) | NOT NULL | 真实姓名 |
| phone | VARCHAR(20) | NOT NULL, UNIQUE | 11位中国手机号 |
| email | VARCHAR(100) | DEFAULT NULL | 邮箱（可选） |

#### 角色和状态字段

| 字段名 | 类型 | 可选值 | 默认值 | 说明 |
|--------|------|--------|--------|------|
| role | ENUM | owner, driver, both | driver | 用户角色 |
| status | ENUM | active, inactive, banned | active | 账户状态 |

**角色说明**:
- `owner`: 车位所有者
- `driver`: 租客
- `both`: 既是车主又是租客

**状态说明**:
- `active`: 正常
- `inactive`: 未激活
- `banned`: 已封禁

#### 扩展信息字段

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| avatar_url | VARCHAR(255) | DEFAULT NULL | 头像URL |
| device_count | INT | DEFAULT 0 | 登录设备数量 |

#### 时间戳字段

| 字段名 | 类型 | 说明 | 自动更新 |
|--------|------|------|----------|
| create_time | TIMESTAMP | 创建时间 | 插入时自动 |
| update_time | TIMESTAMP | 更新时间 | 更新时自动 |

### 索引设计

| 索引名 | 字段 | 类型 | 用途 |
|--------|------|------|------|
| PRIMARY | id | 主键 | 唯一标识 |
| UNIQUE | user_id | 唯一索引 | 逻辑ID查询 |
| UNIQUE | username | 唯一索引 | 用户名查询、登录 |
| UNIQUE | phone | 唯一索引 | 手机号查询、登录 |
| INDEX | email | 普通索引 | 邮箱查询、登录 |
| INDEX | create_time | 普通索引 | 时间范围查询 |

---

## parking_spaces表设计

### 表结构

```sql
CREATE TABLE parking_spaces (
    -- 主键和标识
    id INT AUTO_INCREMENT PRIMARY KEY COMMENT '物理ID',
    space_id VARCHAR(50) NOT NULL UNIQUE COMMENT '逻辑ID',
    owner_id INT NOT NULL COMMENT '车位所有者ID',
    
    -- 基本信息
    space_number VARCHAR(50) NOT NULL COMMENT '停车位编号',
    location VARCHAR(255) NOT NULL COMMENT '停车位位置描述',
    latitude DECIMAL(10, 8) DEFAULT NULL COMMENT '纬度',
    longitude DECIMAL(11, 8) DEFAULT NULL COMMENT '经度',
    
    -- 价格和状态
    price_per_hour DECIMAL(10, 2) NOT NULL COMMENT '每小时价格（元）',
    status ENUM('available', 'occupied', 'maintenance', 'disabled') 
        DEFAULT 'available' COMMENT '停车位状态',
    
    -- 详细信息
    description TEXT DEFAULT NULL COMMENT '停车位描述',
    facilities JSON DEFAULT NULL COMMENT '设施列表',
    images JSON DEFAULT NULL COMMENT '图片URL列表',
    
    -- 时间戳
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    -- 外键约束
    FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE,
    
    -- 索引
    INDEX idx_space_id (space_id),
    INDEX idx_owner_id (owner_id),
    INDEX idx_status (status),
    INDEX idx_location (latitude, longitude),
    INDEX idx_create_time (create_time)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='停车位信息表';
```

### 字段说明

#### 主键和标识字段

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 物理ID | 1, 2, 3 |
| space_id | VARCHAR(50) | NOT NULL, UNIQUE | 逻辑ID | SPC_2025Q4_ABC123 |
| owner_id | INT | NOT NULL, FOREIGN KEY | 车主ID | 1 |

**space_id生成规则**:
```
格式: SPC_YYYYQX_XXXXXX
- SPC: Space的缩写
- YYYY: 年份（2025）
- QX: 季度（Q1-Q4）
- XXXXXX: 6位随机字符（大写字母+数字）
```

#### 基本信息字段

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| space_number | VARCHAR(50) | NOT NULL | 停车位编号 | "A-101" |
| location | VARCHAR(255) | NOT NULL | 位置描述 | "北京市朝阳区xxx小区" |
| latitude | DECIMAL(10,8) | DEFAULT NULL | 纬度（-90到90） | 39.9042 |
| longitude | DECIMAL(11,8) | DEFAULT NULL | 经度（-180到180） | 116.4074 |

#### 价格和状态字段

| 字段名 | 类型 | 可选值 | 默认值 | 说明 |
|--------|------|--------|--------|------|
| price_per_hour | DECIMAL(10,2) | - | - | 每小时价格 |
| status | ENUM | available, occupied, maintenance, disabled | available | 停车位状态 |

**状态说明**:
- `available`: 可用
- `occupied`: 已占用
- `maintenance`: 维护中
- `disabled`: 已禁用

#### 详细信息字段

| 字段名 | 类型 | 约束 | 说明 | 示例 |
|--------|------|------|------|------|
| description | TEXT | DEFAULT NULL | 停车位描述 | "地下车库，靠近电梯" |
| facilities | JSON | DEFAULT NULL | 设施列表 | ["充电桩", "监控"] |
| images | JSON | DEFAULT NULL | 图片URL列表 | ["http://..."] |

#### 时间戳字段

| 字段名 | 类型 | 说明 | 自动更新 |
|--------|------|------|----------|
| create_time | TIMESTAMP | 创建时间 | 插入时自动 |
| update_time | TIMESTAMP | 更新时间 | 更新时自动 |

### 索引设计

| 索引名 | 字段 | 类型 | 用途 |
|--------|------|------|------|
| PRIMARY | id | 主键 | 唯一标识 |
| UNIQUE | space_id | 唯一索引 | 逻辑ID查询 |
| INDEX | owner_id | 普通索引 | 按车主查询 |
| INDEX | status | 普通索引 | 按状态查询 |
| INDEX | (latitude, longitude) | 复合索引 | 地理位置查询 |
| INDEX | create_time | 普通索引 | 时间范围查询 |

---

## 表关系设计

### ER图

```
┌─────────────────┐
│     users       │
│─────────────────│
│ id (PK)         │
│ user_id (UK)    │
│ username (UK)   │
│ phone (UK)      │
│ ...             │
└─────────────────┘
        │
        │ 1
        │
        │ owns
        │
        │ N
        ▼
┌─────────────────┐
│ parking_spaces  │
│─────────────────│
│ id (PK)         │
│ space_id (UK)   │
│ owner_id (FK)   │◄─── FOREIGN KEY
│ ...             │
└─────────────────┘
```

### 关系说明

#### users ↔ parking_spaces (1:N)

**关系类型**: 一对多

**说明**:
- 一个用户可以拥有多个停车位
- 一个停车位只能属于一个用户

**外键约束**:
```sql
FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
```

**级联删除**:
- 当用户被删除时，其所有停车位也会被级联删除
- 保证数据一致性

---

## 索引设计

### 索引策略

#### 1. 主键索引
- 每个表都有自增主键
- 用于唯一标识记录
- 自动创建聚簇索引

#### 2. 唯一索引
- 用于保证字段唯一性
- 用于高频查询字段
- 示例: user_id, username, phone, space_id

#### 3. 普通索引
- 用于提高查询性能
- 用于WHERE、JOIN、ORDER BY字段
- 示例: owner_id, status, create_time

#### 4. 复合索引
- 用于多字段联合查询
- 遵循最左前缀原则
- 示例: (latitude, longitude)

### 索引优化建议

#### users表
```sql
-- 登录查询优化
INDEX idx_username (username)  -- 用户名登录
INDEX idx_phone (phone)        -- 手机号登录
INDEX idx_email (email)        -- 邮箱登录

-- 时间范围查询优化
INDEX idx_create_time (create_time)
```

#### parking_spaces表
```sql
-- 车主查询优化
INDEX idx_owner_id (owner_id)

-- 状态筛选优化
INDEX idx_status (status)

-- 地理位置查询优化
INDEX idx_location (latitude, longitude)

-- 时间范围查询优化
INDEX idx_create_time (create_time)
```

---

## 数据完整性

### 主键约束

**作用**: 保证记录唯一性

**实现**:
- users表: id (AUTO_INCREMENT)
- parking_spaces表: id (AUTO_INCREMENT)

### 唯一约束

**作用**: 保证字段唯一性

**实现**:
- users表: user_id, username, phone
- parking_spaces表: space_id

### 外键约束

**作用**: 保证引用完整性

**实现**:
```sql
-- parking_spaces.owner_id → users.id
FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
```

**级联操作**:
- ON DELETE CASCADE: 删除用户时级联删除其停车位
- 保证数据一致性

### 非空约束

**作用**: 保证必填字段不为空

**实现**:
- users表: username, password_hash, salt, real_name, phone
- parking_spaces表: space_id, owner_id, space_number, location, price_per_hour

### 默认值约束

**作用**: 为字段提供默认值

**实现**:
- users表: role='driver', status='active', device_count=0
- parking_spaces表: status='available'

### 枚举约束

**作用**: 限制字段取值范围

**实现**:
- users.role: owner, driver, both
- users.status: active, inactive, banned
- parking_spaces.status: available, occupied, maintenance, disabled

---

## 📝 总结

### 设计原则

1. **规范化**: 符合第三范式，减少数据冗余
2. **完整性**: 主键、外键、唯一约束保证数据完整性
3. **性能**: 合理的索引设计提高查询性能
4. **扩展性**: 预留扩展字段，便于未来功能扩展
5. **安全性**: 密码加密存储，敏感信息保护

### 技术特点

- ✅ InnoDB引擎支持事务
- ✅ utf8mb4字符集支持emoji
- ✅ 外键约束保证引用完整性
- ✅ 索引优化提高查询性能
- ✅ 时间戳自动更新

### 未来扩展

**规划中的表**:
- bookings: 预订信息表
- payments: 支付信息表
- reviews: 评价信息表
- notifications: 通知信息表

---

**文档版本**: v1.1.0
**最后更新**: 2025-10-02
**维护者**: Shared Parking Team

