# [006] ä¹å±‚æ¶æ„è¯¦è§£ - ä»¥åˆ›å»ºå¸–å­APIä¸ºä¾‹

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-20  
**é€‚ç”¨ç‰ˆæœ¬**: v2.7.0+  
**ä½œè€…**: Knot Team  
**ç›®æ ‡è¯»è€…**: é¡¹ç›®æ–°æˆå‘˜ã€åç«¯å¼€å‘å·¥ç¨‹å¸ˆ

---

## ğŸ“‹ æ–‡æ¡£ç›®å½•

1. [æ–‡æ¡£æ¦‚è¿°](#1-æ–‡æ¡£æ¦‚è¿°)
2. [ä¹å±‚æ¶æ„å…¨æ™¯å›¾](#2-ä¹å±‚æ¶æ„å…¨æ™¯å›¾)
3. [åˆ›å»ºå¸–å­APIå®Œæ•´æµç¨‹](#3-åˆ›å»ºå¸–å­apiå®Œæ•´æµç¨‹)
4. [ç¬¬1å±‚ï¼šå®¢æˆ·ç«¯å±‚](#4-ç¬¬1å±‚å®¢æˆ·ç«¯å±‚)
5. [ç¬¬2å±‚ï¼šHTTPæœåŠ¡å™¨å±‚](#5-ç¬¬2å±‚httpæœåŠ¡å™¨å±‚)
6. [ç¬¬3å±‚ï¼šAPIæ¥å£å±‚](#6-ç¬¬3å±‚apiæ¥å£å±‚)
7. [ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚](#7-ç¬¬4å±‚ä¸šåŠ¡é€»è¾‘å±‚)
8. [ç¬¬5å±‚ï¼šæ•°æ®è®¿é—®å±‚](#8-ç¬¬5å±‚æ•°æ®è®¿é—®å±‚)
9. [ç¬¬6å±‚ï¼šå®‰å…¨å±‚](#9-ç¬¬6å±‚å®‰å…¨å±‚)
10. [ç¬¬7å±‚ï¼šåŸºç¡€è®¾æ–½å±‚](#10-ç¬¬7å±‚åŸºç¡€è®¾æ–½å±‚)
11. [ç¬¬8å±‚ï¼šæ•°æ®æ¨¡å‹å±‚](#11-ç¬¬8å±‚æ•°æ®æ¨¡å‹å±‚)
12. [ç¬¬9å±‚ï¼šæ•°æ®åº“å±‚](#12-ç¬¬9å±‚æ•°æ®åº“å±‚)
13. [å…³é”®è®¾è®¡æ¨¡å¼](#13-å…³é”®è®¾è®¡æ¨¡å¼)
14. [æ€§èƒ½æŒ‡æ ‡ä¸ä¼˜åŒ–](#14-æ€§èƒ½æŒ‡æ ‡ä¸ä¼˜åŒ–)
15. [å¸¸è§é—®é¢˜FAQ](#15-å¸¸è§é—®é¢˜faq)

---

## 1. æ–‡æ¡£æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®çš„

æœ¬æ–‡æ¡£æ—¨åœ¨å¸®åŠ©é¡¹ç›®æ–°æˆå‘˜ï¼š
- **å¿«é€Ÿç†è§£**ï¼šæŒæ¡Knoté¡¹ç›®çš„ä¹å±‚æ¶æ„è®¾è®¡ç†å¿µ
- **å®æˆ˜å­¦ä¹ **ï¼šé€šè¿‡åˆ›å»ºå¸–å­APIçš„å®Œæ•´æµç¨‹ï¼Œå­¦ä¹ ä»£ç å®ç°ç»†èŠ‚
- **æœ€ä½³å®è·µ**ï¼šäº†è§£ä¼ä¸šçº§C++åç«¯å¼€å‘çš„è®¾è®¡æ¨¡å¼å’Œç¼–ç è§„èŒƒ
- **é—®é¢˜æ’æŸ¥**ï¼šæŒæ¡è°ƒè¯•å’Œé—®é¢˜å®šä½çš„æ–¹æ³•

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©åˆ›å»ºå¸–å­API

åˆ›å»ºå¸–å­ï¼ˆ`POST /api/v1/posts`ï¼‰æ˜¯Knoté¡¹ç›®ä¸­æœ€å¤æ‚çš„APIä¹‹ä¸€ï¼Œå®ƒåŒ…å«äº†ï¼š

âœ… **JWTèº«ä»½éªŒè¯** - å®‰å…¨å±‚çš„ä½¿ç”¨  
âœ… **æ–‡ä»¶ä¸Šä¼ å¤„ç†** - multipart/JSONä¸¤ç§æ ¼å¼æ”¯æŒ  
âœ… **å›¾ç‰‡å‹ç¼©å’Œç¼©ç•¥å›¾ç”Ÿæˆ** - åŸºç¡€è®¾æ–½å±‚çš„å›¾ç‰‡å¤„ç†  
âœ… **æ•°æ®åº“äº‹åŠ¡** - å¤šè¡¨æ“ä½œçš„ä¸€è‡´æ€§ä¿è¯  
âœ… **ä¸šåŠ¡è§„åˆ™éªŒè¯** - 1-9å¼ å›¾ç‰‡çš„ä¸šåŠ¡çº¦æŸ  
âœ… **æ‰¹é‡æ•°æ®å¤„ç†** - å›¾ç‰‡å’Œæ ‡ç­¾çš„æ‰¹é‡æ’å…¥  
âœ… **é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•** - å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶  

é€šè¿‡è¿™ä¸ªAPIï¼Œä½ å¯ä»¥å­¦ä¹ åˆ°é¡¹ç›®ä¸­90%çš„æ ¸å¿ƒæŠ€æœ¯ç‚¹ã€‚

### 1.3 å‰ç½®çŸ¥è¯†è¦æ±‚

é˜…è¯»æœ¬æ–‡æ¡£å‰ï¼Œå»ºè®®ä½ å·²ç»äº†è§£ï¼š
- C++11/14/17åŸºç¡€è¯­æ³•ï¼ˆæ™ºèƒ½æŒ‡é’ˆã€lambdaã€RAIIï¼‰
- HTTPåè®®åŸºç¡€ï¼ˆè¯·æ±‚æ–¹æ³•ã€çŠ¶æ€ç ã€Content-Typeï¼‰
- MySQLåŸºç¡€ï¼ˆCRUDæ“ä½œã€ç´¢å¼•ã€å¤–é”®ï¼‰
- JSONæ•°æ®æ ¼å¼

**ä¸éœ€è¦**æŒæ¡çš„å†…å®¹ï¼ˆæ–‡æ¡£ä¼šè¯¦ç»†è®²è§£ï¼‰ï¼š
- cpp-httplibåº“çš„ä½¿ç”¨
- MySQL C APIçš„ä½¿ç”¨
- JWTä»¤ç‰Œçš„ç”Ÿæˆå’ŒéªŒè¯
- å›¾ç‰‡å¤„ç†ç®—æ³•

---

## 2. ä¹å±‚æ¶æ„å…¨æ™¯å›¾

### 2.1 æ¶æ„å±‚æ¬¡å›¾

**æ–‡æœ¬ç‰ˆæœ¬**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬1å±‚ï¼šå®¢æˆ·ç«¯å±‚ï¼ˆHTTP Clientï¼‰                                    â”‚
â”‚ - HarmonyOS App, iOS App, Android App, Web Browser             â”‚
â”‚ - å‘é€HTTPè¯·æ±‚ï¼Œæ¥æ”¶JSONå“åº”                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ HTTP Request (multipart/JSON)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬2å±‚ï¼šHTTPæœåŠ¡å™¨å±‚ï¼ˆsrc/server/http_server.cppï¼‰                 â”‚
â”‚ - æŠ€æœ¯æ ˆï¼šcpp-httplib 0.11.0                                     â”‚
â”‚ - åŠŸèƒ½ï¼šè·¯ç”±åˆ†å‘ã€çº¿ç¨‹æ± ç®¡ç†ã€è¿æ¥ç®¡ç†                              â”‚
â”‚ - é…ç½®ï¼šç›‘å¬0.0.0.0:8080ï¼Œ32çº¿ç¨‹ï¼Œ128è¿æ¥                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ è·¯ç”±åˆ°Handler
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬3å±‚ï¼šAPIæ¥å£å±‚ï¼ˆsrc/api/post_handler.cppï¼‰                      â”‚
â”‚ - åŠŸèƒ½ï¼šè§£æHTTPè¯·æ±‚ã€JWTéªŒè¯ã€å‚æ•°éªŒè¯ã€å“åº”å°è£…                   â”‚
â”‚ - èŒè´£ï¼šåè®®è½¬æ¢ï¼ˆHTTP â†’ ä¸šåŠ¡å¯¹è±¡ï¼‰                                â”‚
â”‚ - å…³é”®ç±»ï¼šPostHandler, BaseHandler                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ è°ƒç”¨Service
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚ï¼ˆsrc/core/post_service.cppï¼‰                    â”‚
â”‚ - åŠŸèƒ½ï¼šä¸šåŠ¡è§„åˆ™éªŒè¯ã€æµç¨‹ç¼–æ’ã€äº‹åŠ¡åè°ƒ                            â”‚
â”‚ - èŒè´£ï¼šå°è£…å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒå¤šä¸ªRepository                       â”‚
â”‚ - å…³é”®ç±»ï¼šPostService, ImageService                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ è°ƒç”¨Repository
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬5å±‚ï¼šæ•°æ®è®¿é—®å±‚ï¼ˆsrc/database/post_repository.cppï¼‰             â”‚
â”‚ - åŠŸèƒ½ï¼šSQLé¢„ç¼–è¯‘è¯­å¥ã€CRUDæ“ä½œã€è¿æ¥ç®¡ç†                          â”‚
â”‚ - èŒè´£ï¼šæ•°æ®æŒä¹…åŒ–ï¼Œå±è”½æ•°æ®åº“ç»†èŠ‚                                 â”‚
â”‚ - å…³é”®ç±»ï¼šPostRepository, ImageRepository, TagRepository         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ å®‰å…¨æ£€æŸ¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬6å±‚ï¼šå®‰å…¨å±‚ï¼ˆsrc/security/ï¼‰                                    â”‚
â”‚ - JWTManagerï¼šä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯ï¼ˆjwt-cpp 0.6.0ï¼‰                     â”‚
â”‚ - PasswordHasherï¼šPBKDF2-HMAC-SHA256å“ˆå¸Œï¼ˆOpenSSL 1.1.1ï¼‰        â”‚
â”‚ - èŒè´£ï¼šèº«ä»½è®¤è¯ã€æˆæƒã€æ•°æ®åŠ å¯†                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ åŸºç¡€è®¾æ–½æ”¯æŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬7å±‚ï¼šåŸºç¡€è®¾æ–½å±‚ï¼ˆsrc/database/, src/utils/ï¼‰                    â”‚
â”‚ - ConnectionPoolï¼šæ•°æ®åº“è¿æ¥æ± ï¼ˆ10è¿æ¥ï¼Œå¯é…ç½®ï¼‰                   â”‚
â”‚ - Loggerï¼šspdlogæ—¥å¿—ç³»ç»Ÿï¼ˆæ–‡ä»¶+æ§åˆ¶å°ï¼‰                           â”‚
â”‚ - ConfigManagerï¼šé…ç½®æ–‡ä»¶ç®¡ç†ï¼ˆconfig.jsonï¼‰                      â”‚
â”‚ - ImageProcessorï¼šSTBå›¾ç‰‡å¤„ç†ï¼ˆå‹ç¼©ã€ç¼©ç•¥å›¾ã€æ ¼å¼è½¬æ¢ï¼‰             â”‚
â”‚ - Base64Decoderï¼šBase64ç¼–è§£ç                                     â”‚
â”‚ - UrlHelperï¼šURLæ‹¼æ¥å’Œå¤„ç†                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ æ•°æ®æ¨¡å‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬8å±‚ï¼šæ•°æ®æ¨¡å‹å±‚ï¼ˆsrc/models/ï¼‰                                  â”‚
â”‚ - Postï¼šå¸–å­ä¸šåŠ¡å®ä½“ï¼ˆåŒ…å«å›¾ç‰‡åˆ—è¡¨ï¼‰                               â”‚
â”‚ - Imageï¼šå›¾ç‰‡ä¸šåŠ¡å®ä½“                                            â”‚
â”‚ - Userï¼šç”¨æˆ·ä¸šåŠ¡å®ä½“                                             â”‚
â”‚ - Tagï¼šæ ‡ç­¾ä¸šåŠ¡å®ä½“                                              â”‚
â”‚ - åŠŸèƒ½ï¼štoJson()/fromJson()ã€æ•°æ®éªŒè¯ã€ä¸šåŠ¡é€»è¾‘å°è£…               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“ æŒä¹…åŒ–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬9å±‚ï¼šæ•°æ®åº“å±‚ï¼ˆMySQL 8.0ï¼‰                                      â”‚
â”‚ - postsï¼šå¸–å­ä¿¡æ¯ï¼ˆä¸»è¡¨ï¼‰                                         â”‚
â”‚ - imagesï¼šå›¾ç‰‡ä¿¡æ¯ï¼ˆå¤–é”®post_idï¼Œçº§è”åˆ é™¤ï¼‰                        â”‚
â”‚ - usersï¼šç”¨æˆ·ä¿¡æ¯                                                â”‚
â”‚ - tags, post_tagsï¼šæ ‡ç­¾ç³»ç»Ÿ                                      â”‚
â”‚ - share_linksï¼šåˆ†äº«é“¾æ¥                                          â”‚
â”‚ - likes, favorites, followsï¼šäº’åŠ¨ç³»ç»Ÿ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Mermaidç‰ˆæœ¬**ï¼ˆæ”¯æŒMermaidçš„ç¯å¢ƒå¯æ¸²æŸ“ï¼‰ï¼š

```mermaid
flowchart TD
    L1["ç¬¬1å±‚ï¼šå®¢æˆ·ç«¯å±‚ï¼ˆHTTP Clientï¼‰<br/>- HarmonyOS App, iOS App, Android App, Web Browser<br/>- å‘é€HTTPè¯·æ±‚ï¼Œæ¥æ”¶JSONå“åº”"]
    L2["ç¬¬2å±‚ï¼šHTTPæœåŠ¡å™¨å±‚ï¼ˆsrc/server/http_server.cppï¼‰<br/>- æŠ€æœ¯æ ˆï¼šcpp-httplib 0.11.0<br/>- åŠŸèƒ½ï¼šè·¯ç”±åˆ†å‘ã€çº¿ç¨‹æ± ç®¡ç†ã€è¿æ¥ç®¡ç†<br/>- é…ç½®ï¼šç›‘å¬0.0.0.0:8080ï¼Œ32çº¿ç¨‹ï¼Œ128è¿æ¥"]
    L3["ç¬¬3å±‚ï¼šAPIæ¥å£å±‚ï¼ˆsrc/api/post_handler.cppï¼‰<br/>- åŠŸèƒ½ï¼šè§£æHTTPè¯·æ±‚ã€JWTéªŒè¯ã€å‚æ•°éªŒè¯ã€å“åº”å°è£…<br/>- èŒè´£ï¼šåè®®è½¬æ¢ï¼ˆHTTP â†’ ä¸šåŠ¡å¯¹è±¡ï¼‰<br/>- å…³é”®ç±»ï¼šPostHandler, BaseHandler"]
    L4["ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚ï¼ˆsrc/core/post_service.cppï¼‰<br/>- åŠŸèƒ½ï¼šä¸šåŠ¡è§„åˆ™éªŒè¯ã€æµç¨‹ç¼–æ’ã€äº‹åŠ¡åè°ƒ<br/>- èŒè´£ï¼šå°è£…å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œåè°ƒå¤šä¸ªRepository<br/>- å…³é”®ç±»ï¼šPostService, ImageService"]
    L5["ç¬¬5å±‚ï¼šæ•°æ®è®¿é—®å±‚ï¼ˆsrc/database/post_repository.cppï¼‰<br/>- åŠŸèƒ½ï¼šSQLé¢„ç¼–è¯‘è¯­å¥ã€CRUDæ“ä½œã€è¿æ¥ç®¡ç†<br/>- èŒè´£ï¼šæ•°æ®æŒä¹…åŒ–ï¼Œå±è”½æ•°æ®åº“ç»†èŠ‚<br/>- å…³é”®ç±»ï¼šPostRepository, ImageRepository, TagRepository"]
    L6["ç¬¬6å±‚ï¼šå®‰å…¨å±‚ï¼ˆsrc/security/ï¼‰<br/>- JWTManagerï¼šä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯ï¼ˆjwt-cpp 0.6.0ï¼‰<br/>- PasswordHasherï¼šPBKDF2-HMAC-SHA256å“ˆå¸Œï¼ˆOpenSSL 1.1.1ï¼‰<br/>- èŒè´£ï¼šèº«ä»½è®¤è¯ã€æˆæƒã€æ•°æ®åŠ å¯†"]
    L7["ç¬¬7å±‚ï¼šåŸºç¡€è®¾æ–½å±‚ï¼ˆsrc/database/, src/utils/ï¼‰<br/>- ConnectionPoolï¼šæ•°æ®åº“è¿æ¥æ± ï¼ˆ10è¿æ¥ï¼Œå¯é…ç½®ï¼‰<br/>- Loggerï¼šspdlogæ—¥å¿—ç³»ç»Ÿï¼ˆæ–‡ä»¶+æ§åˆ¶å°ï¼‰<br/>- ConfigManagerï¼šé…ç½®æ–‡ä»¶ç®¡ç†ï¼ˆconfig.jsonï¼‰<br/>- ImageProcessorï¼šSTBå›¾ç‰‡å¤„ç†ï¼ˆå‹ç¼©ã€ç¼©ç•¥å›¾ã€æ ¼å¼è½¬æ¢ï¼‰<br/>- Base64Decoderï¼šBase64ç¼–è§£ç <br/>- UrlHelperï¼šURLæ‹¼æ¥å’Œå¤„ç†"]
    L8["ç¬¬8å±‚ï¼šæ•°æ®æ¨¡å‹å±‚ï¼ˆsrc/models/ï¼‰<br/>- Postï¼šå¸–å­ä¸šåŠ¡å®ä½“ï¼ˆåŒ…å«å›¾ç‰‡åˆ—è¡¨ï¼‰<br/>- Imageï¼šå›¾ç‰‡ä¸šåŠ¡å®ä½“<br/>- Userï¼šç”¨æˆ·ä¸šåŠ¡å®ä½“<br/>- Tagï¼šæ ‡ç­¾ä¸šåŠ¡å®ä½“<br/>- åŠŸèƒ½ï¼štoJson()/fromJson()ã€æ•°æ®éªŒè¯ã€ä¸šåŠ¡é€»è¾‘å°è£…"]
    L9["ç¬¬9å±‚ï¼šæ•°æ®åº“å±‚ï¼ˆMySQL 8.0ï¼‰<br/>- postsï¼šå¸–å­ä¿¡æ¯ï¼ˆä¸»è¡¨ï¼‰<br/>- imagesï¼šå›¾ç‰‡ä¿¡æ¯ï¼ˆå¤–é”®post_idï¼Œçº§è”åˆ é™¤ï¼‰<br/>- usersï¼šç”¨æˆ·ä¿¡æ¯<br/>- tags, post_tagsï¼šæ ‡ç­¾ç³»ç»Ÿ<br/>- share_linksï¼šåˆ†äº«é“¾æ¥<br/>- likes, favorites, followsï¼šäº’åŠ¨ç³»ç»Ÿ"]
    
    L1 -->|HTTP Request<br/>multipart/JSON| L2
    L2 -->|è·¯ç”±åˆ°Handler| L3
    L3 -->|è°ƒç”¨Service| L4
    L4 -->|è°ƒç”¨Repository| L5
    L5 -->|å®‰å…¨æ£€æŸ¥| L6
    L6 -->|åŸºç¡€è®¾æ–½æ”¯æŒ| L7
    L7 -->|æ•°æ®æ¨¡å‹| L8
    L8 -->|æŒä¹…åŒ–| L9
```

### 2.2 å±‚çº§äº¤äº’è§„åˆ™

**ä¸¥æ ¼çš„å•å‘ä¾èµ–åŸåˆ™**ï¼š

âœ… **å…è®¸**ï¼šä¸Šå±‚è°ƒç”¨ä¸‹å±‚ï¼ˆä¾‹å¦‚ï¼šHandler â†’ Service â†’ Repositoryï¼‰  
âŒ **ç¦æ­¢**ï¼šä¸‹å±‚è°ƒç”¨ä¸Šå±‚ï¼ˆä¾‹å¦‚ï¼šServiceä¸èƒ½è°ƒç”¨Handlerï¼‰  
âŒ **ç¦æ­¢**ï¼šè·¨å±‚è°ƒç”¨ï¼ˆä¾‹å¦‚ï¼šHandlerä¸èƒ½ç›´æ¥è°ƒç”¨Repositoryï¼‰  

**ç¤ºä¾‹**ï¼š

```cpp
// âœ… æ­£ç¡®ï¼šHandlerè°ƒç”¨Service
class PostHandler {
    void handleCreatePost() {
        PostCreateResult result = postService_->createPost(...);
    }
};

// âœ… æ­£ç¡®ï¼šServiceè°ƒç”¨Repository
class PostService {
    PostCreateResult createPost() {
        postRepo_->createPost(post);
        imageRepo_->createImage(image);
    }
};

// âŒ é”™è¯¯ï¼šHandlerç›´æ¥è°ƒç”¨Repositoryï¼ˆè·¨å±‚ï¼‰
class PostHandler {
    void handleCreatePost() {
        postRepo_->createPost(post);  // è¿åæ¶æ„åŸåˆ™ï¼
    }
};

// âŒ é”™è¯¯ï¼šServiceè°ƒç”¨Handlerï¼ˆå‘ä¸Šè°ƒç”¨ï¼‰
class PostService {
    void createPost() {
        handler_->sendResponse(...);  // è¿åæ¶æ„åŸåˆ™ï¼
    }
};
```

### 2.3 å„å±‚èŒè´£åˆ’åˆ†

| å±‚çº§ | æ ¸å¿ƒèŒè´£ | å…³é”®ç±» | æ–‡ä»¶ä½ç½® |
|-----|---------|--------|---------|
| **ç¬¬1å±‚** | å‘é€HTTPè¯·æ±‚ | - | å®¢æˆ·ç«¯åº”ç”¨ |
| **ç¬¬2å±‚** | è·¯ç”±åˆ†å‘ã€çº¿ç¨‹ç®¡ç† | `HttpServer` | `src/server/` |
| **ç¬¬3å±‚** | åè®®è½¬æ¢ã€å‚æ•°éªŒè¯ | `PostHandler` | `src/api/` |
| **ç¬¬4å±‚** | ä¸šåŠ¡é€»è¾‘ã€æµç¨‹ç¼–æ’ | `PostService` | `src/core/` |
| **ç¬¬5å±‚** | æ•°æ®æŒä¹…åŒ–ã€SQLæ“ä½œ | `PostRepository` | `src/database/` |
| **ç¬¬6å±‚** | èº«ä»½è®¤è¯ã€æ•°æ®åŠ å¯† | `JWTManager` | `src/security/` |
| **ç¬¬7å±‚** | åŸºç¡€è®¾æ–½æœåŠ¡ | `ConnectionPool`, `Logger` | `src/utils/` |
| **ç¬¬8å±‚** | ä¸šåŠ¡å®ä½“ã€æ•°æ®éªŒè¯ | `Post`, `Image` | `src/models/` |
| **ç¬¬9å±‚** | æ•°æ®å­˜å‚¨ | - | MySQLæ•°æ®åº“ |

---

## 3. åˆ›å»ºå¸–å­APIå®Œæ•´æµç¨‹

### 3.1 æµç¨‹æ¦‚è§ˆ

**APIç«¯ç‚¹**ï¼š`POST /api/v1/posts`  
**åŠŸèƒ½**ï¼šç”¨æˆ·åˆ›å»ºä¸€ä¸ªåŒ…å«1-9å¼ å›¾ç‰‡çš„å¸–å­  
**è®¤è¯**ï¼šéœ€è¦JWTä»¤ç‰Œ  
**è¯·æ±‚æ ¼å¼**ï¼šæ”¯æŒ`multipart/form-data`å’Œ`application/json`ä¸¤ç§æ ¼å¼

### 3.2 æµç¨‹æ—¶åºå›¾

**æ–‡æœ¬ç‰ˆæœ¬**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å®¢æˆ·ç«¯  â”‚  â”‚HTTPæœåŠ¡å™¨â”‚  â”‚PostHandler â”‚  â”‚PostService  â”‚  â”‚PostRepository â”‚  â”‚ MySQL  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚             â”‚               â”‚                â”‚                 â”‚              â”‚
     â”œâ”€â‘ HTTP POSTâ”€â†’â”‚               â”‚                â”‚                 â”‚              â”‚
     â”‚             â”œâ”€â‘¡è·¯ç”±åˆ†å‘â”€â”€â”€â”€â†’â”‚                â”‚                 â”‚              â”‚
     â”‚             â”‚               â”œâ”€â‘¢JWTéªŒè¯â”€â”€â”€â”€â”€â”€â†’â”‚                 â”‚              â”‚
     â”‚             â”‚               â”‚â†â”€â”€â”€â”€éªŒè¯é€šè¿‡â”€â”€â”€â”¤                 â”‚              â”‚
     â”‚             â”‚               â”œâ”€â‘£è§£æè¯·æ±‚å‚æ•°â”€â†’â”‚                 â”‚              â”‚
     â”‚             â”‚               â”œâ”€â‘¤ä¿å­˜ä¸´æ—¶æ–‡ä»¶â”€â†’â”‚                 â”‚              â”‚
     â”‚             â”‚               â”œâ”€â‘¥è°ƒç”¨Serviceâ”€â”€â†’â”‚                 â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘¦éªŒè¯ä¸šåŠ¡è§„åˆ™â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘§ç”Ÿæˆå¸–å­IDâ”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘¨åˆ›å»ºPostå¯¹è±¡â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘©è°ƒç”¨Repositoryâ†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”‚                 â”œâ”€â‘ªINSERT postsâ†’â”‚
     â”‚             â”‚               â”‚                â”‚                 â”‚â†â”€è¿”å›è‡ªå¢IDâ”€â”¤
     â”‚             â”‚               â”‚                â”œâ”€â‘«å¤„ç†å›¾ç‰‡1â”€â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘¬å¤„ç†å›¾ç‰‡2â”€â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘­å¤„ç†å›¾ç‰‡3â”€â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘®ä¿å­˜Image1â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”‚                 â”œâ”€â‘¯INSERT imagesâ”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘°ä¿å­˜Image2â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘±ä¿å­˜Image3â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘²æ›´æ–°image_countâ”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€â‘³å…³è”æ ‡ç­¾1â”€â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€ã‰‘å…³è”æ ‡ç­¾2â”€â”€â”€â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”œâ”€ã‰’æŸ¥è¯¢å®Œæ•´å¸–å­â”€â”€â†’â”‚              â”‚
     â”‚             â”‚               â”‚                â”‚                 â”œâ”€ã‰“SELECTâ”€â”€â”€â”€â”€â”€â”‚
     â”‚             â”‚               â”‚                â”‚â†â”€â”€â”€â”€è¿”å›Postâ”€â”€â”€â”€â”¤              â”‚
     â”‚             â”‚               â”‚â†â”€ã‰”è¿”å›Resultâ”€â”€â”¤                 â”‚              â”‚
     â”‚             â”‚               â”œâ”€ã‰•æ¸…ç†ä¸´æ—¶æ–‡ä»¶â”€â†’â”‚                 â”‚              â”‚
     â”‚             â”‚               â”œâ”€ã‰–å°è£…JSONå“åº”â”€â†’â”‚                 â”‚              â”‚
     â”‚             â”‚â†â”€ã‰—HTTPå“åº”â”€â”€â”€â”¤                â”‚                 â”‚              â”‚
     â”‚â†â”€ã‰˜æ¥æ”¶å“åº”â”€â”€â”¤               â”‚                â”‚                 â”‚              â”‚
```

**Mermaidç‰ˆæœ¬**ï¼ˆæ”¯æŒMermaidçš„ç¯å¢ƒå¯æ¸²æŸ“ï¼‰ï¼š

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Server as HTTPæœåŠ¡å™¨
    participant Handler as PostHandler
    participant Service as PostService
    participant Repo as PostRepository
    participant DB as MySQL

    Client->>Server: â‘ HTTP POST
    Server->>Handler: â‘¡è·¯ç”±åˆ†å‘
    Handler->>Service: â‘¢JWTéªŒè¯
    Service-->>Handler: éªŒè¯é€šè¿‡
    Handler->>Handler: â‘£è§£æè¯·æ±‚å‚æ•°
    Handler->>Handler: â‘¤ä¿å­˜ä¸´æ—¶æ–‡ä»¶
    Handler->>Service: â‘¥è°ƒç”¨Service
    Service->>Service: â‘¦éªŒè¯ä¸šåŠ¡è§„åˆ™
    Service->>Service: â‘§ç”Ÿæˆå¸–å­ID
    Service->>Service: â‘¨åˆ›å»ºPostå¯¹è±¡
    Service->>Repo: â‘©è°ƒç”¨Repository
    Repo->>DB: â‘ªINSERT posts
    DB-->>Repo: è¿”å›è‡ªå¢ID
    Service->>Service: â‘«å¤„ç†å›¾ç‰‡1
    Service->>Service: â‘¬å¤„ç†å›¾ç‰‡2
    Service->>Service: â‘­å¤„ç†å›¾ç‰‡3
    Service->>Repo: â‘®ä¿å­˜Image1
    Repo->>DB: â‘¯INSERT images
    Service->>Repo: â‘°ä¿å­˜Image2
    Service->>Repo: â‘±ä¿å­˜Image3
    Service->>Repo: â‘²æ›´æ–°image_count
    Service->>Repo: â‘³å…³è”æ ‡ç­¾1
    Service->>Repo: ã‰‘å…³è”æ ‡ç­¾2
    Service->>Repo: ã‰’æŸ¥è¯¢å®Œæ•´å¸–å­
    Repo->>DB: ã‰“SELECT
    Repo-->>Service: è¿”å›Post
    Service-->>Handler: ã‰”è¿”å›Result
    Handler->>Handler: ã‰•æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    Handler->>Handler: ã‰–å°è£…JSONå“åº”
    Handler-->>Server: ã‰—HTTPå“åº”
    Server-->>Client: ã‰˜æ¥æ”¶å“åº”
```

### 3.3 å…³é”®æ­¥éª¤è¯´æ˜

| æ­¥éª¤ | å±‚çº§ | æ“ä½œ | è€—æ—¶(ä¼°ç®—) |
|-----|-----|------|-----------|
| â‘ -â‘¡ | ç¬¬1-2å±‚ | HTTPè¯·æ±‚è·¯ç”± | ~5ms |
| â‘¢ | ç¬¬3å±‚ + ç¬¬6å±‚ | JWTä»¤ç‰ŒéªŒè¯ | ~10ms |
| â‘£-â‘¤ | ç¬¬3å±‚ | è§£æå‚æ•°ã€ä¿å­˜ä¸´æ—¶æ–‡ä»¶ | ~20ms |
| â‘¥-â‘¨ | ç¬¬4å±‚ | ä¸šåŠ¡é€»è¾‘éªŒè¯ã€ç”ŸæˆID | ~5ms |
| â‘©-â‘ª | ç¬¬5å±‚ + ç¬¬9å±‚ | æ’å…¥postsè¡¨ | ~10ms |
| â‘«-â‘± | ç¬¬4å±‚ + ç¬¬7å±‚ + ç¬¬9å±‚ | å¤„ç†3å¼ å›¾ç‰‡ï¼ˆå‹ç¼©+ç¼©ç•¥å›¾+ä¿å­˜ï¼‰ | ~300ms |
| â‘²-ã‰‘ | ç¬¬4å±‚ + ç¬¬5å±‚ | æ›´æ–°ç»Ÿè®¡ã€å…³è”æ ‡ç­¾ | ~30ms |
| ã‰’-ã‰“ | ç¬¬5å±‚ + ç¬¬9å±‚ | æŸ¥è¯¢å®Œæ•´å¸–å­ä¿¡æ¯ | ~20ms |
| ã‰”-ã‰˜ | ç¬¬3-1å±‚ | å“åº”å°è£…ã€è¿”å›å®¢æˆ·ç«¯ | ~50ms |
| **æ€»è®¡** | - | **å®Œæ•´æµç¨‹** | **~450ms** |

**æ€§èƒ½ç“¶é¢ˆ**ï¼šå›¾ç‰‡å¤„ç†ï¼ˆå‹ç¼©+ç¼©ç•¥å›¾ï¼‰å æ€»æ—¶é—´çš„66%ã€‚

---

## 4. ç¬¬1å±‚ï¼šå®¢æˆ·ç«¯å±‚

### 4.1 HTTPè¯·æ±‚ç¤ºä¾‹

**åœºæ™¯**ï¼šç”¨æˆ·ä¸Šä¼ 3å¼ å›¾ç‰‡åˆ›å»ºå¸–å­

#### multipart/form-dataæ ¼å¼ï¼ˆæ¨èç”¨äºWebå’ŒåŸç”ŸAppï¼‰

```http
POST /api/v1/posts HTTP/1.1
Host: api.knot.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo3fQ...
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary7MA4YWxkTrZu0gW

------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="title"

æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="description"

ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæ‹äº†å‡ å¼ é£æ™¯ç…§ï¼
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="tags"

["æ—…æ¸¸", "é£æ™¯"]
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="imageFiles"; filename="photo1.jpg"
Content-Type: image/jpeg

<binary data>
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="imageFiles"; filename="photo2.jpg"
Content-Type: image/jpeg

<binary data>
------WebKitFormBoundary7MA4YWxkTrZu0gW
Content-Disposition: form-data; name="imageFiles"; filename="photo3.jpg"
Content-Type: image/jpeg

<binary data>
------WebKitFormBoundary7MA4YWxkTrZu0gW--
```

#### application/jsonæ ¼å¼ï¼ˆæ¨èç”¨äºHarmonyOSï¼‰

```http
POST /api/v1/posts HTTP/1.1
Host: api.knot.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "title": "æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­",
  "description": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œæ‹äº†å‡ å¼ é£æ™¯ç…§ï¼",
  "tags": ["æ—…æ¸¸", "é£æ™¯"],
  "images": [
    {
      "filename": "photo1.jpg",
      "content_type": "image/jpeg",
      "data": "/9j/4AAQSkZJRgABAQEAYABgAAD..."  // Base64ç¼–ç 
    },
    {
      "filename": "photo2.jpg",
      "content_type": "image/jpeg",
      "data": "data:image/jpeg;base64,/9j/4AAQ..."  // Data URIæ ¼å¼ä¹Ÿæ”¯æŒ
    },
    {
      "filename": "photo3.jpg",
      "content_type": "image/jpeg",
      "data": "/9j/4AAQSkZJRgABAQEAYABgAAD..."
    }
  ]
}
```

### 4.2 å®¢æˆ·ç«¯å®ç°å»ºè®®

**HarmonyOSç¤ºä¾‹**ï¼š

```typescript
// HarmonyOS ArkTSä»£ç 
async createPost(title: string, description: string, imagePaths: string[]) {
  const images = [];
  
  // è¯»å–å›¾ç‰‡æ–‡ä»¶å¹¶è½¬ä¸ºBase64
  for (const path of imagePaths) {
    const imageData = await readImageAsBase64(path);
    images.push({
      filename: getFilename(path),
      content_type: "image/jpeg",
      data: imageData
    });
  }
  
  const response = await httpClient.post('/api/v1/posts', {
    headers: {
      'Authorization': `Bearer ${this.token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      title: title,
      description: description,
      tags: ["æ—…æ¸¸", "é£æ™¯"],
      images: images
    })
  });
  
  return response.data;
}
```

---

## 5. ç¬¬2å±‚ï¼šHTTPæœåŠ¡å™¨å±‚

### 5.1 æœåŠ¡å™¨åˆå§‹åŒ–

**æ–‡ä»¶**ï¼š`src/server/http_server.cpp`

```cpp
class HttpServer {
public:
    HttpServer() {
        // åˆ›å»ºhttplibæœåŠ¡å™¨å®ä¾‹
        server_ = std::make_unique<httplib::Server>();
        
        // æ³¨å†ŒHandler
        postHandler_ = std::make_unique<PostHandler>();
        userHandler_ = std::make_unique<UserHandler>();
        // ... å…¶ä»–Handler
        
        Logger::info("HttpServer initialized");
    }
    
    void start(const std::string& host, int port) {
        // æ³¨å†Œæ‰€æœ‰è·¯ç”±
        postHandler_->registerRoutes(*server_);
        userHandler_->registerRoutes(*server_);
        
        // è®¾ç½®çº¿ç¨‹æ± å¤§å°
        server_->new_task_queue = [] {
            return new httplib::ThreadPool(32);  // 32ä¸ªå·¥ä½œçº¿ç¨‹
        };
        
        // å¯åŠ¨æœåŠ¡å™¨
        Logger::info("Server listening on " + host + ":" + std::to_string(port));
        server_->listen(host.c_str(), port);
    }
    
private:
    std::unique_ptr<httplib::Server> server_;
    std::unique_ptr<PostHandler> postHandler_;
    std::unique_ptr<UserHandler> userHandler_;
};
```

### 5.2 è·¯ç”±æ³¨å†Œæœºåˆ¶

**æ–‡ä»¶**ï¼š`src/api/post_handler.cpp` (ç¬¬32-79è¡Œ)

```cpp
void PostHandler::registerRoutes(httplib::Server& server) {
    // åˆ›å»ºå¸–å­ï¼ˆéœ€è¦è®¤è¯ï¼‰
    server.Post("/api/v1/posts", [this](const httplib::Request& req, httplib::Response& res) {
        handleCreatePost(req, res);
    });
    
    // è·å–å¸–å­è¯¦æƒ…ï¼ˆå…¬å¼€æ¥å£ï¼‰
    server.Get("/api/v1/posts/:post_id", [this](const httplib::Request& req, httplib::Response& res) {
        handleGetPostDetail(req, res);
    });
    
    // æ›´æ–°å¸–å­ï¼ˆéœ€è¦è®¤è¯ï¼‰
    server.Put("/api/v1/posts/:post_id", [this](const httplib::Request& req, httplib::Response& res) {
        handleUpdatePost(req, res);
    });
    
    // åˆ é™¤å¸–å­ï¼ˆéœ€è¦è®¤è¯ï¼‰
    server.Delete("/api/v1/posts/:post_id", [this](const httplib::Request& req, httplib::Response& res) {
        handleDeletePost(req, res);
    });
    
    // è·å–Feedæµï¼ˆå¯é€‰è®¤è¯ï¼‰
    server.Get("/api/v1/posts", [this](const httplib::Request& req, httplib::Response& res) {
        handleGetRecentPosts(req, res);
    });
    
    Logger::info("PostHandler routes registered");
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨lambdaè¡¨è¾¾å¼æ•è·`this`æŒ‡é’ˆï¼Œå®ç°æˆå‘˜æ–¹æ³•å›è°ƒ
- è·¯å¾„å‚æ•°ä½¿ç”¨`:param_name`è¯­æ³•ï¼ˆä¾‹å¦‚`:post_id`ï¼‰
- æ‰€æœ‰è·¯ç”±åœ¨æœåŠ¡å™¨å¯åŠ¨å‰æ³¨å†Œå®Œæˆ

### 5.3 æ€§èƒ½é…ç½®

**CMakeLists.txté…ç½®**ï¼š

```cmake
# ç¼–è¯‘å®šä¹‰
add_definitions(
    -DCPPHTTPLIB_LISTEN_BACKLOG=128      # è¿æ¥é˜Ÿåˆ—é•¿åº¦
    -DCPPHTTPLIB_THREAD_POOL_COUNT=32    # çº¿ç¨‹æ± å¤§å°
    -DCPPHTTPLIB_READ_TIMEOUT_SECOND=30  # è¯»å–è¶…æ—¶
    -DCPPHTTPLIB_WRITE_TIMEOUT_SECOND=30 # å†™å…¥è¶…æ—¶
)
```

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- æœ€å¤§å¹¶å‘è¿æ¥ï¼š128
- å·¥ä½œçº¿ç¨‹æ•°ï¼š32
- ååé‡ï¼š~200 QPSï¼ˆç®€å•æŸ¥è¯¢ï¼‰
- ååé‡ï¼š~50 QPSï¼ˆå›¾ç‰‡ä¸Šä¼ ï¼‰

---

## 6. ç¬¬3å±‚ï¼šAPIæ¥å£å±‚

### 6.1 HandleråŸºç±»è®¾è®¡

**æ–‡ä»¶**ï¼š`src/api/base_handler.h`

```cpp
class BaseHandler {
protected:
    /**
     * @brief æå–JWTä»¤ç‰Œ
     * @return ä»¤ç‰Œå­—ç¬¦ä¸²ï¼Œå¤±è´¥è¿”å›ç©º
     */
    std::string extractToken(const httplib::Request& req) const {
        std::string authHeader = req.get_header_value("Authorization");
        if (authHeader.substr(0, 7) == "Bearer ") {
            return authHeader.substr(7);
        }
        return "";
    }
    
    /**
     * @brief ä»ä»¤ç‰Œè·å–ç”¨æˆ·ID
     * @return ç”¨æˆ·IDï¼ŒéªŒè¯å¤±è´¥è¿”å›0
     */
    int getUserIdFromToken(const std::string& token) const {
        auto jwtManager = std::make_unique<JWTManager>();
        TokenValidationResult result = jwtManager->validateAccessToken(token);
        
        if (result.valid) {
            return result.userId;
        }
        return 0;
    }
    
    /**
     * @brief è§£æJSONè¯·æ±‚ä½“
     */
    bool parseJsonBody(const std::string& body, Json::Value& json) const {
        Json::CharReaderBuilder builder;
        std::string errs;
        std::istringstream stream(body);
        return Json::parseFromStream(builder, stream, &json, &errs);
    }
    
    /**
     * @brief å‘é€æˆåŠŸå“åº”
     */
    void sendSuccessResponse(httplib::Response& res, 
                             const std::string& message,
                             const Json::Value& data = Json::Value()) const {
        Json::Value response;
        response["success"] = true;
        response["message"] = message;
        response["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
        
        if (!data.isNull()) {
            response["data"] = data;
        }
        
        res.set_content(jsonToString(response), "application/json");
        res.status = 200;
    }
    
    /**
     * @brief å‘é€é”™è¯¯å“åº”
     */
    void sendErrorResponse(httplib::Response& res,
                           int statusCode,
                           const std::string& message) const {
        Json::Value response;
        response["success"] = false;
        response["message"] = message;
        response["timestamp"] = static_cast<Json::Int64>(std::time(nullptr));
        
        res.set_content(jsonToString(response), "application/json");
        res.status = statusCode;
    }
};
```

### 6.2 åˆ›å»ºå¸–å­Handlerå®ç°

**æ–‡ä»¶**ï¼š`src/api/post_handler.cpp` (handleCreatePostæ–¹æ³•)

#### 6.2.1 JWTèº«ä»½éªŒè¯

```cpp
void PostHandler::handleCreatePost(const httplib::Request& req, httplib::Response& res) {
    try {
        Logger::info("=== [CREATE POST] Request received ===");
        
        // ã€æ­¥éª¤1ã€‘æå–JWTä»¤ç‰Œ
        std::string token = extractToken(req);
        if (token.empty()) {
            Logger::warning("[CREATE POST] âœ— No token provided");
            sendErrorResponse(res, 401, "æœªæä¾›è®¤è¯ä»¤ç‰Œ");
            return;
        }
        
        // ã€æ­¥éª¤2ã€‘éªŒè¯ä»¤ç‰Œå¹¶è·å–ç”¨æˆ·ID
        int userId = getUserIdFromToken(token);
        if (userId == 0) {
            Logger::warning("[CREATE POST] âœ— Invalid token");
            sendErrorResponse(res, 401, "æ— æ•ˆçš„è®¤è¯ä»¤ç‰Œ");
            return;
        }
        
        Logger::info("[CREATE POST] âœ“ User authenticated - UserID: " + std::to_string(userId));
```

**å®‰å…¨æ£€æŸ¥ç‚¹**ï¼š
- âœ… Authorizationå¤´æ˜¯å¦å­˜åœ¨
- âœ… Bearerå‰ç¼€æ˜¯å¦æ­£ç¡®
- âœ… JWTç­¾åæ˜¯å¦æœ‰æ•ˆ
- âœ… JWTæ˜¯å¦è¿‡æœŸ
- âœ… user_id claimæ˜¯å¦å­˜åœ¨

#### 6.2.2 è¯·æ±‚æ ¼å¼æ£€æµ‹

```cpp
        // ã€æ­¥éª¤3ã€‘æ£€æŸ¥è¯·æ±‚æ ¼å¼
        std::string contentType = req.get_header_value("Content-Type");
        bool isMultipart = req.is_multipart_form_data();
        bool isJson = (contentType.find("application/json") != std::string::npos);
        
        if (!isMultipart && !isJson) {
            Logger::error("[CREATE POST] âœ— Unsupported Content-Type: " + contentType);
            sendErrorResponse(res, 400, "è¯·æ±‚å¿…é¡»ä½¿ç”¨multipart/form-dataæˆ–application/jsonæ ¼å¼");
            return;
        }
        
        Logger::info("[CREATE POST] âœ“ Request format: " + 
                    std::string(isMultipart ? "multipart" : "JSON"));
```

**è®¾è®¡äº®ç‚¹**ï¼š
- æ”¯æŒä¸¤ç§æ ¼å¼ï¼Œé€‚åº”ä¸åŒå®¢æˆ·ç«¯éœ€æ±‚
- multiparté€‚åˆWebæµè§ˆå™¨å’ŒåŸç”ŸApp
- JSON+Base64é€‚åˆHarmonyOSç­‰ç‰¹æ®Šå¹³å°

#### 6.2.3 è§£æmultipartè¯·æ±‚

```cpp
        std::string title;
        std::string description;
        std::vector<std::string> tags;
        std::vector<std::string> savedImagePaths;
        
        if (isMultipart) {
            // ã€æ­¥éª¤4ã€‘è·å–æ–‡æœ¬å­—æ®µ
            if (req.form.has_field("title")) {
                title = req.form.get_field("title");
            }
            if (title.empty()) {
                sendErrorResponse(res, 400, "æ ‡é¢˜ä¸èƒ½ä¸ºç©º");
                return;
            }
            
            if (req.form.has_field("description")) {
                description = req.form.get_field("description");
            }
            
            // ã€æ­¥éª¤5ã€‘è§£ææ ‡ç­¾ï¼ˆæ”¯æŒJSONæ•°ç»„æ ¼å¼ï¼‰
            if (req.form.has_field("tags")) {
                auto tagFields = req.form.get_fields("tags");
                
                if (tagFields.size() == 1) {
                    const std::string& tagsValue = tagFields[0];
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºJSONæ•°ç»„æ ¼å¼ï¼ˆ["tag1", "tag2"]ï¼‰
                    if (!tagsValue.empty() && tagsValue[0] == '[') {
                        try {
                            Json::Value tagsJson;
                            Json::CharReaderBuilder builder;
                            std::string errs;
                            std::istringstream stream(tagsValue);
                            
                            if (Json::parseFromStream(builder, stream, &tagsJson, &errs)) {
                                if (tagsJson.isArray()) {
                                    for (const auto& tag : tagsJson) {
                                        if (tag.isString()) {
                                            tags.push_back(tag.asString());
                                        }
                                    }
                                    Logger::info("[CREATE POST] âœ“ Parsed " + 
                                               std::to_string(tags.size()) + " tags from JSON array");
                                }
                            } else {
                                // JSONè§£æå¤±è´¥ï¼Œå½“ä½œæ™®é€šå­—ç¬¦ä¸²
                                tags.push_back(tagsValue);
                            }
                        } catch (const std::exception& e) {
                            Logger::warning("[CREATE POST] âš  Failed to parse tags JSON: " + 
                                          std::string(e.what()));
                            tags.push_back(tagsValue);
                        }
                    } else {
                        // ä¸æ˜¯JSONæ•°ç»„æ ¼å¼ï¼Œå½“ä½œæ™®é€šå­—ç¬¦ä¸²
                        tags.push_back(tagsValue);
                    }
                } else {
                    // å¤šä¸ªtagså­—æ®µï¼Œç›´æ¥ä½¿ç”¨
                    tags = tagFields;
                }
            }
```

**æ ‡ç­¾è§£ææ”¯æŒçš„æ ¼å¼**ï¼š
1. JSONæ•°ç»„å­—ç¬¦ä¸²ï¼š`["æ—…æ¸¸", "é£æ™¯"]`
2. å¤šä¸ªtagså­—æ®µï¼š`tags=æ—…æ¸¸&tags=é£æ™¯`
3. å•ä¸ªå­—ç¬¦ä¸²ï¼š`tags=æ—…æ¸¸`

#### 6.2.4 å¤„ç†å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ 

```cpp
            // ã€æ­¥éª¤6ã€‘å¤„ç†å›¾ç‰‡æ–‡ä»¶
            if (req.form.has_file("imageFiles")) {
                auto imageFiles = req.form.get_files("imageFiles");
                
                Logger::info("[CREATE POST] âœ“ Received " + 
                           std::to_string(imageFiles.size()) + " image file(s)");
                
                for (size_t i = 0; i < imageFiles.size(); i++) {
                    const auto& fileData = imageFiles[i];
                    
                    Logger::info("[CREATE POST] Processing image " + 
                               std::to_string(i + 1) + "/" + 
                               std::to_string(imageFiles.size()) + 
                               " - Filename: " + fileData.filename + 
                               ", Size: " + std::to_string(fileData.content.size()) + " bytes");
                    
                    // ã€æ­¥éª¤6.1ã€‘éªŒè¯æ–‡ä»¶ç±»å‹
                    if (fileData.content_type.find("image/") != 0) {
                        Logger::error("[CREATE POST] âœ— Invalid MIME type: " + fileData.content_type);
                        sendErrorResponse(res, 400, "åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶");
                        return;
                    }
                    
                    // ã€æ­¥éª¤6.2ã€‘éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
                    const size_t MAX_SIZE = 5 * 1024 * 1024;
                    if (fileData.content.size() > MAX_SIZE) {
                        Logger::error("[CREATE POST] âœ— File too large: " + 
                                    std::to_string(fileData.content.size()) + " bytes");
                        sendErrorResponse(res, 400, "å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB");
                        return;
                    }
                    
                    // ã€æ­¥éª¤6.3ã€‘ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•
                    std::string savedPath = saveUploadedFile(
                        fileData.content,
                        fileData.filename,
                        fileData.content_type
                    );
                    
                    if (savedPath.empty()) {
                        Logger::error("[CREATE POST] âœ— Failed to save image " + 
                                    std::to_string(i + 1));
                        sendErrorResponse(res, 500, "ä¿å­˜å›¾ç‰‡æ–‡ä»¶å¤±è´¥");
                        return;
                    }
                    
                    savedImagePaths.push_back(savedPath);
                    Logger::info("[CREATE POST] âœ“ Image " + std::to_string(i + 1) + 
                               " saved - Path: " + savedPath);
                }
            } else {
                Logger::warning("[CREATE POST] âš  No image files found");
            }
        }
```

**saveUploadedFileè¾…åŠ©æ–¹æ³•**ï¼š

```cpp
std::string PostHandler::saveUploadedFile(
    const std::string& content,
    const std::string& filename,
    const std::string& contentType
) {
    try {
        // ã€æ­¥éª¤1ã€‘æ£€æµ‹å¹¶è§£ç Base64æ•°æ®ï¼ˆå¦‚æœæ˜¯JSONæ ¼å¼ï¼‰
        std::string actualContent = content;
        
        if (Base64Decoder::isBase64(content)) {
            Logger::info("[SAVE FILE] Detected Base64 encoded data");
            actualContent = Base64Decoder::decode(content);
            Logger::info("[SAVE FILE] âœ“ Decoded - Size: " + 
                        std::to_string(actualContent.size()) + " bytes");
        }
        
        // ã€æ­¥éª¤2ã€‘ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
        std::string extension = "";
        size_t dotPos = filename.find_last_of('.');
        if (dotPos != std::string::npos) {
            extension = filename.substr(dotPos);
        }
        
        auto now = std::chrono::system_clock::now();
        auto timestamp = std::chrono::duration_cast<std::chrono::milliseconds>(
            now.time_since_epoch()
        ).count();
        
        std::string uniqueFilename = "upload_" + std::to_string(timestamp) + 
                                    "_" + std::to_string(rand() % 10000) + extension;
        
        // ã€æ­¥éª¤3ã€‘ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
        std::string tempDir = "/tmp/knot_uploads";
        system(("mkdir -p " + tempDir).c_str());
        
        // ã€æ­¥éª¤4ã€‘ä¿å­˜æ–‡ä»¶
        std::string tempPath = tempDir + "/" + uniqueFilename;
        std::ofstream file(tempPath, std::ios::binary);
        if (!file.is_open()) {
            Logger::error("[SAVE FILE] âœ— Failed to open file: " + tempPath);
            return "";
        }
        
        file.write(actualContent.data(), actualContent.size());
        file.close();
        
        Logger::info("[SAVE FILE] âœ“ File saved - Path: " + tempPath);
        return tempPath;
        
    } catch (const std::exception& e) {
        Logger::error("[SAVE FILE] âœ— Exception: " + std::string(e.what()));
        return "";
    }
}
```

---

## 7. ç¬¬4å±‚ï¼šä¸šåŠ¡é€»è¾‘å±‚

ä¸šåŠ¡é€»è¾‘å±‚æ˜¯æ•´ä¸ªæ¶æ„çš„æ ¸å¿ƒï¼Œè´Ÿè´£å°è£…å¤æ‚çš„ä¸šåŠ¡æµç¨‹ï¼Œåè°ƒå¤šä¸ªRepositoryå’ŒåŸºç¡€è®¾æ–½æœåŠ¡ã€‚

### 7.1 PostServiceç±»è®¾è®¡

**æ–‡ä»¶**ï¼š`src/core/post_service.h`

```cpp
class PostService {
public:
    PostService();
    ~PostService();
    
    /**
     * @brief åˆ›å»ºå¸–å­
     * @param userId ç”¨æˆ·ID
     * @param title æ ‡é¢˜
     * @param description æè¿°
     * @param imagePaths å›¾ç‰‡ä¸´æ—¶æ–‡ä»¶è·¯å¾„åˆ—è¡¨
     * @param tags æ ‡ç­¾åˆ—è¡¨
     * @return PostCreateResult åˆ›å»ºç»“æœ
     */
    PostCreateResult createPost(
        int userId,
        const std::string& title,
        const std::string& description,
        const std::vector<std::string>& imagePaths,
        const std::vector<std::string>& tags
    );
    
private:
    std::unique_ptr<PostRepository> postRepo_;
    std::unique_ptr<ImageService> imageService_;
    std::unique_ptr<TagRepository> tagRepo_;
    std::unique_ptr<ImageRepository> imageRepo_;
    
    std::string generatePostId();  // ç”Ÿæˆå”¯ä¸€ID
    bool validateImageCount(int count);  // éªŒè¯å›¾ç‰‡æ•°é‡
    bool checkOwnership(const std::string& postId, int userId);  // æƒé™æ£€æŸ¥
};
```

### 7.2 åˆ›å»ºå¸–å­ä¸šåŠ¡æµç¨‹

**æ–‡ä»¶**ï¼š`src/core/post_service.cpp` (createPostæ–¹æ³•)

#### 7.2.1 ä¸šåŠ¡è§„åˆ™éªŒè¯

```cpp
PostCreateResult PostService::createPost(
    int userId,
    const std::string& title,
    const std::string& description,
    const std::vector<std::string>& imagePaths,
    const std::vector<std::string>& tags
) {
    PostCreateResult result;
    
    try {
        Logger::info("Creating post for user ID: " + std::to_string(userId));
        
        // ã€æ­¥éª¤1ã€‘éªŒè¯æ ‡é¢˜
        if (title.empty() || title.length() > 255) {
            result.message = "æ ‡é¢˜é•¿åº¦å¿…é¡»åœ¨1-255å­—ç¬¦ä¹‹é—´";
            Logger::warning(result.message);
            return result;
        }
        
        // ã€æ­¥éª¤2ã€‘éªŒè¯æè¿°
        if (description.length() > 5000) {
            result.message = "æè¿°é•¿åº¦ä¸èƒ½è¶…è¿‡5000å­—ç¬¦";
            Logger::warning(result.message);
            return result;
        }
        
        // ã€æ­¥éª¤3ã€‘éªŒè¯å›¾ç‰‡æ•°é‡ï¼ˆä¸šåŠ¡æ ¸å¿ƒè§„åˆ™ï¼‰
        if (!validateImageCount(imagePaths.size())) {
            result.message = "å›¾ç‰‡æ•°é‡å¿…é¡»åœ¨1-9å¼ ä¹‹é—´";
            Logger::warning(result.message);
            return result;
        }
```

**validateImageCountæ–¹æ³•**ï¼š

```cpp
bool PostService::validateImageCount(int imageCount) {
    bool valid = (imageCount >= 1 && imageCount <= 9);
    if (!valid) {
        Logger::warning("Invalid image count: " + std::to_string(imageCount) + 
                       " (must be 1-9)");
    }
    return valid;
}
```

**ä¸šåŠ¡è§„åˆ™æ€»ç»“**ï¼š
- æ ‡é¢˜ï¼šå¿…å¡«ï¼Œ1-255å­—ç¬¦
- æè¿°ï¼šå¯é€‰ï¼Œæœ€å¤š5000å­—ç¬¦
- å›¾ç‰‡ï¼šå¿…é¡»1-9å¼ ï¼ˆæ ¸å¿ƒä¸šåŠ¡çº¦æŸï¼‰
- æ ‡ç­¾ï¼šå¯é€‰ï¼Œæ— æ•°é‡é™åˆ¶

#### 7.2.2 ç”Ÿæˆå¸–å­ä¸šåŠ¡ID

```cpp
        // ã€æ­¥éª¤4ã€‘ç”Ÿæˆå¸–å­ID
        std::string postId = generatePostId();
        
        Logger::info("Generated post ID: " + postId);
```

**generatePostIdæ–¹æ³•å®ç°**ï¼š

```cpp
std::string PostService::generatePostId() {
    auto now = std::chrono::system_clock::now();
    auto time = std::chrono::system_clock::to_time_t(now);
    std::tm* tm = std::localtime(&time);
    
    // è®¡ç®—å¹´ä»½å’Œå­£åº¦
    int year = tm->tm_year + 1900;    // 2025
    int quarter = (tm->tm_mon / 3) + 1;  // Q1/Q2/Q3/Q4
    
    // ç”Ÿæˆ6ä½éšæœºå­—ç¬¦ä¸²ï¼ˆå¤§å°å†™å­—æ¯+æ•°å­—ï¼‰
    static const char alphanum[] =
        "0123456789"
        "ABCDEFGHIJKLMNOPQRSTUVWXYZ"
        "abcdefghijklmnopqrstuvwxyz";
    
    std::random_device rd;
    std::mt19937 gen(rd());
    std::uniform_int_distribution<> dis(0, sizeof(alphanum) - 2);
    
    std::string randomPart;
    for (int i = 0; i < 6; ++i) {
        randomPart += alphanum[dis(gen)];
    }
    
    // æ‹¼æ¥ï¼šPOST_2025Q4_Abc123
    std::ostringstream oss;
    oss << "POST_" << year << "Q" << quarter << "_" << randomPart;
    
    return oss.str();
}
```

**IDæ ¼å¼ç¤ºä¾‹**ï¼š
- `POST_2025Q1_A1b2C3` - 2025å¹´ç¬¬1å­£åº¦
- `POST_2025Q4_Xyz789` - 2025å¹´ç¬¬4å­£åº¦
- `POST_2026Q2_MnO4pQ` - 2026å¹´ç¬¬2å­£åº¦

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… å¯è¯»æ€§å¼ºï¼ˆåŒ…å«æ—¶é—´ä¿¡æ¯ï¼‰
- âœ… å”¯ä¸€æ€§é«˜ï¼ˆ62^6 â‰ˆ 568äº¿ç§ç»„åˆï¼‰
- âœ… ä¾¿äºæ’åºï¼ˆæŒ‰å­£åº¦åˆ†åŒºï¼‰
- âœ… ä¾¿äºç»Ÿè®¡ï¼ˆå¯æŒ‰å­£åº¦èšåˆï¼‰

#### 7.2.3 æ„å»ºPostå¯¹è±¡

```cpp
        // ã€æ­¥éª¤5ã€‘æ„å»ºPostå¯¹è±¡
        Post post;
        post.setPostId(postId);
        post.setUserId(userId);
        post.setTitle(title);
        post.setDescription(description);
        post.setImageCount(imagePaths.size());
        post.setStatus(PostStatus::APPROVED);  // é»˜è®¤å®¡æ ¸é€šè¿‡
        post.setLikeCount(0);
        post.setFavoriteCount(0);
        post.setViewCount(0);
```

**ä¸ºä»€ä¹ˆé»˜è®¤å®¡æ ¸é€šè¿‡ï¼Ÿ**
- å½“å‰ç‰ˆæœ¬æœªå®ç°å†…å®¹å®¡æ ¸æœºåˆ¶
- æœªæ¥å¯é›†æˆç¬¬ä¸‰æ–¹å†…å®¹å®¡æ ¸API
- æˆ–è€…å®ç°ç®¡ç†å‘˜æ‰‹åŠ¨å®¡æ ¸åŠŸèƒ½

#### 7.2.4 åˆ›å»ºå¸–å­è®°å½•

```cpp
        // ã€æ­¥éª¤6ã€‘åˆ›å»ºå¸–å­è®°å½•
        if (!postRepo_->createPost(post)) {
            result.message = "åˆ›å»ºå¸–å­è®°å½•å¤±è´¥";
            Logger::error(result.message);
            return result;
        }
        
        Logger::info("Post created with ID: " + postId + 
                    ", physical ID: " + std::to_string(post.getId()));
```

**å…³é”®ç‚¹**ï¼š
- `post.getId()` è¿”å›æ•°æ®åº“è‡ªå¢IDï¼ˆç‰©ç†IDï¼‰
- `post.getPostId()` è¿”å›ä¸šåŠ¡é€»è¾‘IDï¼ˆå¦‚`POST_2025Q4_Abc123`ï¼‰
- Repositoryçš„`createPost`æ–¹æ³•ä¼šè‡ªåŠ¨è®¾ç½®ç‰©ç†ID

#### 7.2.5 å¤„ç†å›¾ç‰‡ä¸Šä¼ 

```cpp
        // ã€æ­¥éª¤7ã€‘å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        std::vector<Image> savedImages;
        int actualImageCount = 0;
        
        for (size_t i = 0; i < imagePaths.size(); i++) {
            Logger::info("Processing image " + std::to_string(i + 1) + "/" + 
                        std::to_string(imagePaths.size()));
            
            // ã€æ­¥éª¤7.1ã€‘è°ƒç”¨ImageServiceå¤„ç†å›¾ç‰‡
            std::vector<std::string> emptyTags;
            ImageUploadResult imgResult = imageService_->uploadImage(
                userId,
                imagePaths[i],   // ä¸´æ—¶æ–‡ä»¶è·¯å¾„
                title,           // ä½¿ç”¨å¸–å­æ ‡é¢˜ä½œä¸ºå›¾ç‰‡æ ‡é¢˜
                "",              // å›¾ç‰‡æè¿°ä¸ºç©º
                emptyTags        // å›¾ç‰‡æ ‡ç­¾ä¸ºç©º
            );
            
            if (!imgResult.success) {
                Logger::warning("Image processing failed: " + imgResult.message);
                continue;  // è·³è¿‡å¤±è´¥çš„å›¾ç‰‡ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€å¼ 
            }
            
            // ã€æ­¥éª¤7.2ã€‘è®¾ç½®å›¾ç‰‡çš„postIdå’ŒdisplayOrder
            Image image = imgResult.image;
            image.setPostId(post.getId());           // å…³è”å¸–å­ç‰©ç†ID
            image.setDisplayOrder(actualImageCount);  // å›¾ç‰‡é¡ºåºï¼ˆ0, 1, 2ï¼‰
            
            // ã€æ­¥éª¤7.3ã€‘ä¿å­˜å›¾ç‰‡è®°å½•åˆ°æ•°æ®åº“
            if (!imageRepo_->createImage(image)) {
                Logger::warning("Failed to save image record: " + image.getImageId());
            } else {
                Logger::info("Image saved successfully: " + image.getImageId());
                savedImages.push_back(image);
                actualImageCount++;
            }
        }
```

**ImageService::uploadImageåšäº†ä»€ä¹ˆï¼Ÿ**

1. **è¯»å–å›¾ç‰‡æ–‡ä»¶**ï¼šä½¿ç”¨STBåº“è¯»å–ä¸´æ—¶æ–‡ä»¶
2. **éªŒè¯å›¾ç‰‡æ ¼å¼**ï¼šæ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„JPEG/PNG/GIF/WebP
3. **å‹ç¼©åŸå›¾**ï¼šJPEG 80%è´¨é‡å‹ç¼©
4. **ç”Ÿæˆç¼©ç•¥å›¾**ï¼šå±…ä¸­è£å‰ªåˆ°300x300åƒç´ 
5. **ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ**ï¼š`/var/uploads/images/2025Q4/`
6. **ç”Ÿæˆå›¾ç‰‡ID**ï¼š`IMG_2025Q4_Xyz789`
7. **è¿”å›Imageå¯¹è±¡**ï¼šåŒ…å«æ–‡ä»¶è·¯å¾„ã€å°ºå¯¸ã€å¤§å°ç­‰ä¿¡æ¯

**ä¸ºä»€ä¹ˆå…è®¸éƒ¨åˆ†å›¾ç‰‡å¤±è´¥ï¼Ÿ**
- å®¹é”™æ€§ï¼šå•å¼ å›¾ç‰‡å¤±è´¥ä¸åº”å¯¼è‡´æ•´ä¸ªæ“ä½œå¤±è´¥
- ç”¨æˆ·ä½“éªŒï¼šè‡³å°‘ä¿ç•™æˆåŠŸçš„å›¾ç‰‡
- ä¸šåŠ¡çº¦æŸï¼šæœ€ç»ˆéªŒè¯è‡³å°‘æœ‰1å¼ å›¾ç‰‡æˆåŠŸ

#### 7.2.6 éªŒè¯å¹¶æ›´æ–°å›¾ç‰‡æ•°é‡ï¼ˆå…³é”®ä¿®å¤ç‚¹ï¼‰

```cpp
        // ã€æ­¥éª¤8ã€‘éªŒè¯è‡³å°‘æœ‰ä¸€å¼ å›¾ç‰‡æˆåŠŸä¸Šä¼ 
        if (savedImages.empty()) {
            Logger::error("No images were successfully processed");
            // å›æ»šï¼šåˆ é™¤åˆšåˆ›å»ºçš„å¸–å­è®°å½•
            postRepo_->deletePost(postId);
            result.message = "æ‰€æœ‰å›¾ç‰‡å¤„ç†å¤±è´¥ï¼Œå¸–å­åˆ›å»ºå¤±è´¥";
            return result;
        }
        
        // ã€æ­¥éª¤9ã€‘ğŸ”§ å…³é”®ä¿®å¤ï¼šå§‹ç»ˆæ›´æ–°å¸–å­çš„å®é™…å›¾ç‰‡æ•°é‡
        post.setImageCount(actualImageCount);
        postRepo_->updatePost(post);
        Logger::info("Updated post image count to: " + std::to_string(actualImageCount));
```

**è¿™é‡Œè§£å†³äº†ä½ æåˆ°çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼**

**é—®é¢˜åŸå› **ï¼š
- åˆå§‹è®¾ç½®ï¼š`post.setImageCount(imagePaths.size())` - å‡è®¾3å¼ 
- å®é™…ä¿å­˜ï¼šå¯èƒ½åªæˆåŠŸ2å¼ ï¼ˆ1å¼ å¤„ç†å¤±è´¥ï¼‰
- æ•°æ®åº“ï¼š`posts.image_count = 3`ï¼Œä½†`images`è¡¨åªæœ‰2æ¡è®°å½•
- ç»“æœï¼šæ•°æ®ä¸ä¸€è‡´

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨`actualImageCount`ï¼ˆå®é™…æˆåŠŸä¿å­˜çš„æ•°é‡ï¼‰
- è°ƒç”¨`postRepo_->updatePost(post)`åŒæ­¥æ›´æ–°æ•°æ®åº“
- ç¡®ä¿`posts.image_count`ä¸`images`è¡¨è®°å½•æ•°ä¸€è‡´

#### 7.2.7 å…³è”æ ‡ç­¾

```cpp
        // ã€æ­¥éª¤10ã€‘å¤„ç†æ ‡ç­¾å…³è”
        for (const auto& tagName : tags) {
            if (tagName.empty()) continue;
            
            Logger::info("Processing tag: " + tagName);
            
            // ã€æ­¥éª¤10.1ã€‘æŸ¥æ‰¾æ ‡ç­¾æ˜¯å¦å­˜åœ¨
            auto tagOpt = tagRepo_->findByName(tagName);
            int tagId = 0;
            
            if (!tagOpt.has_value()) {
                // ã€æ­¥éª¤10.2ã€‘æ ‡ç­¾ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ ‡ç­¾
                Tag newTag;
                newTag.setName(tagName);
                newTag.setUseCount(0);
                
                if (!tagRepo_->createTag(newTag)) {
                    Logger::warning("Failed to create tag: " + tagName);
                    continue;  // è·³è¿‡æ­¤æ ‡ç­¾ï¼Œä¸å½±å“å¸–å­åˆ›å»º
                }
                
                // é‡æ–°æŸ¥è¯¢è·å–æ ‡ç­¾ID
                tagOpt = tagRepo_->findByName(tagName);
                if (!tagOpt.has_value()) {
                    Logger::warning("Failed to retrieve created tag: " + tagName);
                    continue;
                }
            }
            
            tagId = tagOpt->getId();
            
            // ã€æ­¥éª¤10.3ã€‘å…³è”å¸–å­å’Œæ ‡ç­¾ï¼ˆæ’å…¥post_tagsè¡¨ï¼‰
            if (!tagRepo_->linkPostTag(post.getId(), tagId)) {
                Logger::warning("Failed to link post and tag: " + tagName);
                continue;
            }
            
            // ã€æ­¥éª¤10.4ã€‘å¢åŠ æ ‡ç­¾ä½¿ç”¨æ¬¡æ•°
            tagRepo_->incrementUseCount(tagId);
            Logger::info("Tag linked successfully: " + tagName);
        }
```

**æ ‡ç­¾ç³»ç»Ÿè®¾è®¡**ï¼š

**æ•°æ®åº“è¡¨ç»“æ„**ï¼š
```sql
-- tagsè¡¨
CREATE TABLE tags (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) UNIQUE NOT NULL,
    use_count INT DEFAULT 0,
    INDEX idx_name (name),
    INDEX idx_use_count (use_count)
);

-- post_tagså…³è”è¡¨
CREATE TABLE post_tags (
    post_id INT NOT NULL,
    tag_id INT NOT NULL,
    PRIMARY KEY (post_id, tag_id),
    FOREIGN KEY (post_id) REFERENCES posts(id) ON DELETE CASCADE,
    FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE
);
```

**ä¸šåŠ¡é€»è¾‘**ï¼š
- æ ‡ç­¾ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»º
- ä½¿ç”¨`use_count`ç»Ÿè®¡æ ‡ç­¾çƒ­åº¦
- åˆ é™¤å¸–å­æ—¶è‡ªåŠ¨è§£é™¤æ ‡ç­¾å…³è”ï¼ˆçº§è”åˆ é™¤ï¼‰
- æ ‡ç­¾å¤±è´¥ä¸å½±å“å¸–å­åˆ›å»ºï¼ˆå®¹é”™æ€§ï¼‰

#### 7.2.8 æŸ¥è¯¢å®Œæ•´å¸–å­ä¿¡æ¯

```cpp
        // ã€æ­¥éª¤11ã€‘æŸ¥è¯¢å®Œæ•´å¸–å­ä¿¡æ¯ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
        auto postWithImages = postRepo_->findByPostIdWithImages(postId);
        if (!postWithImages.has_value()) {
            // æŸ¥è¯¢å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹postå¯¹è±¡
            result.success = true;
            result.message = "å¸–å­åˆ›å»ºæˆåŠŸï¼ˆå›¾ç‰‡åŠ è½½å¤±è´¥ï¼‰";
            result.post = post;
            Logger::warning("Post created but failed to load with images");
            return result;
        }
        
        // ã€æ­¥éª¤12ã€‘è¿”å›æˆåŠŸç»“æœ
        result.success = true;
        result.message = "å¸–å­åˆ›å»ºæˆåŠŸ";
        result.post = *postWithImages;  // åŒ…å«æ‰€æœ‰å›¾ç‰‡çš„å®Œæ•´Postå¯¹è±¡
        Logger::info("Post created successfully: " + postId);
        return result;
        
    } catch (const std::exception& e) {
        result.message = "åˆ›å»ºå¸–å­å¼‚å¸¸: " + std::string(e.what());
        Logger::error(result.message);
        return result;
    }
}
```

**ä¸ºä»€ä¹ˆè¦é‡æ–°æŸ¥è¯¢ï¼Ÿ**
- ç¡®ä¿è¿”å›çš„æ•°æ®ä¸æ•°æ®åº“ä¸€è‡´
- è·å–å®Œæ•´çš„å›¾ç‰‡åˆ—è¡¨ï¼ˆåŒ…å«æ–‡ä»¶è·¯å¾„ã€å°ºå¯¸ç­‰ï¼‰
- è·å–ç”¨æˆ·é€»è¾‘IDï¼ˆé€šè¿‡LEFT JOIN usersè¡¨ï¼‰
- æä¾›å®Œæ•´çš„å¸–å­ä¿¡æ¯ç»™å‰ç«¯

### 7.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯æ–¹æ³•

#### 7.3.1 recalculateImageCountæ–¹æ³•

**æ–‡ä»¶**ï¼š`src/core/post_service.cpp`

```cpp
bool PostService::recalculateImageCount(const std::string& postId) {
    try {
        Logger::info("Recalculating image count for post: " + postId);
        
        // ã€æ­¥éª¤1ã€‘éªŒè¯å¸–å­æ˜¯å¦å­˜åœ¨
        auto postOpt = postRepo_->findByPostId(postId);
        if (!postOpt.has_value()) {
            Logger::error("Post not found for image count recalculation: " + postId);
            return false;
        }
        
        // ã€æ­¥éª¤2ã€‘è·å–å®é™…çš„å›¾ç‰‡æ•°é‡
        std::vector<Image> images = imageRepo_->findByPostId(postOpt->getId());
        int actualCount = static_cast<int>(images.size());
        
        // ã€æ­¥éª¤3ã€‘æ›´æ–°å›¾ç‰‡æ•°é‡
        if (updateImageCount(postId, actualCount)) {
            Logger::info("Image count recalculated successfully: " + postId + 
                        " -> " + std::to_string(actualCount));
            return true;
        } else {
            Logger::error("Failed to update image count after recalculation: " + postId);
            return false;
        }
        
    } catch (const std::exception& e) {
        Logger::error("Exception in recalculateImageCount: " + std::string(e.what()));
        return false;
    }
}
```

**ä½¿ç”¨åœºæ™¯**ï¼š
- åˆ é™¤å›¾ç‰‡åé‡æ–°è®¡ç®—
- æ·»åŠ å›¾ç‰‡åé‡æ–°è®¡ç®—
- æ•°æ®ä¿®å¤è„šæœ¬

#### 7.3.2 äº‹åŠ¡ä¿æŠ¤ï¼ˆåˆ é™¤å›¾ç‰‡ç¤ºä¾‹ï¼‰

```cpp
bool PostService::removeImageFromPost(
    const std::string& postId,
    const std::string& imageId,
    int userId
) {
    Logger::info("Removing image from post: postId=" + postId + 
                ", imageId=" + imageId + 
                ", userId=" + std::to_string(userId));
    
    // ä½¿ç”¨äº‹åŠ¡ä¿æŠ¤æ•´ä¸ªæ“ä½œ
    return executeInTransaction([this, postId, imageId, userId](MYSQL* conn) -> bool {
        // ã€æ­¥éª¤1ã€‘éªŒè¯å¸–å­æ‰€æœ‰æƒ
        if (!checkOwnership(postId, userId)) {
            Logger::warning("User " + std::to_string(userId) + 
                          " does not own post " + postId);
            return false;  // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
        }
        
        // ã€æ­¥éª¤2ã€‘æŸ¥è¯¢å¸–å­ä¿¡æ¯
        auto postOpt = postRepo_->findByPostId(postId);
        if (!postOpt.has_value()) {
            Logger::error("Post not found: " + postId);
            return false;  // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
        }
        
        Post post = *postOpt;
        
        // ã€æ­¥éª¤3ã€‘æ£€æŸ¥å½“å‰å›¾ç‰‡æ•°é‡ï¼ˆè‡³å°‘è¦ä¿ç•™1å¼ ï¼‰
        int currentImageCount = post.getImageCount();
        if (currentImageCount <= 1) {
            Logger::warning("Cannot remove last image from post (minimum 1 required)");
            return false;  // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
        }
        
        // ã€æ­¥éª¤4ã€‘åˆ é™¤å›¾ç‰‡
        if (!imageService_->deleteImage(imageId, userId)) {
            Logger::error("Failed to delete image: " + imageId);
            return false;  // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
        }
        
        // ã€æ­¥éª¤5ã€‘é‡æ–°è®¡ç®—å¹¶æ›´æ–°å¸–å­çš„å›¾ç‰‡æ•°é‡
        if (!recalculateImageCount(postId)) {
            Logger::error("Failed to recalculate post image count");
            return false;  // äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
        }
        
        Logger::info("Image removed successfully from post: " + postId);
        return true;  // æäº¤äº‹åŠ¡
    });
}
```

**executeInTransactionå®ç°**ï¼ˆç¬¬7å±‚ï¼‰ï¼š

```cpp
bool executeInTransaction(std::function<bool(MYSQL*)> operation) {
    ConnectionGuard connGuard(DatabaseConnectionPool::getInstance());
    if (!connGuard.isValid()) {
        return false;
    }
    
    MYSQL* conn = connGuard.get();
    
    // å¼€å¯äº‹åŠ¡
    if (mysql_query(conn, "START TRANSACTION") != 0) {
        return false;
    }
    
    // æ‰§è¡Œæ“ä½œ
    bool success = operation(conn);
    
    // æäº¤æˆ–å›æ»š
    if (success) {
        mysql_query(conn, "COMMIT");
    } else {
        mysql_query(conn, "ROLLBACK");
    }
    
    return success;
}
```

**äº‹åŠ¡ä¼˜åŠ¿**ï¼š
- âœ… åŸå­æ€§ï¼šæ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… ä¸€è‡´æ€§ï¼šä¿è¯æ•°æ®çš„å®Œæ•´æ€§çº¦æŸ
- âœ… éš”ç¦»æ€§ï¼šå¹¶å‘æ“ä½œä¸ä¼šç›¸äº’å¹²æ‰°
- âœ… æŒä¹…æ€§ï¼šæäº¤åæ•°æ®æ°¸ä¹…ä¿å­˜

---

## 8. ç¬¬5å±‚ï¼šæ•°æ®è®¿é—®å±‚

æ•°æ®è®¿é—®å±‚è´Ÿè´£ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œå±è”½SQLç»†èŠ‚ï¼Œä¸ºä¸Šå±‚æä¾›é¢å‘å¯¹è±¡çš„æ•°æ®è®¿é—®æ¥å£ã€‚

### 8.1 PostRepositoryç±»è®¾è®¡

**æ–‡ä»¶**ï¼š`src/database/post_repository.h`

```cpp
class PostRepository {
public:
    PostRepository();
    ~PostRepository() = default;
    
    /**
     * @brief åˆ›å»ºå¸–å­è®°å½•
     * @param post å¸–å­å¯¹è±¡ï¼ˆä¼šè‡ªåŠ¨è®¾ç½®idï¼‰
     * @return æˆåŠŸè¿”å›true
     */
    bool createPost(Post& post);
    
    /**
     * @brief æ ¹æ®ä¸šåŠ¡IDæŸ¥æ‰¾å¸–å­
     * @param postId ä¸šåŠ¡é€»è¾‘IDï¼ˆå¦‚POST_2025Q4_ABC123ï¼‰
     * @return Postå¯¹è±¡ï¼ˆåŒ…å«ç”¨æˆ·é€»è¾‘IDï¼‰
     */
    std::optional<Post> findByPostId(const std::string& postId);
    
    /**
     * @brief æ ¹æ®ä¸šåŠ¡IDæŸ¥æ‰¾å¸–å­ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
     * @param postId ä¸šåŠ¡é€»è¾‘ID
     * @return Postå¯¹è±¡ï¼ˆåŒ…å«imagesï¼‰
     */
    std::optional<Post> findByPostIdWithImages(const std::string& postId);
    
    /**
     * @brief æ›´æ–°å¸–å­ä¿¡æ¯
     * @param post å¸–å­å¯¹è±¡
     * @return æˆåŠŸè¿”å›true
     */
    bool updatePost(const Post& post);
    
    /**
     * @brief åˆ é™¤å¸–å­ï¼ˆçº§è”åˆ é™¤å›¾ç‰‡ï¼‰
     * @param postId ä¸šåŠ¡é€»è¾‘ID
     * @return æˆåŠŸè¿”å›true
     */
    bool deletePost(const std::string& postId);
};
```

### 8.2 åˆ›å»ºå¸–å­è®°å½•

**æ–‡ä»¶**ï¼š`src/database/post_repository.cpp`

```cpp
bool PostRepository::createPost(Post& post) {
    try {
        // ã€æ­¥éª¤1ã€‘è·å–æ•°æ®åº“è¿æ¥ï¼ˆä½¿ç”¨RAIIï¼‰
        ConnectionGuard connGuard(DatabaseConnectionPool::getInstance());
        if (!connGuard.isValid()) {
            Logger::error("Failed to get database connection");
            return false;
        }
        
        // ã€æ­¥éª¤2ã€‘å‡†å¤‡é¢„ç¼–è¯‘è¯­å¥
        MySQLStatement stmt(connGuard.get());
        if (!stmt.isValid()) {
            return false;
        }
        
        const char* query = 
            "INSERT INTO posts (post_id, user_id, title, description, image_count, status) "
            "VALUES (?, ?, ?, ?, ?, ?)";
        
        if (mysql_stmt_prepare(stmt.get(), query, strlen(query)) != 0) {
            Logger::error("Failed to prepare statement: " + 
                         std::string(mysql_stmt_error(stmt.get())));
            return false;
        }
        
        // ã€æ­¥éª¤3ã€‘ç»‘å®šå‚æ•°
        MYSQL_BIND bind[6];
        memset(bind, 0, sizeof(bind));
        
        // post_id (VARCHAR)
        bind[0].buffer_type = MYSQL_TYPE_STRING;
        bind[0].buffer = (char*)post.getPostId().c_str();
        bind[0].buffer_length = post.getPostId().length();
        
        // user_id (INT)
        int userId = post.getUserId();
        bind[1].buffer_type = MYSQL_TYPE_LONG;
        bind[1].buffer = &userId;
        
        // title (VARCHAR)
        bind[2].buffer_type = MYSQL_TYPE_STRING;
        bind[2].buffer = (char*)post.getTitle().c_str();
        bind[2].buffer_length = post.getTitle().length();
        
        // description (TEXT, å¯ä¸ºNULL)
        std::string description = post.getDescription();
        bool description_is_null = description.empty();
        bind[3].buffer_type = MYSQL_TYPE_STRING;
        bind[3].buffer = (char*)description.c_str();
        bind[3].buffer_length = description.length();
        bind[3].is_null = &description_is_null;  // ç©ºå€¼å¤„ç†
        
        // image_count (INT)
        int imageCount = post.getImageCount();
        bind[4].buffer_type = MYSQL_TYPE_LONG;
        bind[4].buffer = &imageCount;
        
        // status (VARCHAR)
        std::string status = Post::statusToString(post.getStatus());
        bind[5].buffer_type = MYSQL_TYPE_STRING;
        bind[5].buffer = (char*)status.c_str();
        bind[5].buffer_length = status.length();
        
        // ã€æ­¥éª¤4ã€‘ç»‘å®šå¹¶æ‰§è¡Œ
        if (mysql_stmt_bind_param(stmt.get(), bind) != 0) {
            Logger::error("Failed to bind parameters: " + 
                         std::string(mysql_stmt_error(stmt.get())));
            return false;
        }
        
        if (mysql_stmt_execute(stmt.get()) != 0) {
            Logger::error("Failed to execute statement: " + 
                         std::string(mysql_stmt_error(stmt.get())));
            return false;
        }
        
        // ã€æ­¥éª¤5ã€‘è·å–è‡ªå¢ID
        post.setId(static_cast<int>(mysql_stmt_insert_id(stmt.get())));
        
        Logger::info("Post created successfully: " + post.getPostId());
        return true;
        
    } catch (const std::exception& e) {
        Logger::error("Exception in createPost: " + std::string(e.what()));
        return false;
    }
}
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š

1. **ConnectionGuardï¼ˆRAIIæ¨¡å¼ï¼‰**ï¼š
   ```cpp
   ConnectionGuard connGuard(DatabaseConnectionPool::getInstance());
   // ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨å½’è¿˜è¿æ¥åˆ°è¿æ¥æ± 
   ```

2. **MySQLStatementï¼ˆæ™ºèƒ½æŒ‡é’ˆå°è£…ï¼‰**ï¼š
   ```cpp
   MySQLStatement stmt(connGuard.get());
   // ç¦»å¼€ä½œç”¨åŸŸæ—¶è‡ªåŠ¨è°ƒç”¨mysql_stmt_close
   ```

3. **é¢„ç¼–è¯‘è¯­å¥ï¼ˆé˜²SQLæ³¨å…¥ï¼‰**ï¼š
   ```cpp
   // âŒ é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆSQLæ³¨å…¥é£é™©ï¼‰
   std::string sql = "INSERT INTO posts (title) VALUES ('" + title + "')";
   
   // âœ… æ­£ç¡®ï¼šé¢„ç¼–è¯‘è¯­å¥ + å‚æ•°ç»‘å®š
   const char* sql = "INSERT INTO posts (title) VALUES (?)";
   mysql_stmt_prepare(stmt, sql, strlen(sql));
   mysql_stmt_bind_param(stmt, bind);
   ```

4. **NULLå€¼å¤„ç†**ï¼š
   ```cpp
   bool description_is_null = description.empty();
   bind[3].is_null = &description_is_null;  // MySQLä¼šæ’å…¥NULL
   ```

5. **è·å–è‡ªå¢ID**ï¼š
   ```cpp
   int autoIncrementId = mysql_stmt_insert_id(stmt.get());
   post.setId(autoIncrementId);  // è®¾ç½®ç‰©ç†IDä¾›åç»­ä½¿ç”¨
   ```

### 8.3 æŸ¥è¯¢å¸–å­ï¼ˆåŒ…å«ç”¨æˆ·é€»è¾‘IDï¼‰

```cpp
std::optional<Post> PostRepository::findByPostId(const std::string& postId) {
    try {
        ConnectionGuard connGuard(DatabaseConnectionPool::getInstance());
        if (!connGuard.isValid()) {
            return std::nullopt;
        }
        
        MySQLStatement stmt(connGuard.get());
        
        // ã€å…³é”®SQLã€‘ä½¿ç”¨LEFT JOINè·å–ç”¨æˆ·é€»è¾‘ID
        const char* query =
            "SELECT "
            "  p.id, p.post_id, p.user_id, p.title, p.description, "
            "  p.image_count, p.like_count, p.favorite_count, p.view_count, "
            "  p.status, p.create_time, p.update_time, "
            "  COALESCE(u.user_id, '') AS user_logical_id, "  // ç”¨æˆ·é€»è¾‘ID
            "  COALESCE(u.username, '') AS username "          // ç”¨æˆ·æ˜µç§°
            "FROM posts p "
            "LEFT JOIN users u ON p.user_id = u.id "
            "WHERE p.post_id = ?";
        
        // ... çœç•¥ç»‘å®šå’Œæ‰§è¡Œä»£ç 
        
        // ã€æ­¥éª¤ï¼šè§£æç»“æœã€‘
        if (mysql_stmt_fetch(stmt.get()) == 0) {
            Post post;
            post.setId(static_cast<int>(id));
            post.setPostId(std::string(post_id, post_id_length));
            post.setUserId(static_cast<int>(userId));
            post.setTitle(std::string(title, title_length));
            
            // è®¾ç½®ç”¨æˆ·é€»è¾‘IDï¼ˆv2.5.0æ–°å¢ï¼‰
            if (!userLogicalIdIsNull && userLogicalIdLength > 0) {
                post.setUserLogicalId(std::string(userLogicalId, userLogicalIdLength));
            }
            
            // è®¾ç½®ç”¨æˆ·æ˜µç§°ï¼ˆv2.5.1æ–°å¢ï¼‰
            if (!usernameIsNull && usernameLength > 0) {
                post.setUsername(std::string(username, usernameLength));
            }
            
            // ... è§£æå…¶ä»–å­—æ®µ
            
            return post;
        }
        
        return std::nullopt;
        
    } catch (const std::exception& e) {
        Logger::error("Exception in findByPostId: " + std::string(e.what()));
        return std::nullopt;
    }
}
```

**SQLæŸ¥è¯¢å®é™…æ‰§è¡Œ**ï¼š

```sql
SELECT 
  p.id, p.post_id, p.user_id, p.title, p.description,
  p.image_count, p.like_count, p.favorite_count, p.view_count,
  p.status, p.create_time, p.update_time,
  COALESCE(u.user_id, '') AS user_logical_id,
  COALESCE(u.username, '') AS username
FROM posts p
LEFT JOIN users u ON p.user_id = u.id
WHERE p.post_id = 'POST_2025Q4_Abc123';
```

**æŸ¥è¯¢ç»“æœç¤ºä¾‹**ï¼š

| id | post_id | user_id | title | user_logical_id | username |
|----|---------|---------|-------|----------------|----------|
| 42 | POST_2025Q4_Abc123 | 7 | æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­ | USR_2025Q4_Xyz789 | å¼ ä¸‰ |

### 8.4 æŸ¥è¯¢å¸–å­ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰

```cpp
std::optional<Post> PostRepository::findByPostIdWithImages(const std::string& postId) {
    try {
        // ã€æ­¥éª¤1ã€‘å…ˆæŸ¥è¯¢Postï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼‰
        auto postOpt = findByPostId(postId);
        if (!postOpt.has_value()) {
            return std::nullopt;
        }
        
        Post post = postOpt.value();
        
        // ã€æ­¥éª¤2ã€‘å†æŸ¥è¯¢Imagesï¼ˆå…³è”è¡¨ï¼‰
        ImageRepository imageRepo;
        std::vector<Image> images = imageRepo.findByPostId(post.getId());
        
        // ã€æ­¥éª¤3ã€‘æ·»åŠ å›¾ç‰‡åˆ°Post
        for (const auto& image : images) {
            post.addImage(image);
        }
        
        return post;
        
    } catch (const std::exception& e) {
        Logger::error("Exception in findByPostIdWithImages: " + std::string(e.what()));
        return std::nullopt;
    }
}
```

**æŸ¥è¯¢æµç¨‹**ï¼š

1. **ç¬¬1æ¬¡æŸ¥è¯¢**ï¼šè·å–å¸–å­åŸºæœ¬ä¿¡æ¯
   ```sql
   SELECT p.*, u.user_id, u.username
   FROM posts p
   LEFT JOIN users u ON p.user_id = u.id
   WHERE p.post_id = 'POST_2025Q4_Abc123';
   ```

2. **ç¬¬2æ¬¡æŸ¥è¯¢**ï¼šè·å–å…³è”çš„æ‰€æœ‰å›¾ç‰‡
   ```sql
   SELECT image_id, file_url, thumbnail_url, display_order,
          width, height, mime_type, file_size, create_time
   FROM images
   WHERE post_id = 42
   ORDER BY display_order ASC;
   ```

3. **å†…å­˜ç»„è£…**ï¼šå°†å›¾ç‰‡åˆ—è¡¨æ·»åŠ åˆ°Postå¯¹è±¡

**æ€§èƒ½ä¼˜åŒ–**ï¼šå¯¹äºæ‰¹é‡æŸ¥è¯¢ï¼ˆå¦‚Feedæµï¼‰ï¼Œä½¿ç”¨`getRecentPostsWithImagesOptimized`æ–¹æ³•ï¼Œä¸€æ¬¡LEFT JOINæŸ¥è¯¢æ‰€æœ‰æ•°æ®ï¼Œé¿å…N+1é—®é¢˜ã€‚

---

## 9. ç¬¬6å±‚ï¼šå®‰å…¨å±‚

### 9.1 JWTManager - ä»¤ç‰Œç®¡ç†

**æ–‡ä»¶**ï¼š`src/security/jwt_manager.h`

```cpp
class JWTManager {
public:
    JWTManager();
    
    /**
     * @brief ç”Ÿæˆè®¿é—®ä»¤ç‰Œ
     * @param userId ç”¨æˆ·ID
     * @return è®¿é—®ä»¤ç‰Œå­—ç¬¦ä¸²
     */
    std::string generateAccessToken(int userId);
    
    /**
     * @brief ç”Ÿæˆåˆ·æ–°ä»¤ç‰Œ
     * @param userId ç”¨æˆ·ID
     * @return åˆ·æ–°ä»¤ç‰Œå­—ç¬¦ä¸²
     */
    std::string generateRefreshToken(int userId);
    
    /**
     * @brief éªŒè¯è®¿é—®ä»¤ç‰Œ
     * @param token ä»¤ç‰Œå­—ç¬¦ä¸²
     * @return TokenValidationResultï¼ˆåŒ…å«validå’ŒuserIdï¼‰
     */
    TokenValidationResult validateAccessToken(const std::string& token);
    
private:
    std::string secret_;  // JWTå¯†é’¥ï¼ˆä»config.jsonè¯»å–ï¼‰
};

/**
 * @brief ä»¤ç‰ŒéªŒè¯ç»“æœ
 */
struct TokenValidationResult {
    bool valid;        // æ˜¯å¦æœ‰æ•ˆ
    int userId;        // ç”¨æˆ·ID
    std::string error; // é”™è¯¯ä¿¡æ¯
};
```

**æ–‡ä»¶**ï¼š`src/security/jwt_manager.cpp`

```cpp
#include "security/jwt_manager.h"
#include "utils/config_manager.h"
#include <jwt-cpp/jwt.h>

JWTManager::JWTManager() {
    // ä»é…ç½®æ–‡ä»¶è¯»å–å¯†é’¥
    secret_ = ConfigManager::getInstance().getJwtSecret();
}

std::string JWTManager::generateAccessToken(int userId) {
    auto now = std::chrono::system_clock::now();
    
    // è®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸï¼š1å°æ—¶
    auto expireTime = now + std::chrono::hours(1);
    
    auto token = jwt::create()
        .set_issuer("knot-api")                                    // ç­¾å‘è€…
        .set_type("JWT")                                           // ç±»å‹
        .set_issued_at(now)                                        // ç­¾å‘æ—¶é—´
        .set_expires_at(expireTime)                                // è¿‡æœŸæ—¶é—´
        .set_payload_claim("user_id", jwt::claim(userId))          // ç”¨æˆ·ID
        .sign(jwt::algorithm::hs256{secret_});                     // HMAC-SHA256ç­¾å
    
    return token;
}

TokenValidationResult JWTManager::validateAccessToken(const std::string& token) {
    TokenValidationResult result;
    result.valid = false;
    result.userId = 0;
    
    try {
        // ã€æ­¥éª¤1ã€‘è§£ç ä»¤ç‰Œ
        auto decoded = jwt::decode(token);
        
        // ã€æ­¥éª¤2ã€‘åˆ›å»ºéªŒè¯å™¨
        auto verifier = jwt::verify()
            .allow_algorithm(jwt::algorithm::hs256{secret_})  // éªŒè¯ç®—æ³•å’Œå¯†é’¥
            .with_issuer("knot-api");                          // éªŒè¯ç­¾å‘è€…
        
        // ã€æ­¥éª¤3ã€‘éªŒè¯ç­¾åå’Œè¿‡æœŸæ—¶é—´
        verifier.verify(decoded);
        
        // ã€æ­¥éª¤4ã€‘æå–user_id
        if (decoded.has_payload_claim("user_id")) {
            result.userId = decoded.get_payload_claim("user_id").as_int();
            result.valid = true;
        } else {
            result.error = "Missing user_id claim";
        }
        
    } catch (const jwt::token_verification_exception& e) {
        result.error = "Token verification failed: " + std::string(e.what());
    } catch (const std::exception& e) {
        result.error = "Token validation error: " + std::string(e.what());
    }
    
    return result;
}
```

**JWTä»¤ç‰Œç»“æ„**ï¼š

```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJrbm90LWFwaSIsImlhdCI6MTY5NzgxMjIxNSwiZXhwIjoxNjk3ODE1ODE1LCJ1c2VyX2lkIjo3fQ.signature

Headerï¼ˆBase64ï¼‰         Payloadï¼ˆBase64ï¼‰                     Signatureï¼ˆHMAC-SHA256ï¼‰
```

**è§£ç åçš„Payload**ï¼š

```json
{
  "iss": "knot-api",
  "iat": 1697812215,
  "exp": 1697815815,
  "user_id": 7
}
```

**å®‰å…¨ç‰¹æ€§**ï¼š
- âœ… HMAC-SHA256ç­¾åï¼Œé˜²æ­¢ä»¤ç‰Œç¯¡æ”¹
- âœ… æœ‰æ•ˆæœŸæ£€æŸ¥ï¼Œè‡ªåŠ¨æ‹’ç»è¿‡æœŸä»¤ç‰Œ
- âœ… ç­¾å‘è€…éªŒè¯ï¼Œé˜²æ­¢ä¼ªé€ ä»¤ç‰Œ
- âœ… å¯†é’¥å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹

### 9.2 PasswordHasher - å¯†ç å“ˆå¸Œ

**æ–‡ä»¶**ï¼š`src/security/password_hasher.h`

```cpp
class PasswordHasher {
public:
    /**
     * @brief å“ˆå¸Œå¯†ç 
     * @param password åŸå§‹å¯†ç 
     * @return å“ˆå¸Œç»“æœï¼ˆåŒ…å«ç›å€¼ï¼Œæ ¼å¼ï¼šsalt$hashï¼‰
     */
    static std::string hashPassword(const std::string& password);
    
    /**
     * @brief éªŒè¯å¯†ç 
     * @param password åŸå§‹å¯†ç 
     * @param hashedPassword å“ˆå¸Œç»“æœ
     * @return å¯†ç æ˜¯å¦åŒ¹é…
     */
    static bool verifyPassword(const std::string& password, 
                               const std::string& hashedPassword);
};
```

**å®ç°**ï¼š

```cpp
#include <openssl/evp.h>
#include <openssl/rand.h>

std::string PasswordHasher::hashPassword(const std::string& password) {
    // ã€æ­¥éª¤1ã€‘ç”Ÿæˆéšæœºç›å€¼ï¼ˆ16å­—èŠ‚ï¼‰
    unsigned char salt[16];
    RAND_bytes(salt, sizeof(salt));
    
    // ã€æ­¥éª¤2ã€‘PBKDF2-HMAC-SHA256å“ˆå¸Œ
    unsigned char hash[32];
    PKCS5_PBKDF2_HMAC(
        password.c_str(), password.length(),  // å¯†ç 
        salt, sizeof(salt),                   // ç›å€¼
        100000,                                // è¿­ä»£æ¬¡æ•°ï¼ˆ100,000ï¼‰
        EVP_sha256(),                          // å“ˆå¸Œç®—æ³•
        sizeof(hash), hash                     // è¾“å‡º
    );
    
    // ã€æ­¥éª¤3ã€‘è½¬æ¢ä¸ºHexå­—ç¬¦ä¸²
    std::string saltHex = bytesToHex(salt, sizeof(salt));
    std::string hashHex = bytesToHex(hash, sizeof(hash));
    
    // ã€æ­¥éª¤4ã€‘æ‹¼æ¥ï¼šsalt$hash
    return saltHex + "$" + hashHex;
}

bool PasswordHasher::verifyPassword(
    const std::string& password,
    const std::string& hashedPassword
) {
    // ã€æ­¥éª¤1ã€‘åˆ†ç¦»ç›å€¼å’Œå“ˆå¸Œ
    size_t pos = hashedPassword.find('$');
    if (pos == std::string::npos) {
        return false;
    }
    
    std::string saltHex = hashedPassword.substr(0, pos);
    std::string storedHashHex = hashedPassword.substr(pos + 1);
    
    // ã€æ­¥éª¤2ã€‘ä½¿ç”¨ç›¸åŒçš„ç›å€¼é‡æ–°å“ˆå¸Œ
    unsigned char salt[16];
    hexToBytes(saltHex, salt, sizeof(salt));
    
    unsigned char newHash[32];
    PKCS5_PBKDF2_HMAC(
        password.c_str(), password.length(),
        salt, sizeof(salt),
        100000,
        EVP_sha256(),
        sizeof(newHash), newHash
    );
    
    std::string newHashHex = bytesToHex(newHash, sizeof(newHash));
    
    // ã€æ­¥éª¤3ã€‘æ¯”è¾ƒå“ˆå¸Œå€¼
    return newHashHex == storedHashHex;
}
```

**å¯†ç å“ˆå¸Œç¤ºä¾‹**ï¼š

```
åŸå§‹å¯†ç ï¼šmypassword123
ç›å€¼ï¼ˆHexï¼‰ï¼ša1b2c3d4e5f67890a1b2c3d4e5f67890
å“ˆå¸Œï¼ˆHexï¼‰ï¼šf3e2d1c0b9a8f7e6d5c4b3a2918f0e8d7c6b5a49382716f5e4d3c2b1a0f9e8d7
å­˜å‚¨æ ¼å¼ï¼ša1b2c3d4e5f67890a1b2c3d4e5f67890$f3e2d1c0b9a8f7e6d5c4b3a2918f0e8d7c6b5a49382716f5e4d3c2b1a0f9e8d7
```

**å®‰å…¨ç‰¹æ€§**ï¼š
- âœ… æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ç›å€¼ï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»
- âœ… 100,000æ¬¡è¿­ä»£ï¼Œå¢åŠ æš´åŠ›ç ´è§£æˆæœ¬
- âœ… SHA-256ç®—æ³•ï¼Œå¯†ç å­¦å®‰å…¨
- âœ… ç›å€¼å’Œå“ˆå¸Œä¸€èµ·å­˜å‚¨ï¼Œæ–¹ä¾¿éªŒè¯

---

## 10. ç¬¬7å±‚ï¼šåŸºç¡€è®¾æ–½å±‚

### 10.1 ConnectionPool - æ•°æ®åº“è¿æ¥æ± 

**æ–‡ä»¶**ï¼š`src/database/connection_pool.h`

```cpp
class DatabaseConnectionPool {
public:
    static DatabaseConnectionPool& getInstance();
    
    /**
     * @brief è·å–æ•°æ®åº“è¿æ¥
     * @return MYSQLè¿æ¥æŒ‡é’ˆï¼Œå¤±è´¥è¿”å›nullptr
     */
    MYSQL* getConnection();
    
    /**
     * @brief å½’è¿˜è¿æ¥åˆ°è¿æ¥æ± 
     * @param conn MYSQLè¿æ¥æŒ‡é’ˆ
     */
    void returnConnection(MYSQL* conn);
    
private:
    std::vector<MYSQL*> connections_;       // è¿æ¥åˆ—è¡¨
    std::queue<MYSQL*> availableConnections_; // å¯ç”¨è¿æ¥é˜Ÿåˆ—
    std::mutex mutex_;                      // äº’æ–¥é”
    std::condition_variable condition_;     // æ¡ä»¶å˜é‡
    int poolSize_;                          // è¿æ¥æ± å¤§å°
};
```

**å®ç°**ï¼š

```cpp
DatabaseConnectionPool& DatabaseConnectionPool::getInstance() {
    static DatabaseConnectionPool instance;
    return instance;
}

MYSQL* DatabaseConnectionPool::getConnection() {
    std::unique_lock<std::mutex> lock(mutex_);
    
    // ã€æ­¥éª¤1ã€‘ç­‰å¾…å¯ç”¨è¿æ¥
    condition_.wait(lock, [this] {
        return !availableConnections_.empty();
    });
    
    // ã€æ­¥éª¤2ã€‘ä»é˜Ÿåˆ—å–å‡ºè¿æ¥
    MYSQL* conn = availableConnections_.front();
    availableConnections_.pop();
    
    // ã€æ­¥éª¤3ã€‘æ£€æŸ¥è¿æ¥æ˜¯å¦å­˜æ´»
    if (mysql_ping(conn) != 0) {
        Logger::warning("Connection lost, reconnecting...");
        mysql_close(conn);
        conn = createConnection();  // é‡æ–°åˆ›å»ºè¿æ¥
    }
    
    return conn;
}

void DatabaseConnectionPool::returnConnection(MYSQL* conn) {
    std::unique_lock<std::mutex> lock(mutex_);
    
    // å½’è¿˜è¿æ¥åˆ°é˜Ÿåˆ—
    availableConnections_.push(conn);
    
    // é€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹
    condition_.notify_one();
}
```

**è¿æ¥æ± å·¥ä½œæµç¨‹**ï¼š

**æ–‡æœ¬ç‰ˆæœ¬**ï¼š

```
åˆå§‹åŒ–ï¼šåˆ›å»º10ä¸ªMySQLè¿æ¥ï¼Œå…¨éƒ¨æ”¾å…¥availableConnections_é˜Ÿåˆ—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread 1    â”‚â”€â”€â”€â”€getConnection()â”€â”€â”€â†’ ä»é˜Ÿåˆ—å–å‡ºconn1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â†“
                                    ä½¿ç”¨conn1æŸ¥è¯¢
                                        â†“
                                    returnConnection(conn1)
                                        â†“
                                    conn1å›åˆ°é˜Ÿåˆ—

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Thread 2    â”‚â”€â”€â”€â”€getConnection()â”€â”€â”€â†’ ç­‰å¾…ï¼ˆé˜Ÿåˆ—ä¸ºç©ºï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â†“
                                    Thread 1å½’è¿˜å
                                        â†“
                                    è·å–conn1ï¼ˆè¢«å”¤é†’ï¼‰
```

**Mermaidç‰ˆæœ¬**ï¼ˆæ”¯æŒMermaidçš„ç¯å¢ƒå¯æ¸²æŸ“ï¼‰ï¼š

```mermaid
graph TB
    Init["åˆå§‹åŒ–ï¼šåˆ›å»º10ä¸ªMySQLè¿æ¥<br/>å…¨éƒ¨æ”¾å…¥availableConnections_é˜Ÿåˆ—"]
    
    T1Start["Thread 1: getConnection()"]
    T1Get["ä»é˜Ÿåˆ—å–å‡ºconn1"]
    T1Use["ä½¿ç”¨conn1æŸ¥è¯¢"]
    T1Return["returnConnection(conn1)"]
    T1Back["conn1å›åˆ°é˜Ÿåˆ—"]
    
    T2Start["Thread 2: getConnection()"]
    T2Wait["ç­‰å¾…ï¼ˆé˜Ÿåˆ—ä¸ºç©ºï¼‰"]
    T2Wake["Thread 1å½’è¿˜å"]
    T2Get["è·å–conn1ï¼ˆè¢«å”¤é†’ï¼‰"]
    
    Init --> T1Start
    Init --> T2Start
    T1Start --> T1Get
    T1Get --> T1Use
    T1Use --> T1Return
    T1Return --> T1Back
    T1Back -.é€šçŸ¥.-> T2Wake
    
    T2Start --> T2Wait
    T2Wait --> T2Wake
    T2Wake --> T2Get
```

**ä¼˜åŠ¿**ï¼š
- âœ… é¿å…é¢‘ç¹åˆ›å»º/é”€æ¯è¿æ¥ï¼ˆæ˜‚è´µæ“ä½œï¼‰
- âœ… é™åˆ¶æœ€å¤§è¿æ¥æ•°ï¼Œé˜²æ­¢æ•°æ®åº“è¿‡è½½
- âœ… è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œæé«˜å¯ç”¨æ€§
- âœ… çº¿ç¨‹å®‰å…¨ï¼Œæ”¯æŒå¹¶å‘è®¿é—®

### 10.2 Logger - æ—¥å¿—ç³»ç»Ÿ

**æ–‡ä»¶**ï¼š`src/utils/logger.h`

```cpp
class Logger {
public:
    static void init(const std::string& logFile);
    
    static void debug(const std::string& message);
    static void info(const std::string& message);
    static void warning(const std::string& message);
    static void error(const std::string& message);
    static void fatal(const std::string& message);
};
```

**åŸºäºspdlogå®ç°**ï¼š

```cpp
#include <spdlog/spdlog.h>
#include <spdlog/sinks/rotating_file_sink.h>
#include <spdlog/sinks/stdout_color_sinks.h>

void Logger::init(const std::string& logFile) {
    // ã€æ­¥éª¤1ã€‘åˆ›å»ºæ–‡ä»¶æ—¥å¿—ï¼ˆæ¯10MBè½®æ¢ï¼Œä¿ç•™3ä¸ªæ–‡ä»¶ï¼‰
    auto fileSink = std::make_shared<spdlog::sinks::rotating_file_sink_mt>(
        logFile, 10 * 1024 * 1024, 3
    );
    
    // ã€æ­¥éª¤2ã€‘åˆ›å»ºæ§åˆ¶å°æ—¥å¿—ï¼ˆå½©è‰²è¾“å‡ºï¼‰
    auto consoleSink = std::make_shared<spdlog::sinks::stdout_color_sink_mt>();
    
    // ã€æ­¥éª¤3ã€‘ç»„åˆä¸¤ä¸ªsink
    std::vector<spdlog::sink_ptr> sinks {fileSink, consoleSink};
    auto logger = std::make_shared<spdlog::logger>("main", sinks.begin(), sinks.end());
    
    // ã€æ­¥éª¤4ã€‘è®¾ç½®æ—¥å¿—çº§åˆ«å’Œæ ¼å¼
    logger->set_level(spdlog::level::debug);
    logger->set_pattern("[%Y-%m-%d %H:%M:%S.%e] [%^%l%$] [%t] %v");
    
    // ã€æ­¥éª¤5ã€‘è®¾ç½®ä¸ºé»˜è®¤logger
    spdlog::set_default_logger(logger);
}

void Logger::info(const std::string& message) {
    spdlog::info(message);
}
```

**æ—¥å¿—è¾“å‡ºç¤ºä¾‹**ï¼š

```
[2025-10-20 14:30:15.123] [info] [1234] Creating post for user ID: 7
[2025-10-20 14:30:15.156] [info] [1234] Generated post ID: POST_2025Q4_Abc123
[2025-10-20 14:30:15.189] [info] [1234] Processing image 1/3
[2025-10-20 14:30:15.456] [info] [1234] Image saved successfully: IMG_2025Q4_Xyz789
[2025-10-20 14:30:15.489] [info] [1234] Post created successfully: POST_2025Q4_Abc123
```

**æ—¥å¿—çº§åˆ«**ï¼š
- `debug`ï¼šè°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
- `info`ï¼šæ­£å¸¸æµç¨‹ä¿¡æ¯
- `warning`ï¼šè­¦å‘Šä¿¡æ¯ï¼ˆå¯æ¢å¤é”™è¯¯ï¼‰
- `error`ï¼šé”™è¯¯ä¿¡æ¯ï¼ˆæ“ä½œå¤±è´¥ï¼‰
- `fatal`ï¼šè‡´å‘½é”™è¯¯ï¼ˆç¨‹åºå´©æºƒï¼‰

---

## 11. ç¬¬8å±‚ï¼šæ•°æ®æ¨¡å‹å±‚

### 11.1 Postæ¨¡å‹ç±»

**æ–‡ä»¶**ï¼š`src/models/post.h`

```cpp
enum class PostStatus {
    PENDING,     // å¾…å®¡æ ¸
    APPROVED,    // å·²é€šè¿‡
    REJECTED     // å·²æ‹’ç»
};

class Post {
public:
    Post();
    ~Post() = default;
    
    // Getters
    int getId() const { return id_; }
    const std::string& getPostId() const { return postId_; }
    int getUserId() const { return userId_; }
    const std::string& getUserLogicalId() const { return userLogicalId_; }
    const std::string& getUsername() const { return username_; }
    const std::string& getTitle() const { return title_; }
    // ... å…¶ä»–getters
    
    // Setters
    void setId(int id) { id_ = id; }
    void setPostId(const std::string& postId) { postId_ = postId; }
    // ... å…¶ä»–setters
    
    /**
     * @brief æ·»åŠ å›¾ç‰‡åˆ°å¸–å­
     */
    void addImage(const Image& image);
    
    /**
     * @brief è½¬æ¢ä¸ºJSON
     * @param includeImages æ˜¯å¦åŒ…å«å›¾ç‰‡åˆ—è¡¨
     */
    Json::Value toJson(bool includeImages = true) const;
    
    /**
     * @brief ä»JSONåˆ›å»ºPostå¯¹è±¡
     */
    static Post fromJson(const Json::Value& json);
    
    /**
     * @brief æ•°æ®éªŒè¯
     */
    std::string validate() const;
    
private:
    int id_;                      // ç‰©ç†IDï¼ˆè‡ªå¢ä¸»é”®ï¼‰
    std::string postId_;          // ä¸šåŠ¡é€»è¾‘ID
    int userId_;                  // å‘å¸ƒç”¨æˆ·ç‰©ç†ID
    std::string userLogicalId_;   // å‘å¸ƒç”¨æˆ·é€»è¾‘ID
    std::string username_;        // å‘å¸ƒç”¨æˆ·æ˜µç§°
    std::string title_;           // æ ‡é¢˜
    std::string description_;     // æè¿°
    int imageCount_;              // å›¾ç‰‡æ•°é‡
    int likeCount_;               // ç‚¹èµæ•°
    int favoriteCount_;           // æ”¶è—æ•°
    int commentCount_;            // è¯„è®ºæ•°
    int viewCount_;               // æµè§ˆæ•°
    PostStatus status_;           // å®¡æ ¸çŠ¶æ€
    std::time_t createTime_;      // åˆ›å»ºæ—¶é—´
    std::time_t updateTime_;      // æ›´æ–°æ—¶é—´
    std::vector<Image> images_;   // å…³è”çš„å›¾ç‰‡åˆ—è¡¨
};
```

### 11.2 toJsonå®ç°

**æ–‡ä»¶**ï¼š`src/models/post.cpp`

```cpp
Json::Value Post::toJson(bool includeImages) const {
    Json::Value json;
    
    json["id"] = id_;
    json["post_id"] = postId_;
    json["user_id"] = userLogicalId_;  // è¿”å›é€»è¾‘IDï¼ˆå‰ç«¯ä½¿ç”¨ï¼‰
    json["username"] = username_;      // è¿”å›ç”¨æˆ·æ˜µç§°
    json["title"] = title_;
    json["description"] = description_;
    json["image_count"] = imageCount_;
    json["like_count"] = likeCount_;
    json["favorite_count"] = favoriteCount_;
    json["comment_count"] = commentCount_;
    json["view_count"] = viewCount_;
    json["status"] = statusToString(status_);
    json["create_time"] = static_cast<Json::Int64>(createTime_);
    json["update_time"] = static_cast<Json::Int64>(updateTime_);
    
    // æ·»åŠ å°é¢å›¾ç‰‡URL
    std::string coverUrl = getCoverImageUrl();
    if (!coverUrl.empty()) {
        json["cover_image_url"] = coverUrl;
    }
    
    // å¦‚æœéœ€è¦åŒ…å«å›¾ç‰‡åˆ—è¡¨
    if (includeImages && !images_.empty()) {
        Json::Value imagesArray(Json::arrayValue);
        for (const auto& image : images_) {
            imagesArray.append(image.toJson());  // è°ƒç”¨Image::toJson()
        }
        json["images"] = imagesArray;
    }
    
    return json;
}
```

**JSONè¾“å‡ºç¤ºä¾‹**ï¼š

```json
{
  "id": 42,
  "post_id": "POST_2025Q4_Abc123",
  "user_id": "USR_2025Q4_Xyz789",
  "username": "å¼ ä¸‰",
  "title": "æˆ‘çš„ç¬¬ä¸€ç¯‡å¸–å­",
  "description": "ä»Šå¤©å¤©æ°”çœŸå¥½ï¼",
  "image_count": 3,
  "like_count": 0,
  "favorite_count": 0,
  "comment_count": 0,
  "view_count": 0,
  "status": "APPROVED",
  "create_time": 1697812215,
  "update_time": 1697812215,
  "cover_image_url": "https://api.knot.com/uploads/images/2025Q4/IMG_2025Q4_001_thumb.jpg",
  "images": [
    {
      "image_id": "IMG_2025Q4_001",
      "display_order": 0,
      "file_url": "https://api.knot.com/uploads/images/2025Q4/IMG_2025Q4_001.jpg",
      "thumbnail_url": "https://api.knot.com/uploads/images/2025Q4/IMG_2025Q4_001_thumb.jpg",
      "width": 1920,
      "height": 1080,
      "mime_type": "image/jpeg",
      "file_size": 524288,
      "create_time": 1697812215
    }
  ]
}
```

---

## 12. ç¬¬9å±‚ï¼šæ•°æ®åº“å±‚

### 12.1 æ•°æ®åº“è¡¨ç»“æ„

#### 12.1.1 postsè¡¨

**æ–‡ä»¶**ï¼š`config/database.sql`

```sql
CREATE TABLE posts (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç‰©ç†ID',
    post_id VARCHAR(255) UNIQUE NOT NULL COMMENT 'ä¸šåŠ¡é€»è¾‘ID (POST_2025Q4_Abc123)',
    user_id INT NOT NULL COMMENT 'å‘å¸ƒç”¨æˆ·ID (å¤–é”®)',
    title VARCHAR(255) NOT NULL COMMENT 'æ ‡é¢˜',
    description TEXT COMMENT 'æè¿°',
    image_count INT DEFAULT 0 COMMENT 'å›¾ç‰‡æ•°é‡',
    like_count INT DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
    favorite_count INT DEFAULT 0 COMMENT 'æ”¶è—æ•°',
    comment_count INT DEFAULT 0 COMMENT 'è¯„è®ºæ•°',
    view_count INT DEFAULT 0 COMMENT 'æµè§ˆæ•°',
    status VARCHAR(20) DEFAULT 'APPROVED' COMMENT 'å®¡æ ¸çŠ¶æ€',
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    INDEX idx_post_id (post_id),
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_create_time (create_time),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='å¸–å­ä¿¡æ¯è¡¨';
```

**å…³é”®è®¾è®¡ç‚¹**ï¼š

1. **åŒIDè®¾è®¡**ï¼š
   - `id`ï¼šç‰©ç†IDï¼ˆè‡ªå¢ä¸»é”®ï¼‰ï¼Œç”¨äºæ•°æ®åº“å†…éƒ¨å…³è”
   - `post_id`ï¼šä¸šåŠ¡é€»è¾‘IDï¼Œç”¨äºAPIå’Œå‰ç«¯å±•ç¤º

2. **ç´¢å¼•ç­–ç•¥**ï¼š
   - `idx_post_id`ï¼šæ”¯æŒAPIæŸ¥è¯¢ï¼ˆWHERE post_id = ?ï¼‰
   - `idx_user_id`ï¼šæ”¯æŒç”¨æˆ·å¸–å­åˆ—è¡¨ï¼ˆWHERE user_id = ?ï¼‰
   - `idx_status`ï¼šæ”¯æŒæŒ‰çŠ¶æ€ç­›é€‰
   - `idx_create_time`ï¼šæ”¯æŒæ—¶é—´æ’åºï¼ˆORDER BY create_time DESCï¼‰

3. **å¤–é”®çº§è”åˆ é™¤**ï¼š
   - åˆ é™¤ç”¨æˆ·æ—¶è‡ªåŠ¨åˆ é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰å¸–å­
   - `ON DELETE CASCADE`

---

## 13. å…³é”®è®¾è®¡æ¨¡å¼

### 13.1 RAIIï¼ˆResource Acquisition Is Initializationï¼‰

**åŸç†**ï¼šèµ„æºçš„è·å–å’Œé‡Šæ”¾ç»‘å®šåˆ°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚

**åº”ç”¨åœºæ™¯**ï¼šæ•°æ®åº“è¿æ¥ç®¡ç†

```cpp
class ConnectionGuard {
public:
    explicit ConnectionGuard(DatabaseConnectionPool& pool)
        : pool_(pool), conn_(pool.getConnection()) {
        Logger::debug("Connection acquired");
    }
    
    ~ConnectionGuard() {
        if (conn_) {
            pool_.returnConnection(conn_);
            Logger::debug("Connection returned");
        }
    }
    
    MYSQL* get() const { return conn_; }
    bool isValid() const { return conn_ != nullptr; }
    
    // ç¦æ­¢æ‹·è´å’Œèµ‹å€¼
    ConnectionGuard(const ConnectionGuard&) = delete;
    ConnectionGuard& operator=(const ConnectionGuard&) = delete;
    
private:
    DatabaseConnectionPool& pool_;
    MYSQL* conn_;
};
```

**ä¼˜åŠ¿**ï¼š
- âœ… è‡ªåŠ¨èµ„æºç®¡ç†ï¼Œé˜²æ­¢æ³„æ¼
- âœ… å¼‚å¸¸å®‰å…¨ï¼Œå³ä½¿æŠ›å‡ºå¼‚å¸¸ä¹Ÿèƒ½æ­£ç¡®é‡Šæ”¾
- âœ… ä»£ç ç®€æ´ï¼Œæ— éœ€æ‰‹åŠ¨é‡Šæ”¾

---

## 14. æ€»ç»“ä¸å­¦ä¹ è·¯å¾„

### 14.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾

**ä¹å±‚æ¶æ„çš„ç²¾é«“**ï¼š
1. **èŒè´£æ¸…æ™°**ï¼šæ¯å±‚åªåšè‡ªå·±è¯¥åšçš„äº‹
2. **å•å‘ä¾èµ–**ï¼šåªèƒ½ä¸Šå±‚è°ƒç”¨ä¸‹å±‚
3. **ä½è€¦åˆ**ï¼šé€šè¿‡æ¥å£å’Œæ•°æ®æ¨¡å‹äº¤äº’
4. **é«˜å†…èš**ï¼šç›¸å…³åŠŸèƒ½é›†ä¸­åœ¨åŒä¸€å±‚

**åˆ›å»ºå¸–å­APIçš„å…³é”®æŠ€æœ¯**ï¼š
1. **JWTè®¤è¯**ï¼šå®‰å…¨çš„èº«ä»½éªŒè¯æœºåˆ¶
2. **multipart/JSONåŒæ ¼å¼æ”¯æŒ**ï¼šé€‚åº”ä¸åŒå®¢æˆ·ç«¯
3. **å›¾ç‰‡å¤„ç†**ï¼šå‹ç¼©ã€ç¼©ç•¥å›¾ã€æ ¼å¼è½¬æ¢
4. **æ•°æ®åº“äº‹åŠ¡**ï¼šä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **RAIIæ¨¡å¼**ï¼šè‡ªåŠ¨èµ„æºç®¡ç†
6. **é¢„ç¼–è¯‘è¯­å¥**ï¼šé˜²æ­¢SQLæ³¨å…¥
7. **è¿æ¥æ± **ï¼šæå‡æ•°æ®åº“æ€§èƒ½
8. **åŒIDè®¾è®¡**ï¼šç‰©ç†ID + ä¸šåŠ¡é€»è¾‘ID

### 14.2 æ–°äººå­¦ä¹ è·¯å¾„

**ç¬¬1å‘¨ï¼šç†Ÿæ‚‰åŸºç¡€è®¾æ–½å±‚ï¼ˆç¬¬7å±‚ï¼‰**
- å­¦ä¹ è¿æ¥æ± çš„å·¥ä½œåŸç†
- ç†è§£RAIIæ¨¡å¼
- ç†Ÿæ‚‰æ—¥å¿—ç³»ç»Ÿçš„ä½¿ç”¨

**ç¬¬2å‘¨ï¼šæŒæ¡æ•°æ®æ¨¡å‹å±‚ï¼ˆç¬¬8å±‚ï¼‰å’Œæ•°æ®è®¿é—®å±‚ï¼ˆç¬¬5å±‚ï¼‰**
- å­¦ä¹ Postã€Imageæ¨¡å‹ç±»
- ç†è§£Repositoryçš„è®¾è®¡
- ç»ƒä¹ ç¼–å†™é¢„ç¼–è¯‘SQLè¯­å¥

**ç¬¬3å‘¨ï¼šå­¦ä¹ ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆç¬¬4å±‚ï¼‰**
- ç ”ç©¶PostServiceçš„å®ç°
- ç†è§£ä¸šåŠ¡è§„åˆ™éªŒè¯
- å­¦ä¹ äº‹åŠ¡ç®¡ç†

**ç¬¬4å‘¨ï¼šç†è§£APIæ¥å£å±‚ï¼ˆç¬¬3å±‚ï¼‰**
- å­¦ä¹ Handlerçš„è·¯ç”±æ³¨å†Œ
- ç†è§£JWTéªŒè¯æµç¨‹
- ç»ƒä¹ å“åº”å°è£…

**ç¬¬5å‘¨ï¼šç»¼åˆå®æˆ˜**
- ç‹¬ç«‹å®ç°ä¸€ä¸ªç®€å•APIï¼ˆå¦‚è·å–å¸–å­è¯¦æƒ…ï¼‰
- ä»Handler â†’ Service â†’ Repository â†’ Database
- å®Œæˆå•å…ƒæµ‹è¯•

### 14.3 ç»“è¯­

é€šè¿‡æœ¬æ–‡æ¡£ï¼Œä½ å·²ç»å­¦ä¹ äº†ï¼š
- âœ… ä¹å±‚æ¶æ„çš„è®¾è®¡ç†å¿µå’Œå®ç°ç»†èŠ‚
- âœ… åˆ›å»ºå¸–å­APIçš„å®Œæ•´æµç¨‹ï¼ˆ27ä¸ªæ­¥éª¤ï¼‰
- âœ… å…³é”®è®¾è®¡æ¨¡å¼ï¼ˆRAIIã€å•ä¾‹ã€åˆ†å±‚ã€å·¥å‚ã€ç­–ç•¥ï¼‰
- âœ… æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼ˆå¼‚æ­¥å¤„ç†ã€æ‰¹é‡æ’å…¥ã€ç´¢å¼•ä¼˜åŒ–ï¼‰
- âœ… å¸¸è§é—®é¢˜å’Œæœ€ä½³å®è·µ

**ä¸‹ä¸€æ­¥**ï¼š
1. é˜…è¯»å®é™…ä»£ç ï¼Œå¯¹ç…§æ–‡æ¡£ç†è§£
2. å°è¯•è¿è¡Œé¡¹ç›®ï¼Œè§‚å¯Ÿæ—¥å¿—è¾“å‡º
3. ä¿®æ”¹ä»£ç ï¼ŒéªŒè¯ä½ çš„ç†è§£
4. å‚è€ƒæœ¬æ–‡æ¡£å®ç°æ–°åŠŸèƒ½

**è®°ä½**ï¼šå¥½çš„æ¶æ„ä¸æ˜¯ä¸€å¤©å»ºæˆçš„ï¼Œéœ€è¦ä¸æ–­å®è·µå’Œä¼˜åŒ–ã€‚ç¥ä½ åœ¨Knoté¡¹ç›®ä¸­å­¦ä¹ æ„‰å¿«ï¼ğŸš€

---

**æ–‡æ¡£ä½œè€…**: Knot Team  
**æœ€åæ›´æ–°**: 2025-10-20  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**é€‚ç”¨é¡¹ç›®ç‰ˆæœ¬**: v2.7.0+

å¦‚æœ‰ç–‘é—®ï¼Œè¯·æŸ¥é˜…å…¶ä»–é¡¹ç›®æ–‡æ¡£æˆ–è”ç³»é¡¹ç›®è´Ÿè´£äººã€‚

