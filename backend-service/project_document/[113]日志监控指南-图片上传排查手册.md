# 日志监控指南 - 图片上传排查手册

**文档编号**: 113  
**创建日期**: 2025-10-14  
**适用版本**: v2.3.1+  
**用途**: 帮助开发者通过日志快速定位图片上传问题

---

## 📋 目录

1. [日志系统概述](#日志系统概述)
2. [实时监控命令](#实时监控命令)
3. [完整上传流程日志示例](#完整上传流程日志示例)
4. [常见问题排查](#常见问题排查)
5. [日志级别说明](#日志级别说明)
6. [性能监控指标](#性能监控指标)

---

## 日志系统概述

### 日志文件位置

```bash
/home/kun/projects/SharePix/backend-service/logs/auth-service.log
```

### 日志标签系统

所有图片上传相关日志都使用标签前缀，方便过滤：

| 标签 | 说明 | 示例 |
|------|------|------|
| `[CREATE POST]` | 创建帖子主流程 | `[CREATE POST] Request received` |
| `[SAVE FILE]` | 文件保存和Base64处理 | `[SAVE FILE] Base64 detected` |
| `✓` | 成功操作 | `[CREATE POST] ✓ Post created successfully` |
| `✗` | 失败操作 | `[SAVE FILE] ✗ Decode failed` |
| `⚠` | 警告信息 | `[SAVE FILE] ⚠ Base64 detected` |
| `→` | 详细信息 | `[SAVE FILE]   → Size: 10KB` |

---

## 实时监控命令

### 基础监控

```bash
# 监控所有日志
tail -f logs/auth-service.log

# 只看创建帖子相关
tail -f logs/auth-service.log | grep "CREATE POST"

# 只看文件保存相关
tail -f logs/auth-service.log | grep "SAVE FILE"

# 只看Base64相关操作
tail -f logs/auth-service.log | grep -i base64

# 只看错误和警告
tail -f logs/auth-service.log | grep -E "ERROR|WARNING|✗"

# 只看成功操作
tail -f logs/auth-service.log | grep "✓"
```

### 高级过滤

```bash
# 监控特定用户的上传（替换UserID）
tail -f logs/auth-service.log | grep "UserID: 123"

# 监控Base64解码性能
tail -f logs/auth-service.log | grep "Decode time"

# 查看最近的错误（最后50行）
tail -50 logs/auth-service.log | grep -E "ERROR|✗"

# 实时显示带颜色的日志（需要安装ccze）
tail -f logs/auth-service.log | ccze -A
```

### 多窗口监控

推荐使用tmux分屏监控：

```bash
# 窗口1：所有日志
tail -f logs/auth-service.log

# 窗口2：只看Base64相关
tail -f logs/auth-service.log | grep -i base64

# 窗口3：只看错误
tail -f logs/auth-service.log | grep -E "ERROR|✗"
```

---

## 完整上传流程日志示例

### 场景1：二进制上传（正常流程）

```log
[INFO] === [CREATE POST] Request received ===
[INFO] [CREATE POST] User authenticated - UserID: 123
[INFO] [CREATE POST] Form data - Title: '测试帖子', Tags: 2
[INFO] [CREATE POST] Received 3 image file(s)
[INFO] [CREATE POST] Processing image 1/3 - Filename: photo1.png, ContentType: image/png, Size: 102400 bytes
[INFO] [SAVE FILE] Starting to process file - Name: photo1.png, Type: image/png, OriginalSize: 102400 bytes
[INFO] [SAVE FILE] Binary data detected (not Base64)
[INFO] [SAVE FILE]   → Processing as direct binary upload
[INFO] [SAVE FILE] Writing to: /tmp/knot_uploads/upload_1729012345678_1234.png
[INFO] [SAVE FILE] ✓ File saved successfully!
[INFO] [SAVE FILE]   → Path: /tmp/knot_uploads/upload_1729012345678_1234.png
[INFO] [SAVE FILE]   → Final size: 102400 bytes
[INFO] [SAVE FILE]   → Mode: Direct Binary
[INFO] [CREATE POST] Image 1 saved successfully
[INFO] [CREATE POST] Processing image 2/3 - Filename: photo2.jpg, ContentType: image/jpeg, Size: 153600 bytes
[INFO] [SAVE FILE] Starting to process file - Name: photo2.jpg, Type: image/jpeg, OriginalSize: 153600 bytes
[INFO] [SAVE FILE] Binary data detected (not Base64)
[INFO] [SAVE FILE]   → Processing as direct binary upload
[INFO] [SAVE FILE] Writing to: /tmp/knot_uploads/upload_1729012345789_5678.jpg
[INFO] [SAVE FILE] ✓ File saved successfully!
[INFO] [SAVE FILE]   → Path: /tmp/knot_uploads/upload_1729012345789_5678.jpg
[INFO] [SAVE FILE]   → Final size: 153600 bytes
[INFO] [SAVE FILE]   → Mode: Direct Binary
[INFO] [CREATE POST] Image 2 saved successfully
[INFO] [CREATE POST] Processing image 3/3 - Filename: photo3.png, ContentType: image/png, Size: 98304 bytes
[INFO] [SAVE FILE] Starting to process file - Name: photo3.png, Type: image/png, OriginalSize: 98304 bytes
[INFO] [SAVE FILE] Binary data detected (not Base64)
[INFO] [SAVE FILE]   → Processing as direct binary upload
[INFO] [SAVE FILE] Writing to: /tmp/knot_uploads/upload_1729012345890_9012.png
[INFO] [SAVE FILE] ✓ File saved successfully!
[INFO] [SAVE FILE]   → Path: /tmp/knot_uploads/upload_1729012345890_9012.png
[INFO] [SAVE FILE]   → Final size: 98304 bytes
[INFO] [SAVE FILE]   → Mode: Direct Binary
[INFO] [CREATE POST] Image 3 saved successfully
[INFO] [CREATE POST] All images validated successfully, total: 3
[INFO] [CREATE POST] Creating post in database...
[DEBUG] [CREATE POST] Temporary files cleaned up
[INFO] [CREATE POST] ✓ Post created successfully - PostID: POST_2025Q4_abc123, UserID: 123, Images: 3
```

**关键指标**：
- ✅ 3个图片全部二进制上传
- ✅ 无Base64解码开销
- ✅ 总耗时约200-300ms

---

### 场景2：Base64上传（自动解码）

```log
[INFO] === [CREATE POST] Request received ===
[INFO] [CREATE POST] User authenticated - UserID: 456
[INFO] [CREATE POST] Form data - Title: 'Base64测试', Tags: 1
[INFO] [CREATE POST] Received 2 image file(s)
[INFO] [CREATE POST] Processing image 1/2 - Filename: image1.png, ContentType: image/png, Size: 136533 bytes
[INFO] [SAVE FILE] Starting to process file - Name: image1.png, Type: image/png, OriginalSize: 136533 bytes
[INFO] [SAVE FILE] ⚠ Base64 encoded data detected!
[INFO] [SAVE FILE]   → Data format: Pure Base64
[INFO] [SAVE FILE]   → Encoded size: 136533 bytes
[INFO] [SAVE FILE] ✓ Base64 decode successful!
[INFO] [SAVE FILE]   → Decoded size: 102400 bytes
[INFO] [SAVE FILE]   → Size reduction: 25%
[INFO] [SAVE FILE]   → Decode time: 2 ms
[INFO] [SAVE FILE]   → Image format verified: PNG
[INFO] [SAVE FILE] Writing to: /tmp/knot_uploads/upload_1729012456789_2345.png
[INFO] [SAVE FILE] ✓ File saved successfully!
[INFO] [SAVE FILE]   → Path: /tmp/knot_uploads/upload_1729012456789_2345.png
[INFO] [SAVE FILE]   → Final size: 102400 bytes
[INFO] [SAVE FILE]   → Mode: Base64→Binary
[INFO] [CREATE POST] Image 1 saved successfully
[INFO] [CREATE POST] Processing image 2/2 - Filename: image2.jpg, ContentType: image/jpeg, Size: 204800 bytes
[INFO] [SAVE FILE] Starting to process file - Name: image2.jpg, Type: image/jpeg, OriginalSize: 204800 bytes
[INFO] [SAVE FILE] ⚠ Base64 encoded data detected!
[INFO] [SAVE FILE]   → Data format: Data URI
[INFO] [SAVE FILE]   → Encoded size: 204800 bytes
[INFO] [SAVE FILE] ✓ Base64 decode successful!
[INFO] [SAVE FILE]   → Decoded size: 153600 bytes
[INFO] [SAVE FILE]   → Size reduction: 25%
[INFO] [SAVE FILE]   → Decode time: 3 ms
[INFO] [SAVE FILE]   → Image format verified: JPEG
[INFO] [SAVE FILE] Writing to: /tmp/knot_uploads/upload_1729012456890_6789.jpg
[INFO] [SAVE FILE] ✓ File saved successfully!
[INFO] [SAVE FILE]   → Path: /tmp/knot_uploads/upload_1729012456890_6789.jpg
[INFO] [SAVE FILE]   → Final size: 153600 bytes
[INFO] [SAVE FILE]   → Mode: Base64→Binary
[INFO] [CREATE POST] Image 2 saved successfully
[INFO] [CREATE POST] All images validated successfully, total: 2
[INFO] [CREATE POST] Creating post in database...
[DEBUG] [CREATE POST] Temporary files cleaned up
[INFO] [CREATE POST] ✓ Post created successfully - PostID: POST_2025Q4_def456, UserID: 456, Images: 2
```

**关键指标**：
- ⚠️ 检测到Base64编码
- ✅ 自动解码成功
- ✅ 大小减少25%（Base64→Binary）
- ⚠️ 解码耗时2-3ms（额外开销）

---

### 场景3：上传失败示例

#### 3.1 Token验证失败

```log
[INFO] === [CREATE POST] Request received ===
[WARNING] [CREATE POST] Invalid authentication token
```

**排查方向**：
- 检查前端是否正确设置Authorization头
- 验证token是否过期
- 确认token格式是否为 `Bearer <token>`

---

#### 3.2 文件类型错误

```log
[INFO] === [CREATE POST] Request received ===
[INFO] [CREATE POST] User authenticated - UserID: 789
[INFO] [CREATE POST] Form data - Title: '错误测试', Tags: 0
[INFO] [CREATE POST] Received 1 image file(s)
[INFO] [CREATE POST] Processing image 1/1 - Filename: document.pdf, ContentType: application/pdf, Size: 204800 bytes
[WARNING] [CREATE POST] Invalid content type: application/pdf
```

**排查方向**：
- 前端应该过滤非图片文件
- 只允许 `image/*` 类型

---

#### 3.3 Base64解码失败

```log
[INFO] === [CREATE POST] Request received ===
[INFO] [CREATE POST] User authenticated - UserID: 999
[INFO] [CREATE POST] Form data - Title: '解码失败测试', Tags: 0
[INFO] [CREATE POST] Received 1 image file(s)
[INFO] [CREATE POST] Processing image 1/1 - Filename: bad.png, ContentType: image/png, Size: 50000 bytes
[INFO] [SAVE FILE] Starting to process file - Name: bad.png, Type: image/png, OriginalSize: 50000 bytes
[INFO] [SAVE FILE] ⚠ Base64 encoded data detected!
[INFO] [SAVE FILE]   → Data format: Pure Base64
[INFO] [SAVE FILE]   → Encoded size: 50000 bytes
[ERROR] [SAVE FILE] ✗ Base64 decode failed: Invalid Base64 character
[WARNING] [SAVE FILE]   → Falling back to treating as binary data
[INFO] [SAVE FILE] Writing to: /tmp/knot_uploads/upload_1729012567890_1111.png
[INFO] [SAVE FILE] ✓ File saved successfully!
[INFO] [SAVE FILE]   → Path: /tmp/knot_uploads/upload_1729012567890_1111.png
[INFO] [SAVE FILE]   → Final size: 50000 bytes
[INFO] [SAVE FILE]   → Mode: Direct Binary
[ERROR] Image validation failed: Invalid format
```

**排查方向**：
- 前端Base64编码可能不正确
- 数据在传输过程中被截断或损坏
- 尝试使用二进制上传代替Base64

---

#### 3.4 文件太小（解码后）

```log
[INFO] [SAVE FILE] ⚠ Base64 encoded data detected!
[INFO] [SAVE FILE]   → Data format: Pure Base64
[INFO] [SAVE FILE]   → Encoded size: 100 bytes
[INFO] [SAVE FILE] ✓ Base64 decode successful!
[INFO] [SAVE FILE]   → Decoded size: 5 bytes
[ERROR] [SAVE FILE] ✗ Decoded data too small to be valid image
```

**排查方向**：
- 前端可能发送了空数据或损坏的Base64
- 检查前端文件读取逻辑

---

#### 3.5 数据库操作失败

```log
[INFO] [CREATE POST] All images validated successfully, total: 2
[INFO] [CREATE POST] Creating post in database...
[ERROR] [CREATE POST] ✗ Failed to create post - Reason: Database connection timeout
```

**排查方向**：
- 检查数据库连接状态
- 查看数据库连接池是否耗尽
- 检查MySQL服务是否正常

---

## 常见问题排查

### 问题1：前端报400错误

**监控命令**：
```bash
tail -f logs/auth-service.log | grep -E "\[CREATE POST\]|WARNING|ERROR"
```

**可能原因**：

| 日志关键词 | 原因 | 解决方案 |
|-----------|------|---------|
| `Title is empty` | 标题为空 | 前端必须提供title字段 |
| `Invalid content type` | 文件类型不是图片 | 前端过滤非图片文件 |
| `File size exceeds limit` | 文件超过5MB | 压缩图片或提示用户 |
| `Invalid image count` | 图片数量不在1-9之间 | 前端限制上传数量 |
| `No image files found` | 未找到imageFiles字段 | 检查FormData字段名 |

---

### 问题2：前端报401错误

**监控命令**：
```bash
tail -f logs/auth-service.log | grep "authentication"
```

**可能原因**：

| 日志关键词 | 原因 | 解决方案 |
|-----------|------|---------|
| `No authentication token` | 未提供Token | 检查Authorization头 |
| `Invalid authentication token` | Token无效或过期 | 刷新Token后重试 |

---

### 问题3：Base64上传后图片损坏

**监控命令**：
```bash
tail -f logs/auth-service.log | grep -E "Base64|Image format"
```

**排查步骤**：

1. 查看是否检测到Base64：
   ```log
   [INFO] [SAVE FILE] ⚠ Base64 encoded data detected!
   ```

2. 查看解码是否成功：
   ```log
   [INFO] [SAVE FILE] ✓ Base64 decode successful!
   [INFO] [SAVE FILE]   → Decoded size: 102400 bytes
   ```

3. 查看图片格式验证：
   ```log
   [INFO] [SAVE FILE]   → Image format verified: PNG
   ```

如果没有看到"Image format verified"，说明解码后的数据不是有效图片。

---

### 问题4：性能缓慢

**监控命令**：
```bash
tail -f logs/auth-service.log | grep "Decode time"
```

**性能基准**：

| 文件大小 | Base64解码时间 | 正常范围 |
|---------|---------------|---------|
| 100KB | < 1ms | ✓ 正常 |
| 1MB | 1-5ms | ✓ 正常 |
| 5MB | 5-20ms | ⚠️ 可接受 |
| >5MB | >20ms | ✗ 建议优化 |

如果解码时间超出正常范围，建议：
- 前端改用二进制上传
- 前端先压缩图片
- 检查服务器CPU负载

---

## 日志级别说明

### INFO - 信息级别

**用途**：正常操作流程

**示例**：
```log
[INFO] === [CREATE POST] Request received ===
[INFO] [SAVE FILE] Binary data detected (not Base64)
[INFO] [CREATE POST] ✓ Post created successfully
```

**何时关注**：日常监控，了解系统运行状态

---

### WARNING - 警告级别

**用途**：潜在问题或异常情况

**示例**：
```log
[WARNING] [CREATE POST] Invalid content type: application/pdf
[WARNING] [SAVE FILE]   → Falling back to treating as binary data
[WARNING] [CREATE POST] No image files found in request
```

**何时关注**：排查问题时优先查看

---

### ERROR - 错误级别

**用途**：操作失败

**示例**：
```log
[ERROR] [SAVE FILE] ✗ Base64 decode failed: Invalid character
[ERROR] [CREATE POST] ✗ Failed to create post
[ERROR] [SAVE FILE] ✗ Failed to open file for writing
```

**何时关注**：立即处理，表示功能不可用

---

### DEBUG - 调试级别

**用途**：详细的调试信息

**示例**：
```log
[DEBUG] [CREATE POST] Temporary files cleaned up
```

**何时关注**：开发阶段，生产环境可关闭

---

## 性能监控指标

### 关键指标监控

#### 1. Base64解码率

**查看命令**：
```bash
# 统计最近100次上传中Base64的比例
tail -100 logs/auth-service.log | grep "SAVE FILE" | grep -c "Base64 detected"
```

**健康标准**：
- 0%：完美，全部二进制上传
- <50%：可接受，部分Base64
- >50%：建议优化，前端改用二进制

---

#### 2. 平均解码时间

**查看命令**：
```bash
# 提取解码时间
tail -100 logs/auth-service.log | grep "Decode time" | sed 's/.*Decode time: \([0-9]*\) ms.*/\1/'
```

**健康标准**：
- <5ms：优秀
- 5-10ms：良好
- >10ms：需要优化

---

#### 3. 错误率

**查看命令**：
```bash
# 统计最近100个请求的错误数
tail -100 logs/auth-service.log | grep "CREATE POST" | grep -c "✗"
```

**健康标准**：
- 0%：完美
- <5%：可接受
- >5%：需要排查

---

#### 4. 上传成功率

**查看命令**：
```bash
# 成功次数
SUCCESS=$(tail -100 logs/auth-service.log | grep "CREATE POST" | grep -c "✓")

# 失败次数
FAIL=$(tail -100 logs/auth-service.log | grep "CREATE POST" | grep -c "✗")

# 计算成功率
echo "scale=2; $SUCCESS * 100 / ($SUCCESS + $FAIL)" | bc
```

**健康标准**：
- >95%：优秀
- 90-95%：良好
- <90%：需要优化

---

## 日志分析脚本

### 自动统计脚本

创建 `analyze_upload_logs.sh`：

```bash
#!/bin/bash

LOG_FILE="logs/auth-service.log"
LINES=1000

echo "=== 图片上传日志分析（最近${LINES}行）==="
echo ""

# 总上传次数
TOTAL=$(tail -$LINES $LOG_FILE | grep "CREATE POST.*Request received" | wc -l)
echo "总上传次数: $TOTAL"

# 成功次数
SUCCESS=$(tail -$LINES $LOG_FILE | grep "CREATE POST.*✓.*successfully" | wc -l)
echo "成功次数: $SUCCESS"

# 失败次数
FAIL=$(tail -$LINES $LOG_FILE | grep "CREATE POST.*✗" | wc -l)
echo "失败次数: $FAIL"

# 成功率
if [ $TOTAL -gt 0 ]; then
    SUCCESS_RATE=$(echo "scale=2; $SUCCESS * 100 / $TOTAL" | bc)
    echo "成功率: ${SUCCESS_RATE}%"
fi

echo ""
echo "=== Base64使用统计 ==="

# Base64检测次数
BASE64=$(tail -$LINES $LOG_FILE | grep "Base64 encoded data detected" | wc -l)
echo "Base64上传次数: $BASE64"

# 二进制上传次数
BINARY=$(tail -$LINES $LOG_FILE | grep "Binary data detected" | wc -l)
echo "二进制上传次数: $BINARY"

# Base64占比
if [ $(($BASE64 + $BINARY)) -gt 0 ]; then
    BASE64_RATE=$(echo "scale=2; $BASE64 * 100 / ($BASE64 + $BINARY)" | bc)
    echo "Base64占比: ${BASE64_RATE}%"
fi

echo ""
echo "=== 错误类型统计 ==="

# Token错误
TOKEN_ERR=$(tail -$LINES $LOG_FILE | grep -c "Invalid authentication token")
echo "Token验证失败: $TOKEN_ERR"

# 文件类型错误
TYPE_ERR=$(tail -$LINES $LOG_FILE | grep -c "Invalid content type")
echo "文件类型错误: $TYPE_ERR"

# 文件大小错误
SIZE_ERR=$(tail -$LINES $LOG_FILE | grep -c "File size exceeds limit")
echo "文件过大错误: $SIZE_ERR"

# Base64解码错误
DECODE_ERR=$(tail -$LINES $LOG_FILE | grep -c "Base64 decode failed")
echo "Base64解码失败: $DECODE_ERR"

echo ""
echo "分析完成！"
```

**使用方法**：
```bash
chmod +x analyze_upload_logs.sh
./analyze_upload_logs.sh
```

---

## 总结

### 日常监控建议

1. **开发环境**：
   ```bash
   tail -f logs/auth-service.log
   ```

2. **生产环境**：
   ```bash
   tail -f logs/auth-service.log | grep -E "WARNING|ERROR|✗"
   ```

3. **性能调优**：
   ```bash
   tail -f logs/auth-service.log | grep -E "Base64|Decode time"
   ```

### 快速排查清单

遇到问题时按顺序检查：

1. ✓ 查看是否有ERROR日志
2. ✓ 检查Token验证是否通过
3. ✓ 确认文件类型和大小是否合法
4. ✓ 查看Base64检测和解码结果
5. ✓ 验证图片格式是否正确
6. ✓ 检查数据库操作是否成功

---

**相关文档**：
- [112]Base64图片上传问题分析与解决方案.md
- [000]API文档.md - 创建帖子接口说明

---

**作者**: Knot Team  
**版本**: v1.0  
**更新日期**: 2025-10-14

