# Followè·¯ç”±é—®é¢˜è¯Šæ–­ç»“æœ

**æ—¥æœŸ**: 2025-10-17  
**é—®é¢˜ID**: FOLLOW-ROUTE-001  
**çŠ¶æ€**: âœ… æ ¹æœ¬åŸå› å·²æ‰¾åˆ°  

---

## é—®é¢˜æè¿°

POST `/api/v1/users/:user_id/follow` è¿”å›400 Bad Requestï¼Œè€—æ—¶5ç§’ï¼ŒLambdaæœªæ‰§è¡Œã€‚

---

## è¯Šæ–­è¿‡ç¨‹æ€»ç»“

### é˜¶æ®µ1: éªŒè¯æ­£åˆ™è·¯ç”±å†²çªå‡è®¾
**æ“ä½œ**: æ³¨é‡Š `authHandler_->registerWildcardRoutes(*server_);`  
**ç»“æœ**: âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨  
**ç»“è®º**: ä¸æ˜¯AuthHandlerçš„æ­£åˆ™è·¯ç”±å¯¼è‡´çš„å†²çª

### é˜¶æ®µ2: éªŒè¯OPTIONSå¤„ç†å™¨å¹²æ‰°
**æ“ä½œ**: æ³¨é‡Š `server_->Options(".*", ...)`  
**ç»“æœ**: âŒ é—®é¢˜ä¾ç„¶å­˜åœ¨  
**ç»“è®º**: ä¸æ˜¯OPTIONSæ­£åˆ™è·¯ç”±å¯¼è‡´çš„

### é˜¶æ®µ3: ç¼©å°é—®é¢˜èŒƒå›´
**æµ‹è¯•å¯¹æ¯”**:
| è·¯ç”± | æ–¹æ³• | è·¯å¾„å‚æ•° | ç»“æœ |
|------|------|---------|------|
| `/api/v1/auth/login` | POST | æ—  | âœ… 200 OK |
| `/api/v1/users/:user_id/followers` | GET | æœ‰ | âœ… 200 OK |
| `/api/v1/users/:user_id/follow` | POST | æœ‰ | âŒ 400 (5s) |
| `/api/v1/posts/:post_id/like` | POST | æœ‰ | âŒ 400 (5s) |
| `/api/v1/test/:test_id` | POST | æœ‰ | âŒ 400 (5s) |

**ç»“è®º**: **æ‰€æœ‰å¸¦è·¯å¾„å‚æ•°çš„POSTè·¯ç”±éƒ½å¤±è´¥ï¼**

---

## æ ¹æœ¬åŸå› 

**cpp-httplib 0.26.0** å­˜åœ¨è·¯ç”±åŒ¹é…Bugï¼Œæ— æ³•æ­£ç¡®å¤„ç†å¸¦è·¯å¾„å‚æ•°ï¼ˆå¦‚`:user_id`ï¼‰çš„POSTè·¯ç”±ã€‚

**è¯æ®**:
1. ç®€å•æµ‹è¯•è·¯ç”± `POST /api/v1/test/:test_id` ä¹Ÿå¤±è´¥
2. Lambdaå‡½æ•°å®Œå…¨æœªè¢«è°ƒç”¨ï¼ˆæ—¥å¿—æœªå‡ºç°ï¼‰
3. åŒæ ·è·¯å¾„çš„GETè¯·æ±‚æ­£å¸¸å·¥ä½œ
4. æ— è·¯å¾„å‚æ•°çš„POSTè¯·æ±‚æ­£å¸¸å·¥ä½œ

**æŠ€æœ¯ç»†èŠ‚**:
- è¯·æ±‚åˆ°è¾¾æœåŠ¡å™¨ï¼ˆpre_routing_handlerè®°å½•ï¼‰
- è·¯ç”±åŒ¹é…å¤±è´¥ï¼ˆLambdaæœªæ‰§è¡Œï¼‰
- 5ç§’è¶…æ—¶åè¿”å›400ï¼ˆ`CPPHTTPLIB_KEEPALIVE_TIMEOUT_SECOND = 5`ï¼‰
- æ— å“åº”ä½“

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆA: é™çº§cpp-httplibç‰ˆæœ¬ â­â­â­â­â­ (å¼ºçƒˆæ¨è)

**æ“ä½œ**:
1. å°† `backend-service/third_party/httplib.h` æ›¿æ¢ä¸º **0.11.0** æˆ– **0.15.0** ç‰ˆæœ¬
2. é‡æ–°ç¼–è¯‘æµ‹è¯•

**ä¼˜ç‚¹**:
- æ ¹æœ¬è§£å†³é—®é¢˜
- ä¸éœ€è¦ä¿®æ”¹åº”ç”¨ä»£ç 
- å‘åå…¼å®¹

**æ“ä½œæ­¥éª¤**:
```bash
cd backend-service/third_party
# å¤‡ä»½ç°æœ‰ç‰ˆæœ¬
cp httplib.h httplib.h.0.26.0.backup

# ä¸‹è½½0.11.0ç‰ˆæœ¬
wget https://raw.githubusercontent.com/yhirose/cpp-httplib/v0.11.0/httplib.h

# é‡æ–°ç¼–è¯‘
cd ../build
rm -rf * && cmake .. && make -j4

# æµ‹è¯•
./knot_image_sharing ../config/config.json
```

---

### æ–¹æ¡ˆB: æ›´æ”¹è·¯ç”±è·¯å¾„æ¨¡å¼ â­â­â­â˜†â˜†

**æ“ä½œ**: å°†Followè·¯ç”±æ”¹ä¸ºæŸ¥è¯¢å‚æ•°è€Œä¸æ˜¯è·¯å¾„å‚æ•°

```cpp
// ä¿®æ”¹å‰
server.Post("/api/v1/users/:user_id/follow", [this](...) { ... });

// ä¿®æ”¹å
server.Post("/api/v1/follow", [this](const httplib::Request& req, httplib::Response& res) {
    std::string userId = req.get_param_value("user_id");
    // ... ä¸šåŠ¡é€»è¾‘
});
```

**è°ƒç”¨æ–¹å¼**:
```bash
POST /api/v1/follow?user_id=31
```

**ç¼ºç‚¹**:
- ä¸ç¬¦åˆRESTfulè§„èŒƒ
- éœ€è¦ä¿®æ”¹APIæ–‡æ¡£å’Œå®¢æˆ·ç«¯
- æ²»æ ‡ä¸æ²»æœ¬

---

### æ–¹æ¡ˆC: ä½¿ç”¨ç‹¬ç«‹è·¯å¾„å‰ç¼€ â­â­â­â­â˜†

**æ“ä½œ**: å°†Followè·¯ç”±ç§»è‡³ç‹¬ç«‹è·¯å¾„

```cpp
// å…³æ³¨æ“ä½œ
server.Post("/api/v1/follow/:user_id", [this](...) {  
    handleFollow(req, res);
});

// å–æ¶ˆå…³æ³¨
server.Delete("/api/v1/unfollow/:user_id", [this](...) {
    handleUnfollow(req, res);
});

// æŸ¥è¯¢è·¯ç”±ä¿æŒä¸å˜
server.Get("/api/v1/users/:user_id/followers", [this](...) { ... });
server.Get("/api/v1/users/:user_id/following", [this](...) { ... });
```

**ä¼˜ç‚¹**:
- å¯èƒ½é¿å¼€cpp-httplibçš„Bugè§¦å‘æ¡ä»¶
- RESTfulè¯­ä¹‰æ¸…æ™°
- éƒ¨åˆ†APIè·¯å¾„éœ€è¦ä¿®æ”¹

**ç¼ºç‚¹**:
- ä¸ç¡®å®šæ˜¯å¦èƒ½è§£å†³ï¼ˆBugå¯èƒ½å½±å“æ‰€æœ‰POST+è·¯å¾„å‚æ•°ï¼‰
- éœ€è¦æµ‹è¯•éªŒè¯

---

## æ¨èæ‰§è¡Œæ–¹æ¡ˆ

### ğŸ¯ ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ–¹æ¡ˆAï¼ˆé™çº§cpp-httplibï¼‰

1. **ä¸‹è½½0.11.0ç‰ˆæœ¬**ï¼ˆå·²çŸ¥ç¨³å®šï¼‰
2. **å®Œæ•´æµ‹è¯•**æ‰€æœ‰APIåŠŸèƒ½
3. **å¦‚æœä»æœ‰é—®é¢˜**ï¼Œå°è¯•0.15.0ç‰ˆæœ¬

### å¤‡é€‰ï¼šæ–¹æ¡ˆCï¼ˆç‹¬ç«‹è·¯å¾„å‰ç¼€ï¼‰

å¦‚æœé™çº§å¤±è´¥æˆ–ä¸å¯è¡Œï¼Œå°è¯•ç‹¬ç«‹è·¯å¾„å‰ç¼€ã€‚

---

##  æµ‹è¯•éªŒè¯æ¸…å•

é™çº§åå¿…é¡»æµ‹è¯•ï¼š

### æ ¸å¿ƒåŠŸèƒ½
- [ ] POST `/api/v1/users/:user_id/follow` â†’ 200/201
- [ ] POST `/api/v1/posts/:post_id/like` â†’ 200/201
- [ ] POST `/api/v1/test/:test_id` â†’ 200ï¼ˆæµ‹è¯•è·¯ç”±ï¼‰
- [ ] GET `/api/v1/users/:user_id/followers` â†’ 200ï¼ˆç¡®ä¿GETä¸å—å½±å“ï¼‰
- [ ] POST `/api/v1/auth/login` â†’ 200ï¼ˆç¡®ä¿æ— å‚POSTä¸å—å½±å“ï¼‰

### å®Œæ•´å…³æ³¨åŠŸèƒ½
- [ ] å…³æ³¨ç”¨æˆ·
- [ ] å–æ¶ˆå…³æ³¨
- [ ] æ£€æŸ¥å…³æ³¨çŠ¶æ€
- [ ] è·å–å…³æ³¨åˆ—è¡¨
- [ ] è·å–ç²‰ä¸åˆ—è¡¨
- [ ] æ‰¹é‡æ£€æŸ¥å…³æ³¨

---

## ç›¸å…³æ–‡ä»¶

- æµ‹è¯•é—®é¢˜æ±‡æ€»: `[122]å…³æ³¨åŠŸèƒ½æµ‹è¯•é—®é¢˜æ±‡æ€».md`
- è¯Šæ–­æ–¹æ¡ˆ: `test/diagnose_follow_route.md`
- æµ‹è¯•ç¨‹åº: `test/test_follow_route_debug.cpp`

---

## æŠ€æœ¯ç¬”è®°

### cpp-httplibç‰ˆæœ¬å¯¹æ¯”

| ç‰ˆæœ¬ | å‘å¸ƒæ—¥æœŸ | çŠ¶æ€ | å¤‡æ³¨ |
|-----|---------|-----|------|
| 0.11.0 | 2022-03 | âœ… å·²çŸ¥ç¨³å®š | æ–‡æ¡£ä¸­å£°æ˜çš„ç‰ˆæœ¬ |
| 0.15.0 | 2023-06 | ğŸŸ¡ å¾…æµ‹è¯• | ä¸­é—´ç¨³å®šç‰ˆæœ¬ |
| 0.26.0 | 2025-01 | âŒ æœ‰Bug | å½“å‰ä½¿ç”¨ç‰ˆæœ¬ï¼ŒPOST+è·¯å¾„å‚æ•°å¤±è´¥ |

### 5ç§’è¶…æ—¶æ¥æº

```cpp
// third_party/httplib.h ç¬¬45-46è¡Œ
#ifndef CPPHTTPLIB_KEEPALIVE_TIMEOUT_SECOND
#define CPPHTTPLIB_KEEPALIVE_TIMEOUT_SECOND 5
#endif
```

å½“è·¯ç”±åŒ¹é…å¤±è´¥æ—¶ï¼Œcpp-httplibç­‰å¾…5ç§’Keep-Aliveè¶…æ—¶åè¿”å›400ã€‚

---

**æŠ¥å‘Šæ›´æ–°æ—¶é—´**: 2025-10-17 14:55  
**è¯Šæ–­å®Œæˆ**:  âœ… æ ¹æœ¬åŸå› å·²æ‰¾åˆ°ï¼Œæ¨èé™çº§cpp-httplibè‡³0.11.0




