# 应用内分享功能设计文档

## 一、功能概述

### 1.1 功能描述

实现类似B站的应用内帖子分享功能，用户可以将帖子分享给互关的好友，好友可以在"收到的分享"列表中查看分享卡片，点击后跳转到对应的帖子详情页面。

### 1.2 核心流程

```
用户A点击分享 → 选择互关用户B → 创建分享记录 → 用户B在"收到的分享"列表查看 → 点击卡片跳转到帖子详情
```

### 1.3 功能特点

- 仅支持帖子分享（不支持用户分享）
- 无需复杂的会话管理
- 单向信息传递（分享者→接收者）
- 支持未读标记
- 分享卡片展示帖子基本信息
- 点击卡片直接跳转详情页

---

## 二、后端设计

### 2.1 数据库设计

#### 2.1.1 分享表 (shares)

| 字段名           | 类型         | 说明         | 备注                   |
| ---------------- | ------------ | ------------ | ---------------------- |
| id               | BIGINT       | 主键ID       | 自增                   |
| share_id         | VARCHAR(32)  | 分享唯一标识 | 如: SHR_2025Q4_xxxxx   |
| post_id          | VARCHAR(32)  | 帖子ID       | 关联帖子表             |
| sender_id        | VARCHAR(32)  | 分享者ID     | 关联用户表             |
| receiver_id      | VARCHAR(32)  | 接收者ID     | 关联用户表             |
| share_message    | TEXT         | 分享附言     | 可选                   |
| is_read          | BOOLEAN      | 是否已读     | 默认false              |
| post_title       | VARCHAR(255) | 帖子标题     | 冗余字段，提高查询性能 |
| post_cover_image | VARCHAR(512) | 帖子封面图   | 冗余字段               |
| post_description | TEXT         | 帖子描述     | 冗余字段               |
| sender_name      | VARCHAR(100) | 分享者昵称   | 冗余字段               |
| sender_avatar    | VARCHAR(512) | 分享者头像   | 冗余字段               |
| create_time      | BIGINT       | 创建时间     | Unix时间戳(秒)         |

**索引设计：**

```sql
-- 主要查询索引（接收者查看分享列表）
INDEX idx_receiver_time (receiver_id, create_time DESC)

-- 发送者查询索引
INDEX idx_sender (sender_id)

-- 帖子查询索引（统计某个帖子被分享次数）
INDEX idx_post (post_id)

-- 未读查询索引
INDEX idx_receiver_unread (receiver_id, is_read, create_time DESC)
```

**建表SQL：**

```sql
CREATE TABLE shares (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  share_id VARCHAR(32) UNIQUE NOT NULL,
  post_id VARCHAR(32) NOT NULL,
  sender_id VARCHAR(32) NOT NULL,
  receiver_id VARCHAR(32) NOT NULL,
  share_message TEXT,
  is_read BOOLEAN DEFAULT FALSE,
  post_title VARCHAR(255),
  post_cover_image VARCHAR(512),
  post_description TEXT,
  sender_name VARCHAR(100) NOT NULL,
  sender_avatar VARCHAR(512),
  create_time BIGINT NOT NULL,
  
  INDEX idx_receiver_time (receiver_id, create_time DESC),
  INDEX idx_sender (sender_id),
  INDEX idx_post (post_id),
  INDEX idx_receiver_unread (receiver_id, is_read, create_time DESC)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.1.2 关注表扩展（如果需要）

现有的关注表可能需要添加"互关"标记或查询优化：

```sql
-- 如果没有互关标记，需要添加索引优化互关查询
INDEX idx_mutual_following (user_id, followed_user_id, is_following)
```

### 2.2 API接口设计

#### 2.2.1 分享帖子

**接口：** `POST /shares/post`

**请求头：**

```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体：**

```json
{
  "post_id": "POST_2025Q4_xxxxx",
  "receiver_id": "USR_2025Q4_xxxxx",
  "share_message": "这个太赞了，推荐给你！"
}
```

**成功响应：**

```json
{
  "success": true,
  "message": "分享成功",
  "data": {
    "share_id": "SHR_2025Q4_xxxxx",
    "create_time": 1760888256
  },
  "timestamp": 1760888256
}
```

**业务逻辑：**

1. 验证用户登录状态
2. 验证帖子是否存在且可访问
3. 验证接收者是否存在
4. 检查发送者和接收者是否互关（可选）
5. 查询帖子详情，提取标题、封面、描述等信息
6. 查询发送者信息（昵称、头像）
7. 创建分享记录
8. 返回分享ID

**错误码：**

- `40001`: 帖子不存在
- `40002`: 接收者不存在
- `40003`: 未互关无法分享
- `40004`: 不能分享给自己

---

#### 2.2.2 获取收到的分享列表

**接口：** `GET /shares/received`

**请求参数：**

```
page: number         // 页码，默认1
page_size: number    // 每页数量，默认20，最大100
unread_only: boolean // 只看未读，默认false
```

**请求示例：**

```
GET /shares/received?page=1&page_size=20
```

**成功响应：**

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "shares": [
      {
        "share_id": "SHR_2025Q4_xxxxx",
        "post_id": "POST_2025Q4_xxxxx",
        "sender": {
          "user_id": "USR_2025Q4_xxxxx",
          "username": "张三",
          "avatar_url": "/uploads/avatars/xxx.jpg"
        },
        "share_message": "这个太赞了，推荐给你！",
        "post_info": {
          "title": "美食探店攻略",
          "description": "今天去了一家超好吃的川菜馆...",
          "cover_image": "/uploads/posts/xxx.jpg",
          "like_count": 128,
          "favorite_count": 56
        },
        "is_read": false,
        "create_time": 1760888256
      }
    ],
    "total": 15,
    "page": 1,
    "page_size": 20,
    "has_more": false,
    "unread_count": 3
  },
  "timestamp": 1760888256
}
```

**业务逻辑：**

1. 验证用户登录状态
2. 根据 receiver_id 查询分享列表
3. 如果 unread_only=true，只返回未读分享
4. 按创建时间倒序排列
5. 分页返回
6. 同时返回未读数量

---

#### 2.2.3 标记分享已读(不用实现直接删除相关功能和数据表的设计)

**接口：** `PUT /shares/{share_id}/read`

**请求示例：**

```
PUT /shares/SHR_2025Q4_xxxxx/read
```

**成功响应：**

```json
{
  "success": true,
  "message": "标记成功",
  "data": {
    "share_id": "SHR_2025Q4_xxxxx",
    "is_read": true
  },
  "timestamp": 1760888256
}
```

**业务逻辑：**

1. 验证用户登录状态
2. 验证分享是否存在
3. 验证当前用户是否为接收者
4. 更新 is_read 字段为 true
5. 返回结果

---

#### 2.2.4 获取互关用户列表

**接口：** `GET /users/mutual-following`

**请求参数：**

```
page: number       // 页码，默认1
page_size: number  // 每页数量，默认50
search: string     // 搜索关键词（可选）
```

**成功响应：**

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "users": [
      {
        "user_id": "USR_2025Q4_xxxxx",
        "username": "张三",
        "avatar_url": "/uploads/avatars/xxx.jpg",
        "bio": "热爱生活，热爱美食"
      }
    ],
    "total": 25,
    "page": 1,
    "page_size": 50,
    "has_more": false
  },
  "timestamp": 1760888256
}
```

**业务逻辑：**

1. 查询当前用户关注的用户列表
2. 查询关注当前用户的用户列表
3. 取交集得到互关用户
4. 如果有搜索关键词，按用户名筛选
5. 分页返回

**SQL查询示例：**

```sql
-- 查询互关用户
SELECT DISTINCT u.user_id, u.username, u.avatar_url, u.bio
FROM users u
WHERE u.user_id IN (
  -- 我关注的人
  SELECT followed_user_id FROM follows WHERE user_id = ? AND is_following = true
)
AND u.user_id IN (
  -- 关注我的人
  SELECT user_id FROM follows WHERE followed_user_id = ? AND is_following = true
)
ORDER BY u.username
LIMIT ? OFFSET ?;
```

---

#### 2.2.5 获取未读分享数量

**接口：** `GET /shares/unread-count`

**成功响应：**

```json
{
  "success": true,
  "message": "获取成功",
  "data": {
    "unread_count": 3
  },
  "timestamp": 1760888256
}
```

**业务逻辑：**

1. 统计当前用户未读分享数量
2. 返回数量

---

#### 2.2.6 批量标记已读（可选）

**接口：** `PUT /shares/read-all`

**成功响应：**

```json
{
  "success": true,
  "message": "已全部标记为已读",
  "data": {
    "read_count": 5
  },
  "timestamp": 1760888256
}
```

---

#### 2.2.7 删除分享记录（可选）

**接口：** `DELETE /shares/{share_id}`

**成功响应：**

```json
{
  "success": true,
  "message": "删除成功",
  "timestamp": 1760888256
}
```

---

### 2.3 数据冗余策略

为了提高查询性能，避免复杂的JOIN查询，分享表中存储以下冗余字段：

**冗余字段：**

- `post_title` - 帖子标题
- `post_cover_image` - 帖子封面图
- `post_description` - 帖子描述
- `sender_name` - 分享者昵称
- `sender_avatar` - 分享者头像

**更新策略：**

- 创建分享时一次性写入，后续不更新
- 如果需要实时数据，前端在详情页重新获取

**优点：**

- 减少查询时的JOIN操作
- 提高列表页加载速度
- 即使原帖子被删除，分享记录仍可显示

**缺点：**

- 数据可能不是最新的（可接受）
- 存储空间略增加（可接受）

---

## 三、前端设计

### 3.1 数据模型设计

#### 3.1.1 分享实体 (ShareEntity)

**文件路径：** `entry/src/main/ets/models/entities/ShareEntity.ets`

```typescript
export interface ShareSender {
  user_id: string
  username: string
  avatar_url: string
}

export interface SharePostInfo {
  title: string
  description: string
  cover_image: string
  like_count: number
  favorite_count: number
}

export interface ShareEntity {
  share_id: string
  post_id: string
  sender: ShareSender
  share_message: string
  post_info: SharePostInfo
  is_read: boolean
  create_time: number
}

export interface ShareListResponse {
  shares: ShareEntity[]
  total: number
  page: number
  page_size: number
  has_more: boolean
  unread_count: number
}

export interface MutualFollowUser {
  user_id: string
  username: string
  avatar_url: string
  bio: string
}
```

---

### 3.2 API服务层设计

#### 3.2.1 ShareApi.ets

**文件路径：** `entry/src/main/ets/services/api/ShareApi.ets`

```typescript
import { httpRequest, ApiResponse } from './HttpRequest'
import { ApiConstants } from './ApiConstants'
import { 
  ShareEntity, 
  ShareListResponse, 
  MutualFollowUser 
} from '../../models/entities/ShareEntity'

export interface CreateShareData {
  share_id: string
  create_time: number
}

export interface UnreadCountData {
  unread_count: number
}

export interface MutualFollowingResponse {
  users: MutualFollowUser[]
  total: number
  page: number
  page_size: number
  has_more: boolean
}

export const sharePost = async (
  postId: string,
  receiverId: string,
  message?: string
): Promise<ApiResponse<CreateShareData>> => {
  const url = ApiConstants.SHARE_ENDPOINTS.SHARE_POST
  const data: Record<string, string> = {
    post_id: postId,
    receiver_id: receiverId
  }
  if (message) {
    data.share_message = message
  }
  return httpRequest.post<CreateShareData>(url, data)
}

export const getReceivedShares = async (
  page: number = 1,
  pageSize: number = 20,
  unreadOnly: boolean = false
): Promise<ApiResponse<ShareListResponse>> => {
  const url = `${ApiConstants.SHARE_ENDPOINTS.GET_RECEIVED_SHARES}?page=${page}&page_size=${pageSize}&unread_only=${unreadOnly}`
  return httpRequest.get<ShareListResponse>(url)
}

export const markShareAsRead = async (
  shareId: string
): Promise<ApiResponse<{ share_id: string, is_read: boolean }>> => {
  const url = ApiConstants.SHARE_ENDPOINTS.MARK_SHARE_READ.replace('{share_id}', shareId)
  return httpRequest.put(url, {})
}

export const getUnreadShareCount = async (): Promise<ApiResponse<UnreadCountData>> => {
  return httpRequest.get<UnreadCountData>(ApiConstants.SHARE_ENDPOINTS.GET_UNREAD_COUNT)
}

export const getMutualFollowingUsers = async (
  page: number = 1,
  pageSize: number = 50,
  search?: string
): Promise<ApiResponse<MutualFollowingResponse>> => {
  let url = `${ApiConstants.SHARE_ENDPOINTS.GET_MUTUAL_FOLLOWING}?page=${page}&page_size=${pageSize}`
  if (search) {
    url += `&search=${encodeURIComponent(search)}`
  }
  return httpRequest.get<MutualFollowingResponse>(url)
}
```

---

#### 3.2.2 ApiConstants 扩展

**文件路径：** `entry/src/main/ets/services/api/ApiConstants.ets`

```typescript
interface ShareEndpoints {
  SHARE_POST: string
  GET_RECEIVED_SHARES: string
  MARK_SHARE_READ: string
  GET_UNREAD_COUNT: string
  GET_MUTUAL_FOLLOWING: string
  MARK_ALL_READ: string
  DELETE_SHARE: string
}

export class ApiConstants {
  // ... 现有代码 ...
  
  static readonly SHARE_ENDPOINTS: ShareEndpoints = {
    SHARE_POST: '/shares/post',
    GET_RECEIVED_SHARES: '/shares/received',
    MARK_SHARE_READ: '/shares/{share_id}/read',
    GET_UNREAD_COUNT: '/shares/unread-count',
    GET_MUTUAL_FOLLOWING: '/users/mutual-following',
    MARK_ALL_READ: '/shares/read-all',
    DELETE_SHARE: '/shares/{share_id}'
  }
}
```

---

### 3.3 组件设计

#### 3.3.1 ShareUserSelector - 互关用户选择器

**文件路径：** `entry/src/main/ets/views/components/ShareUserSelector.ets`

**功能：**

- 底部弹出的用户选择器
- 展示互关用户列表
- 支持搜索
- 选中用户后确认分享

**UI结构：**

```
┌─────────────────────────────────────┐
│  选择分享对象                 [×]   │
├─────────────────────────────────────┤
│  [搜索框]                           │
├─────────────────────────────────────┤
│  ┌───┐ 张三                         │
│  │头 │ 热爱生活，热爱美食          │
│  │像 │                       [选择] │
│  └───┘                              │
├─────────────────────────────────────┤
│  ┌───┐ 李四                         │
│  │头 │ 摄影爱好者                   │
│  │像 │                       [选择] │
│  └───┘                              │
└─────────────────────────────────────┘
```

**Props：**

```typescript
{
  visible: boolean
  postId: string
  onClose: () => void
  onShareSuccess: () => void
}
```

---

#### 3.3.2 PostShareCard - 帖子分享卡片

**文件路径：** `entry/src/main/ets/views/components/PostShareCard.ets`

**功能：**

- 展示分享信息
- 展示帖子预览
- 点击跳转到详情页

**UI结构：**

```
┌─────────────────────────────────────┐
│ ┌───┐ 张三 分享了一个帖子      [未读]│
│ │头 │  "这个太赞了，推荐给你！"      │
│ │像 │  2小时前                       │
│ └───┘                               │
│ ┌─────────────────────────────────┐ │
│ │ [帖子封面图 - 高度约150]        │ │
│ ├─────────────────────────────────┤ │
│ │ 美食探店攻略                    │ │
│ │ 今天去了一家超好吃的川菜馆...   │ │
│ │ 👍 128  ⭐ 56                   │ │
│ └─────────────────────────────────┘ │
└─────────────────────────────────────┘
```

**Props：**

```typescript
{
  share: ShareEntity
  onCardClick: (postId: string) => void
}
```

---

#### 3.3.3 ShareListPage - 分享列表页面

**文件路径：** `entry/src/main/ets/views/pages/ShareListPage.ets`

**功能：**

- 展示收到的分享列表
- 下拉刷新
- 上拉加载更多
- 未读/已读筛选

**UI结构：**

```
┌─────────────────────────────────────┐
│  ← 收到的分享        [全部] [未读]  │
├─────────────────────────────────────┤
│                                     │
│  [PostShareCard 1]                  │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  [PostShareCard 2]                  │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  [PostShareCard 3]                  │
│                                     │
└─────────────────────────────────────┘
```

**路由配置：**

```typescript
{
  name: 'ShareListPage',
  pageSourceFile: 'src/main/ets/views/pages/ShareListPage'
}
```

---

### 3.4 页面集成

#### 3.4.1 PostDetailPage 集成分享按钮

**位置：** 在 ShareDrawer 中添加"应用内分享"选项

**流程：**

1. 用户点击"更多"按钮
2. 在弹出的 ShareDrawer 中显示"应用内分享"
3. 点击后显示 ShareUserSelector
4. 选择用户并确认分享

---

#### 3.4.2 导航入口设计

**方案A：在"我的"页面添加入口**

```
我的页面
├─ 我的作品
├─ 我的收藏
├─ 收到的分享 [红点：3]  ← 新增
└─ 设置
```

**方案B：在底部TabBar添加（如果有空位）**

```
首页 | 发现 | 分享 | 我的
```

**方案C：在顶部添加消息图标（推荐）**

```
┌─────────────────────────────────────┐
│  首页               [🔔 3]  [🔍]     │
└─────────────────────────────────────┘
```

点击消息图标进入分享列表

---

### 3.5 状态管理

#### 3.5.1 未读数量管理

**方案：** 使用 AppStorage 全局状态

```typescript
AppStorage.SetOrCreate('unreadShareCount', 0)
```

**更新时机：**

- 应用启动时获取
- 进入分享列表页时刷新
- 标记已读后更新
- 收到新分享时更新（如果有推送）

---

### 3.6 用户体验优化

#### 3.6.1 加载状态

- 列表加载显示骨架屏
- 分享操作显示 Loading
- 上拉加载更多显示加载指示器

#### 3.6.2 空状态

- 没有分享时显示空状态提示
- 提示用户可以分享帖子给好友

#### 3.6.3 错误处理

- 网络错误提示
- 分享失败提示原因
- 帖子不存在时的友好提示

#### 3.6.4 交互反馈

- 分享成功 Toast 提示
- 标记已读后卡片样式变化
- 下拉刷新动画

---

## 四、实现优先级

### P0 - 核心功能（第一期）

1. 后端：分享表设计和创建
2. 后端：分享帖子接口
3. 后端：获取分享列表接口
4. 前端：ShareApi 服务层
5. 前端：ShareUserSelector 组件
6. 前端：PostDetailPage 集成分享功能
7. 前端：ShareListPage 页面
8. 前端：PostShareCard 组件
9. 前端：添加导航入口

### P1 - 优化功能（第二期）

1. 后端：标记已读接口
2. 后端：未读数量接口
3. 前端：未读红点提示
4. 前端：已读/未读状态展示
5. 前端：下拉刷新
6. 前端：上拉加载更多

### P2 - 增强功能（第三期）

1. 后端：批量标记已读
2. 后端：删除分享记录
3. 前端：搜索互关用户
4. 前端：分享时添加留言
5. 前端：分享统计（帖子被分享次数）
6. 后端：分享推送通知（可选）

---

## 五、技术要点

### 5.1 性能优化

1. **数据冗余**：避免频繁JOIN查询
2. **索引优化**：针对常用查询添加索引
3. **分页加载**：避免一次性加载大量数据
4. **图片懒加载**：列表中的图片按需加载

### 5.2 安全考虑

1. **权限验证**：只能分享给互关用户
2. **防刷机制**：限制分享频率
3. **敏感信息**：不暴露接收者信息
4. **XSS防护**：分享留言需要过滤

### 5.3 扩展性

1. **其他分享类型**：如需支持用户、话题等，可添加 share_type 字段
2. **消息模板**：可扩展为更复杂的消息系统
3. **推送通知**：预留推送接口
4. **统计分析**：可添加分享数据统计

---

## 六、测试用例

### 6.1 后端接口测试

#### 6.1.1 分享帖子接口

- [ ] 成功分享帖子
- [ ] 帖子不存在
- [ ] 接收者不存在
- [ ] 未互关无法分享
- [ ] 不能分享给自己
- [ ] 分享频率限制

#### 6.1.2 获取分享列表接口

- [ ] 正常获取列表
- [ ] 分页功能
- [ ] 只看未读
- [ ] 空列表
- [ ] 未读数量正确

#### 6.1.3 标记已读接口

- [ ] 成功标记已读
- [ ] 分享不存在
- [ ] 非接收者无法标记

### 6.2 前端功能测试

#### 6.2.1 分享功能

- [ ] 打开用户选择器
- [ ] 搜索互关用户
- [ ] 选择用户并分享
- [ ] 分享成功提示
- [ ] 分享失败提示

#### 6.2.2 分享列表

- [ ] 列表正常显示
- [ ] 卡片样式正确
- [ ] 点击跳转详情
- [ ] 下拉刷新
- [ ] 上拉加载
- [ ] 未读红点显示

---

## 七、上线检查清单

### 7.1 数据库

- [ ] 创建分享表
- [ ] 添加索引
- [ ] 数据备份方案

### 7.2 后端

- [ ] API接口完成
- [ ] 单元测试通过
- [ ] 接口文档更新
- [ ] 性能测试

### 7.3 前端

- [ ] 组件开发完成
- [ ] 页面集成完成
- [ ] UI测试通过
- [ ] 兼容性测试

### 7.4 联调

- [ ] 前后端联调
- [ ] 异常场景测试
- [ ] 性能测试

---

## 八、FAQ

### Q1: 如果用户取消互关，之前的分享还能看到吗？

A: 可以看到。分享记录一旦创建就独立存在，不受后续关注关系变化影响。

### Q2: 如果帖子被删除，分享还能看到吗？

A: 分享卡片仍可见（因为有冗余数据），但点击后会提示"帖子已被删除"。

### Q3: 是否需要实时推送？

A: 第一期不需要，用户进入分享列表时刷新即可。后续可通过 WebSocket 或推送实现。

### Q4: 分享是否有时效性？

A: 暂不设置时效，所有分享永久保存。如需清理，可后续添加删除功能。

### Q5: 是否支持分享到多个用户？

A: 第一期仅支持单个用户。批量分享可在后续版本添加。

### Q6: 为什么只支持帖子分享，不支持用户分享？

A: 根据需求简化功能范围，专注于帖子内容的传播。如需扩展用户分享，可在数据表中添加 share_type 字段。

---

## 九、相关文档

- 数据库设计文档
- API接口文档
- UI设计规范
- 测试用例文档

---

**文档版本：** v1.0  
**创建日期：** 2025-01-19  
**最后更新：** 2025-01-19  
**维护人员：** 开发团队

